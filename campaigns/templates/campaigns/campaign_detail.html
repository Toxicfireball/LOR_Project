{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- ===== Scoped styles (no Bootstrap/Tailwind required) ===== -->
<style>
  :root{
    --bg:#0b1324; --panel:#0f172a; --panel-2:#111827;
    --text:#e5e7eb; --muted:#9aa0aa; --brand:#3b82f6; --brand2:#6366f1;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --ring:#1f2937;
    --card:#0b1220; --border:#202735;
    --radius:14px;
  }
  .wrap{ max-width:1100px; margin:0 auto; padding:24px 16px; color:var(--text); }
  .hero{
    background: linear-gradient(135deg,var(--brand) 0%, var(--brand2) 100%);
    border-radius: var(--radius);
    padding: 20px 22px;
    display:flex; gap:18px; align-items:flex-start; justify-content:space-between;
    color:white; box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }
  .hero h1{ margin:.1rem 0; font-size:1.6rem; font-weight:700; letter-spacing:.2px}
  .pills{ display:flex; gap:8px; flex-wrap:wrap;}
  .pill{ background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.26);
         border-radius:999px; padding:.25rem .55rem; font-size:.8rem }
  .btn{ display:inline-flex; align-items:center; gap:.45rem;
        background:rgba(255,255,255,.12); color:white; border:1px solid rgba(255,255,255,.28);
        padding:.55rem .8rem; border-radius:10px; text-decoration:none; font-weight:600 }
  .btn:hover{ background:rgba(255,255,255,.18) }
  .btn-outline{ background:transparent; border-color:rgba(255,255,255,.5) }
  .btn-danger{ background: var(--danger); border-color: var(--danger) }
  .btn-primary{ background:#2563eb; border-color:#2563eb }
  .btn-sm{ padding:.45rem .6rem; font-size:.9rem; border-radius:9px }

  .panel{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); }
  .panel .hd{ padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700 }
  .panel .bd{ padding:16px }

  /* Tabs */
  .tabs{ display:flex; gap:6px; margin:16px 0 12px; }
  .tab{ background:var(--panel-2); border:1px solid var(--border); color:var(--muted);
        padding:.55rem .9rem; border-radius:999px; cursor:pointer; }
  .tab.active{ background:#1d2435; color:#fff; border-color:#2a3244 }
  .tab:hover{ color:#fff }

  /* Search + attach row */
  .row2{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:12px }
  .search{ position:relative; flex:1 1 360px; }
  .search input{ width:100%; background:#0d1526; color:#e5e7eb; border:1px solid #1f2937;
                 padding:.65rem 2.2rem .65rem .9rem; border-radius:10px; outline:none }
  .search svg{ position:absolute; right:.6rem; top:50%; transform:translateY(-50%); opacity:.5 }

  select, .select{ background:#0d1526; color:#e5e7eb; border:1px solid #1f2937; padding:.6rem .8rem; border-radius:10px; }
  label.small{ font-size:.85rem; color:var(--muted); margin-right:.5rem }

  /* Character grid */
  .grid{ display:grid; grid-template-columns: repeat( auto-fill, minmax(280px,1fr) ); gap:12px; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:10px }
  .row{ display:flex; gap:10px; align-items:center; justify-content:space-between }
  .who{ display:flex; gap:10px; align-items:center }
  .avatar{ width:36px; height:36px; border-radius:50%; background:#111827; display:inline-grid; place-content:center; font-weight:700 }
  .meta{ color:var(--muted); font-size:.9rem }
  .badge{ background:#0e1a2e; color:#a0b8ff; border:1px solid #1f2c46; font-weight:700; font-size:.85rem;
          padding:.18rem .45rem; border-radius:7px }
  .actions{ display:flex; gap:8px; }
  .empty{ color:var(--muted); padding:14px 0 }

  /* Members list */
  .list{ list-style:none; margin:0; padding:0 }
  .list li{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-top:1px solid var(--border) }
  .chip{ font-size:.75rem; padding:.18rem .5rem; border-radius:999px; border:1px solid }
  .chip-gm{ color:#ff6666; background:#2a0e0e; border-color:#3d1717 }
  .chip-pc{ color:#70a2ff; background:#0d1a33; border-color:#1a2b50 }

  .muted{ color:var(--muted) }
  .lead{ font-size:.95rem; line-height:1.5 }
</style>

<div class="wrap">
  <!-- HERO -->
  <div class="hero">
    <div>
      <h1>{{ campaign.name }}</h1>
      <div class="muted" style="font-size:.9rem;">Created {{ campaign.created_at|date:"M j, Y" }}</div>
      <div class="pills" style="margin-top:8px;">
        <span class="pill">{{ stats.gm_count }} GM</span>
        <span class="pill">{{ stats.player_count }} Player{{ stats.player_count|pluralize }}</span>
        <span class="pill">{{ stats.char_count }} Character{{ stats.char_count|pluralize }}</span>
      </div>
    </div>

    <div class="pills" style="align-self:flex-start;">
      {% if not is_member %}
        <a class="btn" href="{% url 'campaigns:join_campaign' campaign.id %}">Join as Player</a>
      {% else %}
        <form method="post" action="{% url 'campaigns:leave_campaign' campaign.id %}">
          {% csrf_token %}
          <button class="btn btn-outline" type="submit">Leave Campaign</button>
        </form>
      {% endif %}
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="overview">Overview</button>
    <button class="tab" data-tab="characters">Characters</button>
    <button class="tab" data-tab="members">Members</button>
  </div>

  <!-- OVERVIEW -->
  <section class="panel" data-panel="overview">
    <div class="bd">
      <h3 class="muted" style="margin:0 0 .5rem 0;">Campaign Description</h3>
      <div class="lead">
        {{ campaign.description|linebreaksbr|default:"<em class='muted'>No description yet. Share setting, tone, allowed sources, schedule, and safety tools here.</em>" }}
      </div>
    </div>
    <div class="bd" style="border-top:1px solid var(--border)">
      <h3 class="muted" style="margin:0 0 .5rem 0;">How this works</h3>
      <ul class="lead muted" style="margin:0; padding-left:1rem;">
        <li><strong style="color:#fff">GM</strong> can view & manage <em>all</em> attached characters (and open their sheets).</li>
        <li><strong style="color:#fff">Players</strong> can attach/detach and open their own characters.</li>
        <li>Attaching auto-adds the character owner as a Player in this campaign (if not already).</li>
        <li>Detaching never deletes data from a character.</li>
      </ul>
    </div>
  </section>

  <!-- CHARACTERS -->
  <section class="panel" style="margin-top:14px; display:none" data-panel="characters">
    <div class="hd">Characters</div>
    <div class="bd">
      <div class="row2">
        <div class="search">
          <input id="charSearch" type="search" placeholder="Search by character or playerâ€¦">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="1.5"/></svg>
        </div>

        {% if is_member %}
        <form method="post" action="{% url 'campaigns:attach_character' campaign.id %}" class="row2" style="flex:0 0 auto">
          {% csrf_token %}
          <label class="small" for="{{ attach_form.character.id_for_label }}">Attach</label>
          {{ attach_form.character }}
          <button class="btn btn-primary" type="submit">Attach</button>
        </form>
        {% endif %}
      </div>

      <div id="charGrid" class="grid">
        {% for ch in attached_characters %}
          <article class="card char" data-name="{{ ch.name|lower }}" data-player="{{ ch.user.username|lower }}">
            <div class="row">
              <div class="who">
                <div class="avatar">{{ ch.name|first|upper }}</div>
                <div>
                  <div style="font-weight:700">{{ ch.name }}</div>
                  <div class="meta">by {{ ch.user.username }}</div>
                </div>
              </div>
              <span class="badge">L{{ ch.level|default:0 }}</span>
            </div>
            <div class="row">
              <div class="actions">
                <a class="btn btn-sm btn-primary" href="{% url 'characters:character_detail' ch.id %}">Open Sheet</a>
                {% if is_gm or ch.user_id == request.user.id %}
                <form method="post" action="{% url 'campaigns:detach_character' campaign.id ch.id %}">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-danger" type="submit">Detach</button>
                </form>
                {% endif %}
              </div>
            </div>
          </article>
        {% empty %}
          <div class="empty">No characters attached yet. Use the <strong>Attach</strong> control to add one.</div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- MEMBERS -->
  <section class="panel" style="margin-top:14px; display:none" data-panel="members">
    <div class="hd">Members</div>
    <div class="bd" style="padding:0">
      <ul class="list">
        {% for m in memberships %}
          <li>
            <div class="who">
              <div class="avatar">{{ m.user.username|first|upper }}</div>
              <div style="font-weight:700">{{ m.user.username }}</div>
            </div>
            {% if m.role == "gm" %}
              <span class="chip chip-gm">GM</span>
            {% else %}
              <span class="chip chip-pc">Player</span>
            {% endif %}
          </li>
        {% empty %}
          <li class="muted" style="padding:16px">No members yet.</li>
        {% endfor %}
      </ul>
    </div>
  </section>
</div>

<!-- ===== Minimal JS for tabs + search ===== -->
<script>
  (function(){
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('[data-panel]');
    function show(which){
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab===which));
      panels.forEach(p => p.style.display = (p.dataset.panel===which) ? '' : 'none');
    }
    tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.tab)));
    show('overview'); // default

    // search
    const q = document.getElementById('charSearch');
    if(q){
      const cards = [...document.querySelectorAll('.char')];
      q.addEventListener('input', () => {
        const s = q.value.trim().toLowerCase();
        cards.forEach(c=>{
          const name=c.dataset.name||'', player=c.dataset.player||'';
          c.style.display = (name.includes(s) || player.includes(s)) ? '' : 'none';
        });
      });
    }
  })();
</script>
{% endblock %}
