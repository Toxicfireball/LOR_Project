{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6">

  <!-- Header -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-4">
    <div class="p-5 flex items-start justify-between">
      <div>
        <h1 class="text-xl font-bold flex items-center gap-2">
          {{ campaign.name }}
          {% if campaign.is_password_protected %}<span title="Password required">🔒</span>{% endif %}
        </h1>
        <p class="text-sm text-gray-600">Created {{ campaign.created_at|date:"M j, Y" }}</p>
        <div class="mt-2 flex flex-wrap gap-2 text-xs">
          <span class="px-2 py-1 rounded-md bg-gray-100 text-gray-700">{{ stats.gm_count }} GM</span>
          <span class="px-2 py-1 rounded-md bg-gray-100 text-gray-700">{{ stats.player_count }} Player{{ stats.player_count|pluralize }}</span>
          <span class="px-2 py-1 rounded-md bg-gray-100 text-gray-700">{{ stats.char_count }} Character{{ stats.char_count|pluralize }}</span>
        </div>
      </div>
      <div class="shrink-0">
        {% if is_member %}
  <a class="inline-flex items-center mt-2 px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
     href="{% url 'characters:propose_background' %}?campaign={{ campaign.id }}">
    Propose Custom Background
  </a>
{% endif %}

        {% if not is_member %}
          <a class="inline-flex items-center px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700"
             href="{% url 'campaigns:join_campaign' campaign.id %}">
            Join as Player{% if campaign.is_password_protected %} (🔒){% endif %}
          </a>
        {% else %}
          <form method="post" action="{% url 'campaigns:leave_campaign' campaign.id %}">
            {% csrf_token %}
            <button class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50">
              Leave Campaign
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="border-b border-gray-200 mb-4" role="tablist" id="campTabs">
    <div class="flex flex-wrap gap-2">
      <button class="tab-btn px-3 py-2 text-sm rounded-t-md border border-b-0 border-transparent data-[active=true]:border-gray-200 data-[active=true]:bg-white data-[active=true]:text-gray-900 text-gray-600 hover:text-gray-900"
              data-tab="#overview" data-active="true">Overview</button>
      <button class="tab-btn px-3 py-2 text-sm rounded-t-md border border-b-0 border-transparent data-[active=true]:border-gray-200 data-[active=true]:bg-white data-[active=true]:text-gray-900 text-gray-600 hover:text-gray-900"
              data-tab="#characters">Characters</button>
      <button class="tab-btn px-3 py-2 text-sm rounded-t-md border border-b-0 border-transparent data-[active=true]:border-gray-200 data-[active=true]:bg-white data-[active=true]:text-gray-900 text-gray-600 hover:text-gray-900"
              data-tab="#members">Members</button>
      <button class="tab-btn px-3 py-2 text-sm rounded-t-md border border-b-0 border-transparent data-[active=true]:border-gray-200 data-[active=true]:bg-white data-[active=true]:text-gray-900 text-gray-600 hover:text-gray-900"
              data-tab="#notes">Notes</button>
      <button class="tab-btn px-3 py-2 text-sm rounded-t-md border border-b-0 border-transparent data-[active=true]:border-gray-200 data-[active=true]:bg-white data-[active=true]:text-gray-900 text-gray-600 hover:text-gray-900"
              data-tab="#inventory">Party Inventory</button>
      <button class="tab-btn px-3 py-2 text-sm rounded-t-md border border-b-0 border-transparent data-[active=true]:border-gray-200 data-[active=true]:bg-white data-[active=true]:text-gray-900 text-gray-600 hover:text-gray-900"
              data-tab="#messages">Messages</button>
    </div>
  </div>

  <div class="space-y-4">
    <!-- Overview -->
    <section id="overview" class="tab-panel bg-white rounded-xl shadow-sm border border-gray-200 p-5">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500 mb-2">Campaign Description</h2>
      <div class="prose max-w-none">
        {{ campaign.description|linebreaksbr|default:"<em class='text-gray-500'>No description yet. Share setting, tone, allowed sources, schedule, and safety tools here.</em>" }}
      </div>
    </section>

    <!-- Characters -->
    <section id="characters" class="tab-panel hidden bg-white rounded-xl shadow-sm border border-gray-200 p-5">
      <div class="grid md:grid-cols-[1fr_auto] gap-3 items-end mb-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Search</label>
          <input id="charSearch" type="search" placeholder="Search by character or player…"
                 class="block w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
        </div>

        {% if is_member %}
        <form class="flex items-end gap-2" method="post" action="{% url 'campaigns:attach_character' campaign.id %}">
          {% csrf_token %}
          <div>
            <label class="block text-sm text-gray-600 mb-1" for="{{ attach_form.character.id_for_label }}">Attach character</label>
            {{ attach_form.character }}
          </div>
          <button class="inline-flex items-center px-3 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700"
                  type="submit">Attach</button>
        </form>
        {% endif %}
      </div>

      <div id="charGrid" class="grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
        {% for ch in attached_characters %}
          <div class="char bg-white rounded-lg border border-gray-200 shadow-sm p-4"
               data-name="{{ ch.name|lower }}" data-player="{{ ch.user.username|lower }}">
            <div class="flex items-start justify-between">
              <div>
                <div class="font-semibold">{{ ch.name }}</div>
                <div class="text-sm text-gray-600">by {{ ch.user.username }}</div>
              </div>
              <span class="text-xs px-2 py-1 rounded-md bg-gray-100 text-gray-700">L{{ ch.level|default:0 }}</span>
            </div>
            <div class="mt-3 flex gap-2">
              <a class="inline-flex items-center px-3 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 text-sm"
                 href="{% url 'characters:character_detail' ch.id %}">Open Sheet</a>
              {% if is_gm or ch.user_id == request.user.id %}
              <form method="post" action="{% url 'campaigns:detach_character' campaign.id ch.id %}">
                {% csrf_token %}
                <button class="inline-flex items-center px-3 py-2 rounded-md border border-red-300 text-red-600 hover:bg-red-50 text-sm"
                        type="submit">Detach</button>
              </form>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="col-span-full rounded-lg border border-gray-200 bg-gray-50 p-4 text-gray-700">
            No characters attached yet. Use the <strong>Attach</strong> control to add one.
          </div>
        {% endfor %}
      </div>
    </section>

    <!-- Members -->
    <section id="members" class="tab-panel hidden bg-white rounded-xl shadow-sm border border-gray-200">
      <ul class="divide-y divide-gray-200">
        {% for row in memberships_with_chars %}
          <li class="p-4 flex items-start justify-between">
            <div>
              <div class="font-semibold">{{ row.m.user.username }}</div>
              <div class="text-sm text-gray-600">
                {% if row.chars %}
                  Character{{ row.chars|length|pluralize }}:
                  {% for ch in row.chars %}{{ ch.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                {% else %}
                  No character attached
                {% endif %}
              </div>
            </div>
            {% if row.m.role == "gm" %}
              <span class="text-xs px-2 py-1 rounded-md bg-red-100 text-red-700">GM</span>
            {% else %}
              <span class="text-xs px-2 py-1 rounded-md bg-indigo-100 text-indigo-700">Player</span>
            {% endif %}
          </li>
        {% empty %}
          <li class="p-4 text-gray-600">No members yet.</li>
        {% endfor %}
      </ul>
    </section>

    <!-- Notes -->
    <section id="notes" class="tab-panel hidden">
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
          <h2 class="font-semibold mb-3">New Note</h2>
          <form method="post" action="{% url 'campaigns:add_campaign_note' campaign.id %}" class="space-y-3">
            {% csrf_token %}
            <div>
              <label class="block text-sm text-gray-600 mb-1">Visibility</label>
              {{ note_form.visibility }}
            </div>

            {% if is_gm %}
              <div class="rounded-md border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700">
                <strong>GM:</strong> Optionally grant an item to the party with this note.
              </div>
              <div class="grid grid-cols-12 gap-3">
                <div class="col-span-7">
                  <label class="block text-sm text-gray-600 mb-1">Give item to party</label>
                  {{ note_form.equipment }}
                </div>
                <div class="col-span-5">
                  <label class="block text-sm text-gray-600 mb-1">Quantity</label>
                  {{ note_form.quantity }}
                </div>
              </div>
            {% endif %}

            <div>
              <label class="block text-sm text-gray-600 mb-1">Note</label>
              {{ note_form.content }}
            </div>

            <button class="inline-flex items-center px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700"
                    type="submit">Post Note</button>
          </form>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
          <h2 class="font-semibold mb-3">Recent Notes</h2>
          <div class="divide-y divide-gray-200">
            {% for n in notes %}
              <div class="py-3">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-gray-700">
                    <strong>{{ n.author.username }}</strong>
                    <span class="text-gray-500">• {{ n.created_at|date:"M j, Y H:i" }}</span>
                    <span class="text-gray-500">• {{ n.get_visibility_display }}</span>
                  </div>
                  {% if n.item %}
                    <span class="text-xs px-2 py-1 rounded-md bg-green-100 text-green-700">🎁 {{ n.item.name }} ×{{ n.quantity }}</span>
                  {% endif %}
                </div>
                <div class="mt-2 text-gray-800">{{ n.content|linebreaksbr }}</div>
              </div>
            {% empty %}
              <div class="text-gray-600">No notes yet.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>

    <!-- Inventory -->
     <!-- Inventory -->
<section id="inventory" class="tab-panel hidden bg-white rounded-xl shadow-sm border border-gray-200">

  {% if is_gm %}
  <form method="post" action="{% url 'campaigns:add_party_item' campaign.id %}"
        class="flex flex-wrap items-end gap-3 p-4 border-b border-gray-200">
    {% csrf_token %}
    <div class="min-w-[260px]">
      <label class="block text-sm text-gray-600 mb-1">Item</label>
      {{ add_item_form.item }}
    </div>
    <div>
      <label class="block text-sm text-gray-600 mb-1">Quantity</label>
      {{ add_item_form.quantity }}
    </div>
    <button type="submit"
            class="inline-flex items-center px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700">
      Add to Party
    </button>
  </form>
  {% endif %}

  <ul class="divide-y divide-gray-200">
    {% for it in inventory %}
      <li class="p-4 flex items-center justify-between">
        <div>
          <div class="font-semibold">{{ it.item.name }}</div>
          <div class="text-sm text-gray-600">Added by {{ it.added_by|default:"System" }} • {{ it.created_at|date:"M j, Y" }}</div>
        </div>
        <span class="text-xs px-2 py-1 rounded-md bg-gray-100 text-gray-700">×{{ it.quantity }}</span>
      </li>
    {% empty %}
      <li class="p-4 text-gray-600">No party items yet.</li>
    {% endfor %}
  </ul>
</section>

    <section id="inventory" class="tab-panel hidden bg-white rounded-xl shadow-sm border border-gray-200">
      <ul class="divide-y divide-gray-200">
        {% for it in inventory %}
          <li class="p-4 flex items-center justify-between">
            <div>
              <div class="font-semibold">{{ it.item.name }}</div>
              <div class="text-sm text-gray-600">Added by {{ it.added_by|default:"System" }} • {{ it.created_at|date:"M j, Y" }}</div>
            </div>
            <span class="text-xs px-2 py-1 rounded-md bg-gray-100 text-gray-700">×{{ it.quantity }}</span>
          </li>
        {% empty %}
          <li class="p-4 text-gray-600">No party items yet.</li>
        {% endfor %}
      </ul>
    </section>
{% if is_gm and pending_bgs %}
<div class="section">
  <h3>Pending Backgrounds</h3>
  <ul>
    {% for pb in pending_bgs %}
      <li style="margin:.5rem 0;">
        <strong>{{ pb.name }}</strong> ({{ pb.code }}) — by {{ pb.requested_by }}
        <form method="post" action="{% url 'campaigns:approve_pending_bg' campaign.id pb.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit">Approve</button>
        </form>
        <form method="post" action="{% url 'campaigns:reject_pending_bg' campaign.id pb.id %}" style="display:inline;">
          {% csrf_token %}
          <input type="text" name="gm_note" placeholder="Reason (optional)" style="width:200px;">
          <button type="submit">Reject</button>
        </form>
      </li>
    {% endfor %}
  </ul>
</div>
{% endif %}


    <!-- Messages -->
    <section id="messages" class="tab-panel hidden">
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
          <h2 class="font-semibold mb-3">Direct Messages</h2>
          <form method="post" action="{% url 'campaigns:send_campaign_message' campaign.id %}" class="space-y-3">
            {% csrf_token %}
            <div>
              <label class="block text-sm text-gray-600 mb-1">To</label>
              {{ message_form.recipient }}
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Message</label>
              {{ message_form.content }}
            </div>
            <button class="inline-flex items-center px-4 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700"
                    type="submit">Send</button>
          </form>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
          <h2 class="font-semibold mb-3">Your recent conversations</h2>
          <div class="divide-y divide-gray-200">
            {% for msg in inbox %}
              <div class="py-3">
                <div class="text-xs text-gray-500">{{ msg.created_at|date:"M j, Y H:i" }}</div>
                <div class="font-semibold">{{ msg.sender.username }}</div>
                <div class="text-sm text-gray-600">→ {{ msg.recipient.username }}</div>
                <div class="mt-1">{{ msg.content|linebreaksbr }}</div>
              </div>
            {% empty %}
              <div class="text-gray-600">No messages yet.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  const panels  = Array.from(document.querySelectorAll('.tab-panel'));
  const buttons = Array.from(document.querySelectorAll('.tab-btn'));
  if (!buttons.length) return;

  function show(id) {
    panels.forEach(p => p.classList.toggle('hidden', '#' + p.id !== id));
    buttons.forEach(b => b.dataset.active = (b.dataset.tab === id));
    history.replaceState(null, '', id);
  }

  // initial: use hash if valid; otherwise Notes for GMs, Overview for others
  const hashOk = location.hash && document.querySelector(location.hash);
  const fallback = {% if is_gm %}'#notes'{% else %}'#overview'{% endif %};
  show(hashOk ? location.hash : (buttons[0]?.dataset.tab || fallback));

  buttons.forEach(b => b.addEventListener('click', () => show(b.dataset.tab)));
  window.addEventListener('hashchange', () => {
    if (document.querySelector(location.hash)) show(location.hash);
  });
})();
</script>

<script>
  (function () {
    const buttons = document.querySelectorAll('#campTabs [data-bs-toggle="tab"]');
    const panes   = document.querySelectorAll('.tab-pane');
    if (!buttons.length) return;

    function activate(targetSel, clickedBtn) {
      panes.forEach(p => p.classList.remove('show','active'));
      buttons.forEach(b => b.classList.remove('active'));
      const pane = document.querySelector(targetSel);
      if (pane) { pane.classList.add('show','active'); }
      if (clickedBtn) clickedBtn.classList.add('active');
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        activate(btn.getAttribute('data-bs-target'), btn);
      });
    });
  })();
</script>
<script>
/* Minimal tabs (no Bootstrap JS required) */
(function () {
  const tablist = document.getElementById('campTabs');
  if (!tablist) return;

  const buttons = tablist.querySelectorAll('[data-bs-toggle="tab"]');
  const panes   = document.querySelectorAll('.tab-content .tab-pane');

  function activate(target) {
    // target comes like "#notes"
    buttons.forEach(btn => {
      const isActive = btn.dataset.bsTarget === target;
      btn.classList.toggle('active', isActive);
      btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });
    panes.forEach(pane => {
      const match = ('#' + pane.id) === target;
      pane.classList.toggle('show',   match);
      pane.classList.toggle('active', match);
      // keep "fade" on non-active panes for a subtle transition
      if (match) pane.classList.remove('fade'); else pane.classList.add('fade');
    });
  }

  // click -> switch and update hash
  buttons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const target = btn.dataset.bsTarget || '#overview';
      history.replaceState(null, '', target);
      activate(target);
    });
  });

  // initial pane from hash (e.g. “…#notes”), or default to overview
  const initial = (location.hash && document.querySelector(location.hash)) ? location.hash : '#overview';
  activate(initial);

  // keep tabs in sync if the hash changes (e.g., redirects to #notes after posting)
  window.addEventListener('hashchange', () => {
    if (document.querySelector(location.hash)) activate(location.hash);
  });
})();
</script>

{% endblock %}
