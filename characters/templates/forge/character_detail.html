{# templates/forge/character_detail.html #}
{% extends "base.html" %}
{% load static %}
{% load ui_extras %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/character.css' %}">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
{% endblock %}

{% block content %}
<style>
    table tbody tr.is-active { outline: 2px solid #0d6efd; }
  #general-feats-table tbody tr.is-selected { background: #fff9db; }
  #general-feats-table tbody tr.is-active { outline: 2px solid #0d6efd; }
</style>

<div class="container my-4">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ character.name }}</h1>
    <div>
      <button
        class="btn btn-secondary me-2"
        {% if not can_edit %}disabled{% endif %}
        data-bs-toggle="modal"
        data-bs-target="#editCharacterModal"
      >Edit Details</button>
      <button
        class="btn btn-primary me-2"
        data-bs-toggle="modal"
        data-bs-target="#levelUpModal"
      >Level Up</button>
      <a
        href="{% url 'characters:level_down' character.pk %}"
        class="btn btn-danger {% if character.level == 0 %}disabled{% endif %}"
      >Level Down</a>
    </div>
  </div>

  <div class="row g-4">
    <!-- LEFT COLUMN -->
    <div class="col-lg-4">
      <div class="card p-3 mb-3">
        <h5>Basic Info</h5>
        <ul class="list-unstyled mb-0">
          <li><strong>Race:</strong> {{ character.race }}</li>
          {% if subrace_name %}<li><strong>Subrace:</strong> {{ subrace_name }}</li>{% endif %}
          {% if character.half_elf_origin %}
            <li><strong>Half-Elf Origin:</strong> {{ character.half_elf_origin }}</li>
          {% endif %}
          <li><strong>Backgrounds:</strong>
            {{ character.main_background }}
            {% if character.side_background_1 %}, {{ character.side_background_1 }}{% endif %}
            {% if character.side_background_2 %}, {{ character.side_background_2 }}{% endif %}
          </li>
          <li><strong>HP:</strong> {{ character.HP }}
            {% if character.temp_HP %}(+{{ character.temp_HP }} temp){% endif %}
          </li>
          <li><strong>Level:</strong> {{ character.level }}</li>
        </ul>
      </div>

      <div class="card p-3 mb-3">
        <h5>Ability Scores</h5>
        <dl class="row mb-0">
          {% for name,val in ability_map.items %}
            <dt class="col-6">{{ name }}</dt>
            <dd class="col-6">{{ val }}</dd>
          {% endfor %}
        </dl>
      </div>

      <div class="card p-3 mb-3">
        <h5>Skill Proficiencies</h5>
        {% if skill_proficiencies %}
          <ul class="mb-0">
            {% for prof in skill_proficiencies %}
              <li><strong>{{ prof.selected_skill.name }}:</strong> {{ prof.proficiency.name }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="mb-0"><em>None</em></p>
        {% endif %}
      </div>

      <div class="card p-3">
        <h5>Racial Features</h5>
        {% if racial_features %}
          <ul class="mb-0">
            {% for rf in racial_features %}
              <li>{{ rf.code }} – {{ rf.name }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="mb-0"><em>None</em></p>
        {% endif %}
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="col-lg-8">
      <div class="card p-3 mb-3">
        <h5>Class Breakdown</h5>
        <ul class="mb-0">
          {% for prog in class_progress %}
            <li>{{ prog.character_class.name }} (Level {{ prog.levels }})</li>
          {% endfor %}
        </ul>
      </div>

      <div class="card p-3 mb-3">
        <h5>Universal Feats / ASI</h5>
        {% if universal_feats %}
          <ul class="mb-0">
            {% for uf in universal_feats %}
              {% if uf.grants_asi %}<li>Ability Score Increase</li>{% endif %}
              {% if uf.grants_general_feat %}<li>General Feat</li>{% endif %}
            {% endfor %}
          </ul>
        {% else %}
          <p class="mb-0">&mdash;</p>
        {% endif %}
      </div>

      <div class="card p-3">
        <h5>Gained Features</h5>
        <ul class="mb-0">
          {% for cf in character.features.all %}
            <li>
              {% if cf.option %}
                {{ cf.option.label }}
              {% elif cf.subclass %}
                {{ cf.subclass.name }}
              {% else %}
                {{ cf.feature.name }}
              {% endif %}
              <small class="text-muted">(L{{ cf.level }})</small>
            </li>
          {% empty %}
            <li><em>No features chosen yet.</em></li>
          {% endfor %}
        </ul>
      </div>
<div class="card p-3 mt-3">
  <h5>Gained Feats</h5>
  {% if character.feats.all %}
    <ul class="mb-0">
      {% for f in character.feats.all %}
        <li>{{ f.feat.name }} <small class="text-muted">(L{{ f.level }})</small></li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="mb-0"><em>None</em></p>
  {% endif %}
</div>


    </div>
  </div>
</div>

{# EDIT CHARACTER MODAL (unchanged) #}
… your existing editCharacterModal here …

<!-- LEVEL UP MODAL -->
<div class="modal fade" id="levelUpModal" tabindex="-1" aria-labelledby="levelUpModalLabel" aria-hidden="true">
<div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="levelUpModalLabel" class="modal-title">Level Up to {{ total_level|add:"1" }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

  
<div class="modal-body p-0">
  <div class="row g-0">
    <!-- LEFT column: class info / preview -->
    <div class="col-12 col-xl-5 p-4 border-end">
      <form method="get"
            action="{% url 'characters:character_detail' character.pk %}#levelUpModal"
            class="mb-4">
        {{ form.base_class }}
      </form>

      <div class="mb-3">
        <h6 class="mb-2">Description</h6>
        <div class="text-muted">{{ preview_class.description }}</div>
      </div>

      <div class="mb-3 small text-muted">
        <div><strong>Hit Die:</strong> d{{ preview_class.hit_die }}</div>
        <div>
          <strong>Key Abilities:</strong>
          {% for a in preview_class.key_abilities.all %}
            {{ a.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>
      </div>

      <div class="mb-3">
        <h6 class="mb-2">Proficiencies</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Type</th>
                {% for tn in tier_names %}<th>{{ tn }}</th>{% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in proficiency_rows %}
                <tr>
                  <td>{{ row.type }}</td>
                  {% for lvl in row.levels %}
                    <td>{{ lvl }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="mb-3">
        <h6 class="mb-2">Features at L{{ total_level|add:"1" }}</h6>
        <ul class="mb-0 ps-3">
          {% for f in auto_feats %}
            <li class="mb-2">
              <strong>{{ f.code }} – {{ f.name }}</strong>
              {% if f.description %}
                <div class="mt-1 small feature-desc">{{ f.description|safe }}</div>
              {% endif %}
            </li>
          {% empty %}
            <li><em>None</em></li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- RIGHT column: your existing POST form and pickers -->
    <div class="col-12 col-xl-7 p-4">
      {# MOVE your whole <form method="post" …> … </form> block HERE #}


        <form method="post" action="{% url 'characters:character_detail' character.pk %}">
          {% csrf_token %}

          {# carry over the chosen class #}
          <input type="hidden" name="base_class" value="{{ form.base_class.value }}">

          {# General Feat #}
          {% if form.general_feat %}
          <div class="mb-3">
            <label class="form-label">{{ form.general_feat.label }}</label>
            <input
      type="text"
      id="general-feat-filter"
      class="form-control mb-2"
      placeholder="Filter feats…"
    >
           
            <table id="general-feats-table" class="table table-bordered">
            <thead>
              <tr>
                <th></th>  {# radio (actual selection) #}
                <th data-sort="1">Feat</th>
                <th data-sort="2">Description</th>
                <th data-sort="3">Level</th>
              <th data-sort="4">
                Requirements
                <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                  <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                  <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                </div>
              </th>             
              <th data-sort="5">
              Tags
              <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                <div class="dropdown-menu p-3 excel-menu" data-col="5" data-split="1" style="width:260px;"></div>
              </div>
            </th>
              </tr>
            </thead>


          <tbody>
            {% for feat in form.general_feat.field.queryset %}
              <tr>
                <td>
                  <input
                    type="radio"
                    name="{{ form.general_feat.name }}"
                    value="{{ feat.pk }}"
                    {% if form.general_feat.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                  >
                </td>

                <td class="feat-name">{{ feat.name }}</td>
                <td class="feat-desc">{{ feat.description|default:"(no description)" }}</td>
                <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
              </tr>
            {% endfor %}
          </tbody>

            </table>
            {% for err in form.general_feat.errors %}
              <div class="text-danger">{{ err }}</div>
            {% endfor %}
          </div>
        {% endif %}






          {# ASI #}
          {% if form.asi %}
            <div class="form-check mb-3">
              {{ form.asi }} {{ form.asi.label_tag }}
              {% for err in form.asi.errors %}
                <div class="text-danger">{{ err }}</div>
              {% endfor %}
            </div>
          {% endif %}



          {# Subclass‐choice & option pickers #}
      

          {# REMOVE the old select block for class_feat_pick and paste this #}
          {% if form.class_feat_pick %}
            <div class="mb-4">
              <label class="form-label">{{ form.class_feat_pick.label }}</label>

              <input type="text" id="class-feat-filter" class="form-control mb-2" placeholder="Filter feats…">

              <table id="class-feats-table" class="table table-bordered">
                <thead>
                  <tr>
                    <th></th>  {# radio #}
                    <th data-sort="1">Feat</th>
                    <th data-sort="2">Description</th>
                    <th data-sort="3">Level</th>
                    <th data-sort="4">
                      Requirements
                      <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                        <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">▾</button>
                        <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                      </div>
                    </th>
                  <th data-sort="5">
                  Tags
                  <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                    <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                    <div class="dropdown-menu p-3 excel-menu" data-col="5" data-split="1" style="width:260px;"></div>
                  </div>
                </th>
                  </tr>
                </thead>
                <tbody>
                  {% for feat in form.class_feat_pick.field.queryset %}
                    <tr>
                      <td>
                        <input
                          type="radio"
                          name="{{ form.class_feat_pick.name }}"
                          value="{{ feat.pk }}"
                          {% if form.class_feat_pick.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                        >
                      </td>
                      <td class="feat-name">{{ feat.name }}</td>
                      <td class="feat-desc">{{ feat.description|default:"(no description)" }}</td>
                      <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                      <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                      <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>

              {% for err in form.class_feat_pick.errors %}
                <div class="text-danger">{{ err }}</div>
              {% endfor %}
            </div>
          {% endif %}
{% for item in feature_fields %}
  {% if item.kind == "subclass_choice" %}
    {# ... your existing subclass UI unchanged ... #}

  {% elif item.kind == "option" %}
    <div class="mb-6">
      <div class="mb-2 text-sm font-medium">{{ item.label }}</div>

      {# 1) PARENT CHOICE details (non-blank only) #}
      {% with f=item.feature %}
      <div class="rounded-xl border p-3 mb-3">
        <div class="font-semibold">{{ f.code }} – {{ f.name }}</div>
        {% if f.description %}
          <div class="prose prose-sm mt-1 max-w-none">{{ f.description|safe }}</div>
        {% endif %}
        <dl class="mt-2 grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-slate-600">
          {% if f.kind %}<div><span class="font-medium">Type:</span> {{ f.get_kind_display|default:f.kind }}</div>{% endif %}
          {% if f.action_type %}<div><span class="font-medium">Action:</span> {{ f.get_action_type_display|default:f.action_type }}</div>{% endif %}
          {% if f.uses %}<div class="col-span-2"><span class="font-medium">Uses:</span> {{ f.uses }}</div>{% endif %}
          {% if f.formula %}
            <div class="col-span-2"><span class="font-medium">Formula:</span> {{ f.formula }}{% if f.formula_target %} ({{ f.get_formula_target_display|default:f.formula_target }}){% endif %}</div>
          {% endif %}

          {% if f.saving_throw_required %}
            <div class="col-span-2"><span class="font-medium">Save:</span> {{ f.get_saving_throw_type_display|default:f.saving_throw_type }}{% if f.saving_throw_granularity %} – {{ f.get_saving_throw_granularity_display|default:f.saving_throw_granularity }}{% endif %}</div>
            {% if f.saving_throw_granularity == "basic" %}
              {% if f.saving_throw_basic_success %}<div class="col-span-2"><span class="font-medium">On Success:</span> {{ f.saving_throw_basic_success }}</div>{% endif %}
              {% if f.saving_throw_basic_failure %}<div class="col-span-2"><span class="font-medium">On Failure:</span> {{ f.saving_throw_basic_failure }}</div>{% endif %}
            {% else %}
              {% if f.saving_throw_critical_success %}<div class="col-span-2"><span class="font-medium">Crit Success:</span> {{ f.saving_throw_critical_success }}</div>{% endif %}
              {% if f.saving_throw_success %}<div class="col-span-2"><span class="font-medium">Success:</span> {{ f.saving_throw_success }}</div>{% endif %}
              {% if f.saving_throw_failure %}<div class="col-span-2"><span class="font-medium">Failure:</span> {{ f.saving_throw_failure }}</div>{% endif %}
              {% if f.saving_throw_critical_failure %}<div class="col-span-2"><span class="font-medium">Crit Failure:</span> {{ f.saving_throw_critical_failure }}</div>{% endif %}
            {% endif %}
          {% endif %}

          {% if f.damage_type %}<div class="col-span-2"><span class="font-medium">Damage Type:</span> {{ f.get_damage_type_display|default:f.damage_type }}</div>{% endif %}

          {% if f.gain_resistance_mode %}
            <div class="col-span-2">
              <span class="font-medium">Grants:</span>
              {% if f.gain_resistance_mode == "reduction" %}
                DR {{ f.gain_resistance_amount|default:"?" }}{% if f.gain_resistance_types %} vs {{ f.gain_resistance_types|join:", " }}{% endif %}
              {% else %}
                Resistance{% if f.gain_resistance_types %} vs {{ f.gain_resistance_types|join:", " }}{% endif %}
              {% endif %}
            </div>
          {% endif %}

          {% if f.kind == "gain_proficiency" and f.modify_proficiency_target %}
            <div class="col-span-2"><span class="font-medium">Proficiency:</span> {{ f.modify_proficiency_target }} → {{ f.modify_proficiency_amount }}</div>
          {% endif %}

          {% if f.gain_subskills.all %}
            <div class="col-span-2">
              <span class="font-medium">Sub-skills:</span>
              {% for s in f.gain_subskills.all %}{{ s.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
            </div>
          {% endif %}
        </dl>
      </div>
      {% endwith %}

      {# 2) OPTIONS list (radio) with each option’s details #}
      <div class="grid gap-3">
        {% for opt in item.feature.options.all %}
          {% with radio_id="id_"|add:item.field.name|add:"_"|add:opt.pk|stringformat:"s" %}
          <label for="{{ radio_id }}" class="flex items-start gap-3 rounded-xl border p-3 hover:bg-slate-50 cursor-pointer">
            <input
              type="radio"
              id="{{ radio_id }}"
              name="{{ item.field.name }}"
              value="{{ opt.pk }}"
              class="mt-1 h-4 w-4 rounded border-slate-300 focus:ring-2 focus:ring-blue-500"
              {% if item.field.value|stringformat:"s" == opt.pk|stringformat:"s" %}checked{% endif %}
              {% if item.field.field.required %}required{% endif %}
            />
            <div class="min-w-0">
              <div class="font-semibold">{{ opt.label }}</div>

              {% if opt.grants_feature %}
                {% with f=opt.grants_feature %}
                {% if f.description %}
                  <div class="prose prose-sm mt-1 max-w-none">{{ f.description|safe }}</div>
                {% endif %}
                <dl class="mt-2 grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-slate-600">
                  {% if f.kind %}<div><span class="font-medium">Type:</span> {{ f.get_kind_display|default:f.kind }}</div>{% endif %}
                  {% if f.action_type %}<div><span class="font-medium">Action:</span> {{ f.get_action_type_display|default:f.action_type }}</div>{% endif %}
                  {% if f.uses %}<div class="col-span-2"><span class="font-medium">Uses:</span> {{ f.uses }}</div>{% endif %}
                  {% if f.formula %}
                    <div class="col-span-2"><span class="font-medium">Formula:</span> {{ f.formula }}{% if f.formula_target %} ({{ f.get_formula_target_display|default:f.formula_target }}){% endif %}</div>
                  {% endif %}

                  {% if f.saving_throw_required %}
                    <div class="col-span-2"><span class="font-medium">Save:</span> {{ f.get_saving_throw_type_display|default:f.saving_throw_type }}{% if f.saving_throw_granularity %} – {{ f.get_saving_throw_granularity_display|default:f.saving_throw_granularity }}{% endif %}</div>
                    {% if f.saving_throw_granularity == "basic" %}
                      {% if f.saving_throw_basic_success %}<div class="col-span-2"><span class="font-medium">On Success:</span> {{ f.saving_throw_basic_success }}</div>{% endif %}
                      {% if f.saving_throw_basic_failure %}<div class="col-span-2"><span class="font-medium">On Failure:</span> {{ f.saving_throw_basic_failure }}</div>{% endif %}
                    {% else %}
                      {% if f.saving_throw_critical_success %}<div class="col-span-2"><span class="font-medium">Crit Success:</span> {{ f.saving_throw_critical_success }}</div>{% endif %}
                      {% if f.saving_throw_success %}<div class="col-span-2"><span class="font-medium">Success:</span> {{ f.saving_throw_success }}</div>{% endif %}
                      {% if f.saving_throw_failure %}<div class="col-span-2"><span class="font-medium">Failure:</span> {{ f.saving_throw_failure }}</div>{% endif %}
                      {% if f.saving_throw_critical_failure %}<div class="col-span-2"><span class="font-medium">Crit Failure:</span> {{ f.saving_throw_critical_failure }}</div>{% endif %}
                    {% endif %}
                  {% endif %}

                  {% if f.damage_type %}<div class="col-span-2"><span class="font-medium">Damage Type:</span> {{ f.get_damage_type_display|default:f.damage_type }}</div>{% endif %}

                  {% if f.gain_resistance_mode %}
                    <div class="col-span-2">
                      <span class="font-medium">Grants:</span>
                      {% if f.gain_resistance_mode == "reduction" %}
                        DR {{ f.gain_resistance_amount|default:"?" }}{% if f.gain_resistance_types %} vs {{ f.gain_resistance_types|join:", " }}{% endif %}
                      {% else %}
                        Resistance{% if f.gain_resistance_types %} vs {{ f.gain_resistance_types|join:", " }}{% endif %}
                      {% endif %}
                    </div>
                  {% endif %}

                  {% if f.kind == "gain_proficiency" and f.modify_proficiency_target %}
                    <div class="col-span-2"><span class="font-medium">Proficiency:</span> {{ f.modify_proficiency_target }} → {{ f.modify_proficiency_amount }}</div>
                  {% endif %}

                  {% if f.gain_subskills.all %}
                    <div class="col-span-2">
                      <span class="font-medium">Sub-skills:</span>
                      {% for s in f.gain_subskills.all %}{{ s.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </div>
                  {% endif %}
                </dl>
                {% endwith %}
              {% endif %}
            </div>
          </label>
          {% endwith %}
        {% endfor %}
      </div>

      {% for err in item.field.errors %}
        <div class="mt-1 text-sm text-red-600">{{ err }}</div>
      {% endfor %}
    </div>

  {% else %}
    {# Fallback (unchanged old simple label+field) #}
    <div class="mb-3">
      <label class="block text-sm font-medium mb-1">{{ item.label }}</label>
      {{ item.field }}
      {% for err in item.field.errors %}
        <div class="text-red-600 text-sm">{{ err }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endfor %}



          {# Optional Martial Mastery #}
          {% if form.martial_mastery %}
            <div class="mb-3">
              {{ form.martial_mastery.label_tag }}
              {{ form.martial_mastery }}
              {% for err in form.martial_mastery.errors %}
                <div class="text-danger">{{ err }}</div>
              {% endfor %}
            </div>
          {% endif %}

          <button type="submit" name="level_up_submit" class="btn btn-primary">
            Confirm Level Up
          </button>
        </form>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  {# 2) Then your custom code, wrapped in DOMContentLoaded #}
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      // — show modal if hash is present
      if (window.location.hash === "#levelUpModal") {
        new bootstrap.Modal(
          document.getElementById("levelUpModal")
        ).show();
      }

      // — wire up the filter input only if it exists

    });
  </script>
<script>
(function(){
  function initFeatTable(opts){
    var table = document.getElementById(opts.tableId);
    if (!table) return;

    // ---- Sorting
    function cellText(row, idx){ var c=row.cells[idx]; return (c?c.textContent:"").trim().toLowerCase(); }
    table.querySelectorAll("th[data-sort]").forEach(function(th){
      th.style.cursor = "pointer";
      th.addEventListener("click", function(){
        var col = parseInt(th.getAttribute("data-sort"), 10);
        var asc = th.getAttribute("data-order") !== "asc";
        th.setAttribute("data-order", asc ? "asc" : "desc");
        var rows = Array.from(table.tBodies[0].rows);
        rows.sort(function(a,b){
          var A = cellText(a, col), B = cellText(b, col);
          return asc ? A.localeCompare(B, undefined, {numeric:true}) : B.localeCompare(A, undefined, {numeric:true});
        });
        rows.forEach(function(r){ table.tBodies[0].appendChild(r); });
      });
    });

    // ---- Excel-like filters
    var BLANK="(Blanks)";
    function getColText(row, colIdx){ var c=row.cells[colIdx]; return (c?c.textContent:"").trim(); }
    function splitTokens(txt){ return txt.split(/[,;/]/).map(function(s){return s.trim();}).filter(Boolean); }

    function uniqueValuesForCol(colIdx, splitByTokens){
      var set = new Set();
      Array.from(table.tBodies[0].rows).forEach(function(r){
        var txt = getColText(r, colIdx);
        if (!txt) set.add(BLANK);
        else if (splitByTokens){ splitTokens(txt).forEach(function(tok){ set.add(tok); }); }
        else set.add(txt);
      });
      return Array.from(set).sort(function(a,b){ return a.localeCompare(b, undefined, {numeric:true}); });
    }

    function applyFilters(){
      var menus = table.querySelectorAll(".excel-menu[data-col]");      var active = [];
      menus.forEach(function(menu){
        var col   = parseInt(menu.dataset.col, 10);
        var split = menu.dataset.split === "1";
        var selected = Array.from(menu.querySelectorAll('input[type="checkbox"]:checked')).map(function(cb){ return cb.value; });
        active.push({col, split, selected, enabled: menu.dataset.ready === "1"});
      });

      Array.from(table.tBodies[0].rows).forEach(function(row){
        var show = true;
        active.forEach(function(f){
          if (!show || !f.enabled) return;
          var txt = getColText(row, f.col);
          var tokens = (!txt) ? [BLANK] : (f.split ? splitTokens(txt) : [txt]);
          if (f.selected.length === 0) { show = false; return; }
          show = tokens.some(function(tok){ return f.selected.indexOf(tok) !== -1; });
        });
        row.style.display = show ? "" : "none";
      });
    }

    function buildFilterMenu(menuEl){
      var col   = parseInt(menuEl.dataset.col, 10);
      var split = menuEl.dataset.split === "1";
      var values = uniqueValuesForCol(col, split);

      menuEl.innerHTML = [
        '<div class="d-flex justify-content-between small mb-2">',
        '  <a href="#" class="excel-sel-all">Select all</a>',
        '  <a href="#" class="excel-clear">Clear</a>',
        '</div>',
        '<input type="text" class="form-control form-control-sm mb-2 excel-search" placeholder="Search values…">',
        '<div class="excel-list" style="max-height:220px; overflow:auto;"></div>',
        '<div class="d-flex justify-content-end gap-2 mt-2">',
        '  <button type="button" class="btn btn-sm btn-outline-secondary excel-cancel">Cancel</button>',
        '  <button type="button" class="btn btn-sm btn-success excel-ok">OK</button>',
        '</div>'
      ].join("");

      var list = menuEl.querySelector(".excel-list");
      function renderList(filter){
        list.innerHTML = "";
        values.forEach(function(v){
          if (filter && v.toLowerCase().indexOf(filter.toLowerCase()) === -1) return;
          var id = "excel_"+opts.tableId+"_"+col+"_"+btoa(unescape(encodeURIComponent(v))).replace(/=/g,'');
          var div = document.createElement("div");
          div.className = "form-check";
          div.innerHTML = '<input class="form-check-input" type="checkbox" id="'+id+'" value="'+v+'" checked>' +
                          '<label class="form-check-label small" for="'+id+'">'+v+'</label>';
          list.appendChild(div);
        });
      }
      renderList("");

      menuEl.querySelector(".excel-search").addEventListener("input", function(){ renderList(this.value.trim()); });
      menuEl.addEventListener("click", function(e){
        if (e.target.matches(".excel-sel-all")){ e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true); applyFilters(); }
        if (e.target.matches(".excel-clear"))  { e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); applyFilters(); }
        if (e.target.matches(".excel-ok,.excel-cancel")){
          var dd = bootstrap.Dropdown.getOrCreateInstance(menuEl.parentElement.querySelector('[data-bs-toggle="dropdown"]'));
          dd.hide();
        }
      });
      list.addEventListener("change", applyFilters);

      menuEl.dataset.ready = "1";
      applyFilters();
    }

    // build menus for all dropdowns attached to THIS table’s header
table.querySelectorAll(".excel-menu[data-col]").forEach(buildFilterMenu);
    // row highlight on radio
    table.addEventListener("change", function(e){
      if (e.target.type === "radio") {
        table.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("is-active"));
        e.target.closest("tr").classList.add("is-active");
      }
    });

    // free-text filter (cooperates with excel filters)
    if (opts.searchId){
      var input = document.getElementById(opts.searchId);
      if (input){
        input.addEventListener("keyup", function(){
          var q = this.value.toLowerCase();
          Array.from(table.tBodies[0].rows).forEach(function(row){
            var textMatch = row.textContent.toLowerCase().includes(q);
            var excelHidden = row.style.display === "none";
            row.style.display = (textMatch && !excelHidden) ? "" : (textMatch ? "" : "none");
          });
        });
      }
    }
  }

  // init both tables
  initFeatTable({ tableId: "general-feats-table", searchId: "general-feat-filter" });
  initFeatTable({ tableId: "class-feats-table",   searchId: "class-feat-filter"   });
})();
</script>


{% endblock %}
