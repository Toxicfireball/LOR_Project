{# templates/forge/character_detail.html #}
{% extends "base.html" %}
{% load static %}
{% load ui_extras %}
{% load range_extras %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/character.css' %}">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
{% endblock %}

{% block content %}
<style>
  .edit-pill {
  border: 0; background: transparent; padding: 0 .25rem; font-size: .85rem;
  color: #6c757d; cursor: pointer;
}
.edit-pill:hover { color: #0d6efd; text-decoration: underline; }

  .summernote-content p{ margin-bottom:.5rem; }
  .summernote-content ul, .summernote-content ol{ padding-left:1.25rem; margin-bottom:.5rem; }
  .summernote-content h1,.summernote-content h2,.summernote-content h3,
  .summernote-content h4,.summernote-content h5,.summernote-content h6{
    margin: .75rem 0 .5rem;
    font-size: inherit; font-weight: 600;
  }
  table tbody tr.is-active { outline: 2px solid #0d6efd; }
  #general-feats-table tbody tr.is-selected { background: #fff9db; }
  #general-feats-table tbody tr.is-active   { outline: 2px solid #0d6efd; }

  #asi-table tbody tr.table-warning { background: #fff9db; }
  #asi-table tbody tr.table-success { background: #e6ffed; }

  #skills-table { min-width: 720px; }
  #skills-table th, #skills-table td { white-space: nowrap; }
  #skills-table td:first-child { min-width: 220px; }
</style>

<div class="container my-4">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ character.name }}</h1>
    <div>
      <button
        class="btn btn-primary me-2"
        data-bs-toggle="modal"
        data-bs-target="#levelUpModal"
      >Level Up</button>
      <a
        href="{% url 'characters:level_down' character.pk %}"
        class="btn btn-danger {% if character.level == 0 %}disabled{% endif %}"
      >Level Down</a>
    </div>
  </div>

  <div class="row g-4">
    <!-- LEFT: Basics + Ability Scores + quick finals -->
    <aside class="col-lg-3">
      <div class="position-sticky" style="top: 1rem;">
        <!-- Basics -->
        <div class="card p-3 mb-3">
          <h5 class="mb-2">Basics</h5>
          <div><strong>Name:</strong> {{ character.name }}</div>
          <div><strong>Race:</strong> {{ character.race|default:"—" }}</div>
          <div><strong>Subrace:</strong> {{ subrace_name|default:"—" }}</div>
          <div><strong>Level:</strong> {{ total_level }}</div>
          <div><strong>Campaign:</strong> {{ character.campaign|default:"—" }}</div>
          <div class="mt-2"><strong>Classes:</strong>
            <ul class="mb-0">
              {% for cp in class_progress %}
                <li>{{ cp.character_class.name }} L{{ cp.levels }}</li>
              {% empty %}
                <li>—</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Ability Scores -->
        <div class="card mb-3">
          <div class="card-header fw-bold">Ability Scores</div>
          <div class="card-body p-0">
            <table class="table mb-0">
              <thead>
                <tr><th>Ability</th><th class="text-end">Score</th><th class="text-end">Mod</th></tr>
              </thead>
              <tbody>
                {% for a in abilities %}
                  <tr>
                    <td>{{ a.label }}</td>
                    <td class="text-end">{{ a.score }}</td>
                    <td class="text-end">{{ a.mod_str }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Quick finals -->
<div class="card">
  <div class="card-header fw-bold">Core Stats</div>
  <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="mb-0">
    {% csrf_token %}
    <ul class="list-group list-group-flush">

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>HP</span>
        <span class="d-flex align-items-center gap-2">
          <input name="HP" type="number" class="form-control form-control-sm" style="width:90px"
                 value="{{ hp_current }}" min="0">
          <span>/</span>
          <input name="hp_max" type="number" class="form-control form-control-sm" style="width:90px"
                 value="{{ hp_max }}" min="0">
        </span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Temp HP</span>
        <span class="d-flex align-items-center gap-2">
          <input name="temp_HP" type="number" class="form-control form-control-sm" style="width:90px"
                 value="{{ temp_hp|default:0 }}" min="0">
        </span>
      </li>

      <li class="list-group-item d-flex justify-content-end">
        <button class="btn btn-sm btn-primary" name="save_core_stats_submit" value="1">Save</button>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Armor</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.armor_total }}</strong>
          <button class="btn btn-xs btn-outline-secondary edit-override" data-key="prof:armor" type="button">✎</button>
        </span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Dodge</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.dodge_total }}</strong>
          <button class="btn btn-xs btn-outline-secondary edit-override" data-key="prof:dodge" type="button">✎</button>
        </span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Reflex</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.reflex_total }}</strong>
          <button class="btn btn-xs btn-outline-secondary edit-override" data-key="prof:reflex" type="button">✎</button>
        </span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Fortitude</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.fortitude_total }}</strong>
          <button class="btn btn-xs btn-outline-secondary edit-override" data-key="prof:fortitude" type="button">✎</button>
        </span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Will</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.will_total }}</strong>
          <button class="btn btn-xs btn-outline-secondary edit-override" data-key="prof:will" type="button">✎</button>
        </span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Perception</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.perception_total }}</strong>
          <button class="btn btn-xs btn-outline-secondary edit-override" data-key="prof:perception" type="button">✎</button>
        </span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Spell/DC</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ spell_dc_main|default:"—" }}</strong>
          <button class="btn btn-xs btn-outline-secondary edit-override" data-key="prof:dc" type="button">✎</button>
        </span>
      </li>
    </ul>
  </form>
</div>



      </div>
    </aside>

    <!-- RIGHT: tabs + panes -->
    <main class="col-lg-9">
      <!-- ONE set of tabs only -->
      <ul class="nav nav-tabs" id="sheetTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-details" type="button">Details</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-combat"  type="button">Combat</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-skills"  type="button">Skills</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-feats"   type="button">Feats</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-active"       type="button">Active</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-passive"      type="button">Passive</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-all"          type="button">All</button></li>
{% if show_spellcasting_tab %}
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-spellcasting" type="button">Spellcasting</button></li>
{% endif %}
      </ul>

      <div class="tab-content pt-3">
        <!-- DETAILS TAB -->
        <div class="tab-pane fade show active" id="tab-details">
<div class="d-flex align-items-center justify-content-between mb-2">
  <h5 class="mb-0">Details</h5>
  {% if can_edit %}
    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#detailsEdit">
      ✎ Edit
    </button>
  {% endif %}
</div>

{% if can_edit %}
  {{ details_form.media }}
  <div id="detailsEdit" class="collapse">
    <form method="post" novalidate>
      {% csrf_token %}
      {{ details_form.non_field_errors }}

      {% for field in details_form.visible_fields %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          <input class="form-control form-control-sm mt-1"
                 name="note__{{ field.name }}"
                 placeholder="Reason (required if changed)">
        </div>
      {% endfor %}

      <button type="submit" name="update_details_submit" class="btn btn-primary">
        Save Details
      </button>
    </form>
  </div>
{% endif %}

{# Always show the read view below; the edit form above is collapsed #}
<div class="mb-4"><h6>Backstory</h6><div class="summernote-view">{{ character.backstory|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Worshipped Gods</h6><div class="summernote-view">{{ character.worshipped_gods|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Believers and ideals</h6><div class="summernote-view">{{ character.believers_and_ideals|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Iconic (Strength)</h6><div class="summernote-view">{{ character.iconic_strengths|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Iconic (Flaws)</h6><div class="summernote-view">{{ character.iconic_flaws|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Bonds/Relationship</h6><div class="summernote-view">{{ character.bonds_relationships|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Ties and Connections</h6><div class="summernote-view">{{ character.ties_connections|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Outlook</h6><div class="summernote-view">{{ character.outlook|safe|default:"—" }}</div></div>

        </div>

        <!-- COMBAT TAB -->
        <div class="tab-pane fade" id="tab-combat">
          <div class="row g-3">
            <!-- Defense -->
            <div class="col-md-5">
              <div class="card h-100">
                <div class="card-header fw-bold">Defense</div>
                <ul class="list-group list-group-flush">
<li class="list-group-item d-flex justify-content-between"><span>Armor</span><span class="fw-bold">{{ derived.armor_total }}</span></li>
                  <li class="list-group-item d-flex justify-content-between"><span>Dodge</span><span class="fw-bold">{% for r in proficiency_detailed %}{% if r.type == "Dodge" %}{{ r.total_s }}{% endif %}{% endfor %}</span></li>
                  <li class="list-group-item d-flex justify-content-between"><span>Reflex</span><span class="fw-bold">{% for r in proficiency_detailed %}{% if r.type == "Reflex" %}{{ r.total_s }}{% endif %}{% endfor %}</span></li>
                  <li class="list-group-item d-flex justify-content-between"><span>Fortitude</span><span class="fw-bold">{% for r in proficiency_detailed %}{% if r.type == "Fortitude" %}{{ r.total_s }}{% endif %}{% endfor %}</span></li>
                  <li class="list-group-item d-flex justify-content-between"><span>Will</span><span class="fw-bold">{% for r in proficiency_detailed %}{% if r.type == "Will" %}{{ r.total_s }}{% endif %}{% endfor %}</span></li>
                </ul>
                <div class="card-body">
                  <form class="d-flex flex-wrap gap-2 align-items-center"
                        method="post" action="{% url 'characters:set_armor_choice' character.pk %}">
                    {% csrf_token %}
                    <label class="me-2 fw-semibold">Armor:</label>
                    <select name="armor_id" class="form-select form-select-sm" style="max-width: 320px">
                      <option value="">— No armor —</option>
                      {% for a in armor_list %}
                        <option value="{{ a.id }}" {% if selected_armor and selected_armor.id == a.id %}selected{% endif %}>
                          {{ a.name }} (+{{ a.armor_value }})
                        </option>
                      {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-outline-primary">Save</button>
                    {% if selected_armor %}
                      <span class="text-muted ms-2">Equipped: {{ selected_armor.name }}</span>
                    {% endif %}
                  </form>
                </div>
              </div>
            </div>
<div class="card-body pt-0">
  <h6 class="mt-2 mb-2">Breakdown</h6>
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Type</th>
          <th>Tier</th>
          <th>Formula</th>
          <th>Values</th>
          <th>Total</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody>
        {% for r in defense_rows %}
          <tr id="row-{{ r.type|slugify }}">
            <td>{{ r.type }}</td>
            <td class="text-muted">{{ r.tier }}</td>
            <td class="text-muted">{{ r.formula }}</td>
            <td>{{ r.values }}</td>
            <td class="fw-semibold">{{ r.total_s }}</td>
            <td>
  {% note_icon "defense:"|add:r.type %}
  <button class="btn btn-xs btn-outline-secondary ms-2 edit-override" data-key="prof:{{ r.code }}" type="button">✎</button>
</td>

          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

            <!-- Offense -->
            <div class="col-md-7">
              <div class="card h-100">
                <div class="card-header fw-bold">Offense</div>
                <div class="card-body">
{% if spell_dc_rows and spell_dc_rows.0 %}
  <div class="mb-3">
    <div><strong>Spell/DC:</strong> {{ spell_dc_rows.0.total }}</div>
    <div class="table-responsive mt-2">
      <table class="table table-sm align-middle w-auto">
        <thead>
          <tr><th>Type</th><th>Formula</th><th>Values</th><th>Total</th><th>Note</th></tr>
        </thead>
        <tbody>
          {% for s in spell_dc_rows %}
            <tr>
              <td>{{ s.label }}</td>
              <td class="text-muted">{{ s.formula }}</td>
              <td>{{ s.values }}</td>
              <td class="fw-semibold">{{ s.total }}</td>
              <td>{% note_icon "dc:"|add:s.label %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

                  <!-- 3 weapon slots (AJAX equip) -->
                  <form class="row g-2 align-items-end mb-2">
                    <div class="col-sm-6">
                      <label class="form-label">Primary Weapon</label>
                      <select class="form-select form-select-sm wep-select" data-slot="1">
                        <option value="">— none —</option>
                        {% if weapons_list %}{% for w in weapons_list %}<option value="{{ w.id }}">{{ w.name }} ({{ w.damage }})</option>{% endfor %}{% endif %}
                      </select>
                    </div>
                    <div class="col-sm-6">
                      <label class="form-label">Secondary Weapon</label>
                      <select class="form-select form-select-sm wep-select" data-slot="2">
                        <option value="">— none —</option>
                        {% if weapons_list %}{% for w in weapons_list %}<option value="{{ w.id }}">{{ w.name }} ({{ w.damage }})</option>{% endfor %}{% endif %}
                      </select>
                    </div>
                    <div class="col-sm-6">
                      <label class="form-label">Tertiary Weapon</label>
                      <select class="form-select form-select-sm wep-select" data-slot="3">
                        <option value="">— none —</option>
                        {% if weapons_list %}{% for w in weapons_list %}<option value="{{ w.id }}">{{ w.name }} ({{ w.damage }})</option>{% endfor %}{% endif %}
                      </select>
                    </div>
                  </form>

                  {% if attacks_detailed %}
                    <div class="table-responsive">
                      <table class="table table-sm align-middle">
                        <thead><tr><th>Slot</th><th>Weapon</th><th>Traits</th><th>Hit</th><th>Damage</th></tr></thead>
                        <tbody>
                          {% for a in attacks_detailed %}
                            <tr>
                              <td>{{ a.slot }}</td>
                              <td>{{ a.name }} <small class="text-muted">{{ a.damage_die }}</small></td>
                              <td><small>{{ a.traits|join:", " }}</small></td>
                              <td>
                                +{{ a.hit_str }}
                                {% if a.show_choice_hit %}<small class="text-muted"> (DEX +{{ a.hit_dex }})</small>{% endif %}
                              </td>
                              <td>
                                {{ a.damage_die }}{% if a.dmg_str >= 0 %}+{% endif %}{{ a.dmg_str }}
                                {% if a.show_choice_dmg %}<small class="text-muted"> (DEX {% if a.dmg_dex >= 0 %}+{% endif %}{{ a.dmg_dex }})</small>{% endif %}
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <h6 class="mb-2">Attacks</h6>
                    <table class="table table-sm align-middle">
                      <thead><tr><th>Type</th><th>Formula</th><th>Values</th><th>Total</th></tr></thead>
                      <tbody>
                        {% for a in attack_rows %}
                          <tr><td>{{ a.label }}</td><td class="text-muted">{{ a.formula }}</td><td>{{ a.values }}</td><td class="fw-semibold">{{ a.total_s }}</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  {% endif %}
                </div>
              </div>
              <hr class="my-3">
<h6 class="mb-2">Martial Mastery</h6>
<div class="mb-2">
  <strong>Total Points:</strong> {{ combat_blocks.martial_mastery.total_points|default:0 }}
  &nbsp;•&nbsp;
  <strong>Known Cap:</strong> {{ combat_blocks.martial_mastery.total_known_cap|default:0 }}
</div>

{% if combat_blocks.martial_mastery.known_names and combat_blocks.martial_mastery.known_names|length %}
  <div class="mb-2">
    <strong>Known:</strong>
    {% for n in combat_blocks.martial_mastery.known_names %}
      <span class="badge text-bg-secondary me-1 mb-1">{{ n }}</span>
    {% endfor %}
  </div>
{% endif %}

{% if active_passive_tab.martial_mastery_entitlement.by_feature and active_passive_tab.martial_mastery_entitlement.by_feature|length %}
  <div class="table-responsive">
    <table class="table table-sm">
      <thead><tr><th>Feature</th><th>Class</th><th>Points</th><th>Known Cap</th></tr></thead>
      <tbody>
        {% for row in active_passive_tab.martial_mastery_entitlement.by_feature %}
          <tr>
            <td>{{ row.feature_name }}</td>
            <td>{{ row.class_name }}</td>
            <td>{{ row.points }}</td>
            <td>{{ row.known_cap }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

            </div>
            
          </div>
        </div>

        <!-- SKILLS TAB -->
{# --- SKILLS TAB (minimal) --- #}
<div class="tab-pane fade" id="tab-skills">
  <div class="card p-3 mb-3">
    <h5>Skills</h5>

    {% if skill_prof_errors and skill_prof_errors|length %}
      <div class="alert alert-danger p-2">
        Please provide a reason for changing: {{ skill_prof_errors|join:", " }}.
      </div>
    {% endif %}

    <form method="post" action="{% url 'characters:character_detail' character.pk %}">
      {% csrf_token %}

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Skill</th>
              <th>Ability</th>
              <th>Tier</th>
              <th>Total</th>
              <th class="text-end" style="width:120px;">Edit</th>
            </tr>
          </thead>
          <tbody>
            {% for row in skills_rows %}
              {# display row #}
              <tr>
                <td>{{ row.label }}</td>
                <td>
                  {{ row.ability1 }}{% if row.ability2 %} / {{ row.ability2 }}{% endif %}
                </td>
                <td>
                  {{ row.prof_name }}
                  <small class="text-muted">
                    ({% if row.prof_bonus >= 0 %}+{% endif %}{{ row.prof_bonus }})
                  </small>
                </td>
                <td>
                  {% if row.total2 is not None %}
                    {% if row.total1 >= row.total2 %}{{ row.total1 }}{% else %}{{ row.total2 }}{% endif %}
                  {% else %}
                    {{ row.total1 }}
                  {% endif %}
                </td>
                <td class="text-end">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary toggle-skill-edit"
                    data-target="edit-{{ row.id_key }}"
                  >Edit</button>
                </td>
              </tr>

              {# inline editor (hidden until Edit is clicked) #}
{# inline editor (hidden until Edit is clicked) #}
<tr id="edit-{{ row.id_key }}" class="d-none">
  <td colspan="5">
    <div class="row g-2 align-items-center">
      <div class="col-md-3">
        <label class="form-label form-label-sm mb-1">Adjustment (±)</label>
        <input type="number" step="1" class="form-control form-control-sm"
               name="skadj_{{ row.id_key }}"
               value="{{ row.adjustment|default:0 }}">
        <div class="form-text">Adds to this skill’s total.</div>
      </div>
      <div class="col-md-7">
        <label class="form-label form-label-sm mb-1">Reason (required)</label>
        <input name="skadj_note_{{ row.id_key }}"
               class="form-control form-control-sm"
               placeholder="Why are you changing this?"
               required>
      </div>
      <div class="col-md-2 text-end">
        <label class="form-label form-label-sm mb-1 d-block">&nbsp;</label>
        <button class="btn btn-sm btn-primary" name="save_skill_row" value="{{ row.id_key }}">
          Save
        </button>
      </div>
    </div>
  </td>
</tr>

            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  </div>
</div>




        <!-- FEATS TAB -->
        <div class="tab-pane fade" id="tab-feats">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header fw-bold">General Feats</div>
                <table class="table table-sm mb-0">
                  <thead><tr><th style="width:70px">Level</th><th>Name</th></tr></thead>
                  <tbody>
                    {% for cf in general_feats %}
            <tr>
              <td>Lv {{ cf.level }}</td>
              <td>
                <div class="d-flex justify-content-between align-items-center">
                  <span>{{ cf.feat.name }} {% note_icon "cfeat:"|add:cf.id %}</span>
                      <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
                      <div class="d-none desc-body mt-2">
                        {% if cf.feat.description %}
                          <div class="summernote-content mb-2">{{ cf.feat.description|safe }}</div>
                        {% endif %}
                        {% with row=cf %}
                        <div class="table-responsive">
                          <table class="table table-sm table-bordered mb-0">
                            <tbody>
                              {% for k,v in row.details %}
                                <tr>
                                  <th class="text-nowrap" style="width: 180px;">{{ k }}</th>
                                  <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                        {% endwith %}
                      </div>

              </td>
            </tr>
                    {% empty %}<tr><td colspan="2" class="text-muted">— None —</td></tr>{% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header fw-bold">Class Feats</div>
                <table class="table table-sm mb-0">
                  <thead><tr><th style="width:70px">Level</th><th>Name</th></tr></thead>
                  <tbody>
                    {% for cf in class_feats %}
<tr>
  <td>Lv {{ cf.level }}</td>
  <td>
    <div class="d-flex justify-content-between align-items-center">
      <span>{{ cf.feat.name }} {% note_icon "cfeat:"|add:cf.id %}</span>
      <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
    </div>
    <div class="d-none desc-body mt-2">
      {% if cf.feat.description %}
        <div class="summernote-content mb-2">{{ cf.feat.description|safe }}</div>
      {% endif %}
      {% with row=cf %}
      <div class="table-responsive">
        <table class="table table-sm table-bordered mb-0">
          <tbody>
            {% for k,v in row.details %}
              <tr>
                <th class="text-nowrap" style="width: 180px;">{{ k }}</th>
                <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endwith %}
    </div>
  </td>
</tr>

                    {% empty %}<tr><td colspan="2" class="text-muted">— None —</td></tr>{% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>


<script>
  // Simple switcher: show the relevant select for the chosen kind
  (function(){
    const kindSel = document.getElementById("id_kind");
    if (!kindSel) return;
    function flip(){
      const v = (kindSel.value || "").toLowerCase();
      document.getElementById("mf-feat").classList.toggle("d-none", v !== "feat");
      document.getElementById("mf-classfeature").classList.toggle("d-none", v !== "class_feature");
      document.getElementById("mf-racialfeature").classList.toggle("d-none", v !== "racial_feature");
    }
    kindSel.addEventListener("change", flip);
    flip();
  })();
</script>


        <!-- ACTIVE/PASSIVE TAB -->
<!-- ACTIVE TAB -->
<div class="tab-pane fade" id="tab-active">
  <div class="card p-3">
    <h5 class="mb-3">Active Abilities</h5>
    {% if active_rows %}
<ul class="list-group">
  {% for r in active_rows %}
    <li class="list-group-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          {{ r.label }}
          {% if r.meta %}<small class="text-muted">— {{ r.meta }}</small>{% endif %}
          {% note_icon r.note_key %}
        </div>
        <div class="d-flex align-items-center gap-2">
          <input class="form-control form-control-sm act-note" placeholder="Note (optional)">
          <button class="btn btn-sm btn-outline-success toggle-activation"
                  data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="1">Active</button>
          <button class="btn btn-sm btn-outline-secondary toggle-activation"
                  data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="0">Set Passive</button>
          <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
        </div>
      </div>
      <div class="d-none desc-body mt-2">
        {% if r.desc %}
          <div class="summernote-content mb-2">{{ r.desc|safe }}</div>
        {% endif %}
        <div class="table-responsive">
          <table class="table table-sm table-bordered mb-0">
            <tbody>
              {% for k,v in r.details %}
                <tr>
                  <th class="text-nowrap" style="width:180px;">{{ k }}</th>
                  <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </li>
  {% endfor %}
</ul>

    {% else %}
      <p class="mb-0 text-muted">None marked Active.</p>
    {% endif %}
  </div>
  <div class="card p-3 mt-3">
  <h5 class="mb-3">Martial Mastery</h5>

  <div class="mb-2">
    <strong>Total Points:</strong> {{ active_passive_tab.martial_mastery_entitlement.total_points|default:0 }}
    &nbsp;•&nbsp;
    <strong>Known Cap:</strong> {{ active_passive_tab.martial_mastery_entitlement.total_known_cap|default:0 }}
  </div>

  {% if active_passive_tab.martial_mastery_entitlement.by_feature and active_passive_tab.martial_mastery_entitlement.by_feature|length %}
    <div class="table-responsive">
      <table class="table table-sm">
        <thead><tr><th>Feature</th><th>Class</th><th>Points</th><th>Known Cap</th></tr></thead>
        <tbody>
          {% for row in active_passive_tab.martial_mastery_entitlement.by_feature %}
            <tr>
              <td>{{ row.feature_name }}</td>
              <td>{{ row.class_name }}</td>
              <td>{{ row.points }}</td>
              <td>{{ row.known_cap }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

  {% if active_passive_tab.masteries and active_passive_tab.masteries|length %}
    <div class="mt-2">
      <strong>Known:</strong>
      {% for m in active_passive_tab.masteries %}
        <span class="badge text-bg-secondary me-1 mb-1">{{ m.mastery.name }}</span>
      {% endfor %}
    </div>
  {% endif %}
</div>

</div>

<!-- PASSIVE TAB -->
<div class="tab-pane fade" id="tab-passive">
  <div class="card p-3">
    <h5 class="mb-3">Passive Abilities</h5>
    {% if passive_rows %}
      <ul class="list-group">
        {% for r in passive_rows %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              {{ r.label }}
              {% if r.meta %}<small class="text-muted">— {{ r.meta }}</small>{% endif %}
              {% note_icon r.note_key %}
            </div>
            <div class="d-flex align-items-center gap-2">
              <input class="form-control form-control-sm act-note" placeholder="Note (optional)">
              <button class="btn btn-sm btn-outline-primary toggle-activation"
                      data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="1">Set Active</button>
              <button class="btn btn-sm btn-outline-secondary toggle-activation"
                      data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="0">Passive</button>
            </div>
            <div class="d-none desc-body mt-2">
  {% if r.desc %}
    <div class="summernote-content mb-2">{{ r.desc|safe }}</div>
  {% endif %}
  <div class="table-responsive">
    <table class="table table-sm table-bordered mb-0">
      <tbody>
        {% for k,v in r.details %}
          <tr>
            <th class="text-nowrap" style="width:180px;">{{ k }}</th>
            <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">None marked Passive.</p>
    {% endif %}
  </div>
</div>

<!-- ALL TAB -->
<!-- ALL TAB -->
<div class="tab-pane fade" id="tab-all">
  <div class="card p-3">
    <h5 class="mb-3">All Abilities</h5>
    {% if all_rows %}
      <ul class="list-group">
        {% for r in all_rows %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                {{ r.label }}
                {% if r.meta %}<small class="text-muted">— {{ r.meta }}</small>{% endif %}
                {% note_icon r.note_key %}
                {% if r.active %}<span class="badge text-bg-success ms-2">Active</span>{% else %}<span class="badge text-bg-secondary ms-2">Passive</span>{% endif %}
              </div>
              <div class="d-flex align-items-center gap-2">
                <input class="form-control form-control-sm act-note" placeholder="Note (optional)">
                <button class="btn btn-sm btn-outline-primary toggle-activation"
                        data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="1">Set Active</button>
                <button class="btn btn-sm btn-outline-secondary toggle-activation"
                        data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="0">Set Passive</button>
                <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
              </div>
            </div>
            <div class="d-none desc-body mt-2">
              {% if r.desc %}
                <div class="summernote-content mb-2">{{ r.desc|safe }}</div>
              {% endif %}
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0">
                  <tbody>
                    {% for k,v in r.details %}
                      <tr>
                        <th class="text-nowrap" style="width:180px;">{{ k }}</th>
                        <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">—</p>
    {% endif %}
  </div>

  <!-- Manually Add Item (moved here) -->
  <div class="card mt-3">
    <div class="card-header fw-bold">Manually Add Item</div>
    <div class="card-body">
      {% if manual_form %}
        <form method="post" action="{% url 'characters:character_detail' character.pk %}">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-3">
              {{ manual_form.kind.label_tag }} {{ manual_form.kind }}
            </div>
            <div class="col-md-3" id="mf-feat">
              {{ manual_form.feat.label_tag }} {{ manual_form.feat }}
            </div>
            <div class="col-md-3 d-none" id="mf-classfeature">
              {{ manual_form.class_feature.label_tag }} {{ manual_form.class_feature }}
            </div>
            <div class="col-md-3 d-none" id="mf-racialfeature">
              {{ manual_form.racial_feature.label_tag }} {{ manual_form.racial_feature }}
            </div>
            <div class="col-12">
              {{ manual_form.reason.label_tag }} {{ manual_form.reason }}
            </div>
          </div>
          <button class="btn btn-primary mt-2" name="manual_add_submit" value="1">Add</button>
        </form>
        {% if manual_form.errors %}
          <div class="alert alert-danger mt-2 mb-0">
            {{ manual_form.errors }}
          </div>
        {% endif %}
      {% else %}
        <p class="mb-0 text-muted">You don’t have permission to add items.</p>
      {% endif %}
    </div>
  </div>
</div>


<!-- SPELLCASTING TAB (single, consolidated) -->
{% if show_spellcasting_tab %}
<div class="tab-pane fade" id="tab-spellcasting">
  {% for b in spell_selection_blocks %}
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ b.class_name }}</strong>
          <span class="text-muted">• {{ b.origin|default:"—" }}</span>
        </div>
        <div class="small text-muted">
          Cantrips: {{ b.known_cantrips_current }}/{{ b.cantrips_max }} |
          Known (≥1): {{ b.known_leveled_current }}{% if b.known_max is not None %}/{{ b.known_max }}{% endif %} |
          Prepared: {{ b.prepared_current }}{% if b.prepared_max is not None %}/{{ b.prepared_max }}{% endif %}
        </div>
      </div>
      <div class="card-body">

        {# 1) SHOW PREPARED SPELLS (by rank) #}
        <h6 class="mb-2">Prepared Spells</h6>
      {% for r, rows in b.prepared_rows_by_rank.items %}
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div class="fw-semibold">Rank {{ r }}</div>
            <div class="small text-muted">
              Slots {{ b.slots_by_rank|get_item:r|default:0 }}
              • Remaining {{ b.prepared_remaining_by_rank|get_item:r|default:0 }}
            </div>
          </div>
{% with prep_id="prep-table-"|add:b.feature_id|stringformat:"s"|add:"-r"|add:r|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=prep_id rows=rows feature_id=b.feature_id action="unprepare" rank=r  %}
{% endwith %}
        </div>
      {% endfor %}


        {# 2) SELECT PREPARED SPELLS FROM KNOWN (by rank) #}
        <h6 class="mt-4 mb-2">Prepare from Known</h6>
        {% for pair in b.known_for_prepare_by_rank.items %}

          {% with r=pair.0 rows=pair.1 %}
            <div class="mb-3">
              <div class="fw-semibold mb-1">Rank {{ r }}</div>
{% with kp_id="knownprep-table-"|add:b.feature_id|stringformat:"s"|add:"-r"|add:r|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=kp_id rows=rows feature_id=b.feature_id action="prepare" rank=r  %}
{% endwith %}
            </div>
          {% endwith %}
        {% endfor %}

        {# 3) SPELL TABLE TO SELECT KNOWN SPELL (by rank > 0) #}
        <h6 class="mt-4 mb-2">Learn New Spells (Leveled)</h6>
        {% for pair in b.learn_spells_by_rank.items %}

          {% with r=pair.0 rows=pair.1 %}
            <div class="mb-3">
              <div class="fw-semibold mb-1">Rank {{ r }}</div>
{% with learn_id="learn-table-"|add:b.feature_id|stringformat:"s"|add:"-r"|add:r|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=learn_id rows=rows feature_id=b.feature_id action="learn_known" rank=r  %}
{% endwith %}

            </div>
          {% endwith %}
        {% endfor %}

        {# 4) SHOW KNOWN CANTRIPS #}
        <h6 class="mt-4 mb-2">Known Cantrips</h6>
{% with known_c_id="learned-cantrips-"|add:b.feature_id|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=known_c_id rows=b.learned_cantrips_rows feature_id=b.feature_id action="unlearn_cantrip" is_cantrip=True  %}
{% endwith %}


        {# 5) SPELL TABLE TO SELECT KNOWN CANTRIP #}
        <h6 class="mt-4 mb-2">Learn New Cantrips</h6>
{% with can_id="cantrips-table-"|add:b.feature_id|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=can_id rows=b.learn_cantrip_rows feature_id=b.feature_id action="learn_cantrip" is_cantrip=True  %}
{% endwith %}


        {# (Optional) quick numeric cap adjustment UI you already wired in views as 'adjust_caps' #}
        {% if can_edit %}
        {% if can_edit %}
  <details class="mt-2">
    <summary>Edit formulas (advanced)</summary>
    <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2 mt-2">
      {% csrf_token %}
      <input type="hidden" name="spells_op" value="adjust_formulas">
      <input type="hidden" name="feature_id" value="{{ b.feature_id }}">
      <div class="col-md-4">
        <label class="form-label form-label-sm">Cantrips formula</label>
        <input class="form-control form-control-sm" name="f_cantrips" placeholder="{{ b.cantrips_formula }}">
        <div class="form-text">Leave blank to remove override</div>
      </div>
      <div class="col-md-4">
        <label class="form-label form-label-sm">Known formula</label>
        <input class="form-control form-control-sm" name="f_known" placeholder="{{ b.spells_known_formula|default:'—' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label form-label-sm">Prepared formula</label>
        <input class="form-control form-control-sm" name="f_prepared" placeholder="{{ b.spells_prepared_formula|default:'—' }}">
      </div>
      <div class="col-md-9">
        <label class="form-label form-label-sm">Reason (required)</label>
        <input class="form-control form-control-sm" name="note" required>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-sm btn-outline-primary w-100">Save</button>
      </div>
    </form>
  </details>
{% endif %}

          <div class="mt-4">
            <details>
              <summary class="mb-2">Adjust numeric caps </summary>
              <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2">
                {% csrf_token %}
                <input type="hidden" name="spells_op" value="adjust_caps">
                <input type="hidden" name="feature_id" value="{{ b.feature_id }}">
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Cantrips</label>
                  <input class="form-control form-control-sm" name="cap_cantrips" type="number" placeholder="{{ b.cantrips_max }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Known</label>
                  <input class="form-control form-control-sm" name="cap_known" type="number" placeholder="{{ b.known_max|default:'—' }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Prepared</label>
                  <input class="form-control form-control-sm" name="cap_prepared" type="number" placeholder="{{ b.prepared_max|default:'—' }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label form-label-sm">Reason (required)</label>
                  <input class="form-control form-control-sm" name="note" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button class="btn btn-sm btn-outline-primary w-100">Save</button>
                </div>
              </form>
            </details>
          </div>
        {% endif %}

      </div>
    </div>







    </div>
  {% endfor %}

</div>
{% endif %} <!-- /.tab-content -->
</div>
    </main>
  </div> <!-- /.row -->
</div> <!-- /.container -->

{# ======= MODALS (unchanged except for context vars already provided) ======= #}

<!-- LEVEL UP MODAL -->
<div class="modal fade" id="levelUpModal" tabindex="-1" aria-labelledby="levelUpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="levelUpModalLabel" class="modal-title">Level Up to {{ total_level|add:"1" }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="modal-body p-0">
          <div class="row g-0">
            <!-- LEFT column: class info / preview -->
            <div class="col-12 col-xl-5 p-4 border-end">
              <form method="get"
                    action="{% url 'characters:character_detail' character.pk %}#levelUpModal"
                    class="mb-4">
                {{ form.base_class }}
              </form>

              <div class="mb-3">
                <h6 class="mb-2">Description</h6>
                {% if preview_class.description %}
                  <div class="text-muted summernote-content">{{ preview_class.description|safe }}</div>
                {% else %}
                  <div class="text-muted"><em>—</em></div>
                {% endif %}
              </div>

              <div class="mb-3 small text-muted">
                <div><strong>Hit Die:</strong> d{{ preview_class.hit_die }}</div>
                <div>
                  <strong>Key Abilities:</strong>
                  {% for a in preview_class.key_abilities.all %}
                    {{ a.name }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </div>
              </div>

              <div class="mb-3">
                <h6 class="mb-2">Proficiencies</h6>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Type</th>
                        {% for tn in tier_names %}<th>{{ tn }}</th>{% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in proficiency_rows %}
                        <tr>
                          <td>{{ row.type }}</td>
                          {% for lvl in row.levels %}
                            <td>{{ lvl }}</td>
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="mb-3">
                <h6 class="mb-2">Features at L{{ total_level|add:"1" }}</h6>
                <ul class="mb-0 ps-3">
                  {% for f in auto_feats %}
                    <li class="mb-2">
                      {% if f.kind == "spell_table" and f.spell_row_next %}
                        <div class="table-responsive mt-2">
                          <table class="table table-sm table-bordered w-auto">
                            <thead>
                              <tr>
                                <th class="text-nowrap">Level</th>
                                {% for _ in "0123456789"|make_list %}<th>{{ forloop.counter }}</th>{% endfor %}
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td class="text-nowrap">Slots</td>
                                <td>{{ f.spell_row_next.slot1 }}</td>
                                <td>{{ f.spell_row_next.slot2 }}</td>
                                <td>{{ f.spell_row_next.slot3 }}</td>
                                <td>{{ f.spell_row_next.slot4 }}</td>
                                <td>{{ f.spell_row_next.slot5 }}</td>
                                <td>{{ f.spell_row_next.slot6 }}</td>
                                <td>{{ f.spell_row_next.slot7 }}</td>
                                <td>{{ f.spell_row_next.slot8 }}</td>
                                <td>{{ f.spell_row_next.slot9 }}</td>
                                <td>{{ f.spell_row_next.slot10 }}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      {% endif %}

                      <div class="mt-2">
                        {% include "partials/_feature_detail.html" with f=f %}
                      </div>
                    </li>
                  {% empty %}
                    <li><em>None</em></li>
                  {% endfor %}
                </ul>
              </div>
            </div> <!-- /LEFT -->

            <div class="col-12 col-xl-7 p-4"><!-- RIGHT: form -->
              <form method="post" action="{% url 'characters:character_detail' character.pk %}">
                {% csrf_token %}

                <input type="hidden" name="base_class" value="{{ form.base_class.value }}">

                {% if form.general_feat %}
                  <div class="mb-3">
                    <label class="form-label">{{ form.general_feat.label }}</label>
                    <input type="text" id="general-feat-filter" class="form-control mb-2" placeholder="Filter feats…">
                    <table id="general-feats-table" class="table table-bordered">
                      <thead>
                        <tr>
                          <th></th>
                          <th data-sort="1">Feat</th>
                          <th data-sort="2">Description</th>
                          <th data-sort="3">Level</th>
                          <th data-sort="4">
                            Requirements
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                          <th data-sort="5">
                            Tags
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="5" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for feat in form.general_feat.field.queryset %}
                          <tr>
                            <td>
                              <input
                                type="radio"
                                name="{{ form.general_feat.html_name }}"
                                value="{{ feat.pk }}"
                                {% if form.general_feat.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                                {% if form.general_feat.field.required %}required{% endif %}
                              >
                            </td>
                            <td class="feat-name">{{ feat.name }}</td>
                            <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
                            <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                            <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                            <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    {% for err in form.general_feat.errors %}
                      <div class="text-danger">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if form.asi_mode %}
                  <div class="mb-4">
                    <label class="form-label d-block">Ability Score Increase</label>

                    <input type="hidden" name="{{ form.asi_mode.html_name }}" id="id_asi_mode" value="{{ form.asi_mode.value|default:'' }}">
                    <input type="hidden" name="{{ form.asi_a.html_name }}"    id="id_asi_a"    value="{{ form.asi_a.value|default:'' }}">
                    <input type="hidden" name="{{ form.asi_b.html_name }}"    id="id_asi_b"    value="{{ form.asi_b.value|default:'' }}">

                    <div class="table-responsive">
                      <table class="table table-bordered align-middle" id="asi-table">
                        <thead>
                          <tr>
                            <th>Ability</th>
                            <th>Current</th>
                            <th>+1</th>
                            <th>+1</th>
                            <th>Result</th>
                          </tr>
                        </thead>
                        <tbody>
                        {% for label,val in ability_map.items %}
                          {% with key=label|lower %}
                          <tr data-key="{{ key }}" data-base="{{ val }}">
                            <td class="fw-semibold">{{ label }}</td>
                            <td class="asi-current">{{ val }}</td>
                            <td class="text-center">
                              <input type="checkbox" class="form-check-input asi-slot" data-slot="A" aria-label="+1 Slot A to {{ label }}">
                            </td>
                            <td class="text-center">
                              <input type="checkbox" class="form-check-input asi-slot" data-slot="B" aria-label="+1 Slot B to {{ label }}">
                            </td>
                            <td class="asi-result">{{ val }}</td>
                          </tr>
                          {% endwith %}
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>

                    <div class="small" id="asi-help"></div>
                    <div class="small mt-2"><strong>Preview:</strong> <span id="asi-preview">—</span></div>

                    {% for err in form.non_field_errors %}
                      <div class="text-danger mt-2">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if form.class_feat_pick %}
                  <div class="mb-4">
                    <label class="form-label">{{ form.class_feat_pick.label }}</label>
                    <input type="text" id="class-feat-filter" class="form-control mb-2" placeholder="Filter feats…">

                    <table id="class-feats-table" class="table table-bordered">
                      <thead>
                        <tr>
                          <th></th>
                          <th data-sort="1">Feat</th>
                          <th data-sort="2">Description</th>
                          <th data-sort="3">Level</th>
                          <th data-sort="4">
                            Requirements
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                          <th data-sort="5">
                            Tags
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="5" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for feat in form.class_feat_pick.field.queryset %}
                          <tr>
                            <td>
                              <input
                                type="radio"
                                name="{{ form.class_feat_pick.html_name }}"
                                value="{{ feat.pk }}"
                                {% if form.class_feat_pick.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                                {% if form.class_feat_pick.field.required %}required{% endif %}
                              >
                            </td>
                            <td class="feat-name">{{ feat.name }}</td>
                            <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
                            <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                            <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                            <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                          </tr>
                        {% empty %}
                          <tr>
                            <td colspan="6" class="text-muted"><em>No class feats meet your current class/level filters.</em></td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>

                    {% for err in form.class_feat_pick.errors %}
                      <div class="text-danger">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                {# === FEATURE FIELDS LOOP === #}
                {% for item in feature_fields %}
                  {% if item.kind == "subclass_choice" %}
                    <div class="mb-4">
                      <label class="form-label d-block">{{ item.label }}</label>
                      <div class="d-grid gap-2">
                        {% for sc in item.group.subclasses.all %}
                          {% with rid=item.field.id_for_label|add:"_"|add:sc.pk|stringformat:"s" %}
                          <label for="{{ rid }}" class="border rounded p-3 d-flex gap-3 align-items-start">
                            <input
                              type="radio"
                              id="{{ rid }}"
                              name="{{ item.field.name }}"
                              value="{{ sc.pk }}"
                              class="form-check-input mt-1"
                              {% if item.field.value|stringformat:"s" == sc.pk|stringformat:"s" %}checked{% endif %}
                              {% if item.field.field.required %}required{% endif %}
                            />
                            <div class="flex-grow-1">
                              <div class="fw-semibold">{{ sc.name }}</div>
                              {% if sc.description %}
                                <div class="small text-muted mt-1 summernote-content">{{ sc.description|safe }}</div>
                              {% endif %}
                              {% if sc.feats_next %}
                                <div class="small mt-2">
                                  <div class="fw-semibold mb-1">Features at L{{ total_level|add:"1" }}:</div>
                                  <div class="d-grid gap-2">
                                    {% for f in sc.feats_next %}
                                      <div class="border rounded p-2">
                                        {% include "partials/_feature_detail.html" with f=f %}
                                      </div>
                                    {% endfor %}
                                  </div>
                                </div>
                              {% endif %}
                            </div>
                          </label>
                          {% endwith %}
                        {% empty %}
                          <div class="text-muted"><em>No subclasses available.</em></div>
                        {% endfor %}
                      </div>
                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>

                  {% elif item.kind == "option" %}
                    <div class="mb-4">
                      <div class="mb-2 fw-semibold">{{ item.label }}</div>
                      <div class="border rounded p-3 mb-3">
                        {% include "partials/_feature_detail.html" with f=item.feature %}
                      </div>

                      <div class="d-grid gap-2">
                        {% for opt in item.feature.options.all %}
                          {% with radio_id=item.field.id_for_label|add:"_"|add:opt.pk|stringformat:"s" %}
                          <label for="{{ radio_id }}" class="border rounded p-3 d-flex gap-3 align-items-start">
                            <input
                              type="radio"
                              id="{{ radio_id }}"
                              name="{{ item.field.name }}"
                              value="{{ opt.pk }}"
                              class="form-check-input mt-1"
                              {% if item.field.value|stringformat:"s" == opt.pk|stringformat:"s" %}checked{% endif %}
                              {% if item.field.field.required %}required{% endif %}
                            />
                            <div class="flex-grow-1">
                              <div class="fw-semibold">{{ opt.label }}</div>
                              {% if opt.grants_feature %}
                                <div class="mt-2">
                                  {% include "partials/_feature_detail.html" with f=opt.grants_feature %}
                                </div>
                              {% endif %}
                            </div>
                          </label>
                          {% endwith %}
                        {% endfor %}
                      </div>

                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>

                  {% elif item.kind == "gain_subclass_feat" %}
                    <div class="mb-4">
                      <div class="mb-2 fw-semibold">{{ item.label }}</div>

                      {% if item.system == "linear" and not item.subclass %}
                        <div class="alert alert-warning p-2">Pick a subclass above …</div>
                      {% endif %}
                      {% if item.system == "linear" %}
                        <div class="alert alert-info p-2">
                          Linear progression: the following {{ item.group.name }} feature(s) are granted automatically.
                        </div>
                      {% endif %}

                      <div class="d-grid gap-2">
                        {% with selected_vals=item.field.value %}
                          {% for f in item.eligible %}
                            {% with cid=item.field.id_for_label|add:"_"|add:f.pk|stringformat:"s" %}
                            <label for="{{ cid }}" class="border rounded p-3 d-flex gap-3 align-items-start">
                              {% if item.system == "linear" %}
                                <input type="checkbox" id="{{ cid }}" disabled checked class="form-check-input mt-1">
                              {% else %}
                                <input
                                  type="checkbox"
                                  id="{{ cid }}"
                                  name="{{ item.field.name }}"
                                  value="{{ f.pk }}"
                                  class="form-check-input mt-1"
                                  {% if selected_vals and f.pk|stringformat:"s" in selected_vals %}checked{% endif %}
                                >
                              {% endif %}
                              <div class="flex-grow-1">
                                {% include "partials/_feature_detail.html" with f=f %}
                              </div>
                            </label>
                            {% endwith %}
                          {% empty %}
                            <div class="text-muted"><em>No eligible features at this level.</em></div>
                          {% endfor %}
                        {% endwith %}
                      </div>

                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>

                  {% else %}
                    <div class="mb-3">
                      <label class="form-label">{{ item.label }}</label>
                      {{ item.field }}
                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}

                {% endfor %}
                {# === END FEATURE FIELDS LOOP === #}

                {% if form.martial_mastery %}
                  <div class="mb-3">
                    {{ form.martial_mastery.label_tag }}
                    {{ form.martial_mastery }}
                    {% for err in form.martial_mastery.errors %}
                      <div class="text-danger">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                <button type="submit" name="level_up_submit" class="btn btn-primary">
                  Confirm Level Up
                </button>
              </form>
            </div> <!-- /RIGHT form -->
          </div>
        </div>
      </div> <!-- /modal-body inner -->
    </div> <!-- /modal-body -->
  </div>
</div>
</div> <!-- /LEVEL UP MODAL -->

<!-- EDIT CHARACTER MODAL (unchanged) -->
<div class="modal fade" id="editCharacterModal" tabindex="-1" aria-labelledby="editCharacterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="editCharacterModalLabel" class="modal-title">Edit Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post" action="{% url 'characters:character_detail' character.pk %}">
        {% csrf_token %}
        <div class="modal-body">
          {% if edit_form %}
            {{ edit_form.non_field_errors }}
            <div class="row g-3">
              {% for field in edit_form.visible_fields %}
                <div class="col-md-6">
                  {{ field.label_tag }} {{ field }}
                  {% if field.errors %}
                    <div class="text-danger small">{{ field.errors|join:", " }}</div>
                  {% endif %}
                  <input class="form-control form-control-sm mt-1"
                        name="note__{{ field.name }}"
                        placeholder="Reason (required if changed)">
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="mb-0 text-muted">You don’t have permission to edit this character.</p>
          {% endif %}
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          {% if edit_form %}
            <button type="submit" class="btn btn-primary" name="edit_character_submit" value="1">Save</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>
<!-- QUICK EDIT NUMBER MODAL -->
<div class="modal fade" id="editNumberModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Adjust Value</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editNumberForm">
        <div class="modal-body">
          <input type="hidden" id="edit-key" name="key">
          <div class="mb-2">
            <label class="form-label form-label-sm">New value</label>
            <input type="number" step="1" class="form-control form-control-sm" id="edit-value" required>
          </div>
          <div>
            <label class="form-label form-label-sm">Reason</label>
            <input class="form-control form-control-sm" id="edit-note" placeholder="Why are you changing this?" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary btn-sm">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Override modal -->
<div class="modal fade" id="overrideModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Set Override</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <form id="overrideForm" method="post" action="{% url 'characters:set_field_override' character.pk %}">
      {% csrf_token %}
      <div class="modal-body">
        <input type="hidden" name="key" id="ov-key">
        <div class="mb-2">
          <label class="form-label">Value (number)</label>
          <input type="number" name="value" id="ov-val" class="form-control form-control-sm" step="1" required>
          <div class="form-text">This replaces the “prof” piece for that row.</div>
        </div>
        <div>
          <label class="form-label">Reason</label>
          <input name="note" id="ov-note" class="form-control form-control-sm" placeholder="Required" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary btn-sm" type="submit">Save</button>
      </div>
    </form>
  </div></div>
</div>

{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function(){
      if (window.location.hash === "#levelUpModal") {
        new bootstrap.Modal(document.getElementById("levelUpModal")).show();
      }
    });
  </script>

  {{ ability_map|json_script:"abilities-data" }}

  {% if form.asi_mode %}
  <script>
  (function(){
    const dataEl = document.getElementById("abilities-data");
    if (!dataEl) return;
    const base = JSON.parse(dataEl.textContent || "{}");

    const tbl = document.getElementById("asi-table");
    if (!tbl) return;

    const help = document.getElementById("asi-help");
    const preview = document.getElementById("asi-preview");

    const modeInput = document.getElementById("id_asi_mode");
    const aInput    = document.getElementById("id_asi_a");
    const bInput    = document.getElementById("id_asi_b");

    let slotA = aInput?.value || "";
    let slotB = bInput?.value || "";

    function pretty(k){ return k.charAt(0).toUpperCase() + k.slice(1); }
    function getBase(k){ return Number(base[pretty(k)] || 0); }
    function lockToOne(){ return [slotA, slotB].filter(Boolean).some(k => getBase(k) >= 20); }

    function updateUI(){
      ["A","B"].forEach((slot) => {
        tbl.querySelectorAll('input.asi-slot[data-slot="'+slot+'"]').forEach((bx)=>{
          const key = bx.closest("tr").dataset.key;
          if (slot === "A") bx.checked = (key === slotA);
          if (slot === "B") bx.checked = (key === slotB);
        });
      });

      const oneOnly = lockToOne();
      const bBoxes = tbl.querySelectorAll('input.asi-slot[data-slot="B"]');
      if (oneOnly) {
        if (slotA && slotB) slotB = "";
        bBoxes.forEach(bx => bx.disabled = true);
        help.innerHTML = '<span class="text-warning">One chosen ability is 20+, so only a single +1 may be applied.</span>';
      } else {
        bBoxes.forEach(bx => bx.disabled = false);
        help.textContent = '';
      }

      tbl.querySelectorAll("tbody tr").forEach(tr => {
        const key = tr.dataset.key;
        const before = Number(tr.dataset.base);
        let inc = 0;
        if (slotA === key) inc += 1;
        if (slotB === key) inc += 1;
        tr.querySelector(".asi-result").textContent = before + inc;
        tr.classList.remove("table-success","table-warning");
        if (inc === 2) tr.classList.add("table-success");
        if (inc === 1) tr.classList.add("table-warning");
      });

      let mode = "";
      if (slotA && slotB) mode = (slotA === slotB) ? "2" : "1+1";
      else if (slotA || slotB) mode = "1";
      if (oneOnly && mode !== "1") { slotB = ""; mode = "1"; }

      modeInput.value = mode;
      aInput.value    = slotA || slotB || "";
      bInput.value    = (mode === "1+1" || mode === "2") ? (slotB || slotA) : "";

      function upText(k, inc){ return `${pretty(k)}: ${getBase(k)} → ${getBase(k)+inc}`; }
      let txt = "—";
      if (mode === "2")       txt = upText(slotA, 2);
      else if (mode === "1+1")txt = `${upText(slotA,1)}; ${upText(slotB,1)}`;
      else if (mode === "1")  txt = upText(slotA || slotB, 1);
      preview.textContent = txt;
    }

    tbl.addEventListener("change", (e) => {
      const box = e.target;
      if (!box.matches(".asi-slot")) return;
      const slot = box.dataset.slot;
      const key  = box.closest("tr").dataset.key;
      if (slot === "A") slotA = box.checked ? key : (slotA === key ? "" : slotA);
      else              slotB = box.checked ? key : (slotB === key ? "" : slotB);
      if (lockToOne() && slotA && slotB) {
        if (slot === "A") slotB = ""; else slotA = "";
      }
      updateUI();
    });

    updateUI();
  })();
  </script>
  {% endif %}

  <script>
  (function(){
window.initFeatTable = function(opts){

  var table = document.getElementById(opts.tableId);
  if (!table) return;

  function cellText(row, idx){ var c=row.cells[idx]; return (c?c.textContent:"").trim(); }
  table.querySelectorAll("th[data-sort]").forEach(function(th){
    th.style.cursor = "pointer";
    th.addEventListener("click", function(){
      var col = parseInt(th.getAttribute("data-sort"), 10);
      var asc = th.getAttribute("data-order") !== "asc";
      th.setAttribute("data-order", asc ? "asc" : "desc");
      var rows = Array.from(table.tBodies[0].rows).filter(function(r,i){ return !r.classList.contains("desc-body"); });
      rows.sort(function(a,b){
        var A = cellText(a, col).toLowerCase(), B = cellText(b, col).toLowerCase();
        return asc ? A.localeCompare(B, undefined, {numeric:true}) : B.localeCompare(A, undefined, {numeric:true});
      });
      // keep each details row just after its data row
      rows.forEach(function(r){
        var detail = r.nextElementSibling && r.nextElementSibling.classList.contains("desc-body") ? r.nextElementSibling : null;
        table.tBodies[0].appendChild(r);
        if (detail) table.tBodies[0].appendChild(detail);
      });
    });
  });

  var BLANK="(Blanks)";
  function splitTokens(txt){ return txt.split(/[,;/]/).map(function(s){return s.trim();}).filter(Boolean); }

  // Build dropdown menu lists
  function uniqueValuesForCol(colIdx, splitByTokens){
    var set = new Set();
    Array.from(table.tBodies[0].rows).forEach(function(r){
      if (r.classList.contains("desc-body")) return;
      var txt = cellText(r, colIdx);
      if (!txt) set.add(BLANK);
      else if (splitByTokens){ splitTokens(txt).forEach(function(tok){ set.add(tok); }); }
      else set.add(txt);
    });
    return Array.from(set).sort(function(a,b){ return a.localeCompare(b, undefined, {numeric:true}); });
  }

  var dropdownFilters = [];  // [{col, split, selected, enabled}]
  function buildFilterMenu(menuEl){
    var col   = parseInt(menuEl.dataset.col, 10);
    var split = menuEl.dataset.split === "1";
    var values = uniqueValuesForCol(col, split);

    menuEl.innerHTML = [
      '<div class="d-flex justify-content-between small mb-2">',
      '  <a href="#" class="excel-sel-all">Select all</a>',
      '  <a href="#" class="excel-clear">Clear</a>',
      '</div>',
      '<input type="text" class="form-control form-control-sm mb-2 excel-search" placeholder="Search values…">',
      '<div class="excel-list" style="max-height:220px; overflow:auto;"></div>',
      '<div class="d-flex justify-content-end gap-2 mt-2">',
      '  <button type="button" class="btn btn-sm btn-outline-secondary excel-cancel">Cancel</button>',
      '  <button type="button" class="btn btn-sm btn-success excel-ok">OK</button>',
      '</div>'
    ].join("");

    var list = menuEl.querySelector(".excel-list");
    function renderList(filter){
      list.innerHTML = "";
      values.forEach(function(v){
        if (filter && v.toLowerCase().indexOf(filter.toLowerCase()) === -1) return;
        var id = "excel_"+opts.tableId+"_"+col+"_"+btoa(unescape(encodeURIComponent(v))).replace(/=/g,'');
        var div = document.createElement("div");
        div.className = "form-check";
        div.innerHTML = '<input class="form-check-input" type="checkbox" id="'+id+'" value="'+v+'" checked>' +
                        '<label class="form-check-label small" for="'+id+'">'+v+'</label>';
        list.appendChild(div);
      });
    }
    renderList("");

    menuEl.querySelector(".excel-search").addEventListener("input", function(){ renderList(this.value.trim()); });
    menuEl.addEventListener("click", function(e){
      if (e.target.matches(".excel-sel-all")){ e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true); applyAllFilters(); }
      if (e.target.matches(".excel-clear"))  { e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); applyAllFilters(); }
      if (e.target.matches(".excel-ok,.excel-cancel")){
        var dd = bootstrap.Dropdown.getOrCreateInstance(menuEl.parentElement.querySelector('[data-bs-toggle="dropdown"]'));
        dd.hide();
      }
    });
    list.addEventListener("change", applyAllFilters);

    menuEl.dataset.ready = "1";
    dropdownFilters.push({col: col, split: split, selected: function(){
      return Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(function(cb){ return cb.value; });
    }});
  }

  table.querySelectorAll(".excel-menu[data-col]").forEach(buildFilterMenu);

  // Per-column text search
  var textFilters = {}; // {col -> lowercased substring}
  table.querySelectorAll(".col-search").forEach(function(inp){
    var col = parseInt(inp.dataset.col, 10);
    textFilters[col] = "";
    inp.addEventListener("input", function(){
      textFilters[col] = (inp.value || "").trim().toLowerCase();
      applyAllFilters();
    });
  });

  function matchesDropdowns(row){
    var show = true;
    dropdownFilters.forEach(function(f){
      if (!show) return;
      var txt = cellText(row, f.col);
      var tokens = (!txt) ? [BLANK] : (f.split ? splitTokens(txt) : [txt]);
      var selected = f.selected();
      // if a menu exists, and nothing is selected, hide all
      if (table.querySelector('.excel-menu[data-col="'+f.col+'"]')) {
        if (selected.length === 0) { show = false; return; }
        show = tokens.some(function(tok){ return selected.indexOf(tok) !== -1; });
      }
    });
    return show;
  }

  function matchesText(row){
    for (var col in textFilters){
      var q = textFilters[col];
      if (!q) continue;
      var txt = cellText(row, parseInt(col,10)).toLowerCase();
      if (txt.indexOf(q) === -1) return false;
    }
    return true;
  }

  function applyAllFilters(){
    Array.from(table.tBodies[0].rows).forEach(function(row){
      if (row.classList.contains("desc-body")) return;
      var ok = matchesDropdowns(row) && matchesText(row);
      row.style.display = ok ? "" : "none";
      var detail = row.nextElementSibling;
      if (detail && detail.classList.contains("desc-body")) {
        // hide details row if master row hidden
        detail.style.display = ok ? detail.style.display : "none";
      }
    });
  }

  // radio highlight (if any radios exist inside)
  table.addEventListener("change", function(e){
    if (e.target.type === "radio") {
      table.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("is-active"));
      e.target.closest("tr").classList.add("is-active");
    }
  });

  // initial filter pass
  applyAllFilters();
}

  initFeatTable({ tableId: "general-feats-table", searchId: "general-feat-filter" });
  initFeatTable({ tableId: "class-feats-table",   searchId: "class-feat-filter"   });
})();
  </script>
<script>
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.toggle-skill-edit');
    if (!btn) return;
    const id = btn.getAttribute('data-target');
    const row = document.getElementById(id);
    if (row) row.classList.toggle('d-none');
  });
</script>
  <script>
    
  (function(){
    const modalEl = document.getElementById('editNumberModal');
    if (!modalEl) return;
    const form = document.getElementById('editNumberForm');
    const keyInput = document.getElementById('edit-key');
    const valInput = document.getElementById('edit-value');
    const noteInput= document.getElementById('edit-note');
    const bsModal = new bootstrap.Modal(modalEl);

    document.body.addEventListener('click', (e)=>{
      const el = e.target.closest('.editable-number');
      if (!el) return;
      const key = el.getAttribute('data-key');
      const current = el.textContent.trim();
      keyInput.value = key;
      valInput.value = current.replace(/[^\d\.\-]/g,'') || "";
      noteInput.value = "";
      bsModal.show();
    });

    function getCookie(name) {
      const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    }

    form.addEventListener('submit', async (e)=>{
      
      e.preventDefault();
      const resp = await fetch("{% url 'characters:set_field_override' character.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
          key: keyInput.value,
          value: valInput.value,
          note: noteInput.value
        })
      });
      if (resp.ok){
        window.location.reload();
      } else {
        alert("Failed to save override.");
      }
    });
  })();
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.wep-select').forEach(function(sel){
      sel.addEventListener('change', function(){
        if (!window.fetch || !this.dataset.slot) return;
        try {
          const fd = new FormData();
          fd.append('slot', this.dataset.slot);
          fd.append('weapon_id', this.value || '');
          fetch("{% url 'characters:set_weapon_choice' character.pk %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': (document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')||[])[2] || '' },
            body: fd
          }).then(()=>location.reload());
        } catch(e) {}
      });
    });
  });
  </script>


  <script>
(function(){
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  document.addEventListener('click', async function(e){
    const btn = e.target.closest('.toggle-activation');
    if (!btn) return;
    const li  = btn.closest('li');
    const note = li ? (li.querySelector('.act-note')?.value || '') : '';
    const ctype  = btn.getAttribute('data-ctype');
    const objId  = btn.getAttribute('data-obj');
    const active = btn.getAttribute('data-active');
    try{
      const resp = await fetch("{% url 'characters:set_activation' character.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/x-www-form-urlencoded",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: new URLSearchParams({ ctype: ctype, obj: objId, active: active, note: note })
      });
      if (!resp.ok) throw new Error("Bad response");
      // easiest UX: refresh so all three tabs sync state
      window.location.reload();
    } catch(err) {
      alert("Failed to update activation.");
    }
  });
})();
</script>
<script>
  // bootstrap modal helper
  const overrideModal = new bootstrap.Modal(document.getElementById('overrideModal'));

  // open modal with the target override key
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.edit-override');
    const toggle = e.target.closest('.toggle-desc');
    if (btn) {
      const key = btn.getAttribute('data-key');
      document.getElementById('ov-key').value = key;
      document.getElementById('ov-val').value = '';
      document.getElementById('ov-note').value = '';
      overrideModal.show();
    }
    if (toggle) {
      const body = toggle.parentElement.parentElement.querySelector('.desc-body');
      if (body) body.classList.toggle('d-none');
    }
  });

  // submit via standard POST (keeps CSRF + redirects handled by view)
  document.getElementById('overrideForm').addEventListener('submit', function(){
    // allow normal submission
  });
</script>

<script>
(function(){
  // Tabs
  document.querySelectorAll('.tabs').forEach(tabs => {
    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if (!btn || btn.disabled) return;
      const wrap = tabs.parentElement; // card-body
      tabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      wrap.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      const panel = wrap.querySelector(btn.dataset.target);
      if (panel) panel.classList.add('active');
    });
  });

  // Selection caps (cantrip / known overall / prepare per rank)
  function updateCounts(root){
    const canMax = +root.querySelector('[data-role="count-cantrips"]')?.dataset.max || 0;
    const canSel = root.querySelectorAll('.pick-cantrip:checked').length;
    const canLbl = root.querySelector('[data-role="count-cantrips"]');
    if (canLbl){ canLbl.textContent = canSel + ' selected'; }
    root.querySelectorAll('.pick-cantrip:not(:checked)').forEach(cb => cb.disabled = canSel >= canMax && canMax > 0);

    const knMax = +root.querySelector('[data-role="count-known"]')?.dataset.max || 0;
    const knSel = root.querySelectorAll('.pick-known:checked').length;
    const knLbl = root.querySelector('[data-role="count-known"]');
    if (knLbl){ knLbl.textContent = knSel + ' selected'; }
    root.querySelectorAll('.pick-known:not(:checked)').forEach(cb => cb.disabled = knSel >= knMax && knMax > 0);

    root.querySelectorAll('[data-role="count-prepare"]').forEach(lbl => {
      const r = lbl.dataset.rank;
      const pMax = +lbl.dataset.max || 0;
      const pSel = root.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:checked').length;
      lbl.textContent = pSel + ' selected';
      root.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:not(:checked)').forEach(cb => cb.disabled = pSel >= pMax && pMax > 0);
    });
  }

  document.querySelectorAll('.spellcard').forEach(card => {
    card.addEventListener('change', (e) => {
      if (!e.target.matches('.pick-cantrip, .pick-known, .pick-prepare')) return;
      updateCounts(card);
    });
    // initial
    updateCounts(card);
  });
})();
</script>
<script>
(function(){
  // ── Tabs (robust if target panel is missing) ───────────────────────────────
  document.querySelectorAll('.tabs').forEach(tabs => {
    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if (!btn || btn.classList.contains('disabled')) return;
      const wrap = tabs.parentElement;
      tabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const targetSel = btn.getAttribute('data-target');
      wrap.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      if (targetSel) {
        const panel = wrap.querySelector(targetSel);
        if (panel) panel.classList.add('active');
      }
    });
  });

  // ── Helpers ────────────────────────────────────────────────────────────────
  function textOfRow(row){ return row.textContent.toLowerCase(); }
  function wireSearch(input, table){
    if (!input || !table) return;
    input.addEventListener('input', () => {
      const q = input.value.trim().toLowerCase();
      table.querySelectorAll('tbody tr').forEach(tr => {
        tr.style.display = (q && !textOfRow(tr).includes(q)) ? 'none' : '';
      });
    });
  }

  // ── Per-feature card logic ────────────────────────────────────────────────
  document.querySelectorAll('.spellcard').forEach(card => {
    const fid = card.dataset.fid;

    // --- Cantrips limit (global per feature) ---
    const cantripBoxes   = card.querySelectorAll('input.pick-cantrip[name="learn_cantrips_'+fid+'"]');
    const cantripMaxEl   = card.querySelector('[data-role="count-cantrips"]');
    const cantripMax     = parseInt(cantripMaxEl?.dataset.max || '0', 10);
    const cantripCounter = cantripMaxEl;

    function enforceCantrips(){
      if (!cantripBoxes.length || !cantripMax) {
        if (cantripCounter) cantripCounter.textContent = '0';
        return;
      }
      const picked = [...cantripBoxes].filter(b => b.checked);
      const over = Math.max(0, picked.length - cantripMax);
      if (over > 0) {
        // uncheck the most recently toggled extras
        picked.slice(-over).forEach(b => { b.checked = false; });
      }
      if (cantripCounter){
        cantripCounter.textContent = Math.min(picked.length, cantripMax);
      }
    }
    cantripBoxes.forEach(b => b.addEventListener('change', enforceCantrips));
    enforceCantrips(); // init

    // --- Known (leveled) limit shared across all ranks for this feature) ---
    const knownBoxes = card.querySelectorAll('input.pick-known[name="learn_known_'+fid+'"]');
    const knownMaxEl = card.querySelector('[data-role="count-known"]');
    const knownMax   = parseInt(knownMaxEl?.dataset.max || '0', 10);

    function enforceKnown(){
      if (!knownBoxes.length) {
        if (knownMaxEl) knownMaxEl.textContent = '0';
        return;
      }
      const picked = [...knownBoxes].filter(b => b.checked);
      if (knownMax > 0 && picked.length > knownMax){
        // uncheck the one the user just turned on (fallback for older browsers)
        let last = null;
        try {
          last = [...knownBoxes].findLast(b => b === document.activeElement || b === document._lastChanged);
        } catch (_e) {
          last = [...knownBoxes].reverse().find(b => b === document.activeElement || b === document._lastChanged);
        }
        (last || picked[picked.length - 1]).checked = false;
      }
      const count = Math.min([...knownBoxes].filter(b => b.checked).length, knownMax || 0);
      if (knownMaxEl) knownMaxEl.textContent = count;
    }
    knownBoxes.forEach(b => {
      b.addEventListener('change', (ev) => { document._lastChanged = ev.target; enforceKnown(); });
    });
    enforceKnown(); // init

    // --- Prepared limits per rank (uses data-rank + per-rank max in data-max) ---
    const prepBoxes = card.querySelectorAll('input.pick-prepare');
    const countersByRank = {};
    card.querySelectorAll('[data-role="count-prepare"]').forEach(el => {
      countersByRank[el.dataset.rank] = { el, max: parseInt(el.dataset.max || '0', 10) };
    });

    function enforcePrepare(ev){
      const t = ev?.target;
      const r = t?.dataset.rank;
      if (!r) return;
      const group = [...prepBoxes].filter(b => b.dataset.rank === r);
      const cap   = countersByRank[r]?.max || 0;
      const picked = group.filter(b => b.checked);
      if (cap > 0 && picked.length > cap){
        (t || picked[picked.length - 1]).checked = false;
      }
      const cnt = Math.min(group.filter(b => b.checked).length, cap);
      if (countersByRank[r]) countersByRank[r].el.textContent = cnt;
    }
    // bind + initialize counts for each rank
    prepBoxes.forEach(b => b.addEventListener('change', enforcePrepare));
    Object.keys(countersByRank).forEach(r => {
      const group = [...prepBoxes].filter(b => b.dataset.rank === r);
      const cap   = countersByRank[r]?.max || 0;
      const cnt   = Math.min(group.filter(b => b.checked).length, cap);
      countersByRank[r].el.textContent = cnt;
    });

    // --- Search boxes wiring ---
    // Cantrips
    wireSearch(
      card.querySelector('#cantrip-filter-'+fid),
      card.querySelector('#cantrips-table-'+fid)
    );
    // Per-level learn tables
    card.querySelectorAll('[id^="learn-filter-'+fid+'-r"]').forEach(input => {
      const tableId = input.id.replace('filter','table');
      wireSearch(input, card.querySelector('#'+tableId));
    });
  });

  // ── “Details” toggler (row or section) ─────────────────────────────────────
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.toggle-desc');
    if (!btn) return;
    const row = btn.closest('tr');
    let details = row?.nextElementSibling;
    if (details && details.classList.contains('desc-body')) {
      details.classList.toggle('d-none');
      return;
    }
    // fallback for card sections
    details = btn.parentElement.parentElement.nextElementSibling;
    if (details && details.classList.contains('desc-body')) {
      details.classList.toggle('d-none');
    }
  });
})();
</script>


<script>
  // Spellcasting tab tables (new)
(function(){
  document.querySelectorAll('table.excel-setup[id^="prep-table-"], table.excel-setup[id^="learned-cantrips-"], table.excel-setup[id^="knownprep-table-"], table.excel-setup[id^="learn-table-"], table.excel-setup[id^="cantrips-table-"]').forEach(function(tbl){
    if (typeof initFeatTable === 'function') initFeatTable({ tableId: tbl.id });
  });
})();

</script>

{% endblock %}
