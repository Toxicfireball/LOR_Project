{# templates/forge/character_detail.html #}
{% extends "base.html" %}
{% load static %}
{% load ui_extras %}
{% load range_extras %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/character.css' %}">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css">
{% endblock %}

{% block content %}
<style>
.modal          { z-index: 2000 !important; }
.modal-backdrop { z-index: 1990 !important; }

  .edit-pill {
  border: 0; background: transparent; padding: 0 .25rem; font-size: .85rem;
  color: #6c757d; cursor: pointer;
}
.edit-pill:hover { color: #0d6efd; text-decoration: underline; }

  .summernote-content p{ margin-bottom:.5rem; }
  .summernote-content ul, .summernote-content ol{ padding-left:1.25rem; margin-bottom:.5rem; }
  .summernote-content h1,.summernote-content h2,.summernote-content h3,
  .summernote-content h4,.summernote-content h5,.summernote-content h6{
    margin: .75rem 0 .5rem;
    font-size: inherit; font-weight: 600;
  }
  table tbody tr.is-active { outline: 2px solid #0d6efd; }
  #general-feats-table tbody tr.is-selected { background: #fff9db; }
  #general-feats-table tbody tr.is-active   { outline: 2px solid #0d6efd; }

  #asi-table tbody tr.table-warning { background: #fff9db; }
  #asi-table tbody tr.table-success { background: #e6ffed; }

  #skills-table { min-width: 720px; }
  #skills-table th, #skills-table td { white-space: nowrap; }
  #skills-table td:first-child { min-width: 220px; }
</style>
<style>
  #skills-accordion .collapse.show { height: auto !important; display: block !important; }
#skills-accordion .collapse     { overflow: visible; }
.skill-picker .skill-list{max-height:340px;overflow:auto;padding:.25rem .25rem 0}
.skill-picker .skill-item{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-top:1px solid rgba(0,0,0,.05);cursor:pointer}
.skill-picker .skill-item:first-child{border-top:0}
.skill-picker .skill-item:hover{background:rgba(0,0,0,.03)}
.skill-picker .skill-label{flex:1}
.skill-picker .skill-item.disabled{opacity:.55;pointer-events:none}
.skill-toolbar{border-bottom:1px solid rgba(0,0,0,.06)}
</style>


{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags|default:'info' }} mb-2">{{ m }}</div>
  {% endfor %}
{% endif %}


<div class="container my-4">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ character.name }}</h1>
    <div>
      <button
        class="btn btn-primary me-2"
        data-bs-toggle="modal"
        data-bs-target="#levelUpModal"
      >Level Up</button>
      <a
        href="{% url 'characters:level_down' character.pk %}"
        class="btn btn-danger {% if total_level == 0 %}disabled{% endif %}"

      >Level Down</a>
    </div>
  </div>

  <div class="row g-4">
    <!-- LEFT: Basics + Ability Scores + quick finals -->
    <aside class="col-lg-3">
      <div class="position-sticky" style="top: 1rem;">
        <!-- Basics -->
        <div class="card p-3 mb-3">
          <h5 class="mb-2">Basics</h5>
          <div><strong>Name:</strong> {{ character.name }}</div>
          <div><strong>Race:</strong> {{ character.race|default:"—" }}</div>
          <div><strong>Subrace:</strong> {{ subrace_name|default:"—" }}</div>
          <div><strong>Level:</strong> {{ total_level }}</div>
          <div><strong>Campaign:</strong> {{ character.campaign|default:"—" }}</div>
          <div class="mt-2"><strong>Classes:</strong>
            <ul class="mb-0">
              {% for cp in class_progress %}
                <li>{{ cp.character_class.name }} L{{ cp.levels }}</li>
              {% empty %}
                <li>—</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Ability Scores -->
        <div class="card mb-3">
          <div class="card-header fw-bold">Ability Scores</div>
          <div class="card-body p-0">
            <table class="table mb-0">
              <thead>
                <tr><th>Ability</th><th class="text-end">Score</th><th class="text-end">Mod</th></tr>
              </thead>
              <tbody>
                {% for a in abilities %}
                  <tr>
                    <td>{{ a.label }}</td>
                    <td class="text-end">{{ a.score }}</td>
                    <td class="text-end">{{ a.mod_str }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Quick finals -->
<div class="card">
  <div class="card-header fw-bold">Core Stats</div>
  <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="mb-0">
    {% csrf_token %}
    <ul class="list-group list-group-flush">

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>HP</span>
        <span class="d-flex align-items-center gap-2">
          <input name="HP" type="number" class="form-control form-control-sm" style="width:90px"
                 value="{{ hp_current }}" min="0">
          <span>/</span>
          <input name="hp_max" type="number" class="form-control form-control-sm" style="width:90px"
                 value="{{ hp_max }}" min="0">
        </span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Temp HP</span>
        <span class="d-flex align-items-center gap-2">
          <input name="temp_HP" type="number" class="form-control form-control-sm" style="width:90px"
                 value="{{ temp_hp|default:0 }}" min="0">
        </span>
      </li>

      <li class="list-group-item d-flex justify-content-end">
        <button class="btn btn-sm btn-primary" name="save_core_stats_submit" value="1">Save</button>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Armor</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.armor_total }}</strong>
<button class="btn btn-xs btn-outline-secondary edit-override"
        type="button"
        data-key="prof:armor"
        data-calc="{{ derived.armor_total }}"
        data-formula=""
        data-debug-el="dbg-armor">✎</button>

        </span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Dodge</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.dodge_total }}</strong>
<button class="btn btn-xs btn-outline-secondary edit-override" type="button"
        data-key="prof:dodge"      data-calc="{{ derived.dodge_total }}"      data-formula="" data-debug-el="dbg-dodge">✎</button>

        </span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Reflex</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.reflex_total }}</strong>
<button class="btn btn-xs btn-outline-secondary edit-override" type="button"
        data-key="prof:reflex"     data-calc="{{ derived.reflex_total }}"     data-formula="" data-debug-el="dbg-reflex">✎</button>

        </span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Fortitude</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.fortitude_total }}</strong>
<button class="btn btn-xs btn-outline-secondary edit-override" type="button"
        data-key="prof:fortitude"  data-calc="{{ derived.fortitude_total }}"  data-formula="" data-debug-el="dbg-fortitude">✎</button>

        </span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Will</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.will_total }}</strong>
<button class="btn btn-xs btn-outline-secondary edit-override" type="button"
        data-key="prof:will"       data-calc="{{ derived.will_total }}"       data-formula="" data-debug-el="dbg-will">✎</button>

        </span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Perception</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ derived.perception_total }}</strong>
<button class="btn btn-xs btn-outline-secondary edit-override" type="button"
        data-key="prof:perception" data-calc="{{ derived.perception_total }}" data-formula="" data-debug-el="dbg-perception">✎</button>

        </span>
      </li>

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Spell/DC</span>
        <span class="d-flex align-items-center gap-2">
          <strong>{{ spell_dc_main|default:"—" }}</strong>
<button class="btn btn-xs btn-outline-secondary edit-override" type="button"
        data-key="dc:main"
        data-calc="{{ spell_dc_main|default:'' }}"
        data-formula="{{ spell_dc_rows.0.formula|default:''|escape }}"
        data-debug-el="dbg-dc">✎</button>

        </span>
      </li>

    </ul>
  </form>
</div>


      </div>
    </aside>

    <!-- RIGHT: tabs + panes -->
    <main class="col-lg-9">
      <!-- ONE set of tabs only -->
      <ul class="nav nav-tabs" id="sheetTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-details" type="button">Details</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-combat"  type="button">Combat</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-skills"  type="button">Skills</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-feats"   type="button">Feats</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-active"       type="button">Active</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-passive"      type="button">Passive</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-all"          type="button">All</button></li>
{% if show_spellcasting_tab %}
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-spellcasting" type="button">Spellcasting</button></li>
{% endif %}
      </ul>

      <div class="tab-content pt-3">
        <!-- DETAILS TAB -->
        <div class="tab-pane fade show active" id="tab-details">
<div class="d-flex align-items-center justify-content-between mb-2">
  <h5 class="mb-0">Details</h5>
  {% if can_edit %}
<button id="toggle-details-edit" type="button" class="btn btn-sm btn-outline-secondary">
  ✎ Edit
</button>

  {% endif %}
</div>

{% if can_edit %}
  {{ details_form.media }}
  <div id="detailsEdit" class="collapse">
    <form method="post" novalidate>
      {% csrf_token %}
      {{ details_form.non_field_errors }}

      {% for field in details_form.visible_fields %}
        <div class="mb-3">
          <label class="form-label">{{ field.label }}</label>
          {{ field }}
          <input class="form-control form-control-sm mt-1"
                 name="note__{{ field.name }}"
                 placeholder="Reason (required if changed)">
        </div>
      {% endfor %}

      <button type="submit" name="update_details_submit" class="btn btn-primary">
        Save Details
      </button>
    </form>
  </div>
{% endif %}

{# Always show the read view below; the edit form above is collapsed #}
<div class="mb-4"><h6>Backstory</h6><div class="summernote-view">{{ character.backstory|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Worshipped Gods</h6><div class="summernote-view">{{ character.worshipped_gods|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Believers and ideals</h6><div class="summernote-view">{{ character.believers_and_ideals|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Iconic (Strength)</h6><div class="summernote-view">{{ character.iconic_strengths|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Iconic (Flaws)</h6><div class="summernote-view">{{ character.iconic_flaws|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Bonds/Relationship</h6><div class="summernote-view">{{ character.bonds_relationships|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Ties and Connections</h6><div class="summernote-view">{{ character.ties_connections|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Outlook</h6><div class="summernote-view">{{ character.outlook|safe|default:"—" }}</div></div>

        </div>

        <!-- COMBAT TAB -->
        <div class="tab-pane fade" id="tab-combat">
          <div class="row g-3">
            <!-- Defense -->
            <div class="col-md-5">
              <div class="card h-100">
                <div class="card-header fw-bold">Defense</div>
                <ul class="list-group list-group-flush">
<li class="list-group-item d-flex justify-content-between"><span>Armor</span><span class="fw-bold">{{ derived.armor_total }}</span></li>
                  <li class="list-group-item d-flex justify-content-between"><span>Dodge</span><span class="fw-bold">{% for r in proficiency_detailed %}{% if r.type == "Dodge" %}{{ r.total_s }}{% endif %}{% endfor %}</span></li>
                  <li class="list-group-item d-flex justify-content-between"><span>Reflex</span><span class="fw-bold">{% for r in proficiency_detailed %}{% if r.type == "Reflex" %}{{ r.total_s }}{% endif %}{% endfor %}</span></li>
                  <li class="list-group-item d-flex justify-content-between"><span>Fortitude</span><span class="fw-bold">{% for r in proficiency_detailed %}{% if r.type == "Fortitude" %}{{ r.total_s }}{% endif %}{% endfor %}</span></li>
                  <li class="list-group-item d-flex justify-content-between"><span>Will</span><span class="fw-bold">{% for r in proficiency_detailed %}{% if r.type == "Will" %}{{ r.total_s }}{% endif %}{% endfor %}</span></li>
                </ul>
                <div class="card-body">
                  <form class="d-flex flex-wrap gap-2 align-items-center"
                        method="post" action="{% url 'characters:set_armor_choice' character.pk %}">
                    {% csrf_token %}
                    <label class="me-2 fw-semibold">Armor:</label>
                    <select name="armor_id" class="form-select form-select-sm" style="max-width: 320px">
                      <option value="">— No armor —</option>
                      {% for a in armor_list %}
                        <option value="{{ a.id }}" {% if selected_armor and selected_armor.id == a.id %}selected{% endif %}>
                          {{ a.name }} (+{{ a.armor_value }})
                        </option>
                      {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-outline-primary">Save</button>
                    {% if selected_armor %}
                      <span class="text-muted ms-2">Equipped: {{ selected_armor.name }}</span>
                    {% endif %}
                  </form>
                </div>
                              <div class="card-body pt-0">
                          

  <h6 class="mt-2 mb-2">Breakdown</h6>
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Type</th>
          <th>Tier</th>
          <th>Formula</th>
          <th>Values</th>
          <th>Total</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody>
        {% for r in defense_rows %}
          <tr id="row-{{ r.type|slugify }}">
            <td>{{ r.type }}</td>
            <td class="text-muted">{{ r.tier }}</td>
            <td class="text-muted">{{ r.formula }}</td>
            <td>{{ r.values }}</td>
            <td class="fw-semibold">{{ r.total_s }}</td>
<td>
  {% note_icon "defense:"|add:r.type %}


<button
  class="btn btn-xs btn-outline-secondary edit-override"
  type="button"
  data-key="prof:{{ r.code }}"
  data-calc="{{ r.total_s }}"
  data-formula="{{ r.formula|escape }}"
  data-debug='{{ r.debug_json|escapejs }}'
>✎</button>

</td>


          </tr>
        {% endfor %}
      </tbody>


      
      </table>
    </div>
  </div>
              </div>


            </div>
<!-- Offense -->
<div class="col-md-7">
  <div class="card h-100">
    <div class="card-header fw-bold">Offense</div>
    <div class="card-body">
        {% if spell_dc_rows and spell_dc_rows.0 %}
          <div class="mb-3">
            <div>
              <strong>Spell/DC:</strong> {{ spell_dc_rows.0.total }}
            </div>


            <div class="table-responsive mt-2">
              <table class="table table-sm align-middle w-auto">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Formula</th>
                    <th>Values</th>
                    <th>Total</th>
                    <th>Note</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in spell_dc_rows %}
                    <tr>
                      <td>{{ s.label }}</td>
                      <td class="text-muted">{{ s.formula }}</td>
                      <td>{{ s.values }}</td>
                      <td class="fw-semibold">{{ s.total }}</td>
                      <td>{% note_icon "dc:"|add:s.label %}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}


      <!-- 3 weapon slots (AJAX equip) -->
      <form class="row g-2 align-items-end mb-2">
<div class="col-sm-6">
  <label class="form-label">Primary Weapon</label>
  <select class="form-select form-select-sm wep-select" data-slot="1">
    <option value="" {% if not equipped_weapon_1 %}selected{% endif %}>— none —</option>
    {% if weapons_list %}{% for w in weapons_list %}
      <option value="{{ w.id }}"
              {% if equipped_weapon_1 and equipped_weapon_1.id == w.id %}selected{% endif %}>
        {{ w.name }} ({{ w.damage }})
      </option>
    {% endfor %}{% endif %}
  </select>
</div>

<div class="col-sm-6">
  <label class="form-label">Secondary Weapon</label>
  <select class="form-select form-select-sm wep-select" data-slot="2">
    <option value="" {% if not equipped_weapon_2 %}selected{% endif %}>— none —</option>
    {% if weapons_list %}{% for w in weapons_list %}
      <option value="{{ w.id }}"
              {% if equipped_weapon_2 and equipped_weapon_2.id == w.id %}selected{% endif %}>
        {{ w.name }} ({{ w.damage }})
      </option>
    {% endfor %}{% endif %}
  </select>
</div>

<div class="col-sm-6">
  <label class="form-label">Tertiary Weapon</label>
  <select class="form-select form-select-sm wep-select" data-slot="3">
    <option value="" {% if not equipped_weapon_3 %}selected{% endif %}>— none —</option>
    {% if weapons_list %}{% for w in weapons_list %}
      <option value="{{ w.id }}"
              {% if equipped_weapon_3 and equipped_weapon_3.id == w.id %}selected{% endif %}>
        {{ w.name }} ({{ w.damage }})
      </option>
    {% endfor %}{% endif %}
  </select>
</div>

        </div>
      </form>

      {% if attacks_detailed %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>Slot</th><th>Weapon</th><th>Traits</th><th>Hit</th><th>Damage</th></tr></thead>
            <tbody>
              {% for a in attacks_detailed %}
                <tr>
                  <td>{{ a.slot }}</td>
                  <td>{{ a.name }} <small class="text-muted">{{ a.damage_die }}</small></td>
                  <td><small>{{ a.traits|join:", " }}</small></td>
                  <td>
                    +{{ a.hit_str }}
                    {% if a.show_choice_hit %}<small class="text-muted"> (DEX +{{ a.hit_dex }})</small>{% endif %}
                  </td>
                  <td>
                    {{ a.damage_die }}{% if a.dmg_str >= 0 %}+{% endif %}{{ a.dmg_str }}
                    {% if a.show_choice_dmg %}<small class="text-muted"> (DEX {% if a.dmg_dex >= 0 %}+{% endif %}{{ a.dmg_dex }})</small>{% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <h6 class="mb-2">Attacks</h6>
        <table class="table table-sm align-middle">
          <thead><tr><th>Type</th><th>Formula</th><th>Values</th><th>Total</th></tr></thead>
          <tbody>
            {% for a in attack_rows %}
              <tr><td>{{ a.label }}</td><td class="text-muted">{{ a.formula }}</td><td>{{ a.values }}</td><td class="fw-semibold">{{ a.total_s }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div> <!-- /.card-body -->
  </div> <!-- /.card -->
</div> <!-- /.col-md-7 -->
</div> <!-- /.row -->

{% with mm=combat_blocks.martial_mastery %}
  {% if mm %}
    <hr class="my-3">

    <h6 class="mb-2">Martial Mastery</h6>
    <div class="mb-2">
      <strong>Total Points:</strong> {{ mm.total_points }}
      &nbsp;•&nbsp;
      <strong>Known Cap:</strong> {{ mm.total_known_cap }}
    </div>

    {% if mm.known_names and mm.known_names|length %}
      <div class="mb-2">
        <strong>Known:</strong>
        {% for n in mm.known_names %}
          <span class="badge text-bg-secondary me-1 mb-1">{{ n }}</span>
        {% endfor %}
      </div>
    {% endif %}

    {% with mme=active_passive_tab.martial_mastery_entitlement %}
      {% if mme and mme.by_feature and mme.by_feature|length %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Feature</th><th>Class</th><th>Points</th><th>Known Cap</th></tr></thead>
            <tbody>
              {% for row in mme.by_feature %}
                <tr>
                  <td>{{ row.feature_name }}</td>
                  <td>{{ row.class_name }}</td>
                  <td>{{ row.points }}</td>
                  <td>{{ row.known_cap }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% endwith %}
  {% endif %}
{% endwith %}

      

        <!-- SKILLS TAB -->
{# --- SKILLS TAB (minimal) --- #}
<div class="tab-pane fade" id="tab-skills">
  <div class="card p-3 mb-3">
    <h5>Skills</h5>

    {% if skill_prof_errors and skill_prof_errors|length %}
      <div class="alert alert-danger p-2">
        Please provide a reason for changing: {{ skill_prof_errors|join:", " }}.
      </div>
    {% endif %}

<form id="skills-profs-form" method="post" action="{% url 'characters:character_detail' character.pk %}">
  {% csrf_token %}


      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Skill</th>
              <th>Ability</th>
              <th>Tier</th>
              <th>Total</th>
              <th class="text-end" style="width:120px;">Edit</th>
            </tr>
          </thead>
          <tbody id="skills-accordion">

            {% for row in skills_rows %}
              {# display row #}
              <tr>
                <td>{{ row.label }}</td>
                <td>
                  {{ row.ability1 }}{% if row.ability2 %} / {{ row.ability2 }}{% endif %}
                </td>
                <td>
                  {{ row.prof_name }}
                  <small class="text-muted">
                    ({% if row.prof_bonus >= 0 %}+{% endif %}{{ row.prof_bonus }})
                  </small>
                </td>
<td>
  {% if row.total2 is not None %}
    {% if row.total1 >= row.total2 %}{{ row.total1 }}{% else %}{{ row.total2 }}{% endif %}
  {% else %}
    {{ row.total1 }}
  {% endif %}

  {% if row.adjustment %}
    <small class="text-muted ms-1">
      {% if row.adjustment >= 0 %}+{% endif %}{{ row.adjustment }}
      {% if row.adjustment_reason %} ({{ row.adjustment_reason }}){% endif %}
    </small>
  {% endif %}

  {% note_icon "skill_delta:"|add:row.id_key %}
</td>


{% with sid=forloop.counter0|stringformat:"s"|add:"-"|add:row.id_key|slugify %}

<td class="text-end">
<button class="btn btn-sm btn-outline-secondary skill-edit-btn"
        type="button"
        data-target="#skedit-{{ sid }}">
  Edit
</button>

</td>


              </tr>

<tr>
  <td colspan="5" class="bg-dark-subtle p-0">
    <div class="collapse p-2 skill-edit-panel"
         id="skedit-{{ sid }}">
<div class="mb-2 small text-muted">
  <div>
    <strong>Current formula (primary):</strong>
    {{ row.formula1 }}
    {% if row.adjustment %}
      {% if row.adjustment >= 0 %}+{% endif %}{{ row.adjustment }}
      {% if row.adjustment_reason %} (<em>{{ row.adjustment_reason }}</em>){% endif %}
    {% endif %}
  </div>
  {% if row.formula2 %}
    <div>
      <strong>Current formula (secondary):</strong>
      {{ row.formula2 }}
      {% if row.adjustment %}
        {% if row.adjustment >= 0 %}+{% endif %}{{ row.adjustment }}
        {% if row.adjustment_reason %} (<em>{{ row.adjustment_reason }}</em>){% endif %}
      {% endif %}
    </div>
  {% endif %}
</div>

    <div class="row g-2">

      <!-- 1) Change PROFICIENCY TIER for this skill/subskill -->
      <div class="col-md-4">
        <label class="form-label mb-1">Tier</label>
        <select name="sp_{{ row.id_key }}" class="form-select form-select-sm">
          <option value="">— no change —</option>
          {% for t in row.tier_choices %}
            <option value="{{ t.id }}" {% if t.id == row.prof_id %}selected{% endif %}>{{ t.name }}</option>
          {% endfor %}
        </select>
        <input name="sp_note_{{ row.id_key }}" class="form-control form-control-sm mt-1"
               placeholder="Reason for tier change">
        <button class="btn btn-sm btn-primary mt-2"
                name="save_skill_profs_submit" value="1">
          Update Tier
        </button>
      </div>

      <!-- 2) Adjust by amount (+/-), with reason; also CLEAR -->
      <div class="col-md-4">
        <label class="form-label mb-1">Adjust by (applies to both columns)</label>
        <div class="input-group input-group-sm">
          <input type="number" class="form-control"
                 name="skadj_{{ row.id_key }}"
                 value="{{ row.adjustment|default:'' }}">
          <input type="text" class="form-control"
                 name="skadj_note_{{ row.id_key }}"
                 placeholder="Reason (required)">
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-warning"
                  name="save_skill_row" value="{{ row.id_key }}">
            Save Adjustment
          </button>
          <button class="btn btn-sm btn-outline-danger"
                  name="clear_skill_adj" value="{{ row.id_key }}">
            Remove Adjustment
          </button>
        </div>
      </div>

      <!-- 3) Formula / Final overrides for Ability 1 -->
      <div class="col-md-4">
        <label class="form-label mb-1">{{ row.ability1 }} column override</label>
        <input class="form-control form-control-sm mb-1"
               name="ov_formula_{{ row.id_key }}_1"
               placeholder='Formula (e.g. "+2" or "prof+half+str_mod")'>
        <div class="input-group input-group-sm mb-1">
          <span class="input-group-text">Final</span>
          <input type="number" class="form-control"
                 name="ov_final_{{ row.id_key }}_1"
                 placeholder="(number)">
        </div>
        <input class="form-control form-control-sm"
               name="ov_reason_{{ row.id_key }}_1"
               placeholder="Reason (required)">
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-success"
                  name="save_skill_override" value="{{ row.id_key }}:1">
            Save Override
          </button>
          <button class="btn btn-sm btn-outline-danger"
                  name="clear_formula_override" value="skill:{{ row.id_key }}:1">
            Clear Formula
          </button>
          <button class="btn btn-sm btn-outline-danger"
                  name="clear_final_override" value="skill:{{ row.id_key }}:1">
            Clear Final
          </button>
        </div>
      </div>

      {% if row.ability2 %}
      <!-- 4) Formula / Final overrides for Ability 2 -->
      <div class="col-md-4 mt-2">
        <label class="form-label mb-1">{{ row.ability2 }} column override</label>
        <input class="form-control form-control-sm mb-1"
               name="ov_formula_{{ row.id_key }}_2"
               placeholder='Formula (e.g. "+1" or "prof+half+dex_mod")'>
        <div class="input-group input-group-sm mb-1">
          <span class="input-group-text">Final</span>
          <input type="number" class="form-control"
                 name="ov_final_{{ row.id_key }}_2"
                 placeholder="(number)">
        </div>
        <input class="form-control form-control-sm"
               name="ov_reason_{{ row.id_key }}_2"
               placeholder="Reason (required)">
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-success"
                  name="save_skill_override" value="{{ row.id_key }}:2">
            Save Override
          </button>
          <button class="btn btn-sm btn-outline-danger"
                  name="clear_formula_override" value="skill:{{ row.id_key }}:2">
            Clear Formula
          </button>
          <button class="btn btn-sm btn-outline-danger"
                  name="clear_final_override" value="skill:{{ row.id_key }}:2">
            Clear Final
          </button>
        </div>
      </div>
      {% endif %}
    </div>
    </div>
  </td>
</tr>

{% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  </div>
</div>




        <!-- FEATS TAB -->
        <div class="tab-pane fade" id="tab-feats">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header fw-bold">General Feats</div>
                <table class="table table-sm mb-0">
                  <thead><tr><th style="width:70px">Level</th><th>Name</th></tr></thead>
                  <tbody>
                    {% for cf in general_feats %}
            <tr>
              <td>Lv {{ cf.level }}</td>
              <td>
                <div class="d-flex justify-content-between align-items-center">
                  <span>{{ cf.feat.name }} {% note_icon "cfeat:"|add:cf.id %}</span>
                      <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
                      <div class="d-none desc-body mt-2">
                        {% if cf.feat.description %}
                          <div class="summernote-content mb-2">{{ cf.feat.description|safe }}</div>
                        {% endif %}
                        {% with row=cf %}
                        <div class="table-responsive">
                          <table class="table table-sm table-bordered mb-0">
                            <tbody>
                              {% for k,v in row.details %}
                                <tr>
                                  <th class="text-nowrap" style="width: 180px;">{{ k }}</th>
                                  <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                        {% endwith %}
                      </div>

              </td>
            </tr>
                    {% empty %}<tr><td colspan="2" class="text-muted">— None —</td></tr>{% endfor %}
                  </tbody>
                </table>
              </div>
            </div>



            <div class="col-md-6">
              <div class="card h-100">
                <div class="card-header fw-bold">Class Feats</div>
                <table class="table table-sm mb-0">
                  <thead><tr><th style="width:70px">Level</th><th>Name</th></tr></thead>
                  <tbody>
                    {% for cf in class_feats %}
<tr>
  <td>Lv {{ cf.level }}</td>
  <td>
    <div class="d-flex justify-content-between align-items-center">
      <span>{{ cf.feat.name }} {% note_icon "cfeat:"|add:cf.id %}</span>
      <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
    </div>
    <div class="d-none desc-body mt-2">
      {% if cf.feat.description %}
        <div class="summernote-content mb-2">{{ cf.feat.description|safe }}</div>
      {% endif %}
      {% with row=cf %}
      <div class="table-responsive">
        <table class="table table-sm table-bordered mb-0">
          <tbody>
            {% for k,v in row.details %}
              <tr>
                <th class="text-nowrap" style="width: 180px;">{{ k }}</th>
                <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endwith %}
    </div>
  </td>
</tr>

                    {% empty %}<tr><td colspan="2" class="text-muted">— None —</td></tr>{% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>


<script>
  // Simple switcher: show the relevant select for the chosen kind
  (function(){
    const kindSel = document.getElementById("id_kind");
    if (!kindSel) return;
    function flip(){
      const v = (kindSel.value || "").toLowerCase();
      document.getElementById("mf-feat").classList.toggle("d-none", v !== "feat");
      document.getElementById("mf-classfeature").classList.toggle("d-none", v !== "class_feature");
      document.getElementById("mf-racialfeature").classList.toggle("d-none", v !== "racial_feature");
    }
    kindSel.addEventListener("change", flip);
    flip();
  })();
</script>


        <!-- ACTIVE/PASSIVE TAB -->
<!-- ACTIVE TAB -->
<div class="tab-pane fade" id="tab-active">
  <div class="card p-3">
    <h5 class="mb-3">Active Abilities</h5>
    {% if active_rows %}
<ul class="list-group">
  {% for r in active_rows %}
    <li class="list-group-item">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          {{ r.label }}
          {% if r.meta %}<small class="text-muted">— {{ r.meta }}</small>{% endif %}
          {% note_icon r.note_key %}
        </div>
        <div class="d-flex align-items-center gap-2">
          <input class="form-control form-control-sm act-note" placeholder="Note (optional)">
          <button class="btn btn-sm btn-outline-success toggle-activation"
                  data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="1">Active</button>
          <button class="btn btn-sm btn-outline-secondary toggle-activation"
                  data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="0">Set Passive</button>
          <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
        </div>
      </div>
      <div class="d-none desc-body mt-2">
        {% if r.desc %}
          <div class="summernote-content mb-2">{{ r.desc|safe }}</div>
        {% endif %}
        <div class="table-responsive">
          <table class="table table-sm table-bordered mb-0">
            <tbody>
              {% for k,v in r.details %}
                <tr>
                  <th class="text-nowrap" style="width:180px;">{{ k }}</th>
                  <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </li>
  {% endfor %}
</ul>

    {% else %}
      <p class="mb-0 text-muted">None marked Active.</p>
    {% endif %}
  </div>


</div>

<!-- PASSIVE TAB -->
<div class="tab-pane fade" id="tab-passive">
  <div class="card p-3">
    <h5 class="mb-3">Passive Abilities</h5>
    {% if passive_rows %}
      <ul class="list-group">
        {% for r in passive_rows %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              {{ r.label }}
              {% if r.meta %}<small class="text-muted">— {{ r.meta }}</small>{% endif %}
              {% note_icon r.note_key %}
            </div>
            <div class="d-flex align-items-center gap-2">
              <input class="form-control form-control-sm act-note" placeholder="Note (optional)">
              <button class="btn btn-sm btn-outline-primary toggle-activation"
                      data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="1">Set Active</button>
              <button class="btn btn-sm btn-outline-secondary toggle-activation"
                      data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="0">Passive</button>
            </div>
            <div class="d-none desc-body mt-2">
  {% if r.desc %}
    <div class="summernote-content mb-2">{{ r.desc|safe }}</div>
  {% endif %}
  <div class="table-responsive">
    <table class="table table-sm table-bordered mb-0">
      <tbody>
        {% for k,v in r.details %}
          <tr>
            <th class="text-nowrap" style="width:180px;">{{ k }}</th>
            <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">None marked Passive.</p>
    {% endif %}
  </div>
</div>

<!-- ALL TAB -->
<!-- ALL TAB -->
<div class="tab-pane fade" id="tab-all">
  <div class="card p-3">
    <h5 class="mb-3">All Abilities</h5>
    {% if racial_feature_rows %}
  <section class="panel">
    <h3>Racial Features</h3>
    {% for row in racial_feature_rows %}
      <div class="feature">
        <div class="feature__title">
          {{ row.racial_feature.name }}
          {% if row.subclass %} — <em>{{ row.subclass.name }}</em>{% endif %}
        </div>
        <div class="feature__details">
          {# if you have a details helper, use it; otherwise show description #}
          {{ row.racial_feature.description|safe }}
        </div>
      </div>
    {% endfor %}
  </section>
{% endif %}

    {% if all_rows %}
      <ul class="list-group">
        {% for r in all_rows %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                {{ r.label }}
                {% if r.meta %}<small class="text-muted">— {{ r.meta }}</small>{% endif %}
                {% note_icon r.note_key %}
                {% if r.active %}<span class="badge text-bg-success ms-2">Active</span>{% else %}<span class="badge text-bg-secondary ms-2">Passive</span>{% endif %}
              </div>
                <div class="d-flex align-items-center gap-2">
                  <input class="form-control form-control-sm act-note" placeholder="Note (optional)">
            <button class="btn btn-sm btn-outline-primary toggle-activation"
                    data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="1">
              Set Active
            </button>
            <button class="btn btn-sm btn-outline-secondary toggle-activation"
                    data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="0">
              Passive
            </button>

                  <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button> <!-- add this -->
                </div>

            </div>
            <div class="d-none desc-body mt-2">
              {% if r.desc %}
                <div class="summernote-content mb-2">{{ r.desc|safe }}</div>
              {% endif %}
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0">
                  <tbody>
                    {% for k,v in r.details %}
                      <tr>
                        <th class="text-nowrap" style="width:180px;">{{ k }}</th>
                        <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">—</p>
    {% endif %}
  </div>

  <!-- Manually Add Item (moved here) -->
  <div class="card mt-3">
    <div class="card-header fw-bold">Manually Add Item</div>
    <div class="card-body">
      {% if manual_form %}
        <form method="post" action="{% url 'characters:character_detail' character.pk %}">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-3">
              {{ manual_form.kind.label_tag }} {{ manual_form.kind }}
            </div>
            <div class="col-md-3" id="mf-feat">
              {{ manual_form.feat.label_tag }} {{ manual_form.feat }}
            </div>
            <div class="col-md-3 d-none" id="mf-classfeature">
              {{ manual_form.class_feature.label_tag }} {{ manual_form.class_feature }}
            </div>
            <div class="col-md-3 d-none" id="mf-racialfeature">
              {{ manual_form.racial_feature.label_tag }} {{ manual_form.racial_feature }}
            </div>
            <div class="col-12">
              {{ manual_form.reason.label_tag }} {{ manual_form.reason }}
            </div>
          </div>
          <button class="btn btn-primary mt-2" name="manual_add_submit" value="1">Add</button>
        </form>
        {% if manual_form.errors %}
          <div class="alert alert-danger mt-2 mb-0">
            {{ manual_form.errors }}
          </div>
        {% endif %}
      {% else %}
        <p class="mb-0 text-muted">You don’t have permission to add items.</p>
      {% endif %}
    </div>
  </div>
</div>


<!-- SPELLCASTING TAB (single, consolidated) -->
{% if show_spellcasting_tab %}
<div class="tab-pane fade" id="tab-spellcasting">
  {% for b in spell_selection_blocks %}
    <div class="card mb-4">
<div class="card-header d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center gap-2">
    <strong>{{ b.class_name }}</strong>
    <span class="text-muted">• {{ b.origin|default:"—" }}</span>

    {% if b.has_any_override %}
      <span class="badge text-bg-info ms-2" title="This character uses personalized caps/formulas for this list">
        Personal override
      </span>
    {% endif %}
  </div>

  <div class="d-flex align-items-center gap-2 small">
    <span class="badge text-bg-secondary">
      Cantrips: {{ b.known_cantrips_current }}/{{ b.cantrips_max }}
    </span>
    <span class="badge {% if b.known_max and b.known_leveled_current >= b.known_max %}text-bg-danger{% else %}text-bg-secondary{% endif %}">
      Known ≥1: {{ b.known_leveled_current }}{% if b.known_max is not None %}/{{ b.known_max }}{% endif %}
    </span>
    <span class="badge {% if b.prepared_max and b.prepared_current >= b.prepared_max %}text-bg-danger{% else %}text-bg-secondary{% endif %}">
      Prepared: {{ b.prepared_current }}{% if b.prepared_max is not None %}/{{ b.prepared_max }}{% endif %}
    </span>

    {% if b.prepared_remaining_by_rank %}
      <span class="ms-2 text-muted">
        {% for r,v in b.prepared_remaining_by_rank.items %}
          <span class="badge rounded-pill {% if v == 0 %}text-bg-warning{% else %}text-bg-light{% endif %}">
            R{{ r }}: {{ v }} left
          </span>
        {% endfor %}
      </span>
    {% endif %}

    {% if can_edit and b.has_any_override %}
      <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="ms-2">
        {% csrf_token %}
        <input type="hidden" name="spells_op" value="reset_caps">
        <input type="hidden" name="feature_id" value="{{ b.feature_id }}">
        <button class="btn btn-xs btn-outline-secondary">Reset</button>
      </form>
    {% endif %}
  </div>
</div>

      <div class="card-body">

        {# 1) SHOW PREPARED SPELLS (by rank) #}
        <h6 class="mb-2">Prepared Spells</h6>
      {% for r, rows in b.prepared_rows_by_rank.items %}
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div class="fw-semibold">Level {{ r }}</div>
            <div class="small text-muted">
              Slots {{ b.slots_by_rank|get_item:r|default:0 }}
              • Remaining {{ b.prepared_remaining_by_rank|get_item:r|default:0 }}
            </div>
          </div>
{% with prep_id="prep-table-"|add:b.feature_id|stringformat:"s"|add:"-r"|add:r|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=prep_id rows=rows feature_id=b.feature_id action="unprepare" rank=r  %}
{% endwith %}
        </div>
      {% endfor %}


        {# 2) SELECT PREPARED SPELLS FROM KNOWN (by rank) #}
        <h6 class="mt-4 mb-2">Prepare from Known</h6>
        {% for pair in b.known_for_prepare_by_rank.items %}

          {% with r=pair.0 rows=pair.1 %}
            <div class="mb-3">
              <div class="fw-semibold mb-1">Level {{ r }}</div>
{% with kp_id="knownprep-table-"|add:b.feature_id|stringformat:"s"|add:"-r"|add:r|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=kp_id rows=rows feature_id=b.feature_id action="prepare" rank=r limit_prepare=b.prepared_remaining_by_rank|get_item:r %}
{% endwith %}


            </div>
          {% endwith %}
        {% endfor %}

        {# 3) SPELL TABLE TO SELECT KNOWN SPELL (by rank > 0) #}
        <h6 class="mt-4 mb-2">Learn New Spells (Leveled)</h6>
        {% for pair in b.learn_spells_by_rank.items %}

          {% with r=pair.0 rows=pair.1 %}
            <div class="mb-3">
              <div class="fw-semibold mb-1">Rank {{ r }}</div>
{% with learn_id="learn-table-"|add:b.feature_id|stringformat:"s"|add:"-r"|add:r|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=learn_id rows=rows feature_id=b.feature_id action="learn_known" rank=r limit_known=b.needs_known %}
{% endwith %}



            </div>
          {% endwith %}
        {% endfor %}

        {# 4) SHOW KNOWN CANTRIPS #}
        <h6 class="mt-4 mb-2">Known Cantrips</h6>
{% with known_c_id="learned-cantrips-"|add:b.feature_id|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=known_c_id rows=b.learned_cantrips_rows feature_id=b.feature_id action="unlearn_cantrip" is_cantrip=True  %}
{% endwith %}


        {# 5) SPELL TABLE TO SELECT KNOWN CANTRIP #}
        <h6 class="mt-4 mb-2">Learn New Cantrips</h6>
{% with can_id="cantrips-table-"|add:b.feature_id|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=can_id rows=b.learn_cantrip_rows feature_id=b.feature_id action="learn_cantrip" is_cantrip=True limit_cantrips=b.needs_cantrips %}
{% endwith %}



        {# (Optional) quick numeric cap adjustment UI you already wired in views as 'adjust_caps' #}
        {% if can_edit %}
        {% if can_edit %}
  <details class="mt-2">
    <summary>Edit formulas (advanced)</summary>
    <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2 mt-2">
      {% csrf_token %}
      <input type="hidden" name="spells_op" value="adjust_formulas">
      <input type="hidden" name="feature_id" value="{{ b.feature_id }}">
      <div class="col-md-4">
        <label class="form-label form-label-sm">Cantrips formula</label>
        <input class="form-control form-control-sm" name="f_cantrips" placeholder="{{ b.cantrips_formula }}">
        <div class="form-text">Leave blank to remove override</div>
      </div>
      <div class="col-md-4">
        <label class="form-label form-label-sm">Known formula</label>
        <input class="form-control form-control-sm" name="f_known" placeholder="{{ b.spells_known_formula|default:'—' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label form-label-sm">Prepared formula</label>
        <input class="form-control form-control-sm" name="f_prepared" placeholder="{{ b.spells_prepared_formula|default:'—' }}">
      </div>
      <div class="col-md-9">
        <label class="form-label form-label-sm">Reason (required)</label>
        <input class="form-control form-control-sm" name="note" required>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-sm btn-outline-primary w-100">Save</button>
      </div>
    </form>
  </details>
{% endif %}

          <div class="mt-4">
            <details>
              <summary class="mb-2">Adjust numeric caps </summary>
              <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2">
                {% csrf_token %}
                <input type="hidden" name="spells_op" value="adjust_caps">
                <input type="hidden" name="feature_id" value="{{ b.feature_id }}">
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Cantrips</label>
<div class="mb-2">
  <label class="form-label mb-0">Cantrips cap</label>
<input type="number" name="cap_cantrips" class="form-control"
       placeholder="{{ b.cantrips_max }}">
<small class="text-muted">Current (calculated): {{ b.cantrips_max }}</small>
</div>                </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Known</label>
<div class="mb-2">
  <label class="form-label mb-0">Known cap</label>
<input type="number" name="cap_known" class="form-control"
       placeholder="{{ b.known_max|default:'—' }}">
<small class="text-muted">Current: {{ b.known_max|default:'—' }}</small>
</div>              </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Prepared</label>
<div class="mb-2">
  <label class="form-label mb-0">Prepared cap</label>
<input type="number" name="cap_prepared" class="form-control"
       placeholder="{{ b.prepared_max|default:'—' }}">
<small class="text-muted">Current: {{ b.prepared_max|default:'—' }}</small>
</div>        </div>
                <div class="col-md-4">
                  <label class="form-label form-label-sm">Reason (required)</label>
                  <input class="form-control form-control-sm" name="note" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button class="btn btn-sm btn-outline-primary w-100">Save</button>
                </div>
              </form>
            </details>
          </div>
        {% endif %}

      </div> <!-- /.card-body -->
    </div> <!-- /.card -->
  {% endfor %}
</div> <!-- /#tab-spellcasting -->
{% endif %}
</div> <!-- /.tab-content -->

    </main>
  </div> <!-- /.row -->
</div> <!-- /.container -->
<!-- ===== Shared Override Modal (Formula / Final / Tier) ===== -->
<div class="modal fade" id="overrideModal" tabindex="-1" aria-labelledby="overrideModalLabel" aria-hidden="true">
<div class="modal-dialog">
  <form id="overrideForm" method="post" action="{% url 'characters:character_detail' character.pk %}" class="modal-content">

      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="overrideModalLabel">Edit Override</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="override_submit" value="1">
        <input type="hidden" name="override_key" id="ov_key">

        <div class="mb-2">
          <label class="form-label">Current total</label>
          <input class="form-control form-control-sm" id="ov_calc" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Formula (optional)</label>
          <input class="form-control form-control-sm" name="override_formula" id="ov_formula" placeholder='e.g. "+2" or "base+prof+half+str_mod"'>
          <div class="form-text">Leave blank to clear the formula override.</div>
        </div>

        <div class="mb-2">
          <label class="form-label">Final (optional)</label>
          <input type="number" class="form-control form-control-sm" name="override_final" id="ov_final" placeholder="(number)">
          <div class="form-text">Leave blank to clear the final override.</div>
        </div>

        <div class="mb-2">
          <label class="form-label">Reason (required)</label>
          <input class="form-control form-control-sm" name="override_reason" id="ov_reason" required>
        </div>

        <!-- Tier override section (only for keys starting with "prof:") -->
        <div id="ov_tier_block" class="border-top pt-2 mt-3 d-none">
          <div class="mb-2">
            <label class="form-label">Proficiency Tier</label>
            <select class="form-select form-select-sm" id="ov_tier_select"></select>
            <div class="form-text">Use this to override the **tier** for this statistic.</div>
          </div>
          <div class="d-flex gap-2">
            <input type="hidden" name="prof_code" id="ov_prof_code">
            <input type="hidden" name="prof_tier_pk" id="ov_prof_tier_pk">
            <input type="hidden" name="prof_tier_reason" id="ov_prof_reason">
            <button type="submit" name="save_prof_tier_override" value="1" class="btn btn-sm btn-outline-primary">
              Save Tier Override
            </button>
            <button type="submit" name="clear_prof_tier_override" value="" id="ov_tier_clear_btn" class="btn btn-sm btn-outline-danger">
              Clear Tier Override
            </button>
          </div>
        </div>

        <!-- Optional debug formula viewer -->
        <div class="mt-3">
          <div id="ov_debug"></div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary">Save Formula / Final</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // Abort gracefully if Bootstrap bundle didn't load
  if (!window.bootstrap) {
    console.error('Bootstrap bundle not loaded; cannot initialize override modal.');
    return;
  }

  // Build Proficiency Levels JSON inline (from context)
  const PROF_LEVELS = [
    {% for pl in proficiency_levels %}
      {"id": {{ pl.id }}, "name": "{{ pl.name|escapejs }}", "bonus": {{ pl.bonus|default:0 }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Define renderDebug to avoid errors and show parts
  function renderDebug(target, data) {
    try {
      if (!data) { target.innerHTML = ""; return; }
      if (typeof data === 'string') data = JSON.parse(data);
      const parts = data.vars || [];
      let html = '<div class="small text-muted"><div><strong>Formula:</strong> ' + (data.formula || '') + '</div>';
      html += '<div><strong>Values:</strong> ' + (data.values || '') + '</div>';
      if (parts.length) {
        html += '<div class="mt-1"><strong>Parts:</strong><ul class="mb-0">';
        for (const p of parts) {
          html += `<li>${(p.name||p.label||p.key||'part')}: ${p.value}${p.note? ' ('+p.note+')':''}</li>`;
        }
        html += '</ul></div>';
      }
      html += '</div>';
      target.innerHTML = html;
    } catch (e) {
      target.innerHTML = '';
    }
  }

  // Bind all ✎ buttons to open the modal (and show Tier block for "prof:*")
  (function(){
    const modalEl = document.getElementById('overrideModal');
    if (!modalEl) return;

    const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
    const keyEl   = document.getElementById('ov_key');
    const calcEl  = document.getElementById('ov_calc');
    const formEl  = document.getElementById('ov_formula');
    const finalEl = document.getElementById('ov_final');
    const reasonEl= document.getElementById('ov_reason');

    // Tier section
    const tierBlock   = document.getElementById('ov_tier_block');
    const tierSelect  = document.getElementById('ov_tier_select');
    const profCodeEl  = document.getElementById('ov_prof_code');
    const profTierPkEl= document.getElementById('ov_prof_tier_pk');
    const profReasonEl= document.getElementById('ov_prof_reason');
    const tierClearBtn= document.getElementById('ov_tier_clear_btn');

    const dbgEl = document.getElementById('ov_debug');

    document.querySelectorAll('.edit-override').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key     = btn.getAttribute('data-key') || '';
        const calc    = btn.getAttribute('data-calc') || '';
        const formula = btn.getAttribute('data-formula') || '';
        const dbgAttr = btn.getAttribute('data-debug') || '';
        const dbgElId = btn.getAttribute('data-debug-el') || '';
        let dbg = dbgAttr;
        if (!dbg && dbgElId) {
          const srcEl = document.getElementById(dbgElId);
          if (srcEl) dbg = srcEl.textContent || srcEl.innerText || '';
        }

        keyEl.value   = key;
        calcEl.value  = calc;
        formEl.value  = formula;
        finalEl.value = '';
        reasonEl.value= '';

        renderDebug(dbgEl, dbg);

        if (key.startsWith('prof:')) {
          tierBlock.classList.remove('d-none');
          tierSelect.innerHTML = '<option value="">— Select Tier —</option>' +
            PROF_LEVELS.map(pl => `<option value="${pl.id}">${pl.name} (+${pl.bonus})</option>`).join('');
          const code = key.split(':')[1] || '';
          profCodeEl.value = code;
          profTierPkEl.value = '';
          profReasonEl.value = '';
          tierClearBtn.value = code;
        } else {
          tierBlock.classList.add('d-none');
          profCodeEl.value = '';
          profTierPkEl.value = '';
          profReasonEl.value = '';
          tierClearBtn.value = '';
        }

        tierSelect.onchange = ()=> {
          profTierPkEl.value = tierSelect.value;
          profReasonEl.value = reasonEl.value || '';
        };
        reasonEl.oninput = ()=> {
          if (profCodeEl.value) { profReasonEl.value = reasonEl.value; }
        };

        bsModal.show();
      });
    });
  })();
});
</script>

{# ======= MODALS (unchanged except for context vars already provided) ======= #}

<!-- LEVEL UP MODAL -->
<div class="modal fade" id="levelUpModal" tabindex="-1" aria-labelledby="levelUpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="levelUpModalLabel" class="modal-title">Level Up to {{ total_level|add:"1" }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-0">
        <div class="row g-0">
          <!-- LEFT column: class info / preview -->
          <div class="col-12 col-xl-5 p-4 border-end">
            <form method="get"
                  action="{% url 'characters:character_detail' character.pk %}#levelUpModal"
                  class="mb-4">
              {{ form.base_class }}
            </form>

            <div class="mb-3">
              <h6 class="mb-2">Description</h6>
              {% if preview_class.description %}
                <div class="text-muted summernote-content">{{ preview_class.description|safe }}</div>
              {% else %}
                <div class="text-muted"><em>—</em></div>
              {% endif %}
            </div>

            <div class="mb-3 small text-muted">
              <div><strong>Hit Die:</strong> d{{ preview_class.hit_die }}</div>
              <div>
                <strong>Key Abilities:</strong>
                {% for a in preview_class.key_abilities.all %}
                  {{ a.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </div>
            </div>

            <div class="mb-3">
              <h6 class="mb-2">Proficiencies</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Type</th>
                      {% for tn in tier_names %}<th>{{ tn }}</th>{% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in proficiency_rows %}
                      <tr>
                        <td>{{ row.type }}</td>
                        {% for lvl in row.levels %}
                          <td>{{ lvl }}</td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mb-3">
              <h6 class="mb-2">Features at L{{ total_level|add:"1" }}</h6>
              <ul class="mb-0 ps-3">
                {% for f in auto_feats %}
                  <li class="mb-2">
                    {% if f.kind == "spell_table" and f.spell_row_next %}
                      <div class="table-responsive mt-2">
                        <table class="table table-sm table-bordered w-auto">
                          <thead>
                            <tr>
                              <th class="text-nowrap">Level</th>
                              {% for _ in "0123456789"|make_list %}<th>{{ forloop.counter }}</th>{% endfor %}
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td class="text-nowrap">Slots</td>
                              <td>{{ f.spell_row_next.slot1 }}</td>
                              <td>{{ f.spell_row_next.slot2 }}</td>
                              <td>{{ f.spell_row_next.slot3 }}</td>
                              <td>{{ f.spell_row_next.slot4 }}</td>
                              <td>{{ f.spell_row_next.slot5 }}</td>
                              <td>{{ f.spell_row_next.slot6 }}</td>
                              <td>{{ f.spell_row_next.slot7 }}</td>
                              <td>{{ f.spell_row_next.slot8 }}</td>
                              <td>{{ f.spell_row_next.slot9 }}</td>
                              <td>{{ f.spell_row_next.slot10 }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    {% endif %}

                    <div class="mt-2">
                      {% include "partials/_feature_detail.html" with f=f %}
                    </div>
                  </li>
                {% empty %}
                  <li><em>None</em></li>
                {% endfor %}
              </ul>
            </div>


          </div> <!-- /LEFT -->

            <div class="col-12 col-xl-7 p-4 position-relative" id="levelUpFormCol"><!-- RIGHT: form -->
              <form method="post" action="{% url 'characters:character_detail' character.pk %}">
                {% csrf_token %}
  {% if show_starting_skill_picker %}
    {% with sc=starting_skill_choices %}
      {% if sc.skills or sc.subskills %}
<div class="card skill-picker mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span class="fw-semibold">Starting Skills (Level 1)</span>
    <small class="text-muted">
      <span id="ss-count">0</span>/<span id="ss-max">{{ starting_skill_max|default:0 }}</span> selected
    </small>
  </div>

  <div class="card-body p-0">
    <div class="skill-toolbar p-2">
      <input type="text" class="form-control form-control-sm" placeholder="Filter skills…" id="ss-filter">
    </div>

    <div class="skill-list" id="startingSkillList">
      {% for s in starting_skill_flat %}
        <label class="skill-item">
          <input type="checkbox"
                 class="form-check-input skill-checkbox"
                 name="starting_skill_picks"
                 value="{{ s.id_key }}">
          <span class="skill-label">{{ s.label }}</span>
        </label>
      {% empty %}
        <div class="p-3 text-muted">No available skills.</div>
      {% endfor %}
    </div>
  </div>

  <div class="card-footer">
    <div class="form-text">
      Choose up to <strong>{{ starting_skill_max|default:0 }}</strong> total.
    </div>
  </div>
</div>
      {% endif %}
    {% endwith %}
  {% endif %}


                <input type="hidden" name="base_class" value="{{ form.base_class.value }}">

                {% if form.general_feat %}
                  <div class="mb-3">
                    <label class="form-label">{{ form.general_feat.label }}</label>
                    <input type="text" id="general-feat-filter" class="form-control mb-2" placeholder="Filter feats…">
                    <table id="general-feats-table" class="table table-bordered">
                      <thead>
                        <tr>
                          <th></th>
                          <th data-sort="1">Feat</th>
                          <th data-sort="2">Description</th>
                          <th data-sort="3">Level</th>
                          <th data-sort="4">
                            Requirements
<div class="dropdown d-inline ms-1" data-bs-auto-close="outside">                          
  <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown" data-bs-display="static">▾</button>
                          <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                        </div>

                          </th>
                          <th data-sort="5">
                            Tags
                      <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                        <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown" data-bs-display="static">▾</button>
                        <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                      </div>

                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for feat in form.general_feat.field.queryset %}
                          <tr>
                            <td>
                              <input
                                type="radio"
                                name="{{ form.general_feat.html_name }}"
                                value="{{ feat.pk }}"
                                {% if form.general_feat.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                                {% if form.general_feat.field.required %}required{% endif %}
                              >
                            </td>
                            <td class="feat-name">{{ feat.name }}</td>
                            <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
                            <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                            <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                            <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    {% for err in form.general_feat.errors %}
                      <div class="text-danger">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if form.asi_mode %}
                  <div class="mb-4">
                    <label class="form-label d-block">Ability Score Increase</label>

                    <input type="hidden" name="{{ form.asi_mode.html_name }}" id="id_asi_mode" value="{{ form.asi_mode.value|default:'' }}">
                    <input type="hidden" name="{{ form.asi_a.html_name }}"    id="id_asi_a"    value="{{ form.asi_a.value|default:'' }}">
                    <input type="hidden" name="{{ form.asi_b.html_name }}"    id="id_asi_b"    value="{{ form.asi_b.value|default:'' }}">

                    <div class="table-responsive">
                      <table class="table table-bordered align-middle" id="asi-table">
                        <thead>
                          <tr>
                            <th>Ability</th>
                            <th>Current</th>
                            <th>+1</th>
                            <th>+1</th>
                            <th>Result</th>
                          </tr>
                        </thead>
                        <tbody>
                        {% for label,val in ability_map.items %}
                          {% with key=label|lower %}
                          <tr data-key="{{ key }}" data-base="{{ val }}">
                            <td class="fw-semibold">{{ label }}</td>
                            <td class="asi-current">{{ val }}</td>
                            <td class="text-center">
                              <input type="checkbox" class="form-check-input asi-slot" data-slot="A" aria-label="+1 Slot A to {{ label }}">
                            </td>
                            <td class="text-center">
                              <input type="checkbox" class="form-check-input asi-slot" data-slot="B" aria-label="+1 Slot B to {{ label }}">
                            </td>
                            <td class="asi-result">{{ val }}</td>
                          </tr>
                          {% endwith %}
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>

                    <div class="small" id="asi-help"></div>
                    <div class="small mt-2"><strong>Preview:</strong> <span id="asi-preview">—</span></div>

                    {% for err in form.non_field_errors %}
                      <div class="text-danger mt-2">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if form.class_feat_pick %}
                  <div class="mb-4">
                    <label class="form-label">{{ form.class_feat_pick.label }}</label>
                    <input type="text" id="class-feat-filter" class="form-control mb-2" placeholder="Filter feats…">

                    <table id="class-feats-table" class="table table-bordered">
                      <thead>
                        <tr>
                          <th></th>
                          <th data-sort="1">Feat</th>
                          <th data-sort="2">Description</th>
                          <th data-sort="3">Level</th>
                          <th data-sort="4">
                            Requirements
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                          <th data-sort="5">
                            Tags
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="5" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for feat in form.class_feat_pick.field.queryset %}
                          <tr>
                            <td>
                              <input
                                type="radio"
                                name="{{ form.class_feat_pick.html_name }}"
                                value="{{ feat.pk }}"
                                {% if form.class_feat_pick.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                                {% if form.class_feat_pick.field.required %}required{% endif %}
                              >
                            </td>
                            <td class="feat-name">{{ feat.name }}</td>
                            <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
                            <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                            <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                            <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                          </tr>
                        {% empty %}
                          <tr>
                            <td colspan="6" class="text-muted"><em>No class feats meet your current class/level filters.</em></td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>

                    {% for err in form.class_feat_pick.errors %}
                      <div class="text-danger">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
{# --- Skill Feat picker (supports single or multi-pick) --- #}
{% if form.skill_feat_pick %}
  {% with fld=form.skill_feat_pick %}
    <div class="mb-4">
      <label class="form-label">{{ fld.label }}</label>
      <input type="text" id="skill-feat-filter" class="form-control mb-2" placeholder="Filter skill feats…">

      <table id="skill-feats-table" class="table table-bordered">
        <thead>
          <tr>
            <th></th>
            <th data-sort="1">Feat</th>
            <th data-sort="2">Description</th>
            <th data-sort="3">Level</th>
            <th data-sort="4">Requirements</th>
            <th data-sort="5">Tags</th>
          </tr>
        </thead>
        <tbody>
          {% for feat in fld.field.queryset %}
            <tr>
              <td>
                {% with multi=fld.field.widget.allow_multiple_selected %}
                  <input
                    type="{% if multi %}checkbox{% else %}radio{% endif %}"
                    name="{{ fld.html_name }}"
                    value="{{ feat.pk }}"
                    {% if multi %}
                      {% if fld.value and feat.pk|stringformat:"s" in fld.value %}checked{% endif %}
                    {% else %}
                      {% if fld.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                      {% if fld.field.required %}required{% endif %}
                    {% endif %}
                  >
                {% endwith %}
              </td>
              <td class="feat-name">{{ feat.name }}</td>
              <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
              <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
              <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
              <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-muted"><em>No skill feats available at this level.</em></td></tr>
          {% endfor %}
        </tbody>
      </table>

      {% for err in fld.errors %}
        <div class="text-danger">{{ err }}</div>
      {% endfor %}
    </div>
  {% endwith %}
{% elif form.skill_feat %}
  {% with fld=form.skill_feat %}
    {# same table/body as above, but using fld=form.skill_feat #}
    <div class="mb-4">
      <label class="form-label">{{ fld.label }}</label>
      <input type="text" id="skill-feat-filter" class="form-control mb-2" placeholder="Filter skill feats…">

      <table id="skill-feats-table" class="table table-bordered">
        <thead>
          <tr>
            <th></th>
            <th data-sort="1">Feat</th>
            <th data-sort="2">Description</th>
            <th data-sort="3">Level</th>
            <th data-sort="4">Requirements</th>
            <th data-sort="5">Tags</th>
          </tr>
        </thead>
        <tbody>
          {% for feat in fld.field.queryset %}
            <tr>
              <td>
                {% with multi=fld.field.widget.allow_multiple_selected %}
                  <input
                    type="{% if multi %}checkbox{% else %}radio{% endif %}"
                    name="{{ fld.html_name }}"
                    value="{{ feat.pk }}"
                    {% if multi %}
                      {% if fld.value and feat.pk|stringformat:"s" in fld.value %}checked{% endif %}
                    {% else %}
                      {% if fld.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                      {% if fld.field.required %}required{% endif %}
                    {% endif %}
                  >
                {% endwith %}
              </td>
              <td class="feat-name">{{ feat.name }}</td>
              <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
              <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
              <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
              <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-muted"><em>No skill feats available at this level.</em></td></tr>
          {% endfor %}
        </tbody>
      </table>

      {% for err in fld.errors %}
        <div class="text-danger">{{ err }}</div>
      {% endfor %}
    </div>
  {% endwith %}
{% endif %}



                {# === FEATURE FIELDS LOOP === #}
                {% for item in feature_fields %}
                  {% if item.kind == "subclass_choice" %}
                    <div class="mb-4">
                      <label class="form-label d-block">{{ item.label }}</label>
                      <div class="d-grid gap-2">
                        {% for sc in item.group.subclasses.all %}
                          {% with rid=item.field.id_for_label|add:"_"|add:sc.pk|stringformat:"s" %}
                          <label for="{{ rid }}" class="border rounded p-3 d-flex gap-3 align-items-start">
                            <input
                              type="radio"
                              id="{{ rid }}"
                              name="{{ item.field.name }}"
                              value="{{ sc.pk }}"
                              class="form-check-input mt-1"
                              {% if item.field.value|stringformat:"s" == sc.pk|stringformat:"s" %}checked{% endif %}
                              {% if item.field.field.required %}required{% endif %}
                            />
                            <div class="flex-grow-1">
                              <div class="fw-semibold">{{ sc.name }}</div>
                              {% if sc.description %}
                                <div class="small text-muted mt-1 summernote-content">{{ sc.description|safe }}</div>
                              {% endif %}
                              {% if sc.feats_next %}
                                <div class="small mt-2">
                                  <div class="fw-semibold mb-1">Features at L{{ total_level|add:"1" }}:</div>
                                  <div class="d-grid gap-2">
                                    {% for f in sc.feats_next %}
                                      <div class="border rounded p-2">
                                        {% include "partials/_feature_detail.html" with f=f %}
                                      </div>
                                    {% endfor %}
                                  </div>
                                </div>
                              {% endif %}
                            </div>
                          </label>
                          {% endwith %}
                        {% empty %}
                          <div class="text-muted"><em>No subclasses available.</em></div>
                        {% endfor %}
                      </div>
                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>

                  {% elif item.kind == "option" %}
                    <div class="mb-4">
                      <div class="mb-2 fw-semibold">{{ item.label }}</div>
                      <div class="border rounded p-3 mb-3">
                        {% include "partials/_feature_detail.html" with f=item.feature %}
                      </div>

                      <div class="d-grid gap-2">
                        {% for opt in item.feature.options.all %}
                          {% with radio_id=item.field.id_for_label|add:"_"|add:opt.pk|stringformat:"s" %}
                          <label for="{{ radio_id }}" class="border rounded p-3 d-flex gap-3 align-items-start">
                            <input
                              type="radio"
                              id="{{ radio_id }}"
                              name="{{ item.field.name }}"
                              value="{{ opt.pk }}"
                              class="form-check-input mt-1"
                              {% if item.field.value|stringformat:"s" == opt.pk|stringformat:"s" %}checked{% endif %}
                              {% if item.field.field.required %}required{% endif %}
                            />
                            <div class="flex-grow-1">
                              <div class="fw-semibold">{{ opt.label }}</div>
                              {% if opt.grants_feature %}
                                <div class="mt-2">
                                  {% include "partials/_feature_detail.html" with f=opt.grants_feature %}
                                </div>
                              {% endif %}
                            </div>
                          </label>
                          {% endwith %}
                        {% endfor %}
                      </div>

                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>

                  {% elif item.kind == "gain_subclass_feat" %}
                    <div class="mb-4">
                      <div class="mb-2 fw-semibold">{{ item.label }}</div>

                      {% if item.system == "linear" and not item.subclass %}
                        <div class="alert alert-warning p-2">Pick a subclass above …</div>
                      {% endif %}
                      {% if item.system == "linear" %}
                        <div class="alert alert-info p-2">
                          Linear progression: the following {{ item.group.name }} feature(s) are granted automatically.
                        </div>
                      {% endif %}


                      <div class="d-grid gap-2">
                        {% with selected_vals=item.field.value %}
                          {% for f in item.eligible %}
                            {% with cid=item.field.id_for_label|add:"_"|add:f.pk|stringformat:"s" %}
                            <label for="{{ cid }}" class="border rounded p-3 d-flex gap-3 align-items-start">
                              {% if item.system == "linear" %}
                                <input type="checkbox" id="{{ cid }}" disabled checked class="form-check-input mt-1">
                              {% else %}
                                <input
                                  type="checkbox"
                                  id="{{ cid }}"
                                  name="{{ item.field.name }}"
                                  value="{{ f.pk }}"
                                  class="form-check-input mt-1"
                                  {% if selected_vals and f.pk|stringformat:"s" in selected_vals %}checked{% endif %}
                                >
                              {% endif %}
                              <div class="flex-grow-1">
                                {% include "partials/_feature_detail.html" with f=f %}
                              </div>
                            </label>
                            {% endwith %}
                          {% empty %}
                            <div class="text-muted"><em>No eligible features at this level.</em></div>
                          {% endfor %}
                        {% endwith %}
                      </div>

                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>

                  {% else %}
                    <div class="mb-3">
                      <label class="form-label">{{ item.label }}</label>
                      {{ item.field }}
                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}

                {% endfor %}
                {# === END FEATURE FIELDS LOOP === #}

                <button type="submit" name="level_up_submit" class="btn btn-primary">
                  Confirm Level Up
                </button>
            </form>
          </div> <!-- /RIGHT form -->
        </div> <!-- /.row -->
      </div> <!-- /.modal-body -->
    </div> <!-- /.modal-content -->
  </div> <!-- /.modal-dialog -->
</div> <!-- /LEVEL UP MODAL -->

<!-- EDIT CHARACTER MODAL (unchanged) -->
<div class="modal fade" id="editCharacterModal" tabindex="-1" aria-labelledby="editCharacterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="editCharacterModalLabel" class="modal-title">Edit Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post" action="{% url 'characters:character_detail' character.pk %}">
        {% csrf_token %}
        <div class="modal-body">
          {% if edit_form %}
            {{ edit_form.non_field_errors }}
            <div class="row g-3">
              {% for field in edit_form.visible_fields %}
                <div class="col-md-6">
                  {{ field.label_tag }} {{ field }}
                  {% if field.errors %}
                    <div class="text-danger small">{{ field.errors|join:", " }}</div>
                  {% endif %}
                  <input class="form-control form-control-sm mt-1"
                        name="note__{{ field.name }}"
                        placeholder="Reason (required if changed)">
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="mb-0 text-muted">You don’t have permission to edit this character.</p>
          {% endif %}
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          {% if edit_form %}
            <button type="submit" class="btn btn-primary" name="edit_character_submit" value="1">Save</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>
<!-- QUICK EDIT NUMBER MODAL -->
<div class="modal fade" id="editNumberModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Adjust Value</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editNumberForm">
        <div class="modal-body">
          <input type="hidden" id="edit-key" name="key">
          <div class="mb-2">
            <label class="form-label form-label-sm">New value</label>
            <input type="number" step="1" class="form-control form-control-sm" id="edit-value" required>
          </div>
          <div>
            <label class="form-label form-label-sm">Reason</label>
            <input class="form-control form-control-sm" id="edit-note" placeholder="Why are you changing this?" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary btn-sm">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>





{% endblock %}

{# --- DEBUG BANK USED BY THE OVERRIDE MODAL --- #}
<div class="d-none" id="debug-bank">
  {% for r in defense_rows %}
    <script type="application/json" id="dbg-{{ r.code }}">{{ r.debug_json|safe }}</script>
  {% endfor %}
  {% if spell_dc_rows and spell_dc_rows.0 %}
    <script type="application/json" id="dbg-dc">{{ spell_dc_rows.0.debug_json|safe }}</script>
  {% endif %}
</div>

{% block extra_js %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){
  // 1) Move modals to <body> BEFORE any show() happens
  ['levelUpModal','editCharacterModal','editNumberModal','overrideModal'].forEach(id => {
    const el = document.getElementById(id);
    if (el && el.parentElement !== document.body) document.body.appendChild(el);
  });

  // 2) Auto-open Level Up modal if hash matches (runs AFTER we moved it)
  if (window.location.hash === "#levelUpModal") {
    const el = document.getElementById("levelUpModal");
    bootstrap.Modal.getOrCreateInstance(el).show();
  }
});
</script>

  {{ ability_map|json_script:"abilities-data" }}

  {% if form.asi_mode %}
  <script>
  (function(){
    const dataEl = document.getElementById("abilities-data");
    if (!dataEl) return;
    const base = JSON.parse(dataEl.textContent || "{}");

    const tbl = document.getElementById("asi-table");
    if (!tbl) return;

    const help = document.getElementById("asi-help");
    const preview = document.getElementById("asi-preview");

    const modeInput = document.getElementById("id_asi_mode");
    const aInput    = document.getElementById("id_asi_a");
    const bInput    = document.getElementById("id_asi_b");

    let slotA = aInput?.value || "";
    let slotB = bInput?.value || "";

    function pretty(k){ return k.charAt(0).toUpperCase() + k.slice(1); }
    function getBase(k){ return Number(base[pretty(k)] || 0); }
    function lockToOne(){ return [slotA, slotB].filter(Boolean).some(k => getBase(k) >= 20); }

    function updateUI(){
      ["A","B"].forEach((slot) => {
        tbl.querySelectorAll('input.asi-slot[data-slot="'+slot+'"]').forEach((bx)=>{
          const key = bx.closest("tr").dataset.key;
          if (slot === "A") bx.checked = (key === slotA);
          if (slot === "B") bx.checked = (key === slotB);
        });
      });

      const oneOnly = lockToOne();
      const bBoxes = tbl.querySelectorAll('input.asi-slot[data-slot="B"]');
      if (oneOnly) {
        if (slotA && slotB) slotB = "";
        bBoxes.forEach(bx => bx.disabled = true);
        help.innerHTML = '<span class="text-warning">One chosen ability is 20+, so only a single +1 may be applied.</span>';
      } else {
        bBoxes.forEach(bx => bx.disabled = false);
        help.textContent = '';
      }

      tbl.querySelectorAll("tbody tr").forEach(tr => {
        const key = tr.dataset.key;
        const before = Number(tr.dataset.base);
        let inc = 0;
        if (slotA === key) inc += 1;
        if (slotB === key) inc += 1;
        tr.querySelector(".asi-result").textContent = before + inc;
        tr.classList.remove("table-success","table-warning");
        if (inc === 2) tr.classList.add("table-success");
        if (inc === 1) tr.classList.add("table-warning");
      });

      let mode = "";
      if (slotA && slotB) mode = (slotA === slotB) ? "2" : "1+1";
      else if (slotA || slotB) mode = "1";
      if (oneOnly && mode !== "1") { slotB = ""; mode = "1"; }

      modeInput.value = mode;
      aInput.value    = slotA || slotB || "";
      bInput.value    = (mode === "1+1" || mode === "2") ? (slotB || slotA) : "";

      function upText(k, inc){ return `${pretty(k)}: ${getBase(k)} → ${getBase(k)+inc}`; }
      let txt = "—";
      if (mode === "2")       txt = upText(slotA, 2);
      else if (mode === "1+1")txt = `${upText(slotA,1)}; ${upText(slotB,1)}`;
      else if (mode === "1")  txt = upText(slotA || slotB, 1);
      preview.textContent = txt;
    }

    tbl.addEventListener("change", (e) => {
      const box = e.target;
      if (!box.matches(".asi-slot")) return;
      const slot = box.dataset.slot;
      const key  = box.closest("tr").dataset.key;
      if (slot === "A") slotA = box.checked ? key : (slotA === key ? "" : slotA);
      else              slotB = box.checked ? key : (slotB === key ? "" : slotB);
      if (lockToOne() && slotA && slotB) {
        if (slot === "A") slotB = ""; else slotA = "";
      }
      updateUI();
    });

    updateUI();
  })();
  </script>
  {% endif %}
<script>
(function(){
  const btn = document.getElementById('toggle-details-edit');
  const target = document.getElementById('detailsEdit');
  if (!btn || !target) return;
  const inst = bootstrap.Collapse.getOrCreateInstance(target, { toggle: false });
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    inst.toggle();
  });
})();
</script>

  <script>
  (function(){
window.initFeatTable = function(opts){

  var table = document.getElementById(opts.tableId);
  if (!table) return;

  function cellText(row, idx){ var c=row.cells[idx]; return (c?c.textContent:"").trim(); }
  table.querySelectorAll("th[data-sort]").forEach(function(th){
    th.style.cursor = "pointer";
    th.addEventListener("click", function(){
      var col = parseInt(th.getAttribute("data-sort"), 10);
      var asc = th.getAttribute("data-order") !== "asc";
      th.setAttribute("data-order", asc ? "asc" : "desc");
      var rows = Array.from(table.tBodies[0].rows).filter(function(r,i){ return !r.classList.contains("desc-body"); });
      rows.sort(function(a,b){
        var A = cellText(a, col).toLowerCase(), B = cellText(b, col).toLowerCase();
        return asc ? A.localeCompare(B, undefined, {numeric:true}) : B.localeCompare(A, undefined, {numeric:true});
      });
      // keep each details row just after its data row
      rows.forEach(function(r){
        var detail = r.nextElementSibling && r.nextElementSibling.classList.contains("desc-body") ? r.nextElementSibling : null;
        table.tBodies[0].appendChild(r);
        if (detail) table.tBodies[0].appendChild(detail);
      });
    });
  });

  var BLANK="(Blanks)";
  function splitTokens(txt){ return txt.split(/[,;/]/).map(function(s){return s.trim();}).filter(Boolean); }

  // Build dropdown menu lists
  function uniqueValuesForCol(colIdx, splitByTokens){
    var set = new Set();
    Array.from(table.tBodies[0].rows).forEach(function(r){
      if (r.classList.contains("desc-body")) return;
      var txt = cellText(r, colIdx);
      if (!txt) set.add(BLANK);
      else if (splitByTokens){ splitTokens(txt).forEach(function(tok){ set.add(tok); }); }
      else set.add(txt);
    });
    return Array.from(set).sort(function(a,b){ return a.localeCompare(b, undefined, {numeric:true}); });
  }

  var dropdownFilters = [];  // [{col, split, selected, enabled}]
  function buildFilterMenu(menuEl){
    var col   = parseInt(menuEl.dataset.col, 10);
    var split = menuEl.dataset.split === "1";
    var values = uniqueValuesForCol(col, split);

    menuEl.innerHTML = [
      '<div class="d-flex justify-content-between small mb-2">',
      '  <a href="#" class="excel-sel-all">Select all</a>',
      '  <a href="#" class="excel-clear">Clear</a>',
      '</div>',
      '<input type="text" class="form-control form-control-sm mb-2 excel-search" placeholder="Search values…">',
      '<div class="excel-list" style="max-height:220px; overflow:auto;"></div>',
      '<div class="d-flex justify-content-end gap-2 mt-2">',
      '  <button type="button" class="btn btn-sm btn-outline-secondary excel-cancel">Cancel</button>',
      '  <button type="button" class="btn btn-sm btn-success excel-ok">OK</button>',
      '</div>'
    ].join("");

    var list = menuEl.querySelector(".excel-list");
    function renderList(filter){
      list.innerHTML = "";
      values.forEach(function(v){
        if (filter && v.toLowerCase().indexOf(filter.toLowerCase()) === -1) return;
        var id = "excel_"+opts.tableId+"_"+col+"_"+btoa(unescape(encodeURIComponent(v))).replace(/=/g,'');
        var div = document.createElement("div");
        div.className = "form-check";
        div.innerHTML = '<input class="form-check-input" type="checkbox" id="'+id+'" value="'+v+'" checked>' +
                        '<label class="form-check-label small" for="'+id+'">'+v+'</label>';
        list.appendChild(div);
      });
    }
    renderList("");

    menuEl.querySelector(".excel-search").addEventListener("input", function(){ renderList(this.value.trim()); });
    menuEl.addEventListener("click", function(e){
      if (e.target.matches(".excel-sel-all")){ e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true); applyAllFilters(); }
      if (e.target.matches(".excel-clear"))  { e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); applyAllFilters(); }
      if (e.target.matches(".excel-ok,.excel-cancel")){
        var dd = bootstrap.Dropdown.getOrCreateInstance(menuEl.parentElement.querySelector('[data-bs-toggle="dropdown"]'));
        dd.hide();
      }
    });
    list.addEventListener("change", applyAllFilters);

    menuEl.dataset.ready = "1";
    dropdownFilters.push({col: col, split: split, selected: function(){
      return Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(function(cb){ return cb.value; });
    }});
  }

  table.querySelectorAll(".excel-menu[data-col]").forEach(buildFilterMenu);

  // Per-column text search
  var textFilters = {}; // {col -> lowercased substring}
  table.querySelectorAll(".col-search").forEach(function(inp){
    var col = parseInt(inp.dataset.col, 10);
    textFilters[col] = "";
    inp.addEventListener("input", function(){
      textFilters[col] = (inp.value || "").trim().toLowerCase();
      applyAllFilters();
    });
  });

  function matchesDropdowns(row){
    var show = true;
    dropdownFilters.forEach(function(f){
      if (!show) return;
      var txt = cellText(row, f.col);
      var tokens = (!txt) ? [BLANK] : (f.split ? splitTokens(txt) : [txt]);
      var selected = f.selected();
      // if a menu exists, and nothing is selected, hide all
      if (table.querySelector('.excel-menu[data-col="'+f.col+'"]')) {
        if (selected.length === 0) { show = false; return; }
        show = tokens.some(function(tok){ return selected.indexOf(tok) !== -1; });
      }
    });
    return show;
  }

  function matchesText(row){
    for (var col in textFilters){
      var q = textFilters[col];
      if (!q) continue;
      var txt = cellText(row, parseInt(col,10)).toLowerCase();
      if (txt.indexOf(q) === -1) return false;
    }
    return true;
  }

  function applyAllFilters(){
    Array.from(table.tBodies[0].rows).forEach(function(row){
      if (row.classList.contains("desc-body")) return;
      var ok = matchesDropdowns(row) && matchesText(row);
      row.style.display = ok ? "" : "none";
      var detail = row.nextElementSibling;
      if (detail && detail.classList.contains("desc-body")) {
        // hide details row if master row hidden
        detail.style.display = ok ? detail.style.display : "none";
      }
    });
  }

  // radio highlight (if any radios exist inside)
  table.addEventListener("change", function(e){
    if (e.target.type === "radio") {
      table.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("is-active"));
      e.target.closest("tr").classList.add("is-active");
    }
  });

  // initial filter pass
  applyAllFilters();
}

  initFeatTable({ tableId: "general-feats-table", searchId: "general-feat-filter" });
  initFeatTable({ tableId: "class-feats-table",   searchId: "class-feat-filter"   });
})();
  </script>

  <script>
    
  (function(){
    const modalEl = document.getElementById('editNumberModal');
    if (!modalEl) return;
    const form = document.getElementById('editNumberForm');
    const keyInput = document.getElementById('edit-key');
    const valInput = document.getElementById('edit-value');
    const noteInput= document.getElementById('edit-note');
    const bsModal = new bootstrap.Modal(modalEl);

    document.body.addEventListener('click', (e)=>{
      const el = e.target.closest('.editable-number');
      if (!el) return;
      const key = el.getAttribute('data-key');
      const current = el.textContent.trim();
      keyInput.value = key;
      valInput.value = current.replace(/[^\d\.\-]/g,'') || "";
      noteInput.value = "";
      bsModal.show();
    });

function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  const form2 = document.getElementById('overrideForm');
  if (!form2) return;

  form2.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form2);
    try {
      const resp = await fetch(form2.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: fd
      });
      if (!resp.ok) throw new Error('Bad response');
      // success → refresh
      location.reload();
    } catch (err) {
      alert('Failed to save override.');
    }
  });
})();
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.wep-select').forEach(function(sel){
      sel.addEventListener('change', function(){
        if (!window.fetch || !this.dataset.slot) return;
        try {
          const fd = new FormData();
          fd.append('slot', this.dataset.slot);
          fd.append('weapon_id', this.value || '');
          fetch("{% url 'characters:set_weapon_choice' character.pk %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': (document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')||[])[2] || '' },
            body: fd
          }).then(()=>location.reload());
        } catch(e) {}
      });
    });
  });
  </script>


  <script>
(function(){
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  document.addEventListener('click', async function(e){
    const btn = e.target.closest('.toggle-activation');
    if (!btn) return;
    const li  = btn.closest('li');
    const note = li ? (li.querySelector('.act-note')?.value || '') : '';
    const ctype  = btn.getAttribute('data-ctype');
    const objId  = btn.getAttribute('data-obj');
    const active = btn.getAttribute('data-active');
    try{
      const resp = await fetch("{% url 'characters:set_activation' character.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/x-www-form-urlencoded",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: new URLSearchParams({ ctype: ctype, obj: objId, active: active, note: note })
      });
      if (!resp.ok) throw new Error("Bad response");
      // easiest UX: refresh so all three tabs sync state
      window.location.reload();
    } catch(err) {
      alert("Failed to update activation.");
    }
  });
})();
</script>

<script>
(function(){
  // Tabs
  document.querySelectorAll('.tabs').forEach(tabs => {
    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if (!btn || btn.disabled) return;
      const wrap = tabs.parentElement; // card-body
      tabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      wrap.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      const panel = wrap.querySelector(btn.dataset.target);
      if (panel) panel.classList.add('active');
    });
  });

  // Selection caps (cantrip / known overall / prepare per rank)
  function updateCounts(root){
    const canMax = +root.querySelector('[data-role="count-cantrips"]')?.dataset.max || 0;
    const canSel = root.querySelectorAll('.pick-cantrip:checked').length;
    const canLbl = root.querySelector('[data-role="count-cantrips"]');
    if (canLbl){ canLbl.textContent = canSel + ' selected'; }
    root.querySelectorAll('.pick-cantrip:not(:checked)').forEach(cb => cb.disabled = canSel >= canMax && canMax > 0);

    const knMax = +root.querySelector('[data-role="count-known"]')?.dataset.max || 0;
    const knSel = root.querySelectorAll('.pick-known:checked').length;
    const knLbl = root.querySelector('[data-role="count-known"]');
    if (knLbl){ knLbl.textContent = knSel + ' selected'; }
    root.querySelectorAll('.pick-known:not(:checked)').forEach(cb => cb.disabled = knSel >= knMax && knMax > 0);

    root.querySelectorAll('[data-role="count-prepare"]').forEach(lbl => {
      const r = lbl.dataset.rank;
      const pMax = +lbl.dataset.max || 0;
      const pSel = root.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:checked').length;
      lbl.textContent = pSel + ' selected';
      root.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:not(:checked)').forEach(cb => cb.disabled = pSel >= pMax && pMax > 0);
    });
  }

  document.querySelectorAll('.spellcard').forEach(card => {
    card.addEventListener('change', (e) => {
      if (!e.target.matches('.pick-cantrip, .pick-known, .pick-prepare')) return;
      updateCounts(card);
    });
    // initial
    updateCounts(card);
  });
})();
</script>
<script>
(function(){
  // ── Tabs (robust if target panel is missing) ───────────────────────────────
  document.querySelectorAll('.tabs').forEach(tabs => {
    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if (!btn || btn.classList.contains('disabled')) return;
      const wrap = tabs.parentElement;
      tabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const targetSel = btn.getAttribute('data-target');
      wrap.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      if (targetSel) {
        const panel = wrap.querySelector(targetSel);
        if (panel) panel.classList.add('active');
      }
    });
  });

  // ── Helpers ────────────────────────────────────────────────────────────────
  function textOfRow(row){ return row.textContent.toLowerCase(); }
  function wireSearch(input, table){
    if (!input || !table) return;
    input.addEventListener('input', () => {
      const q = input.value.trim().toLowerCase();
      table.querySelectorAll('tbody tr').forEach(tr => {
        tr.style.display = (q && !textOfRow(tr).includes(q)) ? 'none' : '';
      });
    });
  }

  // ── Per-feature card logic ────────────────────────────────────────────────
  document.querySelectorAll('.spellcard').forEach(card => {
    const fid = card.dataset.fid;

    // --- Cantrips limit (global per feature) ---
    const cantripBoxes   = card.querySelectorAll('input.pick-cantrip[name="learn_cantrips_'+fid+'"]');
    const cantripMaxEl   = card.querySelector('[data-role="count-cantrips"]');
    const cantripMax     = parseInt(cantripMaxEl?.dataset.max || '0', 10);
    const cantripCounter = cantripMaxEl;

    function enforceCantrips(){
      if (!cantripBoxes.length || !cantripMax) {
        if (cantripCounter) cantripCounter.textContent = '0';
        return;
      }
      const picked = [...cantripBoxes].filter(b => b.checked);
      const over = Math.max(0, picked.length - cantripMax);
      if (over > 0) {
        // uncheck the most recently toggled extras
        picked.slice(-over).forEach(b => { b.checked = false; });
      }
      if (cantripCounter){
        cantripCounter.textContent = Math.min(picked.length, cantripMax);
      }
    }
    cantripBoxes.forEach(b => b.addEventListener('change', enforceCantrips));
    enforceCantrips(); // init

    // --- Known (leveled) limit shared across all ranks for this feature) ---
    const knownBoxes = card.querySelectorAll('input.pick-known[name="learn_known_'+fid+'"]');
    const knownMaxEl = card.querySelector('[data-role="count-known"]');
    const knownMax   = parseInt(knownMaxEl?.dataset.max || '0', 10);

    function enforceKnown(){
      if (!knownBoxes.length) {
        if (knownMaxEl) knownMaxEl.textContent = '0';
        return;
      }
      const picked = [...knownBoxes].filter(b => b.checked);
      if (knownMax > 0 && picked.length > knownMax){
        // uncheck the one the user just turned on (fallback for older browsers)
        let last = null;
        try {
          last = [...knownBoxes].findLast(b => b === document.activeElement || b === document._lastChanged);
        } catch (_e) {
          last = [...knownBoxes].reverse().find(b => b === document.activeElement || b === document._lastChanged);
        }
        (last || picked[picked.length - 1]).checked = false;
      }
      const count = Math.min([...knownBoxes].filter(b => b.checked).length, knownMax || 0);
      if (knownMaxEl) knownMaxEl.textContent = count;
    }
    knownBoxes.forEach(b => {
      b.addEventListener('change', (ev) => { document._lastChanged = ev.target; enforceKnown(); });
    });
    enforceKnown(); // init

    // --- Prepared limits per rank (uses data-rank + per-rank max in data-max) ---
    const prepBoxes = card.querySelectorAll('input.pick-prepare');
    const countersByRank = {};
    card.querySelectorAll('[data-role="count-prepare"]').forEach(el => {
      countersByRank[el.dataset.rank] = { el, max: parseInt(el.dataset.max || '0', 10) };
    });

    function enforcePrepare(ev){
      const t = ev?.target;
      const r = t?.dataset.rank;
      if (!r) return;
      const group = [...prepBoxes].filter(b => b.dataset.rank === r);
      const cap   = countersByRank[r]?.max || 0;
      const picked = group.filter(b => b.checked);
      if (cap > 0 && picked.length > cap){
        (t || picked[picked.length - 1]).checked = false;
      }
      const cnt = Math.min(group.filter(b => b.checked).length, cap);
      if (countersByRank[r]) countersByRank[r].el.textContent = cnt;
    }
    // bind + initialize counts for each rank
    prepBoxes.forEach(b => b.addEventListener('change', enforcePrepare));
    Object.keys(countersByRank).forEach(r => {
      const group = [...prepBoxes].filter(b => b.dataset.rank === r);
      const cap   = countersByRank[r]?.max || 0;
      const cnt   = Math.min(group.filter(b => b.checked).length, cap);
      countersByRank[r].el.textContent = cnt;
    });

    // --- Search boxes wiring ---
    // Cantrips
    wireSearch(
      card.querySelector('#cantrip-filter-'+fid),
      card.querySelector('#cantrips-table-'+fid)
    );
    // Per-level learn tables
    card.querySelectorAll('[id^="learn-filter-'+fid+'-r"]').forEach(input => {
      const tableId = input.id.replace('filter','table');
      wireSearch(input, card.querySelector('#'+tableId));
    });
  });



})();
</script>



<script>
  // Spellcasting tab tables (new)
(function(){
  document.querySelectorAll('table.excel-setup[id^="prep-table-"], table.excel-setup[id^="learned-cantrips-"], table.excel-setup[id^="knownprep-table-"], table.excel-setup[id^="learn-table-"], table.excel-setup[id^="cantrips-table-"]').forEach(function(tbl){
    if (typeof initFeatTable === 'function') initFeatTable({ tableId: tbl.id });
  });
})();

</script>

<script>
(function(){
  function updateFormLimits(form){
    // Cantrips
    const canLbl = form.querySelector('[data-role="count-cantrips"]');
    if (canLbl){
      const max = +canLbl.dataset.max || 0;
      const picked = form.querySelectorAll('.pick-cantrip:checked').length;
      canLbl.textContent = Math.min(picked, max);
      form.querySelectorAll('.pick-cantrip:not(:checked)').forEach(cb => cb.disabled = (max > 0 && picked >= max));
    }
    // Known (leveled)
    const knLbl = form.querySelector('[data-role="count-known"]');
    if (knLbl){
      const max = +knLbl.dataset.max || 0;
      const picked = form.querySelectorAll('.pick-known:checked').length;
      knLbl.textContent = Math.min(picked, max);
      form.querySelectorAll('.pick-known:not(:checked)').forEach(cb => cb.disabled = (max > 0 && picked >= max));
    }
    // Prepare per-rank
    form.querySelectorAll('[data-role="count-prepare"]').forEach(lbl => {
      const r = lbl.dataset.rank;
      const max = +lbl.dataset.max || 0;
      const picked = form.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:checked').length;
      lbl.textContent = Math.min(picked, max);
      form.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:not(:checked)').forEach(cb => cb.disabled = (max > 0 && picked >= max));
    });
  }

  document.querySelectorAll('#tab-spellcasting form').forEach(form => {
    form.addEventListener('change', e => {
      if (!e.target.matches('.pick-cantrip,.pick-known,.pick-prepare')) return;
      updateFormLimits(form);
    });
    // initialize
    updateFormLimits(form);
  });
})();
</script>
<script>
(function(){
  // Force show the skills edit panel and close siblings
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.skill-edit-btn');
    if (!btn) return;

    const targetSel = btn.getAttribute('data-target');
    const panel = document.querySelector(targetSel);
    if (!panel) return;

    const inst = bootstrap.Collapse.getOrCreateInstance(panel, { toggle: false });
    // Close other open panels in the skills accordion
    document.querySelectorAll('#skills-accordion .collapse.show').forEach(el => {
      if (el !== panel) bootstrap.Collapse.getOrCreateInstance(el, { toggle: false }).hide();
    });
    // Now force this one open
    inst.show();

    // Optional: scroll into view so the user sees it immediately
    const row = panel.closest('tr');
    if (row) row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const el = document.getElementById('startingSkillPicks');
  if (!el) return;
  const limit = parseInt(el.dataset.max || '0', 10);
  if (!limit) return; // 0 = unlimited
  el.addEventListener('change', function (e) {
    const picked = Array.from(el.options).filter(o => o.selected);
    if (picked.length > limit) {
      // Unselect the most recently changed option
      e.target.selected = false;
      alert(`You can select up to ${limit} starting skills.`);
    }
  });
});
</script>

<script>
(function () {
  const sel = document.getElementById('startingSkillPicks');
  if (!sel) return;

  // Toggle on simple click
  sel.addEventListener('mousedown', function (e) {
    if (e.target.tagName === 'OPTION') {
      e.preventDefault();
      e.target.selected = !e.target.selected;
      this.dispatchEvent(new Event('change', {bubbles:true}));
    }
  });

  // Enforce the max cap
  sel.addEventListener('change', function () {
    const max = parseInt(this.dataset.max || '0', 10);
    if (!max) return;
    const chosen = Array.from(this.options).filter(o => o.selected);
    if (chosen.length > max) {
      // unselect the oldest one (first in list)
      chosen[0].selected = false;
    }
  });
})();
</script>
<script>
(function () {
  const list   = document.getElementById('startingSkillList');
  const count  = document.getElementById('ss-count');
  const maxEl  = document.getElementById('ss-max');
  const filter = document.getElementById('ss-filter');
  if (!list || !count || !maxEl) return;

  const max = parseInt(maxEl.textContent || '0', 10) || 0;

  function updateCap() {
    const boxes  = list.querySelectorAll('input.skill-checkbox');
    const chosen = list.querySelectorAll('input.skill-checkbox:checked');
    const atCap  = max && chosen.length >= max;
    count.textContent = chosen.length;

    boxes.forEach(cb => {
      const wrap = cb.closest('.skill-item');
      if (!cb.checked) {
        cb.disabled = atCap;
        if (wrap) wrap.classList.toggle('disabled', atCap);
      } else {
        cb.disabled = false;
        if (wrap) wrap.classList.remove('disabled');
      }
    });
  }

  // Toggle on whole-row click
  list.addEventListener('click', e => {
    const row = e.target.closest('.skill-item');
    if (!row) return;
    const cb = row.querySelector('input.skill-checkbox');
    if (e.target !== cb) cb.checked = !cb.checked;
    updateCap();
  });

  list.addEventListener('change', updateCap);

  // Filter
  if (filter) {
    filter.addEventListener('input', () => {
      const q = filter.value.trim().toLowerCase();
      list.querySelectorAll('.skill-item').forEach(row => {
        const text = row.querySelector('.skill-label').textContent.toLowerCase();
        row.style.display = text.includes(q) ? '' : 'none';
      });
    });
  }

  updateCap();
})();
</script>





{% endblock %}


