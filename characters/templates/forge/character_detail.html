{# templates/forge/character_detail.html #}
{% extends "base.html" %}
{% load static %}
{% load ui_extras %}
{% load range_extras %}
{% block extra_css %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css">
  <link rel="stylesheet" href="{% static 'css/character.css' %}">
{% endblock %}

{% block content %}
<style>
  #martial-mastery .mm-head { min-height: 2rem; }
  /* Martial Mastery summary header — keep controls from overlapping columns */
#martial-mastery .mm-head{
  flex-wrap: wrap;          /* allow Reset/✎ to drop to the next line */
  gap: .5rem;               /* keep spacing tidy when wrapped */
  min-height: 2rem;         /* keep your existing height rhythm */
}
#martial-mastery .mm-head form{ display:inline-block; margin:0; }
#martial-mastery .mm-head .btn{ white-space:nowrap; padding:.1rem .5rem; }

  /* Modals on top of everything */
  .modal { z-index: 2000 !important; }
  .modal-backdrop { z-index: 1990 !important; }

  .edit-pill { border: 0; background: transparent; padding: 0 .25rem; font-size: .85rem; color: #6c757d; cursor: pointer; }
  .edit-pill:hover { color: #0d6efd; text-decoration: underline; }

  .summernote-content p{ margin-bottom:.5rem; }
  .summernote-content ul, .summernote-content ol{ padding-left:1.25rem; margin-bottom:.5rem; }
  .summernote-content h1,.summernote-content h2,.summernote-content h3,
  .summernote-content h4,.summernote-content h5,.summernote-content h6{
    margin:.75rem 0 .5rem; font-size:inherit; font-weight:600;
  }
  #resources-bar .r-wrap{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
  #resources-bar .r-pill{display:flex;align-items:center;gap:.5rem;background:var(--bs-gray-100);
    border:1px solid rgba(0,0,0,.1);border-radius:.5rem;padding:.25rem .5rem}
  #resources-bar .r-name{font-weight:600;min-width:0}
  #resources-bar .r-meter{white-space:nowrap;font-variant-numeric:tabular-nums}
  #resources-bar .r-input{width:72px}
  table tbody tr.is-active { outline: 2px solid #0d6efd; }

  #general-feats-table tbody tr.is-selected { background: #fff9db; }
  #general-feats-table tbody tr.is-active { outline: 2px solid #0d6efd; }

  #asi-table tbody tr.table-warning { background: #fff9db; }
  #asi-table tbody tr.table-success { background: #e6ffed; }

  #skills-table { min-width: 720px; }
  #skills-table th, #skills-table td { white-space: nowrap; }
  #skills-table td:first-child { min-width: 220px; }

  /* ── Rebuilt Skills “collapse” (no Bootstrap dependency) ───────────────── */
  #skills-accordion .skill-edit-panel { display: none; }
  #skills-accordion .skill-edit-panel.is-open { display: block; }
  #skills-accordion .skill-edit-panel { padding: .5rem; background: var(--bs-gray-200, #eee); }
  /* Safety: neutralize any leftover Bootstrap state if present */
  #skills-accordion .collapsing { height:auto !important; overflow:visible !important; transition:none !important; }

  /* Details edit: also avoid Bootstrap collapse */


  /* Skill picker */
  .skill-picker .skill-list{max-height:340px;overflow:auto;padding:.25rem .25rem 0}
  .skill-picker .skill-item{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-top:1px solid rgba(0,0,0,.05);cursor:pointer}
  .skill-picker .skill-item:first-child{border-top:0}
  .skill-picker .skill-item:hover{background:rgba(0,0,0,.03)}
  .skill-picker .skill-label{flex:1}
  .skill-picker .skill-item.disabled{opacity:.55;pointer-events:none}
  .skill-toolbar{border-bottom:1px solid rgba(0,0,0,.06)}

/* FIX top gap inside tabs */
.tab-content { padding-top: 0 !important; }
.tab-pane > .card:first-child,
.tab-pane > .card:first-of-type { margin-top: 0 !important; }
/* Resources: keep everything inside the card and wrap nicely */
/* Resources — compact, single-line rows that don't overflow */
#resources-card .list-group-item { padding:.5rem .75rem; }
#resources-card .resource-item { overflow:visible; }
#resources-card .r-grid{
  display:grid;
  grid-template-columns: minmax(0,1fr) auto; /* let name shrink instead of forcing overflow */
  align-items:center;
  column-gap:.5rem;
  row-gap:.25rem;
}


/* a touch slimmer so the name column breathes */
#resources-card .r-input{ width:64px; }

@media (max-width: 540px){
  #resources-card .r-grid{ grid-template-columns: 1fr; }
  #resources-card .r-right{ justify-content:flex-start; }
}



#resources-card .r-name{
  min-width:0;
  white-space:normal;        /* allow wrapping */
  overflow:visible;
  text-overflow:clip;
  word-break:break-word;     /* long tokens wrap */
  hyphens:auto;
}


#resources-card .r-right{
  display:flex;
  align-items:center;
  gap:.5rem;
  flex-wrap:wrap;           /* key: allow wrapping */
  justify-content:flex-end;
  max-width:100%;
}
#resources-card .r-meter{ white-space:nowrap; font-variant-numeric:tabular-nums; }
#resources-card .r-input{ width:72px; max-width:100%; }

#resources-card .r-meter{ white-space:nowrap; font-variant-numeric:tabular-nums; }
#resources-card .btn{ white-space:nowrap; }
#resources-card .r-input{ width:72px; }

/* Slimmer number spinners */
#resources-card input[type=number]::-webkit-outer-spin-button,
#resources-card input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
#resources-card input[type=number]{ -moz-appearance:textfield; }

</style>


{% if messages %}
  {% for m in messages %}
    <div class="alert alert-{{ m.tags|default:'info' }} mb-2">{{ m }}</div>
  {% endfor %}
{% endif %}


<div class="container my-4">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ character.name }}</h1>
    <div>
      <button
        class="btn btn-primary me-2"
        data-bs-toggle="modal"
        data-bs-target="#levelUpModal"
      >Level Up</button>
      <a
        href="{% url 'characters:level_down' character.pk %}"
        class="btn btn-danger {% if total_level == 0 %}disabled{% endif %}"

      >Level Down</a>
      {% if can_share %}
  <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#shareModal">
    Share
  </button>
{% endif %}

    </div>
  </div>

  <div class="row g-4">
    <!-- LEFT: Basics + Ability Scores + quick finals -->
    <aside class="col-lg-3">
      <div class="position-sticky" style="top: 1rem;">
        <!-- Basics -->
        <div class="card p-3 mb-3">
          <h5 class="mb-2">Basics</h5>
          <div><strong>Name:</strong> {{ character.name }}</div>
          <div><strong>Race:</strong> {{ character.race|default:"—" }}</div>
          <div><strong>Subrace:</strong> {{ subrace_name|default:"—" }}</div>
          <div><strong>Level:</strong> {{ total_level }}</div>
  <div class="mt-1">
    <strong>Background:</strong>
    {% if backgrounds.main and backgrounds.main != "—" %}
      {{ backgrounds.main }}
      {% if backgrounds.side1 and backgrounds.side1 != "—" %} · {{ backgrounds.side1 }}{% endif %}
      {% if backgrounds.side2 and backgrounds.side2 != "—" %} · {{ backgrounds.side2 }}{% endif %}
    {% else %}
      —
    {% endif %}
  </div>          <div><strong>Campaign:</strong> {{ character.campaign|default:"—" }}</div>
          <div class="mt-2"><strong>Classes:</strong>
            <ul class="mb-0">
              {% for cp in class_progress %}
                <li>{{ cp.character_class.name }} L{{ cp.levels }}</li>
              {% empty %}
                <li>—</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Ability Scores -->
        <div class="card mb-3">
          <div class="card-header fw-bold">Ability Scores</div>
          <div class="card-body p-0">
            <table class="table mb-0">
              <thead>
                <tr><th>Ability</th><th class="text-end">Score</th><th class="text-end">Mod</th></tr>
              </thead>
              <tbody>
                {% for a in abilities %}
                  <tr>
                    <td>{{ a.label }}</td>
<td class="text-end">
  <span data-ability-score="{{ a.key|lower }}">{{ a.score }}</span>
  {% if can_edit %}
    <button
      class="edit-pill edit-override"
      type="button"
      title="Override ability (formula or final)"
      data-key="ability:{{ a.key }}"
      data-calc="{{ a.score }}"
      data-formula=""
      data-debug-el="">
      ✎
    </button>
  {% endif %}
</td>
<td class="text-end" data-ability-mod="{{ a.key|lower }}">{{ a.mod_str }}</td>

                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Quick finals -->
<div class="card">
  <div class="card-header fw-bold">Core Stats</div>
  <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="mb-0">
    {% csrf_token %}
    <ul class="list-group list-group-flush">

      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>HP</span>
        <span class="d-flex align-items-center gap-2">
          <input name="HP" type="number" class="form-control form-control-sm" style="width:90px"
                 value="{{ hp_current }}" min="0">
          <span>/</span>
          <input name="hp_max" type="number" class="form-control form-control-sm" style="width:90px"
                 value="{{ hp_max }}" min="0">
        </span>
      </li>
<li class="list-group-item">
  <div class="d-flex justify-content-between">
    <span>Speed</span>
    <span class="fw-bold">{{ speed_ctx.total }}</span>
  </div>

  <details class="mt-2">
    <summary>details</summary>
    <div class="mt-2">
      <div>Base:
        <code>
          {{ speed_ctx.base }}
          {% if character.speed is None %}(from race: {{ speed_ctx.race_default }}){% endif %}
        </code>
      </div>

      {% if speed_ctx.deltas %}
      <ul class="mt-2 mb-2">
        {% for m in speed_ctx.deltas %}
        <li>
          <code>{% if m.value >= 0 %}+{% endif %}{{ m.value }}</code>
          <em class="ms-1">{{ m.note }}</em>
          {% if can_edit %}
          <form method="post" class="d-inline" action="{% url 'characters:character_detail' character.pk %}">
            {% csrf_token %}
            <input type="hidden" name="speed_op" value="remove_delta">
            <input type="hidden" name="mod_key" value="{{ m.key }}">
            <button type="submit" class="btn btn-xs btn-link text-danger p-0 ms-2">remove</button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% endif %}

      {% if can_edit %}
      <form method="post" class="row g-2 align-items-end" action="{% url 'characters:character_detail' character.pk %}">
        {% csrf_token %}
        <input type="hidden" name="speed_op" value="add_delta">
        <div class="col-auto">
          <label class="form-label form-label-sm mb-0">Δ</label>
          <input name="delta" type="text" inputmode="numeric" class="form-control form-control-sm" placeholder="+5 or -5" required>
        </div>
        <div class="col">
          <label class="form-label form-label-sm mb-0">Reason</label>
          <input name="note" type="text" class="form-control form-control-sm" placeholder="Haste, armor, etc." required>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-sm btn-outline-primary">Add</button>
        </div>
      </form>
      {% endif %}
    </div>
  </details>
</li>



      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>Temp HP</span>
        <span class="d-flex align-items-center gap-2">
          <input name="temp_HP" type="number" class="form-control form-control-sm" style="width:90px"
                 value="{{ temp_hp|default:0 }}" min="0">
        </span>
      </li>

      <li class="list-group-item d-flex justify-content-end">
        <button class="btn btn-sm btn-primary" name="save_core_stats_submit" value="1">Save</button>
      </li>

<li class="list-group-item d-flex justify-content-between align-items-center">
  <span>Armor</span>
  <span class="d-flex align-items-center gap-2">
    <strong>{{ derived.armor_total }}</strong>
  </span>
</li>


<li class="list-group-item d-flex justify-content-between align-items-center">
  <span>Dodge</span>
  <span class="d-flex align-items-center gap-2">
    <strong>{{ derived.dodge_total }}</strong>
  </span>
</li>


<li class="list-group-item d-flex justify-content-between align-items-center">
  <span>Reflex</span>
  <span class="d-flex align-items-center gap-2">
    <strong>{{ derived.reflex_total }}</strong>
  </span>
</li>

<li class="list-group-item d-flex justify-content-between align-items-center">
  <span>Fortitude</span>
  <span class="d-flex align-items-center gap-2">
    <strong>{{ derived.fortitude_total }}</strong>
  </span>
</li>


<li class="list-group-item d-flex justify-content-between align-items-center">
  <span>Will</span>
  <span class="d-flex align-items-center gap-2">
    <strong>{{ derived.will_total }}</strong>
  </span>
</li>


<li class="list-group-item d-flex justify-content-between align-items-center">
  <span>Perception</span>
  <span class="d-flex align-items-center gap-2">
    <strong>{{ derived.perception_total }}</strong>
  </span>
</li>


<li class="list-group-item d-flex justify-content-between align-items-center">
  <span>Initiative</span>
  <span class="d-flex align-items-center gap-2">
    <strong>{{ derived.initiative_total }}</strong>
  </span>
</li>
<li class="list-group-item d-flex justify-content-between align-items-center">
  <span>Spell/DC</span>
  <span class="d-flex align-items-center gap-2">
    <strong>{{ spell_dc_main|default:"—" }}</strong>
  </span>
</li>


    </ul>
  </form>
</div>

      </div>



    </aside>

    <!-- RIGHT: tabs + panes -->
<main class="col-lg-9">

  <!-- RESOURCES ROW (above tabs) -->
  {% if trackable_resources or can_edit %}
  <div class="card mb-3" id="resources-bar">
    <div class="card-body py-2">
      <div class="r-wrap">
        {% for r in trackable_resources %}
          <div class="r-pill">
            <span class="r-name text-truncate">{{ r.name }}</span>
            <span class="r-meter"><strong>{{ r.cur }}</strong><span class="text-muted"> / {{ r.max }}</span></span>

            {% if can_edit %}
            <form method="post" class="d-inline-flex align-items-center gap-2"
                  action="{% url 'characters:character_detail' character.pk %}">
              {% csrf_token %}
              <input type="hidden" name="resource_op" value="set_current">
              <input type="hidden" name="slug" value="{{ r.slug }}">
              <input name="cur" type="number" class="form-control form-control-sm r-input"
                     value="{{ r.cur }}" min="0" max="{{ r.max }}">
              <button class="btn btn-sm btn-outline-primary">Set</button>
            </form>
            {% endif %}
          </div>
        {% endfor %}

        {% if can_edit %}
        <form method="post" class="d-flex align-items-center gap-2 ms-auto"
              action="{% url 'characters:character_detail' character.pk %}">
          {% csrf_token %}
          <input type="hidden" name="resource_op" value="add">
          <input name="name" class="form-control form-control-sm" placeholder="Name" required style="width:160px">
          <input name="max"  type="number" min="0" class="form-control form-control-sm" placeholder="Max"  required style="width:90px">
          <input name="cur"  type="number" min="0" class="form-control form-control-sm" placeholder="Cur" value="0" style="width:90px">
          <button class="btn btn-sm btn-primary">Add</button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  </ul>
      <ul class="nav nav-tabs" id="sheetTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-details" type="button">Details</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-combat"  type="button">Combat</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-rolls" type="button">Rolls</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-skills"  type="button">Skills</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-feats"   type="button">Feats</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-active"       type="button">Active</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-passive"      type="button">Passive</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-custom" type="button">Custom</button></li>
<li class="nav-item">
  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-notes" type="button">Notes</button>
</li>

<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-all"          type="button">All</button></li>
  <li class="nav-item" role="presentation" {% if not show_martial_mastery_tab %}hidden{% endif %}>
    <button class="nav-link" id="martial-mastery-tab"
            data-bs-toggle="tab" data-bs-target="#martial-mastery"
            type="button" role="tab">
      Martial Mastery
    </button>
  </li>
  <li class="nav-item">
  <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inventory" type="button">
    Inventory
  </button>
</li>


{% if show_spellcasting_tab %}
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-spellcasting" type="button">Spellcasting</button></li>
{% endif %}

      </ul>

      <div class="tab-content pt-3">
        <!-- DETAILS TAB -->
        <div class="tab-pane fade show active" id="tab-details">
<div class="d-flex align-items-center justify-content-between mb-2">
  <h5 class="mb-0">Details</h5>
  {% if can_edit %}
  <button
    class="btn btn-sm btn-outline-secondary"
    type="button"
    data-bs-toggle="modal"
    data-bs-target="#editCharacterModal"
  >
    ✎ Edit
  </button>
  {% endif %}
</div>


<div class="card mb-3">
  <div class="card-header fw-bold">Image</div>
  <div class="card-body">
    {% if character.details_image %}
      <img src="{{ character.details_image.url }}" class="img-fluid rounded mb-2">
    {% else %}
      <div class="text-muted mb-2">No image yet.</div>
    {% endif %}
    {% if can_edit %}
      <form method="post" enctype="multipart/form-data" action="{% url 'characters:character_detail' character.pk %}">
        {% csrf_token %}
        <input type="hidden" name="details_op" value="set_image">
        <div class="row g-2 align-items-end">
          <div class="col-md-8">
            <label class="form-label form-label-sm">Upload image</label>
            <input type="file" name="details_image" accept="image/*" class="form-control form-control-sm">
          </div>
          <div class="col-md-4 d-flex gap-2">
            <button class="btn btn-sm btn-primary">Save</button>
            {% if character.details_image %}
              <button class="btn btn-sm btn-outline-danger" name="clear" value="1">Remove</button>
            {% endif %}
          </div>
        </div>
      </form>
    {% endif %}
  </div>
</div>

{# Always show the read view below; the edit form above is collapsed #}
<div class="mb-4"><h6>Backstory</h6><div class="summernote-view">{{ character.backstory|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Worshipped Gods</h6><div class="summernote-view">{{ character.worshipped_gods|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Believers and ideals</h6><div class="summernote-view">{{ character.believers_and_ideals|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Iconic (Strength)</h6><div class="summernote-view">{{ character.iconic_strengths|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Iconic (Flaws)</h6><div class="summernote-view">{{ character.iconic_flaws|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Bonds/Relationship</h6><div class="summernote-view">{{ character.bonds_relationships|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Ties and Connections</h6><div class="summernote-view">{{ character.ties_connections|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Outlook</h6><div class="summernote-view">{{ character.outlook|safe|default:"—" }}</div></div>
<div class="mb-4"><h6>Appearance</h6><div class="summernote-view">{{ character.apperance|safe|default:"—" }}</div></div>

        </div>

        <!-- COMBAT TAB -->
        <div class="tab-pane fade" id="tab-combat">
          <div class="row g-3">
            <!-- Defense -->
            <div class="col-md-5">
              <div class="card h-100">
                <div class="card-header fw-bold">Defense</div>
                <ul class="list-group list-group-flush">
<li class="list-group-item d-flex justify-content-between"><span>Armor</span><span class="fw-bold">{{ derived.armor_total }}</span></li>
<li class="list-group-item d-flex justify-content-between"><span>Dodge</span><span class="fw-bold">{{ derived.dodge_total  }}</span></li>
<li class="list-group-item d-flex justify-content-between"><span>Reflex</span><span class="fw-bold">{{ defense_totals.Reflex|default:"—" }}</span></li>
<li class="list-group-item d-flex justify-content-between"><span>Fortitude</span><span class="fw-bold">{{ defense_totals.Fortitude|default:"—" }}</span></li>
<li class="list-group-item d-flex justify-content-between align-items-center">
  <span>Speed</span>
  <span class="d-flex align-items-center gap-2">
    <input
      name="speed"
      type="number" min="0" step="1"
      class="form-control form-control-sm" style="width:90px"
      value="{% if character.speed is not None %}{{ character.speed }}{% endif %}"
      placeholder="{{ speed_ctx.race_default }}"
    >
    <small class="text-muted">ft (race: {{ speed_ctx.race_default }})</small>
  </span>
</li>

                </ul>
                <div class="card-body">
                  <form class="d-flex flex-wrap gap-2 align-items-center"
                        method="post" action="{% url 'characters:set_armor_choice' character.pk %}">
                    {% csrf_token %}
                    <label class="me-2 fw-semibold">Armor:</label>
                <select name="armor_id" class="form-select form-select-sm" style="max-width: 420px">
                  <option value="">— No armor —</option>
                  {% for a in armor_list %}
                    <option value="{{ a.id }}"
                            title="{{ a.long_label }}"
                            {% if selected_armor and selected_armor.id == a.id %}selected{% endif %}>
                      {{ a.short_label }}
                    </option>
                  {% endfor %}
                </select>

                    <button class="btn btn-sm btn-outline-primary">Save</button>
                    {% if selected_armor %}
                      <span class="text-muted ms-2">Equipped: {{ selected_armor.name }}</span>
                    {% endif %}
                  </form>
                    <form method="post" action="{% url 'characters:character_detail' character.pk %}"
        class="d-flex flex-wrap gap-2 align-items-center mt-2">
    {% csrf_token %}
    <input type="hidden" name="override_submit" value="1">
    <input type="hidden" name="override_key" value="equipped_shield_id">
    <input type="hidden" name="override_formula" value="">
    <input type="hidden" name="override_reason" value="Equip shield">

    <label class="me-2 fw-semibold">Shield:</label>
<select name="override_final" class="form-select form-select-sm" style="max-width: 420px">
  <option value="">— No shield —</option>
  {% for s in shield_list %}
    <option value="{{ s.id }}"
            title="{{ s.long_label }}"
            {% if selected_shield and selected_shield.id == s.id %}selected{% endif %}>
      {{ s.short_label }}
    </option>
  {% endfor %}
</select>

    <button class="btn btn-sm btn-outline-primary">Save</button>
    {% if selected_shield %}
      <span class="text-muted ms-2">Equipped: {{ selected_shield.name }}</span>
    {% endif %}
  </form>
                </div>
                              <div class="card-body pt-0">
                          

  <h6 class="mt-2 mb-2">Breakdown</h6>
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Type</th>
          <th>Tier</th>
          <th>Formula</th>
          <th>Values</th>
          <th>Total</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody>
        {% for r in defense_rows %}
          <tr id="row-{{ r.type|slugify }}">
            <td>{{ r.type }}</td>
            <td class="text-muted">{{ r.tier }}</td>
            <td class="text-muted">{{ r.formula }}</td>
            <td>{{ r.values }}</td>
            <td class="fw-semibold">{{ r.total_s }}</td>
<td>
  {% note_icon "defense:"|add:r.type %}


<!-- If you later expose group: data-key="prof:weapon:{{ a.group }}" -->
<button
  class="btn btn-sm btn-outline-secondary edit-override"
  type="button"
  data-key="prof:{{ r.code }}"
  data-calc="{{ r.calc.total }}"
  data-formula="{{ r.calc.formula }}"
  data-debug='{{ r.debug_json|safe }}'
>✎</button>



</td>


          </tr>
        {% endfor %}
      </tbody>


      
      </table>
    </div>
  </div>
              </div>


            </div>
<!-- Offense -->
<div class="col-md-7">
  <div class="card h-100">
    <div class="card-header fw-bold">Offense</div>
    <div class="card-body">
      <div class="card-body">

  <!-- Weapon Group Proficiency (edit UX like Skills) -->
<h6 class="mb-2">Weapon Group Proficiencies</h6>
<div class="table-responsive mb-3">
  <table class="table table-sm align-middle w-auto">
    <thead>
      <tr>
        <th>Group</th>
        <th>Tier</th>
        <th>Total (prof)</th>
        <th class="text-end" style="width:120px;">Edit</th>
      </tr>
    </thead>
    <tbody>
      {% for g in weapon_group_display %}
        <tr>
          <td>{{ g.label }}</td>
          <td>{{ g.tier_name|default:"Untrained" }}</td>
          <td>{{ g.modifier|default:0 }}</td>
          <td class="text-end">
<button class="btn btn-sm btn-outline-secondary open-weapon-prof-edit"
        type="button"
        data-wcode="{{ g.code }}"
        data-tpl-id="wpedit-{{ g.code|slugify }}-tpl">Edit</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Hidden templates (one per group) -->
<div class="d-none" id="weapon-prof-edit-templates">
  {% for g in weapon_group_display %}
    <template id="wpedit-{{ g.code|slugify }}-tpl">
      <div class="p-1">
        <div class="p-3 border rounded bg-light">
          <div class="fw-bold mb-2">Proficiency tier — {{ g.label }}</div>
          <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2 align-items-end">
            {% csrf_token %}
            <input type="hidden" name="save_prof_tier_override" value="1">
            <input type="hidden" name="prof_code" value="{{ g.code }}">
            <div class="col-sm-5">
              <label class="form-label small">Tier</label>
              <select class="form-select form-select-sm" name="prof_tier_pk">
                <option value="">— keep current —</option>
                {% for pl in proficiency_tiers %}
                  <option value="{{ pl.id }}">{{ pl.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-5">
              <label class="form-label small">Reason</label>
              <input type="text" class="form-control form-control-sm" name="prof_tier_reason"
                     placeholder="Why are you changing this?">
            </div>
            <div class="col-sm-2 text-end">
              <button class="btn btn-sm btn-success">Save</button>
            </div>
          </form>
        </div>
      </div>
    </template>
  {% endfor %}
</div>


        {% if spell_dc_rows and spell_dc_rows.0 %}
          <div class="mb-3">
            <div>
              <strong>Spell/DC:</strong> {{ spell_dc_rows.0.total }}
            </div>


            <div class="table-responsive mt-2">
              <table class="table table-sm align-middle w-auto">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Formula</th>
                    <th>Values</th>
                    <th>Total</th>
                    <th>Note</th>
                  </tr>
                </thead>
                <tbody>
                  {% for s in spell_dc_rows %}
                    <tr>
                      <td>{{ s.label }}</td>
                      <td class="text-muted">{{ s.formula }}</td>
                      <td>{{ s.values }}</td>
                      <td class="fw-semibold">{{ s.total }}</td>
                      <td>{% note_icon "dc:"|add:s.label %}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}


      <!-- 3 weapon slots (AJAX equip) -->
      <form class="row g-2 align-items-end mb-2">
<div class="col-sm-6">
  <label class="form-label">Primary Weapon</label>
  <select class="form-select form-select-sm wep-select" data-slot="1">
    <option value="" {% if not equipped_weapon_1 %}selected{% endif %}>— none —</option>
    {% if weapons_list %}{% for w in weapons_list %}
      <option value="{{ w.id }}"
              {% if equipped_weapon_1 and equipped_weapon_1.id == w.id %}selected{% endif %}>
        {{ w.name }} ({{ w.damage }})
      </option>
    {% endfor %}{% endif %}
  </select>
</div>

<div class="col-sm-6">
  <label class="form-label">Secondary Weapon</label>
  <select class="form-select form-select-sm wep-select" data-slot="2">
    <option value="" {% if not equipped_weapon_2 %}selected{% endif %}>— none —</option>
    {% if weapons_list %}{% for w in weapons_list %}
      <option value="{{ w.id }}"
              {% if equipped_weapon_2 and equipped_weapon_2.id == w.id %}selected{% endif %}>
        {{ w.name }} ({{ w.damage }})
      </option>
    {% endfor %}{% endif %}
  </select>
</div>

<div class="col-sm-6">
  <label class="form-label">Tertiary Weapon</label>
  <select class="form-select form-select-sm wep-select" data-slot="3">
    <option value="" {% if not equipped_weapon_3 %}selected{% endif %}>— none —</option>
    {% if weapons_list %}{% for w in weapons_list %}
      <option value="{{ w.id }}"
              {% if equipped_weapon_3 and equipped_weapon_3.id == w.id %}selected{% endif %}>
        {{ w.name }} ({{ w.damage }})
      </option>
    {% endfor %}{% endif %}
  </select>
</div>

 
      </form>

      {% if attacks_detailed %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
<thead><tr><th>Slot</th><th>Weapon</th><th>Traits</th><th>Hit</th><th>Damage</th><th>Note</th></tr></thead>
            <tbody>
              {% for a in attacks_detailed %}
                <tr>
                  <td>{{ a.slot }}</td>
                  <td>{{ a.name }} <small class="text-muted">{{ a.damage_die }}</small></td>
                  <td><small>{{ a.traits|join:", " }}</small></td>
<td>
  {% if a.show_choice_hit %}
    {% if a.hit_dex > a.hit_str %}
      +{{ a.hit_dex }} <small class="text-muted">(STR +{{ a.hit_str }})</small>
    {% else %}
      +{{ a.hit_str }} <small class="text-muted">(DEX +{{ a.hit_dex }})</small>
    {% endif %}
  {% else %}
    +{{ a.hit_best|default:a.hit_str }}
  {% endif %}
</td>
<td>
  {% with best=a.dmg_best|default:a.dmg_str %}
    {{ a.damage_die }}{% if best >= 0 %}+{% endif %}{{ best }}
  {% endwith %}
<td>
  {% if a.show_choice_dmg %}
    {% if a.dmg_dex > a.dmg_str %}
      {{ a.damage_die }}+{{ a.dmg_dex }} <small class="text-muted">(STR +{{ a.dmg_str }})</small>
    {% else %}
      {{ a.damage_die }}+{{ a.dmg_str }} <small class="text-muted">(DEX +{{ a.dmg_dex }})</small>
    {% endif %}
  {% else %}
    {{ a.damage_die }}+{{ a.dmg_best|default:a.dmg_str }}
  {% endif %}
</td>

<td>
  {% note_icon "weapon_slot:"|add:a.slot %}
<!-- If you later expose group: data-key="prof:weapon:{{ a.group }}" -->
<button
  class="btn btn-sm btn-outline-secondary edit-override"
  type="button"
  data-key="prof:weapon:{{ a.group }}"   
  data-calc="{{ a.hit_best|default:a.hit_str }}"
  data-formula="prof + ½ level + ability"
  data-debug='{"slot":"{{ a.slot }}","weapon":"{{ a.name|escapejs }}","group":"{{ a.group }}"}'
>✎</button>


</td>
                <tr class="attack-row"
                    data-slot="{{ a.slot }}"
                    data-hit="{{ a.hit_best|default:a.hit_str }}"
                    data-dmg-die="{{ a.damage_die }}">

              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <h6 class="mb-2">Attacks</h6>
        <table class="table table-sm align-middle">
          <thead><tr><th>Type</th><th>Formula</th><th>Values</th><th>Total</th></tr></thead>
          <tbody>
            {% for a in attack_rows %}
              <tr><td>{{ a.label }}</td><td class="text-muted">{{ a.formula }}</td><td>{{ a.values }}</td><td class="fw-semibold">{{ a.total_s }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    </div> <!-- /.card-body -->
  </div> <!-- /.card -->
</div> <!-- /.col-md-7 -->
</div> <!-- /.row -->
</div>

</div>


<!-- ROLLS TAB (Attack → AP derived → Damage) -->
<div class="tab-pane fade" id="tab-rolls">
  <style>
    /* Chips + horizontal layout */
    .chip {display:inline-flex;align-items:center;gap:.4rem;border-radius:999px;padding:.15rem .55rem;font-weight:600;border:1px solid transparent;cursor:default;white-space:nowrap}
    .chip-auto{background:#e8f5e9;border-color:#c8e6c9}
    .chip-cond{background:#e3f2fd;border-color:#bbdefb;cursor:pointer}
    .chip-cond.active{outline:2px solid rgba(25,118,210,.35)}
    .chip .x{cursor:pointer;opacity:.6}
    .chip .x:hover{opacity:1}
    .vr-bucket{display:flex;flex-wrap:wrap;gap:.35rem}
    .form-hint{opacity:.75}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    #roll-log{max-height:220px;overflow:auto}
    .stack-h{display:flex;gap:1rem;flex-wrap:wrap}
    .stack-h>.panel{flex:1 1 320px}
    .panel{border:1px solid rgba(0,0,0,.1);border-radius:.5rem;padding:.75rem}
    .panel h6{margin:0 0 .25rem}
    .soft{opacity:.8}
  </style>

  <div class="d-flex align-items-center justify-content-between mb-2">
    <h5 class="mb-0">Dice Roller — Attack → AP (derived) → Damage</h5>
    <div class="text-muted small">All client-side • saved per character in your browser</div>
  </div>

  <div class="stack-h">
    <!-- ATTACK -->
    <div class="panel">
      <div class="d-flex align-items-center justify-content-between">
        <h6>Attack</h6>
        <div class="d-flex gap-2">
          <button id="btn-sync-combat" class="btn btn-sm btn-outline-secondary">Sync from Combat</button>
          <button id="btn-roll-attack" class="btn btn-sm btn-primary">Roll Attack (d20)</button>
        </div>
      </div>

      <div class="row g-2 mt-1">
        <div class="col-4">
          <label class="form-label form-label-sm mb-0">Base (from Combat)</label>
          <input id="atk-base" type="number" class="form-control form-control-sm" value="0" readonly>
          <div class="form-hint small">Primary weapon’s <strong>Hit</strong></div>
        </div>
        <div class="col-4">
          <label class="form-label form-label-sm mb-0">Last attack total</label>
          <input id="atk-last" type="number" class="form-control form-control-sm" value="0" readonly>
          <div class="form-hint small">Feeds AP automatically</div>
        </div>
        <div class="col-4">
          <label class="form-label form-label-sm mb-0">d20 preview</label>
          <input id="atk-d20" type="number" class="form-control form-control-sm" value="0" readonly>
          <div class="form-hint small">Last die result</div>
        </div>
      </div>

      <div class="mt-2">
        <div class="d-flex align-items-center justify-content-between mb-1">
          <strong class="small mb-0">Variables</strong>
          <span class="small text-muted">Autos always on • Toggle conditionals</span>
        </div>
        <div id="v-attack" class="vr-bucket"></div>

        <form id="add-attack" class="row g-2 mt-2">
          <div class="col-5"><input class="form-control form-control-sm" name="name" placeholder="e.g. High ground" required></div>
          <div class="col-3"><input class="form-control form-control-sm" name="value" type="number" placeholder="+/-" required></div>
          <div class="col-4">
            <select class="form-select form-select-sm" name="kind">
              <option value="auto">Automatic</option>
              <option value="cond">Conditional</option>
            </select>
          </div>
          <div class="col-12 d-grid"><button class="btn btn-sm btn-outline-primary">Add Attack Var</button></div>
        </form>
      </div>
    </div>

    <!-- AP (derived, no roll) -->
    <div class="panel">
      <div class="d-flex align-items-center justify-content-between">
        <h6>Armor Piercing</h6>
        <span class="badge text-bg-secondary">Derived</span>
      </div>

      <div class="row g-2 mt-1">
        <div class="col-6">
          <label class="form-label form-label-sm mb-0">From last Attack</label>
          <input id="ap-source" type="number" class="form-control form-control-sm" value="0" readonly>
          <div class="form-hint small">Kept in sync</div>
        </div>
        <div class="col-6">
          <label class="form-label form-label-sm mb-0">AP Total</label>
          <input id="ap-total" type="number" class="form-control form-control-sm" value="0" readonly>
          <div class="form-hint small">AP = ⌊Attack/2⌋ + AP mods</div>
        </div>
      </div>

      <div class="mt-2">
        <div class="d-flex align-items-center justify-content-between mb-1">
          <strong class="small mb-0">AP Variables</strong>
          <span class="small text-muted">Autos always on • Toggle conditionals</span>
        </div>
        <div id="v-ap" class="vr-bucket"></div>

        <form id="add-ap" class="row g-2 mt-2">
          <div class="col-5"><input class="form-control form-control-sm" name="name" placeholder="e.g. AP Talent" required></div>
          <div class="col-3"><input class="form-control form-control-sm" name="value" type="number" placeholder="+/-" required></div>
          <div class="col-4">
            <select class="form-select form-select-sm" name="kind">
              <option value="auto">Automatic</option>
              <option value="cond">Conditional</option>
            </select>
          </div>
          <div class="col-12 d-grid"><button class="btn btn-sm btn-outline-primary">Add AP Var</button></div>
        </form>
      </div>
    </div>

    <!-- DAMAGE -->
    <div class="panel">
      <div class="d-flex align-items-center justify-content-between">
        <h6>Damage</h6>
        <button id="btn-roll-dmg" class="btn btn-sm btn-primary">Roll Damage</button>
      </div>

      <div class="row g-2 mt-1">
        <div class="col-6">
          <label class="form-label form-label-sm mb-0">Damage dice</label>
          <input id="dmg-dice" class="form-control form-control-sm" placeholder="e.g. 1d8 or 2d6+1" value="1d6">
          <div class="form-hint small">Defaults from Primary weapon</div>
        </div>
        <div class="col-6">
          <label class="form-label form-label-sm mb-0">Flat base (optional)</label>
          <input id="dmg-base" type="number" class="form-control form-control-sm" value="0">
        </div>
      </div>

      <div class="mt-2">
        <div class="d-flex align-items-center justify-content-between mb-1">
          <strong class="small mb-0">Damage Variables</strong>
          <span class="small text-muted">Autos always on • Toggle conditionals</span>
        </div>
        <div id="v-damage" class="vr-bucket"></div>

        <form id="add-damage" class="row g-2 mt-2">
          <div class="col-5"><input class="form-control form-control-sm" name="name" placeholder="e.g. Rage" required></div>
          <div class="col-3"><input class="form-control form-control-sm" name="value" type="number" placeholder="+/-" required></div>
          <div class="col-4">
            <select class="form-select form-select-sm" name="kind">
              <option value="auto">Automatic</option>
              <option value="cond">Conditional</option>
            </select>
          </div>
          <div class="col-12 d-grid"><button class="btn btn-sm btn-outline-primary">Add Damage Var</button></div>
        </form>
      </div>
    </div>
  </div>

  <hr class="my-3">
  <div class="d-flex align-items-center justify-content-between">
    <h6 class="mb-0">Roll Log</h6>
    <div class="d-flex gap-2">
      <button id="clear-log" class="btn btn-sm btn-outline-danger">Clear Log</button>
    </div>
  </div>
  <pre id="roll-log" class="mono mt-2 mb-0"></pre>

  <script>
  (() => {
    // ====== Storage & state ======
    const CHAR_ID = {{ character.pk|default:0 }};
    const STORE_KEY = `lor:rollmods:${CHAR_ID}`;
    const state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if (!raw) return fresh();
        const parsed = JSON.parse(raw);
        return Object.assign(fresh(), parsed);
      } catch(e){ return fresh(); }
    }
    function fresh(){
      return {
        atk: { auto:[], cond:[] },
        ap:  { auto:[], cond:[] },
        dmg: { auto:[], cond:[] },
        base: { atk: 0, dmgDice: "1d6", dmgBase: 0 },
        last: { attackTotal: 0, d20: 0 },
        log: []
      };
    }
    function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
    const el = id => document.getElementById(id);

    // ====== Combat bridge (primary weapon) ======
function parseHitFromRow(row){
  // Prefer data-hit if present (works with your ghost rows)
  if (row && typeof row.dataset?.hit !== 'undefined') {
    const n = Number(row.dataset.hit);
    if (!Number.isNaN(n)) return n;
  }
  // Fallback: 4th cell = "Hit" (e.g. "+9 (STR +7)")
  const cell = row?.querySelector('td:nth-child(4)');
  if (cell){
    const m = cell.textContent.match(/[+-]?\d+/);
    if (m) return Number(m[0]);
  }
  return 0;
}
function parseDiceFromRow(row){
  // Prefer data-dmg-die if present
  if (row?.dataset?.dmgDie) return String(row.dataset.dmgDie);

  // Fallback A: weapon cell's <small> (2nd column)
  const small = row?.querySelector('td:nth-child(2) small');
  if (small){
    const txt = small.textContent.trim();
    const m = txt.match(/\d+d\d+/);
    if (m) return m[0];
  }

  // Fallback B: damage cell (5th column)
  const dmg = row?.querySelector('td:nth-child(5)');
  if (dmg){
    const m = dmg.textContent.match(/\d+d\d+/);
    if (m) return m[0];
  }
  return '1d6';
}

function deriveFromCombat(){
  // Best: explicit ghost row for primary, then any ghost row
  let row =
    document.querySelector('#tab-combat tr.attack-row[data-slot="1"]') ||
    document.querySelector('#tab-combat tr.attack-row');

  // Fallback: first visible row in the Attacks table (identified by headers)
  if (!row){
    const tables = document.querySelectorAll('#tab-combat table');
    for (const t of tables){
      const heads = Array.from(t.querySelectorAll('thead th')).map(th => th.textContent.trim().toLowerCase());
      if (heads.includes('slot') && heads.includes('weapon') && heads.includes('hit') && heads.includes('damage')){
        row = t.querySelector('tbody tr');
        if (row) break;
      }
    }
  }

  const hit  = parseHitFromRow(row);
  const dice = parseDiceFromRow(row);
  return { hit, dice };
}

    // Prime from Combat on load
    (function prime(){
      const d = deriveFromCombat();
      state.base.atk = d.hit;
      if (!state.base.dmgDice || state.base.dmgDice === '1d6') state.base.dmgDice = d.dice;
      save();
    })();

    // ====== Helpers ======
    function sumAuto(bucket){ return (bucket.auto||[]).reduce((a,b)=>a+Number(b.value||0),0); }
    function sumActive(bucket){ return (bucket.cond||[]).filter(v=>v.active).reduce((a,b)=>a+Number(b.value||0),0); }
    function fmt(n){ n=Number(n||0); return (n>=0?'+':'')+n; }
    function rollDie(n){ return Math.floor(Math.random()*n)+1; }
    function rollDiceExpr(expr){
      const m = String(expr||'').replace(/\s+/g,'').match(/^(\d*)d(\d+)([+-]\d+)?$/i);
      if(!m) return { ok:false, err:'Bad dice expression' };
      const N = Math.max(1, parseInt(m[1]||'1',10));
      const M = parseInt(m[2],10);
      const K = m[3] ? parseInt(m[3],10) : 0;
      const rolls = Array.from({length:N}, ()=>rollDie(M));
      const total = rolls.reduce((a,b)=>a+b,0) + K;
      return { ok:true, N, M, K, rolls, total, sumDice: rolls.reduce((a,b)=>a+b,0) };
    }
    function logLine(txt){ state.log.unshift(txt); state.log = state.log.slice(0,200); save(); renderLog(); }
    function renderLog(){ el('roll-log').textContent = state.log.join('\n'); }

    // ====== Chips UI ======
    function makeChip(v, kind, bucketKey){
      const chip = document.createElement('span');
      chip.className = `chip ${kind==='auto'?'chip-auto':'chip-cond'} ${v.active?'active':''}`;
      chip.innerHTML = `
        <span class="name">${v.name}</span>
        <span class="mono">${v.value>=0?'+':''}${Number(v.value)}</span>
        <span class="x" title="Remove">×</span>
      `;
      // toggle active for conditionals
      if (kind === 'cond') {
        chip.addEventListener('click', (e)=>{
          if (e.target.classList.contains('x')) return; // delete handled below
          v.active = !v.active;
          save(); renderBucket(bucketKey);
          if (bucketKey === 'ap') updateAP(); // reflect immediately
        });
      }
      // delete
      chip.querySelector('.x').addEventListener('click', (e)=>{
        e.stopPropagation();
        const list = state[bucketKey][kind];
        const idx = list.findIndex(x=>x.id===v.id);
        if (idx>=0){ list.splice(idx,1); save(); renderBucket(bucketKey); if(bucketKey==='ap') updateAP(); }
      });
      return chip;
    }
    function renderBucket(bucketKey){
      const root = el(`v-${bucketKey}`);
      const b = state[bucketKey];
      root.innerHTML = '';
      if(!(b.auto?.length || b.cond?.length)){
        root.innerHTML = '<div class="small text-muted soft">No variables yet.</div>';
        return;
      }
      // Auto first
      b.auto.forEach(v=>root.appendChild(makeChip(v,'auto',bucketKey)));
      // Then conditionals
      b.cond.forEach(v=>root.appendChild(makeChip(v,'cond',bucketKey)));
      // Tiny totals preview
      const total = sumAuto(b) + sumActive(b);
      const sumEl = document.createElement('div');
      sumEl.className = 'small text-muted mt-1';
      sumEl.textContent = `Sum (auto + active cond): ${total>=0?'+':''}${total}`;
      root.appendChild(sumEl);
    }
    function addVarForm(formId, bucketKey){
      const form = el(formId);
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const name = String(fd.get('name')||'').trim();
        const value = Number(fd.get('value')||0);
        const kind = String(fd.get('kind')||'auto');
        if(!name) return;
        const v = { id: 'v_'+Math.random().toString(36).slice(2,9), name, value };
        if(kind==='auto') state[bucketKey].auto.push(v);
        else state[bucketKey].cond.push(Object.assign(v,{active:true}));
        save(); form.reset(); renderBucket(bucketKey);
        if(bucketKey==='ap') updateAP();
      });
    }

    // ====== Attack roll ======
    function syncFromCombat(){
      const d = deriveFromCombat();
      state.base.atk = Number(d.hit||0);
      if (!state.base.dmgDice || state.base.dmgDice === '1d6') state.base.dmgDice = d.dice || '1d6';
      save();
      el('atk-base').value = state.base.atk;
      el('dmg-dice').value = state.base.dmgDice || '1d6';
      logLine(`[SYNC] Combat → base=${fmt(state.base.atk)}; dmg dice=${state.base.dmgDice}`);
      updateAP();
    }
    el('btn-sync-combat').addEventListener('click', syncFromCombat);

    el('btn-roll-attack').addEventListener('click', ()=>{
      const d20 = rollDie(20);
      const base = Number(state.base.atk||0);
      const auto = sumAuto(state.atk);
      const cond = sumActive(state.atk);
      const total = d20 + base + auto + cond;

      state.last.d20 = d20;
      state.last.attackTotal = total;
      save();

      el('atk-d20').value = d20;
      el('atk-last').value = total;
      el('ap-source').value = total;

      updateAP();

      logLine(`[ATTACK] d20=${d20}  base=${fmt(base)}  auto=${fmt(auto)}  cond=${fmt(cond)}  => total=${total}`);
    });

    // ====== AP (derived) ======
    function updateAP(){
      const src = Number(state.last.attackTotal||0);
      el('ap-source').value = src;
      const baseAP = Math.floor(src/2);
      const auto = sumAuto(state.ap);
      const cond = sumActive(state.ap);
      const total = baseAP + auto + cond;
      el('ap-total').value = total;
    }

    // ====== Damage roll ======
    el('btn-roll-dmg').addEventListener('click', ()=>{
      const expr = (el('dmg-dice').value||'1d6').trim();
      const base = Number(el('dmg-base').value||0);
      state.base.dmgDice = expr;
      state.base.dmgBase = base;
      save();

      const r = rollDiceExpr(expr);
      if(!r.ok){ logLine(`[DMG] ⚠ Bad dice expression: "${expr}"`); return; }

      const auto = sumAuto(state.dmg);
      const cond = sumActive(state.dmg);
      const total = r.total + base + auto + cond;

      logLine(`[DMG] ${r.N}d${r.M}${r.K? (r.K>=0?`+${r.K}`:r.K):''} rolls=${JSON.stringify(r.rolls)} sum=${r.sumDice}${r.K? (r.K>=0?`+${r.K}`:r.K):''}  base=${fmt(base)}  auto=${fmt(auto)}  cond=${fmt(cond)}  => total=${total}`);
    });

    // ====== Init render ======
    // Load primitives
    el('atk-base').value = state.base.atk || 0;
    el('atk-last').value = state.last.attackTotal || 0;
    el('atk-d20').value  = state.last.d20 || 0;
    el('ap-source').value = state.last.attackTotal || 0;
    el('dmg-dice').value = state.base.dmgDice || '1d6';
    el('dmg-base').value = state.base.dmgBase || 0;

    addVarForm('add-attack', 'atk');
    addVarForm('add-ap', 'ap');
    addVarForm('add-damage', 'dmg');

    renderBucket('atk');
    renderBucket('ap');
    renderBucket('dmg');
    updateAP();
    renderLog();

    // Clear log
    el('clear-log').addEventListener('click', ()=>{ state.log = []; save(); renderLog(); });

    // Re-sync shortly after weapon selects change (covers AJAX rerenders)
    document.querySelectorAll('.wep-select').forEach(sel=>{
      sel.addEventListener('change', ()=> setTimeout(syncFromCombat, 80));
    });

    // Also re-sync when switching to Combat or Rolls tabs (in case DOM updates while hidden)
    document.addEventListener('shown.bs.tab', (e)=>{
      const t = e.target?.getAttribute('data-bs-target');
      if (t === '#tab-combat' || t === '#tab-rolls') {
        setTimeout(syncFromCombat, 80);
      }
    });

    // Final safety: if base looks zero but combat has a value, sync on first render
    if (Number(state.base.atk || 0) === 0) {
      setTimeout(syncFromCombat, 0);
    }
  })();
  </script>

</div>
<!-- /ROLLS TAB -->

        <!-- SKILLS TAB -->
{# --- SKILLS TAB (minimal) --- #}
<div class="tab-pane fade" id="tab-skills">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h5 class="mb-0">Skills</h5>
    <span class="badge text-bg-dark">Skill Points: {{ skill_points_balance|default:0 }}</span>
  </div>



    {% if skill_prof_errors and skill_prof_errors|length %}
      <div class="alert alert-danger p-2">
        Please provide a reason for changing: {{ skill_prof_errors|join:", " }}.
      </div>
    {% endif %}




      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Skill</th>
              <th>Ability</th>
              <th>Tier</th>
              <th>Total</th>
<th class="text-end" style="width:160px;">Spend SP</th>
<th class="text-end" style="width:120px;">Edit</th>            
</tr>
          </thead>
          <tbody id="skills-accordion">

            {% for row in skills_rows %}
              {# display row #}
              <tr>
                <td>{{ row.label }}</td>
                <td>
                  {{ row.ability1 }}{% if row.ability2 %} / {{ row.ability2 }}{% endif %}
                </td>
                <td>
                  {{ row.prof_name }}
                  <small class="text-muted">
                    ({% if row.prof_bonus >= 0 %}+{% endif %}{{ row.prof_bonus }})
                  </small>
                </td>
<td>
  {% if row.total2 is not None %}
    {% if row.total1 >= row.total2 %}{{ row.total1 }}{% else %}{{ row.total2 }}{% endif %}
  {% else %}
    {{ row.total1 }}
  {% endif %}

  {% if row.adjustment %}
    <small class="text-muted ms-1">
      {% if row.adjustment >= 0 %}+{% endif %}{{ row.adjustment }}
      {% if row.adjustment_reason %} ({{ row.adjustment_reason }}){% endif %}
    </small>
  {% endif %}

  {% note_icon "skill_delta:"|add:row.id_key %}
</td>
<td class="text-end" style="min-width:190px">
  <div class="d-inline-flex gap-1">
    {% if can_edit and row.next_tier and row.can_reach_next_now and skill_points_balance|default:0 >= row.upgrade_cost %}
      <form method="post" action="{% url 'characters:character_detail' character.pk %}">
        {% csrf_token %}
        <input type="hidden" name="skills_op" value="upgrade_tier">
        <input type="hidden" name="id_key" value="{{ row.id_key }}">
        <button class="btn btn-sm btn-primary">Upgrade</button>
      </form>
    {% elif row.next_tier %}
      <button class="btn btn-sm btn-secondary" disabled title="Need L{{ row.min_level_for_next }} or {{ row.upgrade_cost }} SP">
        Upgrade
      </button>
    {% endif %}

    {% if can_edit and row.can_retrain %}
      <form method="post" action="{% url 'characters:character_detail' character.pk %}">
        {% csrf_token %}
        <input type="hidden" name="skills_op" value="retrain_tier">
        <input type="hidden" name="id_key" value="{{ row.id_key }}">
        <button class="btn btn-sm btn-outline-danger"
                title="Refund preview: {{ row.refund_preview }} SP">
          Retrain
        </button>
      </form>
    {% endif %}
  </div>

  {% if row.prof_history %}
    <div class="text-muted small mt-1">
      {% for h in row.prof_history|slice:":2" %}
        <div>• {{ h }}</div>
      {% endfor %}
    </div>
  {% endif %}
</td>

{% with sid=row.id_key|slugify %}
<td class="text-end">
  <button
    class="btn btn-sm btn-outline-secondary open-skill-edit"
    type="button"
    data-sid="{{ sid }}"
  >
    Edit
  </button>
</td>
{% endwith %}

              </tr>







            {% endfor %}
          </tbody>
        </table>
<!-- Skill edit templates (one per row), kept outside the table -->
<div class="d-none" id="skill-edit-templates">
  {% for row in skills_rows %}
{% with sid=row.id_key|slugify %}
      <template id="skedit-{{ sid }}-tpl">
        <div class="p-1">
          <div class="p-3 border rounded bg-light">

            <!-- (1) Current formula used (primary & secondary), including applied changes -->
            <div class="mb-3">
              <div class="fw-bold mb-1">Current formula used</div>
              <div class="small text-muted">This mirrors Combat’s calculation.</div>

              <div class="mt-2">
                <div><strong>{{ row.label }}</strong></div>

                <div class="mt-1">
                  <div><em>Primary</em> — {{ row.formula1 }} <span class="text-muted">= {{ row.values1 }}</span></div>
                  <div class="mt-1"><strong>Total:</strong> {{ row.total1 }}</div>
                </div>

                {% if row.ability2 %}
                <div class="mt-2">
                  <div><em>Secondary</em> — {{ row.formula2 }} <span class="text-muted">= {{ row.values2 }}</span></div>
                  <div class="mt-1"><strong>Total:</strong> {{ row.total2 }}</div>
                </div>
                {% endif %}
              </div>

              {% if row.modifications and row.modifications|length %}
                <div class="mt-3">
                  <div class="fw-bold">Past adjustments</div>
                  <ul class="mb-2">
                    {% for m in row.modifications %}
                      <li>
                        {{ m.value|floatformat:0 }}{% if m.note %} ({{ m.note }}){% endif %}
                        <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="d-inline">
                          {% csrf_token %}
                          <input type="hidden" name="skills_op" value="remove_delta">
                          <input type="hidden" name="mod_key" value="{{ m.key }}">
                          <button class="btn btn-link btn-sm text-danger p-0 ms-2"
                                  onclick="return confirm('Remove this adjustment?')">remove</button>
                        </form>
                      </li>
                    {% endfor %}
                  </ul>

                  <form method="post" action="{% url 'characters:character_detail' character.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="skills_op" value="clear_deltas">
                    <input type="hidden" name="id_key" value="{{ row.id_key }}">
                    <button class="btn btn-sm btn-outline-danger">Clear all adjustments</button>
                  </form>
                </div>
              {% endif %}
            </div>

            <!-- (3) Add modification to formula -->
            <div class="mb-4">
              <div class="fw-bold mb-1">Add modification to formula</div>
              <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2">
                {% csrf_token %}
                <input type="hidden" name="skills_op" value="add_delta">
                <input type="hidden" name="id_key" value="{{ row.id_key }}">
                <div class="col-sm-3">
                  <input name="delta" type="number" class="form-control form-control-sm" placeholder="+/-">
                </div>
                <div class="col-sm-6">
                  <input name="note" type="text" class="form-control form-control-sm" placeholder="Reason (required)">
                </div>
                <div class="col-sm-3 text-end">
                  <button class="btn btn-sm btn-primary">Add</button>
                </div>
              </form>
              {% if row.adjustment_total %}
                <div class="small text-muted mt-1">
                  Current sum of adjustments: {{ row.adjustment_total|floatformat:0 }}
                </div>
              {% endif %}
            </div>

            <!-- (2) Proficiency tier changer + visible history -->
            <div>
              <div class="fw-bold mb-1">Proficiency tier</div>
              <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2 align-items-end">
                {% csrf_token %}
                <div class="col-sm-4">
                  <label class="form-label small">Tier</label>
                  <select class="form-select form-select-sm" name="sp_{{ row.id_key }}">
                    <option value="">— keep {{ row.prof_name }} —</option>
                    {% for pl in row.tier_choices %}
                      <option value="{{ pl.id }}" {% if pl.id == row.prof_id %}selected{% endif %}>
                        {{ pl.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-sm-6">
                  <label class="form-label small">Reason</label>
                  <input type="text" class="form-control form-control-sm"
                         name="sp_note_{{ row.id_key }}" placeholder="Why are you changing this?">
                </div>
                <div class="col-sm-2 text-end">
                  <button class="btn btn-sm btn-success" name="save_skill_profs_submit" value="1">Save</button>
                </div>
              </form>

              {% if row.prof_history and row.prof_history|length %}
                <div class="mt-2">
                  <div class="small text-muted">Previous tier changes:</div>
                  <ul class="small mb-0">
                    {% for h in row.prof_history %}
                      <li>{{ h }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </div>

          </div>
        </div>
      </template>
    {% endwith %}
  {% endfor %}
</div>


</div>

</div>

<!-- INVENTORY TAB -->
<div class="tab-pane fade" id="tab-inventory">
  <div class="row g-3">
    <!-- Currency -->
    <div class="col-12 col-lg-5">
      <div class="card h-100">
        <div class="card-header fw-bold">Currency</div>
        <div class="card-body">
          <form method="post" class="row g-2">
            {% csrf_token %}
            <input type="hidden" name="inventory_op" value="save_currency">
            <div class="col-4">
              <label class="form-label form-label-sm">Gold</label>
              <input name="gold" type="number" class="form-control form-control-sm"
                     value="{{ inventory_currency.gold|default:0 }}" min="0">
            </div>
            <div class="col-4">
              <label class="form-label form-label-sm">Silver</label>
              <input name="silver" type="number" class="form-control form-control-sm"
                     value="{{ inventory_currency.silver|default:0 }}" min="0">
            </div>
            <div class="col-4">
              <label class="form-label form-label-sm">Copper</label>
              <input name="copper" type="number" class="form-control form-control-sm"
                     value="{{ inventory_currency.copper|default:0 }}" min="0">
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button class="btn btn-sm btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- My Items -->
<div class="card h-100">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span class="fw-bold">Items</span>
  </div>

  <div class="card-body">

    <!-- Get Weapon -->
    <form method="post" class="d-flex gap-2 align-items-center mb-2">
      {% csrf_token %}
      <input type="hidden" name="inventory_op" value="get_weapon">
      <select name="weapon_id" class="form-select form-select-sm" required style="max-width:420px">
        <option value="">— Select a weapon —</option>
        {% for w in weapons_all %}
          <option value="{{ w.id }}">{{ w.name }} ({{ w.damage }})</option>
        {% endfor %}
      </select>
      <input name="item_qty" type="number" class="form-control form-control-sm" value="1" min="1" style="width:90px">
      <button class="btn btn-sm btn-outline-primary">Get Weapon</button>
    </form>

    <!-- Get Armor -->
    <form method="post" class="d-flex gap-2 align-items-center mb-3">
      {% csrf_token %}
      <input type="hidden" name="inventory_op" value="get_armor">
      <select name="armor_id" class="form-select form-select-sm" required style="max-width:420px">
        <option value="">— Select an armor —</option>
        {% for a in armors_all %}
          <option value="{{ a.id }}">{{ a.name }} (+{{ a.armor_value }})</option>
        {% endfor %}
      </select>
      <input name="item_qty" type="number" class="form-control form-control-sm" value="1" min="1" style="width:90px">
      <button class="btn btn-sm btn-outline-primary">Get Armor</button>
    </form>

    <!-- Manual free-text add (unchanged) -->
    <form method="post" class="d-flex gap-2 align-items-center mb-3">
      {% csrf_token %}
      <input type="hidden" name="inventory_op" value="add_item">
      <input name="item_name" class="form-control form-control-sm" placeholder="Add item…" required>
      <input name="item_qty" type="number" class="form-control form-control-sm" value="1" min="1" style="width:90px">
      <input name="item_desc" class="form-control form-control-sm"
             placeholder="Description (optional)" style="min-width:220px">
      <button class="btn btn-sm btn-primary">Add</button>
    </form>


    <div class="table-responsive">
<table class="table table-sm">
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Rarity</th>
      <th>Description</th>
      <th class="text-end" style="width:120px">Qty</th>
      <th class="text-end" style="width:100px">Action</th>
    </tr>
  </thead>
  <tbody>
    {% for it in inventory_items %}
      <tr>
        <td>
          {{ it.name|default:it.item }}
          {% if it.weapon %}<span class="badge text-bg-secondary ms-1">Weapon</span>{% endif %}
          {% if it.armor %}<span class="badge text-bg-secondary ms-1">Armor</span>{% endif %}
        </td>
        <td class="text-muted">{{ it.kind|default:"—" }}</td>
        <td class="text-muted">{{ it.rarity|default:"—" }}</td>
        <td class="text-muted">{{ it.description }}</td>
        <td class="text-end">{{ it.quantity }}</td>
        <td class="text-end">
          <form method="post" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="inventory_op" value="remove_item">
            <input type="hidden" name="inventory_item_id" value="{{ it.id }}">
            <button class="btn btn-sm btn-outline-danger">Remove</button>
          </form>
        </td>
      </tr>
    {% empty %}

            <tr><td colspan="3" class="text-muted">No items yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

    <!-- Party Pool (collect) -->
    <div class="col-12">
      <div class="card">
        <div class="card-header fw-bold">Party Pool (from Campaign)</div>
        <div class="card-body">
          {% if party_pool_items %}
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr><th>Name</th><th style="width:120px" class="text-end">Qty</th><th style="width:160px" class="text-end">Action</th></tr>
                </thead>
                <tbody>
                  {% for ci in party_pool_items %}
                    <tr>
                      <td>{{ ci.name }}</td>
                      <td class="text-end">{{ ci.quantity|default:1 }}</td>
                      <td class="text-end">
                        <form method="post" class="d-inline">
                          {% csrf_token %}
                          <input type="hidden" name="inventory_op" value="collect_campaign_item">
                          <input type="hidden" name="campaign_item_id" value="{{ ci.id }}">
                          <button class="btn btn-sm btn-success">Collect</button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0">No unclaimed party items in this campaign.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>


        <!-- FEATS TAB -->
<!-- FEATS TAB -->
<div class="tab-pane fade" id="tab-feats">
    <!-- Manual Add Feat (searchable) -->
  {% if can_edit %}
  <div class="card mb-3">
    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
      <span>Manual Add Feat</span>
    </div>
    <div class="card-body">
      <form method="post" class="d-flex flex-wrap gap-2 align-items-center"
            action="{% url 'characters:character_detail' character.pk %}">
        {% csrf_token %}
        <input type="hidden" name="feats_op" value="manual_add">

        <label class="form-label mb-0 me-2">Select feat</label>
        <select id="manual-feat-select" name="feat_id"
                class="form-select"
                style="min-width: 320px; max-width: 520px;" required>
          <option value="">— Search and select a feat —</option>
          {% for f in all_feats %}
            <option value="{{ f.id }}">{{ f.name }}</option>
          {% endfor %}
        </select>

        <button class="btn btn-sm btn-primary">Add</button>
      </form>

      <hr class="my-3">

      <h6 class="mb-2">Manually Added Feats</h6>
      {% if manual_feats %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr><th>Name</th><th class="text-end" style="width:120px">Action</th></tr>
            </thead>
            <tbody>
              {% for mf in manual_feats %}
                <tr>
                  <td>{{ mf.feat.name }}</td>
                  <td class="text-end">
                    <form method="post" class="d-inline"
                          action="{% url 'characters:character_detail' character.pk %}">
                      {% csrf_token %}
                      <input type="hidden" name="feats_op" value="manual_remove">
                      <input type="hidden" name="manual_id" value="{{ mf.id }}">
                      <button class="btn btn-sm btn-outline-danger">Remove</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">No manual feats yet.</p>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="row g-3">
    <!-- General -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header fw-bold">General Feats</div>
        <table class="table table-sm mb-0">
          <thead><tr><th style="width:70px">Level</th><th>Name</th></tr></thead>
          <tbody>
            {% for cf in general_feats %}
            <tr>
              <td>Lv {{ cf.level }}</td>
              <td>
                <div class="d-flex justify-content-between align-items-center">
                  <span>{{ cf.feat.name }} {% note_icon "cfeat:"|add:cf.id %}</span>
                  <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
                </div>
                <div class="d-none desc-body mt-2">
                  {% if cf.feat.description %}
                    <div class="summernote-content mb-2">{{ cf.feat.description|safe }}</div>
                  {% endif %}
                  {% with row=cf %}
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                      <tbody>
                        {% for k,v in row.details %}
                          <tr>
                            <th class="text-nowrap" style="width: 180px;">{{ k }}</th>
                            <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% endwith %}
                </div>
              </td>
            </tr>
            {% empty %}<tr><td colspan="2" class="text-muted">— None —</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Class -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Class Feats</div>
        <table class="table table-sm mb-0">
          <thead><tr><th style="width:70px">Level</th><th>Name</th></tr></thead>
          <tbody>
            {% for cf in class_feats %}
            <tr>
              <td>Lv {{ cf.level }}</td>
              <td>
                <div class="d-flex justify-content-between align-items-center">
                  <span>{{ cf.feat.name }} {% note_icon "cfeat:"|add:cf.id %}</span>
                  <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
                </div>
                <div class="d-none desc-body mt-2">
                  {% if cf.feat.description %}
                    <div class="summernote-content mb-2">{{ cf.feat.description|safe }}</div>
                  {% endif %}
                  {% with row=cf %}
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                      <tbody>
                        {% for k,v in row.details %}
                          <tr>
                            <th class="text-nowrap" style="width: 180px;">{{ k }}</th>
                            <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% endwith %}
                </div>
              </td>
            </tr>
            {% empty %}<tr><td colspan="2" class="text-muted">— None —</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Skill (NEW) -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Skill Feats</div>
        <table class="table table-sm mb-0">
          <thead><tr><th style="width:70px">Level</th><th>Name</th></tr></thead>
          <tbody>
            {% for cf in skill_feats %}
            <tr>
              <td>Lv {{ cf.level }}</td>
              <td>
                <div class="d-flex justify-content-between align-items-center">
                  <span>{{ cf.feat.name }} {% note_icon "cfeat:"|add:cf.id %}</span>
                  <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
                </div>
                <div class="d-none desc-body mt-2">
                  {% if cf.feat.description %}
                    <div class="summernote-content mb-2">{{ cf.feat.description|safe }}</div>
                  {% endif %}
{% with row=cf %}
  <div class="table-responsive">
    <table class="table table-sm table-bordered mb-0">
      <tbody>
        {# If details is a dict, use .items; otherwise, assume list of (k, v) #}
        {% if row.details.items %}
          {% for k, v in row.details.items %}
            <tr>
              <th class="text-nowrap" style="width: 180px;">{{ k }}</th>
              <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
            </tr>
          {% endfor %}
        {% else %}
          {% for k, v in row.details %}
            <tr>
              <th class="text-nowrap" style="width: 180px;">{{ k }}</th>
              <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>
{% endwith %}


                </div>
              </td>
            </tr>
            {% empty %}<tr><td colspan="2" class="text-muted">— None —</td></tr>{% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>



<script>
  // Simple switcher: show the relevant select for the chosen kind
  (function(){
    const kindSel = document.getElementById("id_kind");
    if (!kindSel) return;
    function flip(){
      const v = (kindSel.value || "").toLowerCase();
      document.getElementById("mf-feat").classList.toggle("d-none", v !== "feat");
      document.getElementById("mf-classfeature").classList.toggle("d-none", v !== "class_feature");
      document.getElementById("mf-racialfeature").classList.toggle("d-none", v !== "racial_feature");
    }
    kindSel.addEventListener("change", flip);
    flip();
  })();
</script>


<!-- ACTIVE TAB -->
<div class="tab-pane fade" id="tab-active">
  <div class="card p-3">
    <h5 class="mb-3">Active Abilities</h5>

    {% if active_rows or martial_mastery_known %}
      <ul class="list-group">
        {% for r in active_rows %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                {{ r.label }}
                {% if r.meta %}<small class="text-muted">— {{ r.meta }}</small>{% endif %}
                {% note_icon r.note_key %}
              </div>
              <div class="d-flex align-items-center gap-2">
                <input class="form-control form-control-sm act-note" placeholder="Note (optional)">
                <button class="btn btn-sm btn-outline-secondary toggle-activation"
                        data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="0">Set Passive</button>
                <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
              </div>
            </div>
            <div class="d-none desc-body mt-2">
              {% if r.desc %}<div class="summernote-content mb-2">{{ r.desc|safe }}</div>{% endif %}
              {% if r.details %}
                <div class="table-responsive">
                  <table class="table table-sm table-bordered mb-0">
                    <tbody>
                      {% for k,v in r.details %}
                        <tr>
                          <th class="text-nowrap" style="width:180px;">{{ k }}</th>
                          <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>
          </li>
        {% endfor %}

        {% for mm in martial_mastery_known %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                {{ mm.name }}
                <span class="badge text-bg-info ms-2">Martial Mastery</span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
              </div>
            </div>
            <div class="d-none desc-body mt-2">
              {% if mm.description %}<div class="summernote-content mb-2">{{ mm.description|safe }}</div>
              {% elif mm.summary %}<div class="summernote-content mb-2">{{ mm.summary|safe }}</div>{% endif %}
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0">
                  <tbody>
                    <tr><th class="text-nowrap" style="width:180px;">Tags</th><td>{{ mm.tags|default:"—" }}</td></tr>
                    <tr><th class="text-nowrap" style="width:180px;">Prerequisites</th><td>{{ mm.prereq|default:"—" }}</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">None marked Active.</p>
    {% endif %}
  </div>
</div>



<!-- PASSIVE TAB -->
<div class="tab-pane fade" id="tab-passive">
  <div class="card p-3">
    <h5 class="mb-3">Passive Abilities</h5>
    {% if passive_rows %}
      <ul class="list-group">
        {% for r in passive_rows %}
<li class="list-group-item">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      {{ r.label }}
      {% if r.meta %}<small class="text-muted">— {{ r.meta }}</small>{% endif %}
      {% note_icon r.note_key %}
    </div>
    <div class="d-flex align-items-center gap-2">
      <input class="form-control form-control-sm act-note" placeholder="Note (optional)">
      <button class="btn btn-sm btn-outline-primary toggle-activation"
              data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="1">Set Active</button>
      <button class="btn btn-sm btn-outline-secondary toggle-activation"
              data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="0">Passive</button>
      <!-- NEW: Details toggle -->
  <button type="button" class="btn btn-sm btn-outline-primary"
          onclick="openDetails('{{ r.label|escapejs }}', `
            <dl class='row'>
              {% for k,v in r.details %}
                <dt class='col-sm-3'>{{ k }}</dt>
                <dd class='col-sm-9'>{{ v|linebreaksbr }}</dd>
              {% endfor %}
            </dl>
          `)">
    Details
  </button>    
</div>
  </div>
  <!-- Keep details panel as a sibling under the header row (easier to find/toggle) -->
  <div class="d-none desc-body mt-2">
    {% if r.desc %}
      <div class="summernote-content mb-2">{{ r.desc|safe }}</div>
    {% endif %}
    <div class="table-responsive">
      <table class="table table-sm table-bordered mb-0">
        <tbody>
          {% for k,v in r.details %}
            <tr>
              <th class="text-nowrap" style="width:180px;">{{ k }}</th>
              <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</li>

        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">None marked Passive.</p>
    {% endif %}
  </div>
</div>
<div class="tab-pane fade" id="tab-custom">
  <div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Custom</h5>
      {% if can_edit %}
      <form method="post" class="d-flex gap-2" action="{% url 'characters:character_detail' character.pk %}">
        {% csrf_token %}
        <input type="hidden" name="custom_op" value="create_header">
        <input name="label" class="form-control form-control-sm" placeholder="New header" required>
        <button class="btn btn-sm btn-outline-primary">Add Header</button>
      </form>
      {% endif %}
    </div>

    {% if custom_ctx and custom_ctx.headers %}
      {% for h in custom_ctx.headers %}
      <section class="mb-3 border rounded p-2" data-hid="{{ h.id }}">
        <header class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">{{ h.label }}</h6>
          {% if can_edit %}
          <div class="d-flex gap-2">
            <form method="post" class="d-flex gap-2" action="{% url 'characters:character_detail' character.pk %}">
              {% csrf_token %}
              <input type="hidden" name="custom_op" value="rename_header">
              <input type="hidden" name="header_id" value="{{ h.id }}">
              <input name="label" class="form-control form-control-sm" placeholder="Rename">
              <button class="btn btn-sm btn-outline-secondary">Rename</button>
            </form>
            <form method="post" action="{% url 'characters:character_detail' character.pk %}">
              {% csrf_token %}
              <input type="hidden" name="custom_op" value="toggle_header">
              <input type="hidden" name="header_id" value="{{ h.id }}">
              <button class="btn btn-sm btn-outline-secondary">{% if h.hidden %}Show{% else %}Hide{% endif %}</button>
            </form>
            <form method="post" action="{% url 'characters:character_detail' character.pk %}">
              {% csrf_token %}
              <input type="hidden" name="custom_op" value="delete_header">
              <input type="hidden" name="header_id" value="{{ h.id }}">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </div>
          {% endif %}
        </header>

        <ul class="list-group mb-2">
          {% for it in custom_ctx.items_by_header|get_item:h.id %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ it.name }}</div>
                  {% if it.desc %}<div class="text-muted small">{{ it.desc|linebreaksbr }}</div>{% endif %}
                </div>
                {% if can_edit %}
                <form method="post" class="d-inline" action="{% url 'characters:character_detail' character.pk %}">
                  {% csrf_token %}
                  <input type="hidden" name="custom_op" value="{% if it.kind == 'ref' %}unassign_ref{% else %}delete_item{% endif %}">
                  {% if it.kind == "ref" %}
                    <input type="hidden" name="ctype" value="{{ it.ref.ctype }}">
                    <input type="hidden" name="obj_id" value="{{ it.ref.obj_id }}">
                  {% else %}
                    <input type="hidden" name="item_id" value="{{ it.id }}">
                  {% endif %}
                  <button class="btn btn-sm btn-outline-danger">Remove</button>
                </form>
                {% endif %}
              </div>
            </li>
          {% empty %}
            <li class="list-group-item text-muted">No items yet.</li>
          {% endfor %}
        </ul>

        {% if can_edit %}
        <form method="post" class="row g-2" action="{% url 'characters:character_detail' character.pk %}">
          {% csrf_token %}
          <input type="hidden" name="custom_op" value="add_item">
          <input type="hidden" name="header_id" value="{{ h.id }}">
          <div class="col-md-4"><input name="name" class="form-control form-control-sm" placeholder="Name" required></div>
          <div class="col-md-7"><input name="desc" class="form-control form-control-sm" placeholder="Description (optional)"></div>
          <div class="col-md-1 d-grid"><button class="btn btn-sm btn-outline-primary">Add</button></div>
        </form>
        {% endif %}
      </section>
      {% endfor %}
    {% else %}
      <p class="text-muted mb-0">No custom headers yet.</p>
    {% endif %}
  </div>
</div>

<!-- MARTIAL MASTERY TAB -->
<div class="tab-pane fade" id="martial-mastery" role="tabpanel" aria-labelledby="martial-mastery-tab">
  {% if show_martial_mastery_tab %}
    <div class="row g-3">
      <!-- Summary card -->
      <div class="col-12 col-lg-6">
        <div class="card">
          <div class="card-header">Martial Mastery — Summary</div>
          <div class="card-body">
           <div class="row text-center g-2 align-items-start">

<div class="col-6">
<div class="h6 mb-1 d-flex justify-content-center align-items-center gap-2 mm-head">
<span class="text-nowrap">Points</span>
    {% if can_edit %}
      <button class="edit-pill edit-override"
              type="button"
              title="Override total martial points"
              data-key="mm:points_total"
              data-calc="{{ martial_mastery_ctx.total_points }}"
              data-formula="">
        ✎
      </button>
      <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="d-inline">
        {% csrf_token %}
        <input type="hidden" name="martial_op" value="reset_points_override">
        <button class="btn btn-sm btn-outline-secondary">Reset</button>
      </form>
    {% endif %}
  </div>
  <div class="display-6">{{ martial_mastery_ctx.total_points }}</div>
  <div class="small text-muted">
    {{ martial_mastery_ctx.formula_points }}
    {% if martial_mastery_ctx.values_points %}<br><code>{{ martial_mastery_ctx.values_points }}</code>{% endif %}
  </div>
</div>

<div class="col-6">
<div class="h6 mb-1 d-flex justify-content-center align-items-center gap-2 mm-head">
<span class="text-nowrap">Known Cap</span>
    {% if can_edit %}
      <button class="edit-pill edit-override"
              type="button"
              title="Override known cap"
              data-key="mm:known_cap"
              data-calc="{{ martial_mastery_ctx.total_known_cap }}"
              data-formula="">
        ✎
      </button>
      <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="d-inline">
        {% csrf_token %}
        <input type="hidden" name="martial_op" value="reset_known_cap_override">
        <button class="btn btn-sm btn-outline-secondary">Reset</button>
      </form>
    {% endif %}
  </div>
<div class="display-6">{{ martial_mastery_ctx.total_known_cap }}</div>
  <div class="small text-muted">
    {{ martial_mastery_ctx.formula_known }}
    {% if martial_mastery_ctx.values_known %}<br><code>{{ martial_mastery_ctx.values_known }}</code>{% endif %}
  </div>
</div>

            </div>
            <hr>
            <!-- Per-feature breakdown (optional) -->
            {% if martial_mastery_ctx.by_feature %}
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Feature</th>
                      <th>Class</th>
                      <th class="text-end">Points</th>
                      <th class="text-end">Known</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in martial_mastery_ctx.by_feature %}
<tr>
  <td>{{ row.feature_name }}</td>
  <td>{{ row.class_name }}</td>
  <td class="text-end">
    {{ row.points }}
    {% if can_edit %}
      <button class="edit-pill edit-override"
              type="button"
              title="Override points from this feature"
              data-key="mm:feature:{{ row.feature_name|slugify }}:points"
              data-calc="{{ row.points }}"
              data-formula="">✎</button>
    {% endif %}
  </td>
  <td class="text-end">
    {{ row.known_cap }}
    {% if can_edit %}
      <button class="edit-pill edit-override"
              type="button"
              title="Override known from this feature"
              data-key="mm:feature:{{ row.feature_name|slugify }}:known"
              data-calc="{{ row.known_cap }}"
              data-formula="">✎</button>
    {% endif %}
  </td>
</tr>

                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Known list -->
<div class="col-12">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Known Martial Mastery</span>
      {% if can_edit and martial_mastery_known %}
        <button class="btn btn-outline-danger btn-sm"
                type="submit"
                form="mm-unlearn-form">
          Unlearn Selected
        </button>
      {% endif %}
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped align-middle m-0">
                <thead>
                  <tr>
                    {% if can_edit %}<th style="width:36px"></th>{% endif %}
                    <th>Name</th>
                    <th class="text-end">Level</th>
                    <th class="text-end">Points</th>
                    <th class="text-end">Action</th>
                    <th>Restrictions</th>
                    <th style="width:60px"></th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in martial_mastery_known %}
                    <tr>
                      {% if can_edit %}
                        <td><input type="checkbox" name="pick[]" formmethod="post" form="mm-unlearn-form" value="{{ r.id }}"></td>
                      {% endif %}
                      <td>{{ r.name }}</td>
                      <td class="text-end">{{ r.level }}</td>
                      <td class="text-end">{{ r.points_cost }}</td>
                      <td class="text-end">{{ r.actions_required }}</td>
<td>{{ r.restrictions }}</td>
<td class="text-end">
  <button type="button" class="btn btn-sm btn-outline-primary"
          onclick="openDetails('{{ r.name|escapejs }}', `
            <dl class='row'>
              {% for k,v in r.details %}
                <dt class='col-sm-3'>{{ k }}</dt>
                <dd class='col-sm-9'>{{ v|linebreaksbr }}</dd>
              {% endfor %}
            </dl>
          `)">
    Details
  </button>
</td>


                    </tr>

                  {% empty %}
                    <tr><td colspan="7" class="text-center text-muted py-3">No martial masteries known yet.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- hidden form target for unlearn -->
        {% if can_edit %}
          <form id="mm-unlearn-form" method="post" class="d-none">
            {% csrf_token %}
            <input type="hidden" name="martial_op" value="unlearn">
          </form>
        {% endif %}
      </div>

      <!-- Available list -->
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Available (meets level & class)</span>
            {% if can_edit %}
              <form method="post" id="mm-learn-form" class="m-0">
                {% csrf_token %}
                <input type="hidden" name="martial_op" value="learn">
                <button class="btn btn-primary btn-sm" type="submit" {% if not martial_mastery_ctx.can_learn_more or martial_mastery_ctx.points_left|default:0 == 0 %}disabled{% endif %}>
                  Learn Selected
                </button>
              </form>
            {% endif %}
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle m-0">
                <thead>
                  <tr>
                    {% if can_edit %}<th style="width:36px"></th>{% endif %}
                    <th>Name</th>
                    <th class="text-end">Level</th>
                    <th class="text-end">Points</th>
                    <th class="text-end">Action</th>
                    <th>Restrictions</th>
                    <th style="width:60px"></th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in martial_mastery_available %}
                    <tr class="{% if not r.can_learn_now %}table-secondary{% endif %}">
                      {% if can_edit %}
                        <td>
                          <input type="checkbox" name="pick[]" form="mm-learn-form" value="{{ r.id }}" {% if not r.can_learn_now %}disabled{% endif %}>
                        </td>
                      {% endif %}
                      <td>{{ r.name }}</td>
                      <td class="text-end">{{ r.level }}</td>
                      <td class="text-end">{{ r.points_cost }}</td>
                      <td class="text-end">{{ r.actions_required }}</td>
                  <td>{{ r.restrictions }}</td>
<td class="text-end">
  <button type="button" class="btn btn-sm btn-outline-primary"
          onclick="openDetails('{{ r.name|escapejs }}', `
            <dl class='row'>
              {% for k,v in r.details %}
                <dt class='col-sm-3'>{{ k }}</dt>
                <dd class='col-sm-9'>{{ v|linebreaksbr }}</dd>
              {% endfor %}
            </dl>
          `)">
    Details
  </button>
</td>


                    </tr>

                  {% empty %}
                    <tr><td colspan="7" class="text-center text-muted py-3">Nothing available right now.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  {% else %}
    <div class="alert alert-secondary my-3">This character has no Martial Mastery entitlements yet.</div>
  {% endif %}
</div>
<div class="tab-pane fade" id="tab-notes" role="tabpanel" aria-labelledby="tab-notes-tab">
  <div class="row g-3">

    <!-- FORMS ON TOP, FULL WIDTH -->
    <aside class="col-12 order-1">
      {% if can_edit %}
      <div class="card mb-3">
        <div class="card-header fw-bold">Add Category</div>
        <div class="card-body">
          <form method="post" action="{% url 'characters:character_detail' character.pk %}">
            {% csrf_token %}
            <input type="hidden" name="notes_op" value="add_category">
            <div class="mb-2">
              <label for="note-cat-name" class="form-label form-label-sm">Category name</label>
              <input id="note-cat-name" name="name" class="form-control form-control-sm"
                     placeholder="e.g. NPCs, Quests" maxlength="120" required>
              <div id="note-cat-help" class="form-text">Up to 120 characters.</div>
            </div>
            <button class="btn btn-sm btn-primary" type="submit">Add</button>
          </form>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header fw-bold">Add Note</div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data"
                action="{% url 'characters:character_detail' character.pk %}">
            {% csrf_token %}
            <input type="hidden" name="notes_op" value="add_note">

            <div class="mb-2">
              <label for="note-title" class="form-label form-label-sm">Title</label>
              <input id="note-title" name="title" class="form-control form-control-sm"
                     maxlength="200" required>
            </div>

            <div class="mb-2">
              <label for="note-category" class="form-label form-label-sm">Category (optional)</label>
              <select id="note-category" name="category_id" class="form-select form-select-sm">
                <option value="">— None —</option>
                {% for c in note_categories %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-2">
              <label for="note-desc" class="form-label form-label-sm">Description</label>
              <textarea id="note-desc" name="description" rows="4"
                        class="form-control form-control-sm"
                        placeholder="Write your note…"></textarea>
              <div class="form-text" id="note-desc-help">Plain text; line breaks are kept.</div>
            </div>

            <div class="mb-3">
              <label for="note-image" class="form-label form-label-sm">Image (optional)</label>
              <input id="note-image" type="file" name="image" accept="image/*"
                     class="form-control form-control-sm" aria-describedby="note-image-help">
              <div id="note-image-help" class="form-text">JPEG/PNG/GIF, a few MB max.</div>
            </div>

            <button class="btn btn-sm btn-primary" type="submit">Add Note</button>
          </form>
        </div>
      </div>
      {% endif %}
    </aside>

    <!-- RESULTS BELOW, FULL WIDTH -->
    <section class="col-12 order-2">
      <div class="card mb-3">
        <div class="card-body py-2 d-flex align-items-center gap-2">
          <label for="note-search" class="form-label mb-0 small">Search</label>
          <input id="note-search" class="form-control form-control-sm" placeholder="Filter by title…"
                 oninput="for(const r of document.querySelectorAll('[data-note-title]')){r.closest('.note-row').style.display = r.dataset.noteTitle.includes(this.value.toLowerCase())?'':'none';}">
        </div>
      </div>

      {% if note_categories %}
        {% for c in note_categories %}
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold">{{ c.name }}</span>
            {% if can_edit %}
            <form method="post" class="m-0"
                  action="{% url 'characters:character_detail' character.pk %}"
                  onsubmit="return confirm('Delete category “{{ c.name }}”? Notes will become uncategorised.');">
              {% csrf_token %}
              <input type="hidden" name="notes_op" value="delete_category">
              <input type="hidden" name="category_id" value="{{ c.id }}">
              <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
            </form>
            {% endif %}
          </div>
          <div class="card-body">
            {% with rows=notes_by_category|get_item:c.id %}
              {% if rows %}
                <ul class="list-group">
                  {% for n in rows %}
                  <li class="list-group-item note-row">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="pe-3">
                        <div class="fw-semibold" data-note-title="{{ n.title|lower }}">{{ n.title }}</div>
                        {% if n.image %}
                          <img src="{{ n.image.url }}" class="img-fluid rounded my-2" style="max-height:160px" alt="">
                        {% endif %}
                        {% if n.description %}
                          <div class="text-muted small">{{ n.description|linebreaksbr }}</div>
                        {% endif %}
                        <div class="text-muted small mt-1">Added {{ n.created_at|date:"M j, Y H:i" }}</div>
                      </div>
                      {% if can_edit %}
                      <div class="text-end">
                        <form method="post" class="d-inline" action="{% url 'characters:character_detail' character.pk %}">
                          {% csrf_token %}
                          <input type="hidden" name="notes_op" value="delete_note">
                          <input type="hidden" name="note_id" value="{{ n.id }}">
                          <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                        </form>
                        <form method="post" class="d-inline" action="{% url 'characters:character_detail' character.pk %}">
                          {% csrf_token %}
                          <input type="hidden" name="notes_op" value="move_note">
                          <input type="hidden" name="note_id" value="{{ n.id }}">
                          <label class="visually-hidden" for="mv-{{ n.id }}">Move to…</label>
                          <select id="mv-{{ n.id }}" name="category_id"
                                  class="form-select form-select-sm d-inline-block" style="width:auto">
                            <option value="">— None —</option>
                            {% for c2 in note_categories %}
                              <option value="{{ c2.id }}" {% if n.category_id == c2.id %}selected{% endif %}>{{ c2.name }}</option>
                            {% endfor %}
                          </select>
                          <button class="btn btn-sm btn-outline-secondary" type="submit">Move</button>
                        </form>
                      </div>
                      {% endif %}
                    </div>
                  </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-muted">No notes in this category.</div>
              {% endif %}
            {% endwith %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="alert alert-secondary">No categories yet. Create one above to get started.</div>
      {% endif %}

      <!-- Uncategorised -->
      <div class="card">
        <div class="card-header fw-bold">Uncategorised</div>
        <div class="card-body">
          {% with rows=notes_by_category|get_item:None %}
            {% if rows %}
              <ul class="list-group">
                {% for n in rows %}
                <li class="list-group-item note-row">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="pe-3">
                      <div class="fw-semibold" data-note-title="{{ n.title|lower }}">{{ n.title }}</div>
                      {% if n.image %}
                        <img src="{{ n.image.url }}" class="img-fluid rounded my-2" style="max-height:160px" alt="">
                      {% endif %}
                      {% if n.description %}
                        <div class="text-muted small">{{ n.description|linebreaksbr }}</div>
                      {% endif %}
                      <div class="text-muted small mt-1">Added {{ n.created_at|date:"M j, Y H:i" }}</div>
                    </div>
                    {% if can_edit %}
                    <div class="text-end">
                      <form method="post" class="d-inline" action="{% url 'characters:character_detail' character.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="notes_op" value="delete_note">
                        <input type="hidden" name="note_id" value="{{ n.id }}">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                      </form>
                      <form method="post" class="d-inline" action="{% url 'characters:character_detail' character.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="notes_op" value="move_note">
                        <input type="hidden" name="note_id" value="{{ n.id }}">
                        <label class="visually-hidden" for="mv-{{ n.id }}-u">Move to…</label>
                        <select id="mv-{{ n.id }}-u" name="category_id"
                                class="form-select form-select-sm d-inline-block" style="width:auto">
                          <option value="">— None —</option>
                          {% for c2 in note_categories %}
                            <option value="{{ c2.id }}">{{ c2.name }}</option>
                          {% endfor %}
                        </select>
                        <button class="btn btn-sm btn-outline-secondary" type="submit">Move</button>
                      </form>
                    </div>
                    {% endif %}
                  </div>
                </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-muted">No uncategorised notes.</div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </section>

  </div>
</div>


<!-- ALL TAB -->
<!-- ALL TAB -->
<div class="tab-pane fade" id="tab-all">
  <div class="card p-3">
    <h5 class="mb-3">All Abilities</h5>


    {% if all_rows %}
      <ul class="list-group">
        {% for r in all_rows %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                {{ r.label }}
                {% if r.meta %}<small class="text-muted">— {{ r.meta }}</small>{% endif %}
                {% note_icon r.note_key %}
                {% if r.active %}<span class="badge text-bg-success ms-2">Active</span>{% else %}<span class="badge text-bg-secondary ms-2">Passive</span>{% endif %}
              </div>

<div class="d-flex align-items-center gap-2">
  <input class="form-control form-control-sm act-note" placeholder="Note (optional)">

  <button class="btn btn-sm btn-outline-primary toggle-activation"
          data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="1">
    Set Active
  </button>
  <button class="btn btn-sm btn-outline-secondary toggle-activation"
          data-ctype="{{ r.ctype }}" data-obj="{{ r.obj_id }}" data-active="0">
    Passive
  </button>

  {% if can_edit and custom_ctx and custom_ctx.headers %}
  <form method="post"
        class="d-flex align-items-center gap-2 m-0"
        action="{% url 'characters:character_detail' character.pk %}">
    {% csrf_token %}
    <input type="hidden" name="custom_op" value="assign_ref">
    <input type="hidden" name="ctype" value="{{ r.ctype }}">
    <input type="hidden" name="obj_id" value="{{ r.obj_id }}">

    <select name="header_id" class="form-select form-select-sm" style="width:auto">
      {% for h in custom_ctx.headers %}
        <option value="{{ h.id }}">{{ h.label }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-sm btn-outline-secondary">Move</button>
  </form>
  {% endif %}

  <button class="btn btn-sm btn-link p-0 toggle-desc" type="button">Details</button>
</div>

            </div>
            <div class="d-none desc-body mt-2">
              {% if r.desc %}
                <div class="summernote-content mb-2">{{ r.desc|safe }}</div>
              {% endif %}
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0">
                  <tbody>
                    {% for k,v in r.details %}
                      <tr>
                        <th class="text-nowrap" style="width:180px;">{{ k }}</th>
                        <td>{% if k == "Description" %}{{ v|safe }}{% else %}{{ v }}{% endif %}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">—</p>
    {% endif %}
  </div>

  <!-- Manually Add Item (moved here) -->
  <div class="card mt-3">
    <div class="card-header fw-bold">Manually Add Item</div>
    <div class="card-body">
      {% if manual_form %}
        <form method="post" action="{% url 'characters:character_detail' character.pk %}">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-3">
              {{ manual_form.kind.label_tag }} {{ manual_form.kind }}
            </div>
            <div class="col-md-3" id="mf-feat">
              {{ manual_form.feat.label_tag }} {{ manual_form.feat }}
            </div>
            <div class="col-md-3 d-none" id="mf-classfeature">
              {{ manual_form.class_feature.label_tag }} {{ manual_form.class_feature }}
            </div>
            <div class="col-md-3 d-none" id="mf-racialfeature">
              {{ manual_form.racial_feature.label_tag }} {{ manual_form.racial_feature }}
            </div>
            <div class="col-12">
              {{ manual_form.reason.label_tag }} {{ manual_form.reason }}
            </div>
          </div>
          <button class="btn btn-primary mt-2" name="manual_add_submit" value="1">Add</button>
        </form>
        {% if manual_form.errors %}
          <div class="alert alert-danger mt-2 mb-0">
            {{ manual_form.errors }}
          </div>
        {% endif %}
      {% else %}
        <p class="mb-0 text-muted">You don’t have permission to add items.</p>
      {% endif %}
    </div>
  </div>
</div>


<!-- SPELLCASTING TAB (single, consolidated) -->
{% if show_spellcasting_tab %}
<div class="tab-pane fade" id="tab-spellcasting">

  <!-- NEW: Raw slot tables from real Class Features -->
  <div class="card mb-4">
    <div class="card-header">
      <strong>Spell Slot Tables</strong>
      <span class="text-muted ms-2">from class features</span>
    </div>
    <div class="card-body">
      {% if spellcasting_blocks %}
        {% for t in spellcasting_blocks %}
          <div class="mb-3">
            <div class="d-flex justify-content-between small mb-1">
              <span>
                <strong>{{ t.class_name }}</strong>
                • {{ t.feature_name }}
                {% if t.origin_label %} — <span class="text-muted">{{ t.origin_label }}</span>{% endif %}
              </span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 90px">Level</th>
                    <th style="width: 90px" class="text-end">Slots</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r, slots in t.slots_by_rank.items %}
                    <tr>
                      <td>Level {{ r }}</td>
                      <td class="text-end">{{ slots }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="2" class="text-muted">No slots.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-muted">No spell slot tables from class features.</div>
      {% endif %}
    </div>
  </div>


  {% for b in spell_selection_blocks %}
    <div class="card mb-4">
<div class="card-header d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center gap-2">
    <strong>{{ b.class_name }}</strong>
    <span class="text-muted">• {{ b.origin|default:"—" }}</span>

    {% if b.has_any_override %}
      <span class="badge text-bg-info ms-2" title="This character uses personalized caps/formulas for this list">
        Personal override
      </span>
    {% endif %}
  </div>

  <div class="d-flex align-items-center gap-2 small">
    <span class="badge text-bg-secondary">
      Cantrips: {{ b.known_cantrips_current }}/{{ b.cantrips_max }}
    </span>
    <span class="badge {% if b.known_max and b.known_leveled_current >= b.known_max %}text-bg-danger{% else %}text-bg-secondary{% endif %}">
      Known ≥1: {{ b.known_leveled_current }}{% if b.known_max is not None %}/{{ b.known_max }}{% endif %}
    </span>
    <span class="badge {% if b.prepared_max and b.prepared_current >= b.prepared_max %}text-bg-danger{% else %}text-bg-secondary{% endif %}">
      Prepared: {{ b.prepared_current }}{% if b.prepared_max is not None %}/{{ b.prepared_max }}{% endif %}
    </span>

    <!-- NEW: totals across all spell slot tables (if provided by the view) -->
{% if b.grand_caps %}
  <span class="ms-3 text-muted">
    Totals — C: {{ b.grand_caps.cantrips }}, K: {{ b.grand_caps.known }}, P: {{ b.grand_caps.prepared }}
  </span>
{% endif %}


    {% if b.prepared_remaining_by_rank %}
      <span class="ms-2 text-muted">
        {% for r,v in b.prepared_remaining_by_rank.items %}
          <span class="badge rounded-pill {% if v == 0 %}text-bg-warning{% else %}text-bg-light{% endif %}">
            R{{ r }}: {{ v }} left
          </span>
        {% endfor %}
      </span>
    {% endif %}

    {% if can_edit and b.has_any_override %}
      <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="ms-2">
        {% csrf_token %}
        <input type="hidden" name="spells_op" value="reset_caps">
        <input type="hidden" name="feature_id" value="{{ b.feature_id }}">
        <button class="btn btn-xs btn-outline-secondary">Reset</button>
      </form>
    {% endif %}
  </div>
</div>

      <div class="card-body">

      <div class="card-body">

        {# ⬅ Slots summary (one per origin block) #}
        <div class="table-responsive mb-3">
          <table class="table table-sm table-bordered align-middle mb-0">
<thead class="table-light">
  <tr>
    <th style="width: 90px">Level</th>
    <th style="width: 90px" class="text-end">Slots</th>
    <th style="width: 110px" class="text-end">Left</th>
  </tr>
</thead>


<tbody>
  {% for pair in b.slots_by_rank.items %}
    {% with r=pair.0 slots=pair.1 %}
      {% with left=b.slots_left_by_rank|get_item:r|default:slots %}
        <tr>
          <td>Level {{ r }}</td>
          <td class="text-end">{{ slots }}</td>
          <td class="text-end">
            <span class="badge {% if left == 0 %}text-bg-warning{% else %}text-bg-success{% endif %}">
              {{ left }}
            </span>
          </td>
        </tr>
      {% endwith %}
    {% endwith %}
  {% empty %}
    <tr><td colspan="3" class="text-muted">No slots for this list.</td></tr>
  {% endfor %}
</tbody>
</table>  {# ← close the table BEFORE the form #}

{# Editable “slots left” form (moved OUTSIDE the table) #}
{% if can_edit and b.max_rank %}
  <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2 mt-2">
    {% csrf_token %}
    <input type="hidden" name="spells_op" value="set_slots_left">
    {% for pair in b.slots_by_rank.items %}
      {% with r=pair.0 slots=pair.1 %}
        {% with left=b.slots_left_by_rank|get_item:r|default:slots %}
          <div class="col-md-2">
            <label class="form-label form-label-sm mb-1">Lvl {{ r }} left</label>
            <input type="number"
                   class="form-control form-control-sm"
                   name="slots_left[{{ r }}]"
                   value="{{ left }}"
                   min="0"
                   max="{{ slots }}">
            <div class="form-text">of {{ slots }}</div>
          </div>
        {% endwith %}
      {% endwith %}
    {% endfor %}
    <div class="col-12 mt-1">
      <button class="btn btn-sm btn-outline-primary">Save slots</button>

    </div>
  </form>
{% endif %}



          </table>
        </div>

<h6 class="mb-2">Prepared Spells</h6>
{% with prep_id="prep-all-"|add:b.feature_id|stringformat:"s" %}
  {# unified, no per-rank cap; unprepare doesn’t need rank #}
  {% include "characters/_spell_table.html" with table_id=prep_id rows=b.prepared_rows_all feature_id=b.feature_id action="unprepare" rank=0 %}
{% endwith %}




<h6 class="mt-4 mb-2">Prepare from Known</h6>
{% with kp_id="knownprep-all-"|add:b.feature_id|stringformat:"s" %}
  {# pass rank=0 so the backend uses each spell’s own level; limit uses global remaining #}
  {% include "characters/_spell_table.html" with table_id=kp_id rows=b.known_for_prepare_all feature_id=b.feature_id action="prepare" rank=0 limit_prepare=b.prepared_remaining_total %}
{% endwith %}


<h6 class="mt-4 mb-2">Learn New Spells (Leveled)</h6>
{% with learn_id="learn-all-"|add:b.feature_id|stringformat:"s" %}
  {# pass rank=0 so each pick uses its own spell level; cap uses global needs_known #}
  {% include "characters/_spell_table.html" with table_id=learn_id rows=b.learn_spells_all feature_id=b.feature_id action="learn_known" rank=0 limit_known=b.needs_known %}
{% endwith %}




        {# 4) SHOW KNOWN CANTRIPS #}
        <h6 class="mt-4 mb-2">Known Cantrips</h6>
{% with known_c_id="learned-cantrips-"|add:b.feature_id|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=known_c_id rows=b.learned_cantrips_rows feature_id=b.feature_id action="unlearn_cantrip" is_cantrip=True  %}
{% endwith %}


        {# 5) SPELL TABLE TO SELECT KNOWN CANTRIP #}
        <h6 class="mt-4 mb-2">Learn New Cantrips</h6>
{% with can_id="cantrips-table-"|add:b.feature_id|stringformat:"s" %}
  {% include "characters/_spell_table.html" with table_id=can_id rows=b.learn_cantrip_rows feature_id=b.feature_id action="learn_cantrip" is_cantrip=True limit_cantrips=b.needs_cantrips %}
{% endwith %}



        {# (Optional) quick numeric cap adjustment UI you already wired in views as 'adjust_caps' #}
        {% if can_edit %}
  <details class="mt-2">
    <summary>Edit formulas (advanced)</summary>
    <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2 mt-2">
      {% csrf_token %}
      <input type="hidden" name="spells_op" value="adjust_formulas">
      <input type="hidden" name="feature_id" value="{{ b.feature_id }}">
      <div class="col-md-4">
        <label class="form-label form-label-sm">Cantrips formula</label>
        <input class="form-control form-control-sm" name="f_cantrips" placeholder="{{ b.cantrips_formula }}">
        <div class="form-text">Leave blank to remove override</div>
      </div>
      <div class="col-md-4">
        <label class="form-label form-label-sm">Known formula</label>
        <input class="form-control form-control-sm" name="f_known" placeholder="{{ b.spells_known_formula|default:'—' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label form-label-sm">Prepared formula</label>
        <input class="form-control form-control-sm" name="f_prepared" placeholder="{{ b.spells_prepared_formula|default:'—' }}">
      </div>
      <div class="col-md-9">
        <label class="form-label form-label-sm">Reason (required)</label>
        <input class="form-control form-control-sm" name="note" required>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-sm btn-outline-primary w-100">Save</button>
      </div>
    </form>
  </details>
{% endif %}

          <div class="mt-4">
            <details>
              <summary class="mb-2">Adjust numeric caps </summary>
              <form method="post" action="{% url 'characters:character_detail' character.pk %}" class="row g-2">
                {% csrf_token %}
                <input type="hidden" name="spells_op" value="adjust_caps">
                <input type="hidden" name="feature_id" value="{{ b.feature_id }}">
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Cantrips</label>
<div class="mb-2">
  <label class="form-label mb-0">Cantrips cap</label>
<input type="number" name="cap_cantrips" class="form-control"
       placeholder="{{ b.cantrips_max }}">
<small class="text-muted">Current (calculated): {{ b.cantrips_max }}</small>
</div>                </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Known</label>
<div class="mb-2">
  <label class="form-label mb-0">Known cap</label>
<input type="number" name="cap_known" class="form-control"
       placeholder="{{ b.known_max|default:'—' }}">
<small class="text-muted">Current: {{ b.known_max|default:'—' }}</small>
</div>              </div>
                <div class="col-md-2">
                  <label class="form-label form-label-sm">Prepared</label>
<div class="mb-2">
  <label class="form-label mb-0">Prepared cap</label>
<input type="number" name="cap_prepared" class="form-control"
       placeholder="{{ b.prepared_max|default:'—' }}">
<small class="text-muted">Current: {{ b.prepared_max|default:'—' }}</small>
</div>        </div>
                <div class="col-md-4">
                  <label class="form-label form-label-sm">Reason (required)</label>
                  <input class="form-control form-control-sm" name="note" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button class="btn btn-sm btn-outline-primary w-100">Save</button>
                </div>
              </form>
            </details>
          </div>

      </div> <!-- /.card-body -->
    </div> <!-- /.card -->
  {% endfor %}
  
</div> <!-- /#tab-spellcasting -->
{% endif %}
</div> <!-- /.tab-content -->

    </main>
  </div> <!-- /.row -->
</div> <!-- /.container -->

<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalTitle">Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="detailsModalBody">Loading…</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script>
function openDetails(title, html) {
  const modalEl = document.getElementById('detailsModal');
  if (modalEl && modalEl.parentElement !== document.body) {
    document.body.appendChild(modalEl); // ensure it's not trapped inside a tab/card
  }
  document.getElementById('detailsModalTitle').textContent = title || 'Details';
  document.getElementById('detailsModalBody').innerHTML = html || '';
  bootstrap.Modal.getOrCreateInstance(document.getElementById('detailsModal')).show();
}

</script>

<!-- ===== Shared Override Modal (Formula / Final / Tier) ===== -->
<div class="modal fade" id="overrideModal" tabindex="-1" aria-labelledby="overrideModalLabel" aria-hidden="true">
<div class="modal-dialog">
  <form id="overrideForm" method="post" action="{% url 'characters:character_detail' character.pk %}" class="modal-content">

      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="overrideModalLabel">Edit Override</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="override_submit" value="1">
        <input type="hidden" name="override_key" id="ov_key">

        <div class="mb-2">
          <label class="form-label">Current total</label>
          <input class="form-control form-control-sm" id="ov_calc" readonly>
        </div>

        <div class="mb-2">
          <label class="form-label">Formula (optional)</label>
          <input class="form-control form-control-sm" name="override_formula" id="ov_formula" placeholder='e.g. "+2" or "base+prof+half+str_mod"'>
          <div class="form-text">Leave blank to clear the formula override.</div>
        </div>

        <div class="mb-2">
          <label class="form-label">Final (optional)</label>
          <input type="number" class="form-control form-control-sm" name="override_final" id="ov_final" placeholder="(number)">
          <div class="form-text">Leave blank to clear the final override.</div>
        </div>

        <div class="mb-2">
          <label class="form-label">Reason (required)</label>
          <input class="form-control form-control-sm" name="override_reason" id="ov_reason" required>
        </div>

        <!-- Tier override section (only for keys starting with "prof:") -->
        <div id="ov_tier_block" class="border-top pt-2 mt-3 d-none">
          <div class="mb-2">
            <label class="form-label">Proficiency Tier</label>
            <select class="form-select form-select-sm" id="ov_tier_select"></select>
            <div class="form-text">Use this to override the **tier** for this statistic.</div>
          </div>
          <div class="d-flex gap-2">
            <input type="hidden" name="prof_code" id="ov_prof_code">
            <input type="hidden" name="prof_tier_pk" id="ov_prof_tier_pk">
            <input type="hidden" name="prof_tier_reason" id="ov_prof_reason">
            <button type="submit" name="save_prof_tier_override" value="1" class="btn btn-sm btn-outline-primary">
              Save Tier Override
            </button>
            <button type="submit" name="clear_prof_tier_override" value="" id="ov_tier_clear_btn" class="btn btn-sm btn-outline-danger">
              Clear Tier Override
            </button>
          </div>
        </div>

        <!-- Optional debug formula viewer -->
        <div class="mt-3">
          <div id="ov_debug"></div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary">Save Formula / Final</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // Abort gracefully if Bootstrap bundle didn't load
  if (!window.bootstrap) {
    console.error('Bootstrap bundle not loaded; cannot initialize override modal.');
    return;
  }

  // Build Proficiency Levels JSON inline (from context)
  const PROF_LEVELS = [
    {% for pl in proficiency_levels %}
      {"id": {{ pl.id }}, "name": "{{ pl.name|escapejs }}", "bonus": {{ pl.bonus|default:0 }} }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  // Define renderDebug to avoid errors and show parts
  function renderDebug(target, data) {
    try {
      if (!data) { target.innerHTML = ""; return; }
      if (typeof data === 'string') data = JSON.parse(data);
      const parts = data.vars || [];
      let html = '<div class="small text-muted"><div><strong>Formula:</strong> ' + (data.formula || '') + '</div>';
      html += '<div><strong>Values:</strong> ' + (data.values || '') + '</div>';
      if (parts.length) {
html += '<div class="mt-1"><strong>Parts:</strong><ul class="mb-0">';
for (const p of parts) {
  html += `<li>${(p.name || p.label || p.key || 'part')}: ${p.value}${p.note ? ' (' + p.note + ')' : ''}</li>`;
}
html += '</ul></div>';

      }
      html += '</div>';
      target.innerHTML = html;
    } catch (e) {
      target.innerHTML = '';
    }
  }

  // Bind all ✎ buttons to open the modal (and show Tier block for "prof:*")
  (function(){
    const modalEl = document.getElementById('overrideModal');
    if (!modalEl) return;

    const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
    const keyEl   = document.getElementById('ov_key');
    const calcEl  = document.getElementById('ov_calc');
    const formEl  = document.getElementById('ov_formula');
    const finalEl = document.getElementById('ov_final');
    const reasonEl= document.getElementById('ov_reason');

    // Tier section
    const tierBlock   = document.getElementById('ov_tier_block');
    const tierSelect  = document.getElementById('ov_tier_select');
    const profCodeEl  = document.getElementById('ov_prof_code');
    const profTierPkEl= document.getElementById('ov_prof_tier_pk');
    const profReasonEl= document.getElementById('ov_prof_reason');
    const tierClearBtn= document.getElementById('ov_tier_clear_btn');

    const dbgEl = document.getElementById('ov_debug');

    document.querySelectorAll('.edit-override').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key     = btn.getAttribute('data-key') || '';
        const calc    = btn.getAttribute('data-calc') || '';
        const formula = btn.getAttribute('data-formula') || '';
        const dbgAttr = btn.getAttribute('data-debug') || '';
        const dbgElId = btn.getAttribute('data-debug-el') || '';
        let dbg = dbgAttr;
        if (!dbg && dbgElId) {
          const srcEl = document.getElementById(dbgElId);
          if (srcEl) dbg = srcEl.textContent || srcEl.innerText || '';
        }

        keyEl.value   = key;
        calcEl.value  = calc;
        formEl.value  = formula;
        finalEl.value = '';
        reasonEl.value= '';

        renderDebug(dbgEl, dbg);

        if (key.startsWith('prof:')) {
          tierBlock.classList.remove('d-none');
tierSelect.innerHTML = '<option value="">— Select Tier —</option>' +
  PROF_LEVELS.map(pl => `<option value="${pl.id}">${pl.name} (+${pl.bonus})</option>`).join('');

          const code = key.split(':')[1] || '';
          profCodeEl.value = code;
          profTierPkEl.value = '';
          profReasonEl.value = '';
          tierClearBtn.value = code;
        } else {
          tierBlock.classList.add('d-none');
          profCodeEl.value = '';
          profTierPkEl.value = '';
          profReasonEl.value = '';
          tierClearBtn.value = '';
        }

        tierSelect.onchange = ()=> {
          profTierPkEl.value = tierSelect.value;
          profReasonEl.value = reasonEl.value || '';
        };
        reasonEl.oninput = ()=> {
          if (profCodeEl.value) { profReasonEl.value = reasonEl.value; }
        };

        bsModal.show();
      });
    });
  })();
});
</script>

{# ======= MODALS (unchanged except for context vars already provided) ======= #}
<!-- LEVEL UP MODAL (REPLACEMENT) -->
{% firstof request.POST.advance_track request.GET.advance_track form.advance_track.value 'base' as track %}

<div class="modal fade" id="levelUpModal" tabindex="-1" aria-labelledby="levelUpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="levelUpModalLabel" class="modal-title">Level Up to {{ total_level|add:"1" }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-0">
        <div class="row g-0">
          <!-- LEFT column: track + selectors + preview -->
          <div class="col-12 col-xl-5 p-4 border-end">

            <!-- LEFT: PREVIEW/SELECTOR FORM (GET) -->
            <form id="classPreviewForm"
                  method="get"
                  action="{% url 'characters:character_detail' character.pk %}#levelUpModal"
                  class="mb-4">

              {% with next_level=total_level|add:"1" %}
              <div class="mb-2">
                <label class="form-label fw-semibold">Advance in…</label>

                <div class="form-check">
                  <input class="form-check-input"
                        type="radio"
                        id="adv-base"
                        name="advance_track"
                        value="base"
                        {% if track != 'prestige' %}checked{% endif %}>
                  <label class="form-check-label" for="adv-base">Base class</label>
                </div>

                <div class="form-check">
                  <input class="form-check-input"
                        type="radio"
                        id="adv-prestige"
                        name="advance_track"
                        value="prestige"
                        {% if next_level < 7 %}disabled{% endif %}
                        {% if track == 'prestige' and next_level >= 7 %}checked{% endif %}>
                  <label class="form-check-label" for="adv-prestige">
                    Prestige class
                    {% if next_level < 7 %}<span class="text-muted">(requires level 7+)</span>{% endif %}
                  </label>
                </div>

                <div class="form-text small mt-1">
                  Minimum level 7; at most one prestige class. Prerequisites must be met.
                </div>
              </div>
              {% endwith %}

              {# LEFT: Base class (visible when Base track) #}
              {% with sel=request.GET.base_class|default:preview_class.id %}
              <div id="left-base-wrap" class="mt-2" {% if track == 'prestige' %}hidden{% endif %}>
                <label class="form-label fw-semibold">Base class</label>
                <select name="base_class" id="left-base-class" class="form-select">
                  {% for cls in base_class_choices %}
                    <option value="{{ cls.id }}"
                            {% if sel|stringformat:"s" == cls.id|stringformat:"s" %}selected{% endif %}>
                      {{ cls.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              {% endwith %}

              {# LEFT: Prestige dropdown (only visible when Prestige track) #}
              <div id="left-prestige-wrap" class="mt-3" {% if track != 'prestige' %}hidden{% endif %}>
                <label class="form-label fw-semibold">Prestige class</label>
                {% if prestige_choices %}
                  {% with psel=request.GET.prestige_enrollment|default:'' %}
                    <select name="prestige_enrollment" id="left-prestige" class="form-select">
                      <option value="">— Select prestige —</option>
                      {% for p in prestige_choices %}
                        <option value="{{ p.id }}"
                                {% if p.allowed_bases.all %}
                                  data-bases="{% for bc in p.allowed_bases.all %}{{ bc.id }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                {% endif %}
                                {% if psel|stringformat:"s" == p.id|stringformat:"s" %}selected{% endif %}>
                          {{ p.name }}
                        </option>
                      {% endfor %}
                    </select>
                  {% endwith %}
                  <div class="form-text small mt-1" id="left-prestige-help" hidden>
                    Select a Base class for this prestige.
                  </div>
                {% else %}
                  <div class="text-muted small">No eligible prestige classes.</div>
                {% endif %}
              </div>

              {# Optional: mapping { "<prestige_id>": [<base_id>...] } #}
              {% if prestige_base_map %}
                {{ prestige_base_map|json_script:"prestige-base-map" }}
              {% endif %}
            </form>

            <!-- PREVIEW / INFO PANE (LEFT) -->
            <div class="mb-3">
              <h6 class="mb-2">Description</h6>
              {% if preview_class.description %}
                <div class="text-muted summernote-content">{{ preview_class.description|safe }}</div>
              {% else %}
                <div class="text-muted"><em>—</em></div>
              {% endif %}
            </div>

            <div class="mb-3 small text-muted">
              <div><strong>Hit Die:</strong> d{{ preview_class.hit_die }}</div>
              <div>
                <strong>Key Abilities:</strong>
                {% for a in preview_class.key_abilities.all %}
                  {{ a.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </div>
            </div>

            <div class="mb-3">
              <h6 class="mb-2">Proficiencies</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Type</th>
                      {% for tn in tier_names %}<th>{{ tn }}</th>{% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in proficiency_rows %}
                      <tr>
                        <td>{{ row.type }}</td>
                        {% for lvl in row.levels %}<td>{{ lvl }}</td>{% endfor %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mb-3">
              <h6 class="mb-2">Features at L{{ total_level|add:"1" }}</h6>
              <ul class="mb-0 ps-3">
                {% for f in auto_feats %}
                  <li class="mb-2">
                    {% if f.kind == "spell_table" and f.spell_row_next %}
                      <div class="table-responsive mt-2">
                        <table class="table table-sm table-bordered w-auto">
                          <thead>
                            <tr>
                              <th class="text-nowrap">Level</th>
                              {% for _ in "0123456789"|make_list %}<th>{{ forloop.counter }}</th>{% endfor %}
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td class="text-nowrap">Slots</td>
                              <td>{{ f.spell_row_next.slot1 }}</td>
                              <td>{{ f.spell_row_next.slot2 }}</td>
                              <td>{{ f.spell_row_next.slot3 }}</td>
                              <td>{{ f.spell_row_next.slot4 }}</td>
                              <td>{{ f.spell_row_next.slot5 }}</td>
                              <td>{{ f.spell_row_next.slot6 }}</td>
                              <td>{{ f.spell_row_next.slot7 }}</td>
                              <td>{{ f.spell_row_next.slot8 }}</td>
                              <td>{{ f.spell_row_next.slot9 }}</td>
                              <td>{{ f.spell_row_next.slot10 }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    {% endif %}
                    <div class="mt-2">
                      {% include "partials/_feature_detail.html" with f=f %}
                    </div>
                  </li>
                {% empty %}
                  <li><em>None</em></li>
                {% endfor %}
              </ul>
            </div>
          </div> <!-- /LEFT -->

          <!-- RIGHT: ACTUAL POST FORM -->
          <div class="col-12 col-xl-7 p-4 position-relative" id="levelUpFormCol">
            <form method="post" action="{% url 'characters:character_detail' character.pk %}">
              {% csrf_token %}

              {# Mirror of track + selectors for POST (hidden) #}
              {% firstof request.POST.advance_track request.GET.advance_track form.advance_track.value 'base' as track %}
              <input type="hidden" name="advance_track" id="postAdvanceTrack" value="{{ track|default:'base' }}">

              {# Prestige-only (POST mirror, plus counts-as) #}
              <div id="prestige-fields" {% if track != 'prestige' %}hidden{% endif %}>
                {% if form.prestige_enrollment %}
                  <input type="hidden"
                        name="{{ form.prestige_enrollment.html_name }}"
                        id="postPrestigeEnrollment"
                        value="{{ request.GET.prestige_enrollment|default:'' }}">
                {% endif %}

                {% if form.prestige_counts_as %}
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Counts-as (this prestige level)</label>
                    {{ form.prestige_counts_as }}
                    {% for e in form.prestige_counts_as.errors %}
                      <div class="text-danger small">{{ e }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>

              <!-- Base-only fields wrapper -->
              <div id="base-fields" {% if track == 'prestige' %}hidden{% endif %}>

                <!-- Keep POST base_class in sync with left select -->
                <input type="hidden" name="base_class" id="postBaseClass"
                      value="{{ request.GET.base_class|default:preview_class.id }}">

                {% if show_starting_skill_picker %}
                  {% with sc=starting_skill_choices %}
                    {% if sc.skills or sc.subskills %}
                      <div class="card skill-picker mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                          <span class="fw-semibold">Starting Skills (Level 1)</span>
                          <small class="text-muted">
                            <span id="ss-count">0</span>/<span id="ss-max">{{ starting_skill_max|default:0 }}</span> selected
                          </small>
                        </div>

                        <div class="card-body p-0">
                          <div class="skill-toolbar p-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Filter skills…" id="ss-filter">
                          </div>

                          <div class="skill-list" id="startingSkillList">
                            {% for s in starting_skill_flat %}
                              <label class="skill-item">
                                <input type="checkbox"
                                      class="form-check-input skill-checkbox"
                                      name="starting_skill_picks"
                                      value="{{ s.id_key }}">
                                <span class="skill-label">{{ s.label }}</span>
                              </label>
                            {% empty %}
                              <div class="p-3 text-muted">No available skills.</div>
                            {% endfor %}
                          </div>
                        </div>

                        <div class="card-footer">
                          <div class="form-text">
                            Choose up to <strong>{{ starting_skill_max|default:0 }}</strong> total.
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endwith %}
                {% endif %}
</div> <!-- /#base-fields -->

                {% if form.general_feat %}
                  <div class="mb-3">
                    <label class="form-label">{{ form.general_feat.label }}</label>
                    <input type="text" id="general-feat-filter" class="form-control mb-2" placeholder="Filter feats…">
                    <table id="general-feats-table" class="table table-bordered">
                      <thead>
                        <tr>
                          <th></th>
                          <th data-sort="1">Feat</th>
                          <th data-sort="2">Description</th>
                          <th data-sort="3">Level</th>
                          <th data-sort="4">
                            Requirements
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown" data-bs-display="static">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                          <th data-sort="5">
                            Tags
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown" data-bs-display="static">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="5" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for feat in form.general_feat.field.queryset %}
                          <tr>
                            <td>
                              <input
                                type="radio"
                                name="{{ form.general_feat.html_name }}"
                                value="{{ feat.pk }}"
                                {% if form.general_feat.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                                {% if form.general_feat.field.required %}required{% endif %}
                              >
                            </td>
                            <td class="feat-name">{{ feat.name }}</td>
                            <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
                            <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                            <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                            <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    {% for err in form.general_feat.errors %}
                      <div class="text-danger">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if form.asi_mode %}
                  <div class="mb-4">
                    <label class="form-label d-block">Ability Score Increase</label>

                    <input type="hidden" name="{{ form.asi_mode.html_name }}" id="id_asi_mode" value="{{ form.asi_mode.value|default:'' }}">
                    <input type="hidden" name="{{ form.asi_a.html_name }}"    id="id_asi_a"    value="{{ form.asi_a.value|default:'' }}">
                    <input type="hidden" name="{{ form.asi_b.html_name }}"    id="id_asi_b"    value="{{ form.asi_b.value|default:'' }}">

                    <div class="table-responsive">
                      <table class="table table-bordered align-middle" id="asi-table">
                        <thead>
                          <tr>
                            <th>Ability</th>
                            <th>Current</th>
                            <th>+1</th>
                            <th>+1</th>
                            <th>Result</th>
                          </tr>
                        </thead>
                        <tbody>
                        {% for label,val in ability_map.items %}
                          {% with key=label|lower %}
                          <tr data-key="{{ key }}" data-base="{{ val }}">
                            <td class="fw-semibold">{{ label }}</td>
                            <td class="asi-current">{{ val }}</td>
                            <td class="text-center">
                              <input type="checkbox" class="form-check-input asi-slot" data-slot="A" aria-label="+1 Slot A to {{ label }}">
                            </td>
                            <td class="text-center">
                              <input type="checkbox" class="form-check-input asi-slot" data-slot="B" aria-label="+1 Slot B to {{ label }}">
                            </td>
                            <td class="asi-result">{{ val }}</td>
                          </tr>
                          {% endwith %}
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>

                    <div class="small" id="asi-help"></div>
                    <div class="small mt-2"><strong>Preview:</strong> <span id="asi-preview">—</span></div>

                    {% for err in form.non_field_errors %}
                      <div class="text-danger mt-2">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
                <div id="base-fields-tail" {% if track == 'prestige' %}hidden{% endif %}>
                {% if form.class_feat_pick %}
                  <div class="mb-4">
                    <label class="form-label">{{ form.class_feat_pick.label }}</label>
                    <input type="text" id="class-feat-filter" class="form-control mb-2" placeholder="Filter feats…">

                    <table id="class-feats-table" class="table table-bordered">
                      <thead>
                        <tr>
                          <th></th>
                          <th data-sort="1">Feat</th>
                          <th data-sort="2">Description</th>
                          <th data-sort="3">Level</th>
                          <th data-sort="4">
                            Requirements
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                          <th data-sort="5">
                            Tags
                            <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                              <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                              <div class="dropdown-menu p-3 excel-menu" data-col="5" data-split="1" style="width:260px;"></div>
                            </div>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for feat in form.class_feat_pick.field.queryset %}
                          <tr>
                            <td>
                              <input
                                type="radio"
                                name="{{ form.class_feat_pick.html_name }}"
                                value="{{ feat.pk }}"
                                {% if form.class_feat_pick.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                                {% if form.class_feat_pick.field.required %}required{% endif %}
                              >
                            </td>
                            <td class="feat-name">{{ feat.name }}</td>
                            <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
                            <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                            <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                            <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                          </tr>
                        {% empty %}
                          <tr>
                            <td colspan="6" class="text-muted"><em>No class feats meet your current class/level filters.</em></td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>

                    {% for err in form.class_feat_pick.errors %}
                      <div class="text-danger">{{ err }}</div>
                    {% endfor %}
                  </div>
                {% endif %}

                {% if form.skill_feat_pick %}
                  {% with fld=form.skill_feat_pick %}
                    <div class="mb-4">
                      <label class="form-label">{{ fld.label }}</label>
                      <input type="text" id="skill-feat-filter" class="form-control mb-2" placeholder="Filter skill feats…">

                      <table id="skill-feats-table" class="table table-bordered">
                        <thead>
                          <tr>
                            <th></th>
                            <th data-sort="1">Feat</th>
                            <th data-sort="2">Description</th>
                            <th data-sort="3">Level</th>
                            <th data-sort="4">Requirements</th>
                            <th data-sort="5">Tags</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for feat in fld.field.queryset %}
                            <tr>
                              <td>
                                {% with multi=fld.field.widget.allow_multiple_selected %}
                                  <input
                                    type="{% if multi %}checkbox{% else %}radio{% endif %}"
                                    name="{{ fld.html_name }}"
                                    value="{{ feat.pk }}"
                                    {% if multi %}
                                      {% if fld.value and feat.pk|stringformat:"s" in fld.value %}checked{% endif %}
                                    {% else %}
                                      {% if fld.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                                      {% if fld.field.required %}required{% endif %}
                                    {% endif %}
                                  >
                                {% endwith %}
                              </td>
                              <td class="feat-name">{{ feat.name }}</td>
                              <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
                              <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                              <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                              <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                            </tr>
                          {% empty %}
                            <tr><td colspan="6" class="text-muted"><em>No skill feats available at this level.</em></td></tr>
                          {% endfor %}
                        </tbody>
                      </table>

                      {% for err in fld.errors %}
                        <div class="text-danger">{{ err }}</div>
                      {% endfor %}
                    </div>
                  {% endwith %}
                {% elif form.skill_feat %}
                  {% with fld=form.skill_feat %}
                    <div class="mb-4">
                      <label class="form-label">{{ fld.label }}</label>
                      <input type="text" id="skill-feat-filter" class="form-control mb-2" placeholder="Filter skill feats…">

                      <table id="skill-feats-table" class="table table-bordered">
                        <thead>
                          <tr>
                            <th></th>
                            <th data-sort="1">Feat</th>
                            <th data-sort="2">Description</th>
                            <th data-sort="3">Level</th>
                            <th data-sort="4">Requirements</th>
                            <th data-sort="5">Tags</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for feat in fld.field.queryset %}
                            <tr>
                              <td>
                                {% with multi=fld.field.widget.allow_multiple_selected %}
                                  <input
                                    type="{% if multi %}checkbox{% else %}radio{% endif %}"
                                    name="{{ fld.html_name }}"
                                    value="{{ feat.pk }}"
                                    {% if multi %}
                                      {% if fld.value and feat.pk|stringformat:"s" in fld.value %}checked{% endif %}
                                    {% else %}
                                      {% if fld.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                                      {% if fld.field.required %}required{% endif %}
                                    {% endif %}
                                  >
                                {% endwith %}
                              </td>
                              <td class="feat-name">{{ feat.name }}</td>
                              <td class="feat-desc summernote-content">{{ feat.description|default:"(no description)"|safe }}</td>
                              <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                              <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                              <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                            </tr>
                          {% empty %}
                            <tr><td colspan="6" class="text-muted"><em>No skill feats available at this level.</em></td></tr>
                          {% endfor %}
                        </tbody>
                      </table>

                      {% for err in fld.errors %}
                        <div class="text-danger">{{ err }}</div>
                      {% endfor %}
                    </div>
                  {% endwith %}
                {% endif %}

                {# === FEATURE FIELDS LOOP (unchanged) === #}
                {% for item in feature_fields %}
                  {% if item.kind == "subclass_choice" %}
                    <div class="mb-4">
                      <label class="form-label d-block">{{ item.label }}</label>
                      <div class="d-grid gap-2">
                        {% for sc in item.group.subclasses.all %}
                          {% with rid=item.field.id_for_label|add:"_"|add:sc.pk|stringformat:"s" %}
                          <label for="{{ rid }}" class="border rounded p-3 d-flex gap-3 align-items-start">
                            <input
                              type="radio"
                              id="{{ rid }}"
                              name="{{ item.field.name }}"
                              value="{{ sc.pk }}"
                              class="form-check-input mt-1"
                              {% if item.field.value|stringformat:"s" == sc.pk|stringformat:"s" %}checked{% endif %}
                              {% if item.field.field.required %}required{% endif %}
                            />
                            <div class="flex-grow-1">
                              <div class="fw-semibold">{{ sc.name }}</div>
                              {% if sc.description %}
                                <div class="small text-muted mt-1 summernote-content">{{ sc.description|safe }}</div>
                              {% endif %}
                              {% if sc.feats_next %}
                                <div class="small mt-2">
                                  <div class="fw-semibold mb-1">Features at L{{ total_level|add:"1" }}:</div>
                                  <div class="d-grid gap-2">
                                    {% for f in sc.feats_next %}
                                      <div class="border rounded p-2">
                                        {% include "partials/_feature_detail.html" with f=f %}
                                      </div>
                                    {% endfor %}
                                  </div>
                                </div>
                              {% endif %}
                            </div>
                          </label>
                          {% endwith %}
                        {% empty %}
                          <div class="text-muted"><em>No subclasses available.</em></div>
                        {% endfor %}
                      </div>
                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>

                  {% elif item.kind == "option" %}
                    <div class="mb-4">
                      <div class="mb-2 fw-semibold">{{ item.label }}</div>
                      <div class="border rounded p-3 mb-3">
                        {% include "partials/_feature_detail.html" with f=item.feature %}
                      </div>

                      <div class="d-grid gap-2">
                        {% for opt in item.feature.options.all %}
                          {% with radio_id=item.field.id_for_label|add:"_"|add:opt.pk|stringformat:"s" %}
                          <label for="{{ radio_id }}" class="border rounded p-3 d-flex gap-3 align-items-start">
                            <input
                              type="radio"
                              id="{{ radio_id }}"
                              name="{{ item.field.name }}"
                              value="{{ opt.pk }}"
                              class="form-check-input mt-1"
                              {% if item.field.value|stringformat:"s" == opt.pk|stringformat:"s" %}checked{% endif %}
                              {% if item.field.field.required %}required{% endif %}
                            />
                            <div class="flex-grow-1">
                              <div class="fw-semibold">{{ opt.label }}</div>
                              {% if opt.grants_feature %}
                                <div class="mt-2">
                                  {% include "partials/_feature_detail.html" with f=opt.grants_feature %}
                                </div>
                              {% endif %}
                            </div>
                          </label>
                          {% endwith %}
                        {% endfor %}
                      </div>

                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>

                  {% elif item.kind == "gain_subclass_feat" %}
                    <div class="mb-4">
                      <div class="mb-2 fw-semibold">{{ item.label }}</div>

                      {% if item.system == "linear" and not item.subclass %}
                        <div class="alert alert-warning p-2">Pick a subclass above …</div>
                      {% endif %}
                      {% if item.system == "linear" %}
                        <div class="alert alert-info p-2">
                          Linear progression: the following {{ item.group.name }} feature(s) are granted automatically.
                        </div>
                      {% endif %}

                      <div class="d-grid gap-2">
                        {% with selected_vals=item.field.value %}
                          {% for f in item.eligible %}
                            {% with cid=item.field.id_for_label|add:"_"|add:f.pk|stringformat:"s" %}
                            <label for="{{ cid }}" class="border rounded p-3 d-flex gap-3 align-items-start">
                              {% if item.system == "linear" %}
                                <input type="checkbox" id="{{ cid }}" disabled checked class="form-check-input mt-1">
                              {% else %}
                                <input
                                  type="checkbox"
                                  id="{{ cid }}"
                                  name="{{ item.field.name }}"
                                  value="{{ f.pk }}"
                                  class="form-check-input mt-1"
                                  {% if selected_vals and f.pk|stringformat:"s" in selected_vals %}checked{% endif %}
                                >
                              {% endif %}
                              <div class="flex-grow-1">
                                {% include "partials/_feature_detail.html" with f=f %}
                              </div>
                            </label>
                            {% endwith %}
                          {% empty %}
                            <div class="text-muted"><em>No eligible features at this level.</em></div>
                          {% endfor %}
                        {% endwith %}
                      </div>

                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>

                  {% else %}
                    <div class="mb-3">
                      <label class="form-label">{{ item.label }}</label>
                      {{ item.field }}
                      {% for err in item.field.errors %}
                        <div class="text-danger mt-1">{{ err }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                {# === END FEATURE FIELDS LOOP === #}
                </div> <!-- /#base-fields-tail -->


              <button type="submit" name="level_up_submit" class="btn btn-primary">
                Confirm Level Up
              </button>
            </form>
          </div> <!-- /RIGHT -->
        </div> <!-- /.row -->

        <!-- Modal-scoped JS -->
        <script>
        (function(){
          // Auto-open when hash is present
          if (window.location.hash === "#levelUpModal") {
            const el = document.getElementById("levelUpModal");
            if (el && window.bootstrap) bootstrap.Modal.getOrCreateInstance(el).show();
          }

          const leftForm  = document.getElementById('classPreviewForm');
          const advBase   = document.getElementById('adv-base');
          const advPrest  = document.getElementById('adv-prestige');

          const leftBaseWrap   = document.getElementById('left-base-wrap');
          const leftBaseSelect = document.getElementById('left-base-class');
          const leftPrestWrap  = document.getElementById('left-prestige-wrap');
          const leftPrest      = document.getElementById('left-prestige');
          const leftPrestHelp  = document.getElementById('left-prestige-help');

          const postAdvance    = document.getElementById('postAdvanceTrack');
          const postBase       = document.getElementById('postBaseClass');
          const postPrest      = document.getElementById('postPrestigeEnrollment');


          const baseHead       = document.getElementById('base-fields');
          const baseTail       = document.getElementById('base-fields-tail');
          const prestigeFields = document.getElementById('prestige-fields');

          // Optional JSON mapping injected by view
          let PBM = {};
          const pbmEl = document.getElementById('prestige-base-map');
          if (pbmEl && pbmEl.textContent) {
            try { PBM = JSON.parse(pbmEl.textContent); } catch(e) {}
          }

          function getAllowedBases(){
            if (!leftPrest || !leftPrest.value) return null;
            const pid = String(leftPrest.value);
            if (PBM && PBM[pid] && PBM[pid].length) return PBM[pid].map(String);
            const opt = leftPrest.options[leftPrest.selectedIndex];
            const csv = opt ? (opt.getAttribute('data-bases') || '') : '';
            const arr = csv.split(',').map(s => s.trim()).filter(Boolean);
            return arr.length ? arr : null;
          }

          function filterBaseForPrestige(){
            if (!leftBaseSelect) return;
            const allowed = getAllowedBases(); // null → no restriction
            [...leftBaseSelect.options].forEach(o => {
              const ok = !allowed || allowed.includes(String(o.value));
              o.hidden = o.disabled = !ok;
            });

            const cur = leftBaseSelect.options[leftBaseSelect.selectedIndex];
            if (!cur || cur.hidden || cur.disabled) {
              const firstOk = [...leftBaseSelect.options].find(o => !o.hidden && !o.disabled);
              if (firstOk) firstOk.selected = true;
            }

            const isPrestige = advPrest && advPrest.checked;
            const showBaseForPrestige = isPrestige && allowed && allowed.length > 1;
            if (leftBaseWrap) leftBaseWrap.hidden = isPrestige ? !showBaseForPrestige : false;
            if (leftPrestHelp) leftPrestHelp.hidden = !showBaseForPrestige;

            if (postBase && leftBaseSelect) postBase.value = leftBaseSelect.value || '';
            if (leftForm && leftForm.requestSubmit) leftForm.requestSubmit();
          }

          function flipTrackUI(){
            const isPrestige = advPrest && advPrest.checked;

            if (leftPrestWrap) leftPrestWrap.hidden = !isPrestige;
            if (leftBaseWrap)  leftBaseWrap.hidden  = isPrestige ? true : false;

            if (baseHead)       baseHead.hidden       =  isPrestige;
            if (baseTail)       baseTail.hidden       =  isPrestige;
            if (prestigeFields) prestigeFields.hidden = !isPrestige;

            if (postAdvance) postAdvance.value = isPrestige ? 'prestige' : 'base';

            if (isPrestige) filterBaseForPrestige();

            if (leftForm && leftForm.requestSubmit) leftForm.requestSubmit();
          }

          if (advBase)  advBase.addEventListener('change', flipTrackUI);
          if (advPrest) advPrest.addEventListener('change', flipTrackUI);

          if (leftPrest) {
            leftPrest.addEventListener('change', () => {
              if (postPrest) postPrest.value = leftPrest.value || '';
              filterBaseForPrestige();
            });
          }

          if (leftBaseSelect) {
            leftBaseSelect.addEventListener('change', () => {
              if (postBase) postBase.value = leftBaseSelect.value || '';
              if (leftForm && leftForm.requestSubmit) leftForm.requestSubmit();
            });
          }

          flipTrackUI();
        })();
        </script>
      </div> <!-- /.modal-body -->
    </div> <!-- /.modal-content -->
  </div> <!-- /.modal-dialog -->
</div> <!-- /LEVEL UP MODAL -->

{% if can_share %}
<!-- SHARE MODAL (styled like the others) -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="shareModalLabel" class="modal-title">Share Character</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="post" action="{% url 'characters:character_share_create' character.pk %}">
        {% csrf_token %}
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Select a user</label>
            <select class="form-select" name="user_id" required>
              <option value="" selected disabled>— Choose a user —</option>
              {% for u in available_users %}
                <option value="{{ u.id }}">
                  {{ u.get_full_name|default:u.username }} ({{ u.email }})
                </option>
              {% endfor %}
            </select>

            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="send_email" id="sendEmail" checked>
              <label class="form-check-label" for="sendEmail">Email a notification</label>
            </div>
          </div>

          {% if share_invites %}
            <div class="mb-3">
              <h6 class="mb-2">Pending invites</h6>
              <ul class="list-group">
                {% for inv in share_invites %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                      <strong>{{ inv.invited_email }}</strong>
                      <small class="text-muted ms-1">expires {{ inv.expires_at|date:"Y-m-d H:i" }}</small>
                    </span>
                    <a class="btn btn-sm btn-outline-danger"
                       href="{% url 'characters:character_share_revoke' character.pk inv.pk %}">
                      Revoke
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          <div>
            <h6 class="mb-2">People with access</h6>
            {% if shared_viewers %}
              <ul class="list-group">
                {% for v in shared_viewers %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                      {{ v.user.get_full_name|default:v.user.username }}
                      <small class="text-muted ms-1">({{ v.user.email }})</small>
                    </span>
                    <a class="btn btn-sm btn-outline-danger"
                       href="{% url 'characters:character_share_remove' character.pk v.user_id %}">
                      Remove
                    </a>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">No additional viewers.</p>
            {% endif %}
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Share</button>
        </div>
      </form>

    </div>
  </div>
</div>
{% endif %}


<!-- EDIT CHARACTER MODAL (unchanged) -->
<div class="modal fade" id="editCharacterModal" tabindex="-1" aria-labelledby="editCharacterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="editCharacterModalLabel" class="modal-title">Edit Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

<form id="levelUpPostForm" method="post" action="{% url 'characters:character_detail' character.pk %}">
        {% csrf_token %}
        <div class="modal-body">
          {% if edit_form %}
            {{ edit_form.non_field_errors }}
<div class="row g-3">
  {% for field in edit_form.visible_fields %}
    <div class="col-12">
      {{ field.label_tag }} {{ field }}
      {% if field.errors %}
        <div class="text-danger small">{{ field.errors|join:", " }}</div>
      {% endif %}
      <input class="form-control form-control-sm mt-1"
             name="note__{{ field.name }}"
             placeholder="Reason (required if changed)">
    </div>
  {% endfor %}
</div>

          {% else %}
            <p class="mb-0 text-muted">You don’t have permission to edit this character.</p>
          {% endif %}
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          {% if edit_form %}
            <button type="submit" class="btn btn-primary" name="edit_character_submit" value="1">Save</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>
<!-- QUICK EDIT NUMBER MODAL -->
<div class="modal fade" id="editNumberModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Adjust Value</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editNumberForm">
        <div class="modal-body">
          <input type="hidden" id="edit-key" name="key">
          <div class="mb-2">
            <label class="form-label form-label-sm">New value</label>
            <input type="number" step="1" class="form-control form-control-sm" id="edit-value" required>
          </div>
          <div>
            <label class="form-label form-label-sm">Reason</label>
            <input class="form-control form-control-sm" id="edit-note" placeholder="Why are you changing this?" required>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary btn-sm">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>



<div class="modal fade" id="skillEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Skill</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="skillEditModalBody"></div>
    </div>
  </div>
</div>





{% endblock %}

{# --- DEBUG BANK USED BY THE OVERRIDE MODAL --- #}
<div class="d-none" id="debug-bank">
  {% for r in defense_rows %}
    <script type="application/json" id="dbg-{{ r.code }}">{{ r.debug_json|safe }}</script>
  {% endfor %}
  {% if spell_dc_rows and spell_dc_rows.0 %}
    <script type="application/json" id="dbg-dc">{{ spell_dc_rows.0.debug_json|safe }}</script>
  {% endif %}
</div>

{% block extra_js %}

 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){

  if (window.location.hash === "#levelUpModal") {
    const el = document.getElementById("levelUpModal");
    bootstrap.Modal.getOrCreateInstance(el).show();
  }

  // Auto-submit the left-side preview form when base class changes
  const previewForm = document.getElementById("classPreviewForm");
  if (previewForm) {
    const sel = previewForm.querySelector('select[name="{{ form.base_class.html_name|default:"base_class" }}"]');
    if (sel) {
      sel.addEventListener('change', () => {
        if (previewForm.requestSubmit) previewForm.requestSubmit();
        else previewForm.submit();
      });
    }
  }
});
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  // Event delegation for any "Details" toggle button
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.toggle-desc');
    if (!btn) return;

    // Find the closest container that logically owns its details block
    // (works for <li>, table cells/rows, etc.)
    const container = btn.closest('li, td, tr, .list-group-item, .card, .card-body, .tab-pane') || document;

    // Prefer a details block within the same container
    let panel = container.querySelector('.desc-body');

    // Fallback: if the immediate sibling after the button is the panel
    if (!panel && btn.nextElementSibling && btn.nextElementSibling.classList.contains('desc-body')) {
      panel = btn.nextElementSibling;
    }
    // Fallback #2: walk up to a common parent and look for the next .desc-body
    if (!panel) {
      let p = btn.parentElement;
      while (p && p !== container && !panel) {
        if (p.nextElementSibling && p.nextElementSibling.classList?.contains('desc-body')) {
          panel = p.nextElementSibling;
          break;
        }
        p = p.parentElement;
      }
    }

    if (!panel) return; // nothing to toggle

    panel.classList.toggle('d-none');

    // Optional: flip button label between Details/Hide
    const shown = !panel.classList.contains('d-none');
    const orig = btn.getAttribute('data-label') || 'Details';
    const alt  = btn.getAttribute('data-label-alt') || 'Hide';
    btn.textContent = shown ? alt : orig;
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.open-skill-edit');
    if (!btn) return;

    const sid = btn.getAttribute('data-sid');
    const tpl = document.getElementById(`skedit-${sid}-tpl`);
    if (!tpl) return;

    // inject the template into the modal body and show it
    const body = document.getElementById('skillEditModalBody');
    body.innerHTML = '';
    body.appendChild(tpl.content.cloneNode(true));

    bootstrap.Modal.getOrCreateInstance(
      document.getElementById('skillEditModal')
    ).show();
  });
});
</script>


  {{ ability_map|json_script:"abilities-data" }}

  {% if form.asi_mode %}
  <script>
  (function(){
    const dataEl = document.getElementById("abilities-data");
    if (!dataEl) return;
    const base = JSON.parse(dataEl.textContent || "{}");

    const tbl = document.getElementById("asi-table");
    if (!tbl) return;

    const help = document.getElementById("asi-help");
    const preview = document.getElementById("asi-preview");

    const modeInput = document.getElementById("id_asi_mode");
    const aInput    = document.getElementById("id_asi_a");
    const bInput    = document.getElementById("id_asi_b");

    let slotA = aInput?.value || "";
    let slotB = bInput?.value || "";

    function pretty(k){ return k.charAt(0).toUpperCase() + k.slice(1); }
    function getBase(k){ return Number(base[pretty(k)] || 0); }
    function lockToOne(){ return [slotA, slotB].filter(Boolean).some(k => getBase(k) >= 20); }

    function updateUI(){
      ["A","B"].forEach((slot) => {
        tbl.querySelectorAll('input.asi-slot[data-slot="'+slot+'"]').forEach((bx)=>{
          const key = bx.closest("tr").dataset.key;
          if (slot === "A") bx.checked = (key === slotA);
          if (slot === "B") bx.checked = (key === slotB);
        });
      });

      const oneOnly = lockToOne();
      const bBoxes = tbl.querySelectorAll('input.asi-slot[data-slot="B"]');
      if (oneOnly) {
        if (slotA && slotB) slotB = "";
        bBoxes.forEach(bx => bx.disabled = true);
        help.innerHTML = '<span class="text-warning">One chosen ability is 20+, so only a single +1 may be applied.</span>';
      } else {
        bBoxes.forEach(bx => bx.disabled = false);
        help.textContent = '';
      }

      tbl.querySelectorAll("tbody tr").forEach(tr => {
        const key = tr.dataset.key;
        const before = Number(tr.dataset.base);
        let inc = 0;
        if (slotA === key) inc += 1;
        if (slotB === key) inc += 1;
        tr.querySelector(".asi-result").textContent = before + inc;
        tr.classList.remove("table-success","table-warning");
        if (inc === 2) tr.classList.add("table-success");
        if (inc === 1) tr.classList.add("table-warning");
      });

      let mode = "";
      if (slotA && slotB) mode = (slotA === slotB) ? "2" : "1+1";
      else if (slotA || slotB) mode = "1";
      if (oneOnly && mode !== "1") { slotB = ""; mode = "1"; }

      modeInput.value = mode;
      aInput.value    = slotA || slotB || "";
      bInput.value    = (mode === "1+1" || mode === "2") ? (slotB || slotA) : "";

   function upText(k, inc){ return `${pretty(k)}: ${getBase(k)} → ${getBase(k)+inc}`; }
      let txt = "—";
      if (mode === "2")       txt = upText(slotA, 2);
      else if (mode === "1+1")txt = `${upText(slotA,1)}; ${upText(slotB,1)}`;
      else if (mode === "1")  txt = upText(slotA || slotB, 1);
      preview.textContent = txt;
    }

    tbl.addEventListener("change", (e) => {
      const box = e.target;
      if (!box.matches(".asi-slot")) return;
      const slot = box.dataset.slot;
      const key  = box.closest("tr").dataset.key;
      if (slot === "A") slotA = box.checked ? key : (slotA === key ? "" : slotA);
      else              slotB = box.checked ? key : (slotB === key ? "" : slotB);
      if (lockToOne() && slotA && slotB) {
        if (slot === "A") slotB = ""; else slotA = "";
      }
      updateUI();
    });

    updateUI();
  })();
  </script>
  {% endif %}


  <script>
  (function(){
window.initFeatTable = function(opts){

  var table = document.getElementById(opts.tableId);
  if (!table) return;

  function cellText(row, idx){ var c=row.cells[idx]; return (c?c.textContent:"").trim(); }
  table.querySelectorAll("th[data-sort]").forEach(function(th){
    th.style.cursor = "pointer";
    th.addEventListener("click", function(){
      var col = parseInt(th.getAttribute("data-sort"), 10);
      var asc = th.getAttribute("data-order") !== "asc";
      th.setAttribute("data-order", asc ? "asc" : "desc");
      var rows = Array.from(table.tBodies[0].rows).filter(function(r,i){ return !r.classList.contains("desc-body"); });
      rows.sort(function(a,b){
        var A = cellText(a, col).toLowerCase(), B = cellText(b, col).toLowerCase();
        return asc ? A.localeCompare(B, undefined, {numeric:true}) : B.localeCompare(A, undefined, {numeric:true});
      });
      // keep each details row just after its data row
      rows.forEach(function(r){
        var detail = r.nextElementSibling && r.nextElementSibling.classList.contains("desc-body") ? r.nextElementSibling : null;
        table.tBodies[0].appendChild(r);
        if (detail) table.tBodies[0].appendChild(detail);
      });
    });
  });

  var BLANK="(Blanks)";
  function splitTokens(txt){ return txt.split(/[,;/]/).map(function(s){return s.trim();}).filter(Boolean); }

  // Build dropdown menu lists
  function uniqueValuesForCol(colIdx, splitByTokens){
    var set = new Set();
    Array.from(table.tBodies[0].rows).forEach(function(r){
      if (r.classList.contains("desc-body")) return;
      var txt = cellText(r, colIdx);
      if (!txt) set.add(BLANK);
      else if (splitByTokens){ splitTokens(txt).forEach(function(tok){ set.add(tok); }); }
      else set.add(txt);
    });
    return Array.from(set).sort(function(a,b){ return a.localeCompare(b, undefined, {numeric:true}); });
  }

  var dropdownFilters = [];  // [{col, split, selected, enabled}]
  function buildFilterMenu(menuEl){
    var col   = parseInt(menuEl.dataset.col, 10);
    var split = menuEl.dataset.split === "1";
    var values = uniqueValuesForCol(col, split);

    menuEl.innerHTML = [
      '<div class="d-flex justify-content-between small mb-2">',
      '  <a href="#" class="excel-sel-all">Select all</a>',
      '  <a href="#" class="excel-clear">Clear</a>',
      '</div>',
      '<input type="text" class="form-control form-control-sm mb-2 excel-search" placeholder="Search values…">',
      '<div class="excel-list" style="max-height:220px; overflow:auto;"></div>',
      '<div class="d-flex justify-content-end gap-2 mt-2">',
      '  <button type="button" class="btn btn-sm btn-outline-secondary excel-cancel">Cancel</button>',
      '  <button type="button" class="btn btn-sm btn-success excel-ok">OK</button>',
      '</div>'
    ].join("");

    var list = menuEl.querySelector(".excel-list");
    function renderList(filter){
      list.innerHTML = "";
      values.forEach(function(v){
        if (filter && v.toLowerCase().indexOf(filter.toLowerCase()) === -1) return;
        var id = "excel_"+opts.tableId+"_"+col+"_"+btoa(unescape(encodeURIComponent(v))).replace(/=/g,'');
        var div = document.createElement("div");
        div.className = "form-check";
        div.innerHTML = '<input class="form-check-input" type="checkbox" id="'+id+'" value="'+v+'" checked>' +
                        '<label class="form-check-label small" for="'+id+'">'+v+'</label>';
        list.appendChild(div);
      });
    }
    renderList("");

    menuEl.querySelector(".excel-search").addEventListener("input", function(){ renderList(this.value.trim()); });
    menuEl.addEventListener("click", function(e){
      if (e.target.matches(".excel-sel-all")){ e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true); applyAllFilters(); }
      if (e.target.matches(".excel-clear"))  { e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); applyAllFilters(); }
      if (e.target.matches(".excel-ok,.excel-cancel")){
        var dd = bootstrap.Dropdown.getOrCreateInstance(menuEl.parentElement.querySelector('[data-bs-toggle="dropdown"]'));
        dd.hide();
      }
    });
    list.addEventListener("change", applyAllFilters);

    menuEl.dataset.ready = "1";
    dropdownFilters.push({col: col, split: split, selected: function(){
      return Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(function(cb){ return cb.value; });
    }});
  }

  table.querySelectorAll(".excel-menu[data-col]").forEach(buildFilterMenu);

  // Per-column text search
  var textFilters = {}; // {col -> lowercased substring}
  table.querySelectorAll(".col-search").forEach(function(inp){
    var col = parseInt(inp.dataset.col, 10);
    textFilters[col] = "";
    inp.addEventListener("input", function(){
      textFilters[col] = (inp.value || "").trim().toLowerCase();
      applyAllFilters();
    });
  });

  function matchesDropdowns(row){
    var show = true;
    dropdownFilters.forEach(function(f){
      if (!show) return;
      var txt = cellText(row, f.col);
      var tokens = (!txt) ? [BLANK] : (f.split ? splitTokens(txt) : [txt]);
      var selected = f.selected();
      // if a menu exists, and nothing is selected, hide all
      if (table.querySelector('.excel-menu[data-col="'+f.col+'"]')) {
        if (selected.length === 0) { show = false; return; }
        show = tokens.some(function(tok){ return selected.indexOf(tok) !== -1; });
      }
    });
    return show;
  }

  function matchesText(row){
    for (var col in textFilters){
      var q = textFilters[col];
      if (!q) continue;
      var txt = cellText(row, parseInt(col,10)).toLowerCase();
      if (txt.indexOf(q) === -1) return false;
    }
    return true;
  }

  function applyAllFilters(){
    Array.from(table.tBodies[0].rows).forEach(function(row){
      if (row.classList.contains("desc-body")) return;
      var ok = matchesDropdowns(row) && matchesText(row);
      row.style.display = ok ? "" : "none";
      var detail = row.nextElementSibling;
      if (detail && detail.classList.contains("desc-body")) {
        // hide details row if master row hidden
        detail.style.display = ok ? detail.style.display : "none";
      }
    });
  }

  // radio highlight (if any radios exist inside)
  table.addEventListener("change", function(e){
    if (e.target.type === "radio") {
      table.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("is-active"));
      e.target.closest("tr").classList.add("is-active");
    }
  });

  // initial filter pass
  applyAllFilters();
}

  initFeatTable({ tableId: "general-feats-table", searchId: "general-feat-filter" });
  initFeatTable({ tableId: "class-feats-table",   searchId: "class-feat-filter"   });
})();
  </script>

  <script>
    
  (function(){
    const modalEl = document.getElementById('editNumberModal');
    if (!modalEl) return;
    const form = document.getElementById('editNumberForm');
    const keyInput = document.getElementById('edit-key');
    const valInput = document.getElementById('edit-value');
    const noteInput= document.getElementById('edit-note');
    const bsModal = new bootstrap.Modal(modalEl);

    document.body.addEventListener('click', (e)=>{
      const el = e.target.closest('.editable-number');
      if (!el) return;
      const key = el.getAttribute('data-key');
      const current = el.textContent.trim();
      keyInput.value = key;
      valInput.value = current.replace(/[^\d\.\-]/g,'') || "";
      noteInput.value = "";
      bsModal.show();
    });

function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  const form2 = document.getElementById('overrideForm');
  if (!form2) return;

  form2.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form2);
    try {
      const resp = await fetch(form2.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: fd
      });
      if (!resp.ok) throw new Error('Bad response');
      // success → refresh
      location.reload();
    } catch (err) {
      alert('Failed to save override.');
    }
  });
})();
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.wep-select').forEach(function(sel){
      sel.addEventListener('change', function(){
        if (!window.fetch || !this.dataset.slot) return;
        try {
          const fd = new FormData();
          fd.append('slot', this.dataset.slot);
          fd.append('weapon_id', this.value || '');
          fetch("{% url 'characters:set_weapon_choice' character.pk %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': (document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')||[])[2] || '' },
            body: fd
          }).then(()=>location.reload());
        } catch(e) {}
      });
    });
  });
  </script>


  <script>
(function(){
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  document.addEventListener('click', async function(e){
    const btn = e.target.closest('.toggle-activation');
    if (!btn) return;
    const li  = btn.closest('li');
    const note = li ? (li.querySelector('.act-note')?.value || '') : '';
    const ctype  = btn.getAttribute('data-ctype');
    const objId  = btn.getAttribute('data-obj');
    const active = btn.getAttribute('data-active');
    try{
      const resp = await fetch("{% url 'characters:set_activation' character.pk %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/x-www-form-urlencoded",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: new URLSearchParams({ ctype: ctype, obj: objId, active: active, note: note })
      });
      if (!resp.ok) throw new Error("Bad response");
      // easiest UX: refresh so all three tabs sync state
      window.location.reload();
    } catch(err) {
      alert("Failed to update activation.");
    }
  });
})();
</script>

<script>
(function(){
  // Tabs
  document.querySelectorAll('.tabs').forEach(tabs => {
    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if (!btn || btn.disabled) return;
      const wrap = tabs.parentElement; // card-body
      tabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      wrap.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      const panel = wrap.querySelector(btn.dataset.target);
      if (panel) panel.classList.add('active');
    });
  });

  // Selection caps (cantrip / known overall / prepare per rank)
  function updateCounts(root){
    const canMax = +root.querySelector('[data-role="count-cantrips"]')?.dataset.max || 0;
    const canSel = root.querySelectorAll('.pick-cantrip:checked').length;
    const canLbl = root.querySelector('[data-role="count-cantrips"]');
    if (canLbl){ canLbl.textContent = canSel + ' selected'; }
    root.querySelectorAll('.pick-cantrip:not(:checked)').forEach(cb => cb.disabled = canSel >= canMax && canMax > 0);

    const knMax = +root.querySelector('[data-role="count-known"]')?.dataset.max || 0;
    const knSel = root.querySelectorAll('.pick-known:checked').length;
    const knLbl = root.querySelector('[data-role="count-known"]');
    if (knLbl){ knLbl.textContent = knSel + ' selected'; }
    root.querySelectorAll('.pick-known:not(:checked)').forEach(cb => cb.disabled = knSel >= knMax && knMax > 0);

    root.querySelectorAll('[data-role="count-prepare"]').forEach(lbl => {
      const r = lbl.dataset.rank;
      const pMax = +lbl.dataset.max || 0;
      const pSel = root.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:checked').length;
      lbl.textContent = pSel + ' selected';
      root.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:not(:checked)').forEach(cb => cb.disabled = pSel >= pMax && pMax > 0);
    });
  }

  document.querySelectorAll('.spellcard').forEach(card => {
    card.addEventListener('change', (e) => {
      if (!e.target.matches('.pick-cantrip, .pick-known, .pick-prepare')) return;
      updateCounts(card);
    });
    // initial
    updateCounts(card);
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-ability-mod]').forEach(modCell => {
    const key = modCell.getAttribute('data-ability-mod');
    const scoreEl = document.querySelector('[data-ability-score="'+key+'"]');
    if (!scoreEl) return;
    const n = parseInt(scoreEl.textContent, 10);
    if (Number.isFinite(n)) {
      const mod = Math.floor((n - 10) / 2);
      const s = (mod >= 0 ? '+' : '') + mod;
      if (modCell.textContent.trim() !== s) modCell.textContent = s;
    }
  });
});
</script>

<script>
(function(){
  // ── Tabs (robust if target panel is missing) ───────────────────────────────
  document.querySelectorAll('.tabs').forEach(tabs => {
    tabs.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if (!btn || btn.classList.contains('disabled')) return;
      const wrap = tabs.parentElement;
      tabs.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const targetSel = btn.getAttribute('data-target');
      wrap.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      if (targetSel) {
        const panel = wrap.querySelector(targetSel);
        if (panel) panel.classList.add('active');
      }
    });
  });

  // ── Helpers ────────────────────────────────────────────────────────────────
  function textOfRow(row){ return row.textContent.toLowerCase(); }
  function wireSearch(input, table){
    if (!input || !table) return;
    input.addEventListener('input', () => {
      const q = input.value.trim().toLowerCase();
      table.querySelectorAll('tbody tr').forEach(tr => {
        tr.style.display = (q && !textOfRow(tr).includes(q)) ? 'none' : '';
      });
    });
  }

  // ── Per-feature card logic ────────────────────────────────────────────────
  document.querySelectorAll('.spellcard').forEach(card => {
    const fid = card.dataset.fid;

    // --- Cantrips limit (global per feature) ---
    const cantripBoxes   = card.querySelectorAll('input.pick-cantrip[name="learn_cantrips_'+fid+'"]');
    const cantripMaxEl   = card.querySelector('[data-role="count-cantrips"]');
    const cantripMax     = parseInt(cantripMaxEl?.dataset.max || '0', 10);
    const cantripCounter = cantripMaxEl;

    function enforceCantrips(){
      if (!cantripBoxes.length || !cantripMax) {
        if (cantripCounter) cantripCounter.textContent = '0';
        return;
      }
      const picked = [...cantripBoxes].filter(b => b.checked);
      const over = Math.max(0, picked.length - cantripMax);
      if (over > 0) {
        // uncheck the most recently toggled extras
        picked.slice(-over).forEach(b => { b.checked = false; });
      }
      if (cantripCounter){
        cantripCounter.textContent = Math.min(picked.length, cantripMax);
      }
    }
    cantripBoxes.forEach(b => b.addEventListener('change', enforceCantrips));
    enforceCantrips(); // init

    // --- Known (leveled) limit shared across all ranks for this feature) ---
    const knownBoxes = card.querySelectorAll('input.pick-known[name="learn_known_'+fid+'"]');
    const knownMaxEl = card.querySelector('[data-role="count-known"]');
    const knownMax   = parseInt(knownMaxEl?.dataset.max || '0', 10);

    function enforceKnown(){
      if (!knownBoxes.length) {
        if (knownMaxEl) knownMaxEl.textContent = '0';
        return;
      }
      const picked = [...knownBoxes].filter(b => b.checked);
      if (knownMax > 0 && picked.length > knownMax){
        // uncheck the one the user just turned on (fallback for older browsers)
        let last = null;
        try {
          last = [...knownBoxes].findLast(b => b === document.activeElement || b === document._lastChanged);
        } catch (_e) {
          last = [...knownBoxes].reverse().find(b => b === document.activeElement || b === document._lastChanged);
        }
        (last || picked[picked.length - 1]).checked = false;
      }
      const count = Math.min([...knownBoxes].filter(b => b.checked).length, knownMax || 0);
      if (knownMaxEl) knownMaxEl.textContent = count;
    }
    knownBoxes.forEach(b => {
      b.addEventListener('change', (ev) => { document._lastChanged = ev.target; enforceKnown(); });
    });
    enforceKnown(); // init

    // --- Prepared limits per rank (uses data-rank + per-rank max in data-max) ---
    const prepBoxes = card.querySelectorAll('input.pick-prepare');
    const countersByRank = {};
    card.querySelectorAll('[data-role="count-prepare"]').forEach(el => {
      countersByRank[el.dataset.rank] = { el, max: parseInt(el.dataset.max || '0', 10) };
    });

    function enforcePrepare(ev){
      const t = ev?.target;
      const r = t?.dataset.rank;
      if (!r) return;
      const group = [...prepBoxes].filter(b => b.dataset.rank === r);
      const cap   = countersByRank[r]?.max || 0;
      const picked = group.filter(b => b.checked);
      if (cap > 0 && picked.length > cap){
        (t || picked[picked.length - 1]).checked = false;
      }
      const cnt = Math.min(group.filter(b => b.checked).length, cap);
      if (countersByRank[r]) countersByRank[r].el.textContent = cnt;
    }
    // bind + initialize counts for each rank
    prepBoxes.forEach(b => b.addEventListener('change', enforcePrepare));
    Object.keys(countersByRank).forEach(r => {
      const group = [...prepBoxes].filter(b => b.dataset.rank === r);
      const cap   = countersByRank[r]?.max || 0;
      const cnt   = Math.min(group.filter(b => b.checked).length, cap);
      countersByRank[r].el.textContent = cnt;
    });

    // --- Search boxes wiring ---
    // Cantrips
    wireSearch(
      card.querySelector('#cantrip-filter-'+fid),
      card.querySelector('#cantrips-table-'+fid)
    );
    // Per-level learn tables
    card.querySelectorAll('[id^="learn-filter-'+fid+'-r"]').forEach(input => {
      const tableId = input.id.replace('filter','table');
      wireSearch(input, card.querySelector('#'+tableId));
    });
  });



})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  const el = document.getElementById('manual-feat-select');
  if (el && window.TomSelect){
    new TomSelect(el, {
      allowEmptyOption: true,
      maxOptions: 10000,
      searchField: ['text'],
      sortField: { field: 'text', direction: 'asc' },
      placeholder: 'Search feats…'
    });
  }
});
</script>

<script>
  // Spellcasting tab tables (new)
(function(){
  document.querySelectorAll('table.excel-setup[id^="prep-table-"], table.excel-setup[id^="learned-cantrips-"], table.excel-setup[id^="knownprep-table-"], table.excel-setup[id^="learn-table-"], table.excel-setup[id^="cantrips-table-"]').forEach(function(tbl){
    if (typeof initFeatTable === 'function') initFeatTable({ tableId: tbl.id });
  });
})();

</script>
<script>
(function () {
  const leftForm   = document.getElementById('classPreviewForm');
  const leftSelect = leftForm ? leftForm.querySelector('select[name="base_class"]') : null;
  const postHidden = document.getElementById('postBaseClass');

  // keep POST hidden in sync with the left selector
  if (leftSelect && postHidden) {
    if (!postHidden.value) postHidden.value = leftSelect.value;   // initial fill
    leftSelect.addEventListener('change', function () {
      postHidden.value = this.value;
      // auto-refresh the left preview to match the chosen class:
      if (leftForm) leftForm.submit();
    });
  }

  // (nice-to-have) mirror the advance_track radios into the left hidden
  const trackHidden = leftForm ? leftForm.querySelector('input[name="advance_track"]') : null;
  document.querySelectorAll('input[name="{{ form.advance_track.html_name }}"]').forEach(function (r) {
    r.addEventListener('change', function () {
      if (trackHidden) trackHidden.value = this.value;
      // show/hide prestige/base sections without reload (optional)
      const isPrestige = this.value === 'prestige';
      const base = document.getElementById('base-fields');
      const pre  = document.getElementById('prestige-fields');
      if (base) base.hidden = isPrestige;
      if (pre)  pre.hidden  = !isPrestige;
    });
  });
})();
</script>

</div> <!-- /LEVEL UP MODAL -->

<script>
(function(){
  function updateFormLimits(form){
    // Cantrips
    const canLbl = form.querySelector('[data-role="count-cantrips"]');
    if (canLbl){
      const max = +canLbl.dataset.max || 0;
      const picked = form.querySelectorAll('.pick-cantrip:checked').length;
      canLbl.textContent = Math.min(picked, max);
      form.querySelectorAll('.pick-cantrip:not(:checked)').forEach(cb => cb.disabled = (max > 0 && picked >= max));
    }
    // Known (leveled)
    const knLbl = form.querySelector('[data-role="count-known"]');
    if (knLbl){
      const max = +knLbl.dataset.max || 0;
      const picked = form.querySelectorAll('.pick-known:checked').length;
      knLbl.textContent = Math.min(picked, max);
      form.querySelectorAll('.pick-known:not(:checked)').forEach(cb => cb.disabled = (max > 0 && picked >= max));
    }
    // Prepare per-rank
    form.querySelectorAll('[data-role="count-prepare"]').forEach(lbl => {
      const r = lbl.dataset.rank;
      const max = +lbl.dataset.max || 0;
      const picked = form.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:checked').length;
      lbl.textContent = Math.min(picked, max);
      form.querySelectorAll('.pick-prepare[data-rank="'+r+'"]:not(:checked)').forEach(cb => cb.disabled = (max > 0 && picked >= max));
    });
  }

  document.querySelectorAll('#tab-spellcasting form').forEach(form => {
    form.addEventListener('change', e => {
      if (!e.target.matches('.pick-cantrip,.pick-known,.pick-prepare')) return;
      updateFormLimits(form);
    });
    // initialize
    updateFormLimits(form);
  });
})();
</script>



<script>
document.addEventListener('DOMContentLoaded', function () {
  const el = document.getElementById('startingSkillPicks');
  if (!el) return;
  const limit = parseInt(el.dataset.max || '0', 10);
  if (!limit) return; // 0 = unlimited
  el.addEventListener('change', function (e) {
    const picked = Array.from(el.options).filter(o => o.selected);
    if (picked.length > limit) {
      // Unselect the most recently changed option
      e.target.selected = false;
      alert(`You can select up to ${limit} starting skills.`);
    }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const modalEl = document.getElementById('detailsEditModal');
  if (!modalEl || !window.bootstrap) return;

  // Inject the template form into the modal body on open
  modalEl.addEventListener('show.bs.modal', function(){
    const tpl  = document.getElementById('detailsEditTemplate');
    const body = modalEl.querySelector('.modal-body');
    if (!tpl || !body) return;

    const frag = tpl.content.cloneNode(true);
    const form = frag.querySelector('form');

    // Belt-and-suspenders: ensure the hidden submit marker is present
    if (form && !form.querySelector('input[name="update_details_submit"]')) {
      const hid = document.createElement('input');
      hid.type = 'hidden';
      hid.name = 'update_details_submit';
      hid.value = '1';
      form.prepend(hid);
    }

    body.innerHTML = '';
    body.appendChild(frag);
  });

  // If the server asked to open the modal (e.g., validation errors), do so now
  {% if open_details_modal %}
    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  {% endif %}
});
</script>

<script>
(function () {
  const sel = document.getElementById('startingSkillPicks');
  if (!sel) return;

  // Toggle on simple click
  sel.addEventListener('mousedown', function (e) {
    if (e.target.tagName === 'OPTION') {
      e.preventDefault();
      e.target.selected = !e.target.selected;
      this.dispatchEvent(new Event('change', {bubbles:true}));
    }
  });

  // Enforce the max cap
  sel.addEventListener('change', function () {
    const max = parseInt(this.dataset.max || '0', 10);
    if (!max) return;
    const chosen = Array.from(this.options).filter(o => o.selected);
    if (chosen.length > max) {
      // unselect the oldest one (first in list)
      chosen[0].selected = false;
    }
  });
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('editCharacterModal');
  if (!modal || !window.bootstrap) return;

  modal.addEventListener('shown.bs.modal', function () {
    if (!window.jQuery || !jQuery.fn.summernote) {
      console.error('Summernote not loaded');
      return;
    }
    const $ = jQuery;

    // INIT ON ALL TEXTAREAS (including Backstory)
    modal.querySelectorAll('textarea').forEach(ta => {
      const $ta = $(ta);
      if (!$ta.data('summernote')) {
        $ta.summernote({
          height: 220,
          placeholder: ta.getAttribute('placeholder') || '',
          dialogsInBody: true,
          toolbar: [
            ['style', ['bold','italic','underline','clear']],
            ['para',  ['ul','ol','paragraph']],
            ['insert',['link','picture']],
            ['view',  ['codeview','help']]
          ]
        });
      }
    });
  });

  // Clean up editors when modal closes
  modal.addEventListener('hidden.bs.modal', function () {
    if (!window.jQuery || !jQuery.fn.summernote) return;
    jQuery(modal).find('textarea').each(function () {
      const $ta = jQuery(this);
      if ($ta.data('summernote')) $ta.summernote('destroy');
    });
  });
});
</script>


<script>
(function(){
  // Use the Django-provided html_name if present, else fallback to literal "advance_track"
  var fieldName = '{{ form.advance_track.html_name|default:"advance_track" }}';

function applyToggle(){
  var bHead  = document.getElementById('base-fields');
  var bTail  = document.getElementById('base-fields-tail');
  var presEl = document.getElementById('prestige-fields');

  var chosen = document.querySelector('[name="'+fieldName+'"]:checked');
  if (!chosen) chosen = document.querySelector('[name="'+fieldName+'"]');

  var isPrestige = !!chosen && chosen.value === 'prestige';
  if (bHead)  bHead.hidden  = isPrestige;
  if (bTail)  bTail.hidden  = isPrestige;
  if (presEl) presEl.hidden = !isPrestige;
}


  document.addEventListener('change', function(e){
    if (e.target && e.target.name === fieldName) applyToggle();
  });

  document.addEventListener('DOMContentLoaded', applyToggle);
})();
</script>

<script>
(function () {
  const list   = document.getElementById('startingSkillList');
  const count  = document.getElementById('ss-count');
  const maxEl  = document.getElementById('ss-max');
  const filter = document.getElementById('ss-filter');
  if (!list || !count || !maxEl) return;

  const max = parseInt(maxEl.textContent || '0', 10) || 0;

  function updateCap() {
    const boxes  = list.querySelectorAll('input.skill-checkbox');
    const chosen = list.querySelectorAll('input.skill-checkbox:checked');
    const atCap  = max && chosen.length >= max;
    count.textContent = chosen.length;

    boxes.forEach(cb => {
      const wrap = cb.closest('.skill-item');
      if (!cb.checked) {
        cb.disabled = atCap;
        if (wrap) wrap.classList.toggle('disabled', atCap);
      } else {
        cb.disabled = false;
        if (wrap) wrap.classList.remove('disabled');
      }
    });
  }

  // Toggle on whole-row click
  list.addEventListener('click', e => {
    const row = e.target.closest('.skill-item');
    if (!row) return;
    const cb = row.querySelector('input.skill-checkbox');
    if (e.target !== cb) cb.checked = !cb.checked;
    updateCap();
  });

  list.addEventListener('change', updateCap);

  // Filter
  if (filter) {
    filter.addEventListener('input', () => {
      const q = filter.value.trim().toLowerCase();
      list.querySelectorAll('.skill-item').forEach(row => {
        const text = row.querySelector('.skill-label').textContent.toLowerCase();
        row.style.display = text.includes(q) ? '' : 'none';
      });
    });
  }

  updateCap();
})();
</script>

<script>
(function(){
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  document.querySelectorAll('.wep-select').forEach(sel => {
    sel.addEventListener('change', async (e) => {
      const slot = sel.dataset.slot;
      const weapon_id = sel.value; // "" clears
      const form = new FormData();
      form.append('equip_weapon_slot', '1');
      form.append('weapon_id', weapon_id);
      form.append('slot', slot); // not used, but kept for logs

      // We post to this same URL
      const resp = await fetch(window.location.href, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        body: form
      });
      // optional: toast or badge
    });
  });
})();
</script>

<!-- AFTER: add this block -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modalEl = document.getElementById('skillEditModal');
  const bodyEl  = document.getElementById('skillEditModalBody');
  if (!modalEl || !bodyEl || !window.bootstrap) return;
  const bs = bootstrap.Modal.getOrCreateInstance(modalEl);

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.open-weapon-prof-edit');
    if (!btn) return;

    // Use the exact template id we stamped on the button, no guessing
    const tplId = btn.getAttribute('data-tpl-id');
    const tpl   = tplId ? document.getElementById(tplId) : null;
    if (!tpl) return; // nothing to show

    bodyEl.innerHTML = '';
    bodyEl.appendChild(tpl.content.cloneNode(true));
    bs.show();
  });
});
</script>

<script>
(function () {
  // avoid rebinding if the partial is included multiple times
  if (window.__spellTableDetailsBound) return;
  window.__spellTableDetailsBound = true;

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.toggle-desc');
    if (!btn) return;

    // don't let any parent click handlers eat this
    e.preventDefault();
    e.stopPropagation();

    const tr = btn.closest('tr');
    if (!tr) return;

    // the details row is rendered immediately after the data row
    const details = tr.nextElementSibling;
    if (!details || !details.classList.contains('desc-body')) return;

    // toggle visibility
    const hidden = details.classList.toggle('d-none');

    // optional affordance
    btn.textContent = hidden ? 'Details' : 'Hide';
    btn.setAttribute('aria-expanded', String(!hidden));
  }, false);
})();
</script>
<script>
document.addEventListener('change', function (e) {
  if (e.target && e.target.name === 'advance_track') {
    const isPrestige = e.target.value === 'prestige';
    const pre   = document.getElementById('prestige-fields');
    const bHead = document.getElementById('base-fields');
    const bTail = document.getElementById('base-fields-tail');
    if (pre)   pre.hidden   = !isPrestige;
    if (bHead) bHead.hidden =  isPrestige;
    if (bTail) bTail.hidden =  isPrestige;

    // keep the left preview GET in sync
    const mirror = document.querySelector('#classPreviewForm input[name="advance_track"]');
    if (mirror) mirror.value = e.target.value;
  }
});

</script>

<script>
function resetSpeed(btn){
  const form = btn.closest('form');
  if (!form) return;

  const input = form.elements.namedItem('speed') || form.querySelector('#id_speed');
  if (!input) return;

  // Clear the value
  input.value = '';

  // Fire input/change events with fallback for older browsers
  try {
    input.dispatchEvent(new Event('input',  { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
  } catch {
    if (document.createEvent) {
      const ev1 = document.createEvent('Event'); ev1.initEvent('input',  true, true);  input.dispatchEvent(ev1);
      const ev2 = document.createEvent('Event'); ev2.initEvent('change', true, true);  input.dispatchEvent(ev2);
    }
  }

  // Persist immediately — prefer clicking the Save button so its name/value posts
  const saveBtn = form.querySelector('button[name="save_core_stats_submit"]');
  if (saveBtn) {
    saveBtn.click();
  } else if (form.requestSubmit) {
    form.requestSubmit(); // may include first submitter's name/value
  } else {
    // final fallback: ensure the server sees the "save" flag
    const h = document.createElement('input');
    h.type = 'hidden';
    h.name = 'save_core_stats_submit';
    h.value = '1';
    form.appendChild(h);
    form.submit();
  }
}
</script>
<script>
  // Ensure ANY modal (including #shareModal) lives directly under <body> before it opens.
  document.addEventListener('show.bs.modal', (e) => {
    const m = e.target;
    if (m && m.parentElement !== document.body) {
      document.body.appendChild(m);
    }
  });

  // Also fix on DOM ready in case something tried to open earlier or ids changed
  document.addEventListener('DOMContentLoaded', () => {
    const ensureInBody = (id) => {
      const el = document.getElementById(id);
      if (el && el.parentElement !== document.body) document.body.appendChild(el);
    };
    [
      'shareModal','detailsModal','overrideModal',
      'levelUpModal','editCharacterModal','editNumberModal','skillEditModal'
    ].forEach(ensureInBody);

    if (window.location.hash === "#levelUpModal") {
      const el = document.getElementById("levelUpModal");
      if (el) bootstrap.Modal.getOrCreateInstance(el).show();
    }
  });
</script>



{% endblock %}


