{# templates/forge/character_detail.html #}
{% extends "base.html" %}
{% load static %}
{% load ui_extras %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/character.css' %}">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
{% endblock %}

{% block content %}
<style>
    table tbody tr.is-active { outline: 2px solid #0d6efd; }
  #general-feats-table tbody tr.is-selected { background: #fff9db; }
  #general-feats-table tbody tr.is-active { outline: 2px solid #0d6efd; }

#asi-table tbody tr.table-warning { background: #fff9db; }
#asi-table tbody tr.table-success { background: #e6ffed; }

</style>

<div class="container my-4">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ character.name }}</h1>
    <div>
      <button
        class="btn btn-secondary me-2"
        {% if not can_edit %}disabled{% endif %}
        data-bs-toggle="modal"
        data-bs-target="#editCharacterModal"
      >Edit Details</button>
      <button
        class="btn btn-primary me-2"
        data-bs-toggle="modal"
        data-bs-target="#levelUpModal"
      >Level Up</button>
      <a
        href="{% url 'characters:level_down' character.pk %}"
        class="btn btn-danger {% if character.level == 0 %}disabled{% endif %}"
      >Level Down</a>
    </div>
  </div>

  <div class="row g-4">
    <!-- LEFT COLUMN -->
    <div class="col-lg-4">
      <div class="card p-3 mb-3">
        <h5>Basic Info</h5>
        <ul class="list-unstyled mb-0">
          <li><strong>Race:</strong> {{ character.race }}</li>
          {% if subrace_name %}<li><strong>Subrace:</strong> {{ subrace_name }}</li>{% endif %}
          {% if character.half_elf_origin %}
            <li><strong>Half-Elf Origin:</strong> {{ character.half_elf_origin }}</li>
          {% endif %}
          <li><strong>Backgrounds:</strong>
            {{ character.main_background }}
            {% if character.side_background_1 %}, {{ character.side_background_1 }}{% endif %}
            {% if character.side_background_2 %}, {{ character.side_background_2 }}{% endif %}
          </li>
          <li><strong>HP:</strong> {{ character.HP }}
            {% if character.temp_HP %}(+{{ character.temp_HP }} temp){% endif %}
          </li>
          <li><strong>Level:</strong> {{ character.level }}</li>
        </ul>
      </div>

      <div class="card p-3 mb-3">
        <h5>Ability Scores</h5>
        <dl class="row mb-0">
          {% for name,val in ability_map.items %}
            <dt class="col-6">{{ name }}</dt>
            <dd class="col-6">{{ val }}</dd>
          {% endfor %}
        </dl>
      </div>

      <div class="card p-3 mb-3">
        <h5>Skill Proficiencies</h5>
        {% if skill_proficiencies %}
          <ul class="mb-0">
            {% for prof in skill_proficiencies %}
              <li><strong>{{ prof.selected_skill.name }}:</strong> {{ prof.proficiency.name }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="mb-0"><em>None</em></p>
        {% endif %}
      </div>

      <div class="card p-3">
        <h5>Racial Features</h5>
        {% if racial_features %}
          <ul class="mb-0">
            {% for rf in racial_features %}
              <li>{{ rf.code }} – {{ rf.name }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="mb-0"><em>None</em></p>
        {% endif %}
      </div>


      <div class="card p-3 mb-3">
  <h5>Spellcasting</h5>
  {% if spellcasting_blocks %}
    {% for b in spellcasting_blocks %}
      <div class="mb-3">
        <div class="fw-semibold">
          {{ b.klass.name }} — {{ b.list|default:"(Unknown list)" }}
        </div>

        {% if b.slots %}
          <div class="table-responsive mt-2">
            <table class="table table-sm table-bordered w-auto">
              <thead>
                <tr>
                  <th class="text-nowrap">Rank</th>
                  {% for _ in b.slots %}<th>{{ forloop.counter }}</th>{% endfor %}
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="text-nowrap">Slots</td>
                  {% for s in b.slots %}<td>{{ s }}</td>{% endfor %}
                </tr>
              </tbody>
            </table>
          </div>
        {% endif %}

        <div class="small text-muted mt-1">
          Cantrips: {{ b.cantrips|default:0 }}.
          {% if b.known is not None %} Spells known: {{ b.known }}.{% endif %}
          {% if b.prepared is not None %} Prepared: {{ b.prepared }}.{% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="mb-0"><em>—</em></p>
  {% endif %}
</div>

    </div>

    <!-- RIGHT COLUMN -->
    <div class="col-lg-8">
      <div class="card p-3 mb-3">
        <h5>Class Breakdown</h5>
        <ul class="mb-0">
          {% for prog in class_progress %}
            <li>{{ prog.character_class.name }} (Level {{ prog.levels }})</li>
          {% endfor %}
        </ul>
      </div>

      <div class="card p-3 mb-3">
        <h5>Universal Feats / ASI</h5>
        {% if universal_feats %}
          <ul class="mb-0">
            {% for uf in universal_feats %}
              {% if uf.grants_asi %}<li>Ability Score Increase</li>{% endif %}
              {% if uf.grants_general_feat %}<li>General Feat</li>{% endif %}
            {% endfor %}
          </ul>
        {% else %}
          <p class="mb-0">&mdash;</p>
        {% endif %}
      </div>

<div class="card p-3">
  <h5>Gained Features</h5>
  <ul class="mb-0">
    {% for cf in character.features.all %}
      <li class="mb-3">
        <div>
          {% if cf.option %}{{ cf.option.label }}
          {% elif cf.subclass %}{{ cf.subclass.name }}
          {% else %}{{ cf.feature.name }}{% endif %}
          <small class="text-muted">(L{{ cf.level }})</small>
        </div>

        {% if cf.feature %}
          <div class="border rounded p-2 mt-1">
            {% include "partials/_feature_detail.html" with f=cf.feature %}
          </div>
        {% elif cf.option and cf.option.grants_feature %}
          <div class="border rounded p-2 mt-1">
            {% include "partials/_feature_detail.html" with f=cf.option.grants_feature %}
          </div>
        {% endif %}
      </li>
    {% empty %}
      <li><em>No features chosen yet.</em></li>
    {% endfor %}
  </ul>
</div>

<div class="card p-3 mt-3">
  <h5>Gained Feats</h5>
  {% if character.feats.all %}
    <ul class="mb-0">
      {% for f in character.feats.all %}
        <li>{{ f.feat.name }} <small class="text-muted">(L{{ f.level }})</small></li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="mb-0"><em>None</em></p>
  {% endif %}
</div>


    </div>
  </div>
</div>

{# EDIT CHARACTER MODAL (unchanged) #}


<!-- LEVEL UP MODAL -->
<div class="modal fade" id="levelUpModal" tabindex="-1" aria-labelledby="levelUpModalLabel" aria-hidden="true">
<div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="levelUpModalLabel" class="modal-title">Level Up to {{ total_level|add:"1" }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

  
<div class="modal-body p-0">
  <div class="row g-0">
    <!-- LEFT column: class info / preview -->
    <div class="col-12 col-xl-5 p-4 border-end">
      <form method="get"
            action="{% url 'characters:character_detail' character.pk %}#levelUpModal"
            class="mb-4">
        {{ form.base_class }}
      </form>

      <div class="mb-3">
        <h6 class="mb-2">Description</h6>
        <div class="text-muted">{{ preview_class.description }}</div>
      </div>

      <div class="mb-3 small text-muted">
        <div><strong>Hit Die:</strong> d{{ preview_class.hit_die }}</div>
        <div>
          <strong>Key Abilities:</strong>
          {% for a in preview_class.key_abilities.all %}
            {{ a.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </div>
      </div>

      <div class="mb-3">
        <h6 class="mb-2">Proficiencies</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Type</th>
                {% for tn in tier_names %}<th>{{ tn }}</th>{% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in proficiency_rows %}
                <tr>
                  <td>{{ row.type }}</td>
                  {% for lvl in row.levels %}
                    <td>{{ lvl }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="mb-3">
        <h6 class="mb-2">Features at L{{ total_level|add:"1" }}</h6>
<ul class="mb-0 ps-3">
  {% for f in auto_feats %}
    <li class="mb-2">
      {% if f.kind == "spell_table" and f.spell_row_next %}
        <div class="table-responsive mt-2">
          <table class="table table-sm table-bordered w-auto">
            <thead>
              <tr>
                <th class="text-nowrap">Rank</th>
                {% for i in "12345678910"|make_list %}<th>{{ forloop.counter }}</th>{% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-nowrap">Slots</td>
                <td>{{ f.spell_row_next.slot1 }}</td>
                <td>{{ f.spell_row_next.slot2 }}</td>
                <td>{{ f.spell_row_next.slot3 }}</td>
                <td>{{ f.spell_row_next.slot4 }}</td>
                <td>{{ f.spell_row_next.slot5 }}</td>
                <td>{{ f.spell_row_next.slot6 }}</td>
                <td>{{ f.spell_row_next.slot7 }}</td>
                <td>{{ f.spell_row_next.slot8 }}</td>
                <td>{{ f.spell_row_next.slot9 }}</td>
                <td>{{ f.spell_row_next.slot10 }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      {% endif %}

      <div class="mt-2">
        {% include "partials/_feature_detail.html" with f=f %}
      </div>
    </li>
  {% empty %}
    <li><em>None</em></li>
  {% endfor %}
</ul>


      </div>
    </div> {# closes LEFT column #}
    <div class="col-12 col-xl-7 p-4"> {# RIGHT column starts here, still inside the .row #}

      {# MOVE your whole <form method="post" …> … </form> block HERE #}


        <form method="post" action="{% url 'characters:character_detail' character.pk %}">
          {% csrf_token %}

          {# carry over the chosen class #}
          <input type="hidden" name="base_class" value="{{ form.base_class.value }}">

          {# General Feat #}
          {% if form.general_feat %}
          <div class="mb-3">
            <label class="form-label">{{ form.general_feat.label }}</label>
            <input
      type="text"
      id="general-feat-filter"
      class="form-control mb-2"
      placeholder="Filter feats…"
    >
           
            <table id="general-feats-table" class="table table-bordered">
            <thead>
              <tr>
                <th></th>  {# radio (actual selection) #}
                <th data-sort="1">Feat</th>
                <th data-sort="2">Description</th>
                <th data-sort="3">Level</th>
              <th data-sort="4">
                Requirements
                <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                  <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                  <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                </div>
              </th>             
              <th data-sort="5">
              Tags
              <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                <div class="dropdown-menu p-3 excel-menu" data-col="5" data-split="1" style="width:260px;"></div>
              </div>
            </th>
              </tr>
            </thead>


          <tbody>
            {% for feat in form.general_feat.field.queryset %}
              <tr>
                <td>
                <input
                  type="radio"
                  name="{{ form.general_feat.html_name }}"
                  value="{{ feat.pk }}"
                  {% if form.general_feat.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                  {% if form.general_feat.field.required %}required{% endif %}
                >

                </td>

                <td class="feat-name">{{ feat.name }}</td>
                <td class="feat-desc">{{ feat.description|default:"(no description)" }}</td>
                <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
              </tr>
            {% endfor %}
          </tbody>

            </table>
            {% for err in form.general_feat.errors %}
              <div class="text-danger">{{ err }}</div>
            {% endfor %}
          </div>
        {% endif %}



    {# --- ASI: table UI --- #}
    {% if form.asi_mode %}
      <div class="mb-4">
        <label class="form-label d-block">Ability Score Increase</label>

        {# hidden real form fields that the JS will fill #}
        <input type="hidden" name="{{ form.asi_mode.html_name }}" id="id_asi_mode"
              value="{{ form.asi_mode.value|default:'' }}">
        <input type="hidden" name="{{ form.asi_a.html_name }}" id="id_asi_a"
              value="{{ form.asi_a.value|default:'' }}">
        <input type="hidden" name="{{ form.asi_b.html_name }}" id="id_asi_b"
              value="{{ form.asi_b.value|default:'' }}">

        <div class="table-responsive">
          <table class="table table-bordered align-middle" id="asi-table">
            <thead>
              <tr>
                <th>Ability</th>
                <th>Current</th>
                <th>+1 </th>
                <th>+1 </th>
                <th>Result</th>
              </tr>
            </thead>
            <tbody>
            {% for label,val in ability_map.items %}
              {% with key=label|lower %}
              <tr data-key="{{ key }}" data-base="{{ val }}">
                <td class="fw-semibold">{{ label }}</td>
                <td class="asi-current">{{ val }}</td>
                <td class="text-center">
                  <input type="checkbox" class="form-check-input asi-slot" data-slot="A" aria-label="+1 Slot A to {{ label }}">
                </td>
                <td class="text-center">
                  <input type="checkbox" class="form-check-input asi-slot" data-slot="B" aria-label="+1 Slot B to {{ label }}">
                </td>
                <td class="asi-result">{{ val }}</td>
              </tr>
              {% endwith %}
            {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="small" id="asi-help"></div>
        <div class="small mt-2"><strong>Preview:</strong> <span id="asi-preview">—</span></div>

        {% for err in form.non_field_errors %}
          <div class="text-danger mt-2">{{ err }}</div>
        {% endfor %}
      </div>
    {% endif %}





          {# Subclass‐choice & option pickers #}
      

          {# REMOVE the old select block for class_feat_pick and paste this #}
          {% if form.class_feat_pick %}
            <div class="mb-4">
              <label class="form-label">{{ form.class_feat_pick.label }}</label>

              <input type="text" id="class-feat-filter" class="form-control mb-2" placeholder="Filter feats…">

              <table id="class-feats-table" class="table table-bordered">
                <thead>
                  <tr>
                    <th></th>  {# radio #}
                    <th data-sort="1">Feat</th>
                    <th data-sort="2">Description</th>
                    <th data-sort="3">Level</th>
                    <th data-sort="4">
                      Requirements
                      <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                        <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">▾</button>
                        <div class="dropdown-menu p-3 excel-menu" data-col="4" data-split="1" style="width:260px;"></div>
                      </div>
                    </th>
                  <th data-sort="5">
                  Tags
                  <div class="dropdown d-inline ms-1" data-bs-auto-close="outside">
                    <button class="btn btn-sm btn-outline-secondary px-2 py-0" type="button" data-bs-toggle="dropdown">▾</button>
                    <div class="dropdown-menu p-3 excel-menu" data-col="5" data-split="1" style="width:260px;"></div>
                  </div>
                </th>
                  </tr>
                </thead>
                <tbody>
                  {% for feat in form.class_feat_pick.field.queryset %}
                    <tr>
                      <td>
                    <input
                      type="radio"
                      name="{{ form.class_feat_pick.html_name }}"
                      value="{{ feat.pk }}"
                      {% if form.class_feat_pick.value|stringformat:"s" == feat.pk|stringformat:"s" %}checked{% endif %}
                      {% if form.class_feat_pick.field.required %}required{% endif %}
                    >
                      </td>
                      <td class="feat-name">{{ feat.name }}</td>
                      <td class="feat-desc">{{ feat.description|default:"(no description)" }}</td>
                      <td class="feat-level">{{ feat.level_prerequisite|default:"None" }}</td>
                      <td class="feat-reqs">{{ feat.prerequisites|default:"—" }}</td>
                      <td class="feat-tags">{{ feat.tags|default:"None" }}</td>
                                          </tr>

                        {% empty %}
    <tr>
      <td colspan="6" class="text-muted"><em>No class feats meet your current class/level filters.</em></td>
    </tr>
                  {% endfor %}
                </tbody>
              </table>

              {% for err in form.class_feat_pick.errors %}
                <div class="text-danger">{{ err }}</div>
              {% endfor %}
            </div>
          {% endif %}

{# === BEGIN: FEATURE FIELDS LOOP === #}
{% for item in feature_fields %}

  {% if item.kind == "subclass_choice" %}
    <div class="mb-4">
      <label class="form-label d-block">{{ item.label }}</label>

      <div class="d-grid gap-2">
        {% for sc in item.group.subclasses.all %}
          {% with rid=item.field.id_for_label|add:"_"|add:sc.pk|stringformat:"s" %}
          <label for="{{ rid }}" class="border rounded p-3 d-flex gap-3 align-items-start">
            <input
              type="radio"
              id="{{ rid }}"
              name="{{ item.field.name }}"
              value="{{ sc.pk }}"
              class="form-check-input mt-1"
              {% if item.field.value|stringformat:"s" == sc.pk|stringformat:"s" %}checked{% endif %}
              {% if item.field.field.required %}required{% endif %}
            />
            <div class="flex-grow-1">
              <div class="fw-semibold">{{ sc.name }}</div>
              {% if sc.description %}
                <div class="small text-muted mt-1">{{ sc.description }}</div>
              {% endif %}
              {% if sc.feats_next %}
                <div class="small mt-2">
                  <div class="fw-semibold mb-1">Features at L{{ total_level|add:"1" }}:</div>
                  <div class="d-grid gap-2">
                    {% for f in sc.feats_next %}
                      <div class="border rounded p-2">
                        {% include "partials/_feature_detail.html" with f=f %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>
          </label>
          {% endwith %}
        {% empty %}
          <div class="text-muted"><em>No subclasses available.</em></div>
        {% endfor %}
      </div>

      {% for err in item.field.errors %}
        <div class="text-danger mt-1">{{ err }}</div>
      {% endfor %}
    </div>

  {% elif item.kind == "option" %}
    <div class="mb-4">
      <div class="mb-2 fw-semibold">{{ item.label }}</div>

      <div class="border rounded p-3 mb-3">
        {% include "partials/_feature_detail.html" with f=item.feature %}
      </div>

      <div class="d-grid gap-2">
        {% for opt in item.feature.options.all %}
          {% with radio_id=item.field.id_for_label|add:"_"|add:opt.pk|stringformat:"s" %}
          <label for="{{ radio_id }}" class="border rounded p-3 d-flex gap-3 align-items-start">
            <input
              type="radio"
              id="{{ radio_id }}"
              name="{{ item.field.name }}"
              value="{{ opt.pk }}"
              class="form-check-input mt-1"
              {% if item.field.value|stringformat:"s" == opt.pk|stringformat:"s" %}checked{% endif %}
              {% if item.field.field.required %}required{% endif %}
            />
            <div class="flex-grow-1">
              <div class="fw-semibold">{{ opt.label }}</div>
              {% if opt.grants_feature %}
                <div class="mt-2">
                  {% include "partials/_feature_detail.html" with f=opt.grants_feature %}
                </div>
              {% endif %}
            </div>
          </label>
          {% endwith %}
        {% endfor %}
      </div>

      {% for err in item.field.errors %}
        <div class="text-danger mt-1">{{ err }}</div>
      {% endfor %}
    </div>

  {% elif item.kind == "gain_subclass_feat" %}
    <div class="mb-4">
      <div class="mb-2 fw-semibold">{{ item.label }}</div>

      {% if item.system == "linear" and not item.subclass %}
        <div class="alert alert-warning p-2">Pick a subclass above …</div>
      {% endif %}
      {% if item.system == "linear" %}
        <div class="alert alert-info p-2">
          Linear progression: the following {{ item.group.name }} feature(s) are granted automatically.
        </div>
      {% endif %}

      <div class="d-grid gap-2">
        {% with selected_vals=item.field.value %}
          {% for f in item.eligible %}
            {% with cid=item.field.id_for_label|add:"_"|add:f.pk|stringformat:"s" %}
            <label for="{{ cid }}" class="border rounded p-3 d-flex gap-3 align-items-start">
              {% if item.system == "linear" %}
                <input type="checkbox" id="{{ cid }}" disabled checked class="form-check-input mt-1">
              {% else %}
                <input
                  type="checkbox"
                  id="{{ cid }}"
                  name="{{ item.field.name }}"
                  value="{{ f.pk }}"
                  class="form-check-input mt-1"
                  {% if selected_vals and f.pk|stringformat:"s" in selected_vals %}checked{% endif %}
                >
              {% endif %}
              <div class="flex-grow-1">
                {% include "partials/_feature_detail.html" with f=f %}
              </div>
            </label>
            {% endwith %}
          {% empty %}
            <div class="text-muted"><em>No eligible features at this level.</em></div>
          {% endfor %}
        {% endwith %}
      </div>

      {% for err in item.field.errors %}
        <div class="text-danger mt-1">{{ err }}</div>
      {% endfor %}
    </div>

  {% else %}
    <div class="mb-3">
      <label class="form-label">{{ item.label }}</label>
      {{ item.field }}
      {% for err in item.field.errors %}
        <div class="text-danger mt-1">{{ err }}</div>
      {% endfor %}
    </div>
  {% endif %}

{% endfor %}
{# === END: FEATURE FIELDS LOOP === #}




          {# Optional Martial Mastery #}
          {% if form.martial_mastery %}
            <div class="mb-3">
              {{ form.martial_mastery.label_tag }}
              {{ form.martial_mastery }}
              {% for err in form.martial_mastery.errors %}
                <div class="text-danger">{{ err }}</div>
              {% endfor %}
            </div>
          {% endif %}

          <button type="submit" name="level_up_submit" class="btn btn-primary">
            Confirm Level Up
          </button>
        </form>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  {# 2) Then your custom code, wrapped in DOMContentLoaded #}
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      // — show modal if hash is present
      if (window.location.hash === "#levelUpModal") {
        new bootstrap.Modal(
          document.getElementById("levelUpModal")
        ).show();
      }

      // — wire up the filter input only if it exists

    });
  </script>
  {{ ability_map|json_script:"abilities-data" }}
{% if form.asi_mode %}
<script>
(function(){
  const dataEl = document.getElementById("abilities-data");
  if (!dataEl) return; // safety
  const base = JSON.parse(dataEl.textContent || "{}"); // {"Strength": 18, ...}

  const tbl = document.getElementById("asi-table");
  if (!tbl) return;

  const help = document.getElementById("asi-help");
  const preview = document.getElementById("asi-preview");

  // Hidden real fields
  // Hidden real fields
  const modeInput = document.getElementById("id_asi_mode");
  const aInput    = document.getElementById("id_asi_a");
  const bInput    = document.getElementById("id_asi_b");

  let slotA = aInput?.value || "";
  let slotB = bInput?.value || "";

  function pretty(k){ return k.charAt(0).toUpperCase() + k.slice(1); }
  function getBase(k){ return Number(base[pretty(k)] || 0); }

  // Any row 20+ selected? then only one slot is allowed AND it cannot be +2 on that same 20+ ability
  function lockToOne() {
    // If either chosen ability is 20+, lock to one slot total
    const chosen = [slotA, slotB].filter(Boolean);
    return chosen.some(k => getBase(k) >= 20);
  }

  function updateUI() {
    // Enforce single-selection per column (A and B):
    ["A","B"].forEach((slot) => {
      const boxes = tbl.querySelectorAll('input.asi-slot[data-slot="'+slot+'"]');
      boxes.forEach(bx => {
        const key = bx.closest("tr").dataset.key;
        if (slot === "A") bx.checked = (key === slotA);
        if (slot === "B") bx.checked = (key === slotB);
      });
    });

    // Hard rule: if any selected is 20+, only one slot allowed
    const oneOnly = lockToOne();
    const bBoxes = tbl.querySelectorAll('input.asi-slot[data-slot="B"]');
    if (oneOnly) {
      // allow only one slot; keep A, clear B if both were set
      if (slotA && slotB) slotB = "";
      bBoxes.forEach(bx => bx.disabled = true);
      help.innerHTML = '<span class="text-warning">Because one chosen ability is 20 or higher, you may only apply +1 to a single ability this level.</span>';
    } else {
      bBoxes.forEach(bx => bx.disabled = false);
      help.textContent = '';
    }

    // Compute results per row & color hints
    tbl.querySelectorAll("tbody tr").forEach(tr => {
      const key = tr.dataset.key;
      const before = Number(tr.dataset.base);
      let inc = 0;
      if (slotA === key) inc += 1;
      if (slotB === key) inc += 1;
      tr.querySelector(".asi-result").textContent = before + inc;

      tr.classList.remove("table-success","table-warning");
      if (inc === 2) tr.classList.add("table-success");
      if (inc === 1) tr.classList.add("table-warning");
    });

// Deduce mode & build preview text
// Deduce mode & build preview text
function upText(k, inc){ return `${pretty(k)}: ${getBase(k)} → ${getBase(k)+inc}`; }

let mode = "";
if (slotA && slotB) {
  mode = (slotA === slotB) ? "2" : "1+1";
} else if (slotA || slotB) {
  mode = "1";
}

// If any selected ability is 20+, force single-slot mode
if (oneOnly && mode !== "1") {
  // prefer keeping A; clear B
  slotB = "";
  mode = "1";
}

// push into hidden form fields
modeInput.value = mode;
aInput.value    = slotA || slotB || "";
bInput.value    = (mode === "1+1" || mode === "2") ? (slotB || slotA) : "";

// Preview string
let txt = "—";
if (mode === "2") {
  txt = upText(slotA, 2);
} else if (mode === "1+1") {
  txt = `${upText(slotA,1)}; ${upText(slotB,1)}`;
} else if (mode === "1") {
  const k = slotA || slotB;
  txt = upText(k, 1);
}
preview.textContent = txt;


  }

  // Click handling: only one checkbox per column at a time
  tbl.addEventListener("change", (e) => {
    const box = e.target;
    if (!box.matches(".asi-slot")) return;

    const slot = box.dataset.slot; // "A" or "B"
    const key  = box.closest("tr").dataset.key;

    // Toggle behavior: checking it selects that row for the slot; unchecking clears the slot
    if (slot === "A") {
      slotA = box.checked ? key : (slotA === key ? "" : slotA);
    } else {
      slotB = box.checked ? key : (slotB === key ? "" : slotB);
    }

    // If the currently selected ability in ANY slot is 20+, prevent two-slot allocations
    if (lockToOne() && slotA && slotB) {
      // Keep the one they just set in A; clear B (or vice versa) to enforce one slot
      if (slot === "A") { slotB = ""; }
      else { slotA = ""; }
    }

    updateUI();
  });

  // Initialize clean state
  updateUI();
})();
</script>
{% endif %}



<script>
(function(){
  function initFeatTable(opts){
    var table = document.getElementById(opts.tableId);
    if (!table) return;

    // ---- Sorting
    function cellText(row, idx){ var c=row.cells[idx]; return (c?c.textContent:"").trim().toLowerCase(); }
    table.querySelectorAll("th[data-sort]").forEach(function(th){
      th.style.cursor = "pointer";
      th.addEventListener("click", function(){
        var col = parseInt(th.getAttribute("data-sort"), 10);
        var asc = th.getAttribute("data-order") !== "asc";
        th.setAttribute("data-order", asc ? "asc" : "desc");
        var rows = Array.from(table.tBodies[0].rows);
        rows.sort(function(a,b){
          var A = cellText(a, col), B = cellText(b, col);
          return asc ? A.localeCompare(B, undefined, {numeric:true}) : B.localeCompare(A, undefined, {numeric:true});
        });
        rows.forEach(function(r){ table.tBodies[0].appendChild(r); });
      });
    });

    // ---- Excel-like filters
    var BLANK="(Blanks)";
    function getColText(row, colIdx){ var c=row.cells[colIdx]; return (c?c.textContent:"").trim(); }
    function splitTokens(txt){ return txt.split(/[,;/]/).map(function(s){return s.trim();}).filter(Boolean); }

    function uniqueValuesForCol(colIdx, splitByTokens){
      var set = new Set();
      Array.from(table.tBodies[0].rows).forEach(function(r){
        var txt = getColText(r, colIdx);
        if (!txt) set.add(BLANK);
        else if (splitByTokens){ splitTokens(txt).forEach(function(tok){ set.add(tok); }); }
        else set.add(txt);
      });
      return Array.from(set).sort(function(a,b){ return a.localeCompare(b, undefined, {numeric:true}); });
    }

    function applyFilters(){
      var menus = table.querySelectorAll(".excel-menu[data-col]");      var active = [];
      menus.forEach(function(menu){
        var col   = parseInt(menu.dataset.col, 10);
        var split = menu.dataset.split === "1";
        var selected = Array.from(menu.querySelectorAll('input[type="checkbox"]:checked')).map(function(cb){ return cb.value; });
        active.push({col, split, selected, enabled: menu.dataset.ready === "1"});
      });

      Array.from(table.tBodies[0].rows).forEach(function(row){
        var show = true;
        active.forEach(function(f){
          if (!show || !f.enabled) return;
          var txt = getColText(row, f.col);
          var tokens = (!txt) ? [BLANK] : (f.split ? splitTokens(txt) : [txt]);
          if (f.selected.length === 0) { show = false; return; }
          show = tokens.some(function(tok){ return f.selected.indexOf(tok) !== -1; });
        });
        row.style.display = show ? "" : "none";
      });
    }

    function buildFilterMenu(menuEl){
      var col   = parseInt(menuEl.dataset.col, 10);
      var split = menuEl.dataset.split === "1";
      var values = uniqueValuesForCol(col, split);

      menuEl.innerHTML = [
        '<div class="d-flex justify-content-between small mb-2">',
        '  <a href="#" class="excel-sel-all">Select all</a>',
        '  <a href="#" class="excel-clear">Clear</a>',
        '</div>',
        '<input type="text" class="form-control form-control-sm mb-2 excel-search" placeholder="Search values…">',
        '<div class="excel-list" style="max-height:220px; overflow:auto;"></div>',
        '<div class="d-flex justify-content-end gap-2 mt-2">',
        '  <button type="button" class="btn btn-sm btn-outline-secondary excel-cancel">Cancel</button>',
        '  <button type="button" class="btn btn-sm btn-success excel-ok">OK</button>',
        '</div>'
      ].join("");

      var list = menuEl.querySelector(".excel-list");
      function renderList(filter){
        list.innerHTML = "";
        values.forEach(function(v){
          if (filter && v.toLowerCase().indexOf(filter.toLowerCase()) === -1) return;
          var id = "excel_"+opts.tableId+"_"+col+"_"+btoa(unescape(encodeURIComponent(v))).replace(/=/g,'');
          var div = document.createElement("div");
          div.className = "form-check";
          div.innerHTML = '<input class="form-check-input" type="checkbox" id="'+id+'" value="'+v+'" checked>' +
                          '<label class="form-check-label small" for="'+id+'">'+v+'</label>';
          list.appendChild(div);
        });
      }
      renderList("");

      menuEl.querySelector(".excel-search").addEventListener("input", function(){ renderList(this.value.trim()); });
      menuEl.addEventListener("click", function(e){
        if (e.target.matches(".excel-sel-all")){ e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true); applyFilters(); }
        if (e.target.matches(".excel-clear"))  { e.preventDefault(); list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false); applyFilters(); }
        if (e.target.matches(".excel-ok,.excel-cancel")){
          var dd = bootstrap.Dropdown.getOrCreateInstance(menuEl.parentElement.querySelector('[data-bs-toggle="dropdown"]'));
          dd.hide();
        }
      });
      list.addEventListener("change", applyFilters);

      menuEl.dataset.ready = "1";
      applyFilters();
    }

    // build menus for all dropdowns attached to THIS table’s header
table.querySelectorAll(".excel-menu[data-col]").forEach(buildFilterMenu);
    // row highlight on radio
    table.addEventListener("change", function(e){
      if (e.target.type === "radio") {
        table.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("is-active"));
        e.target.closest("tr").classList.add("is-active");
      }
    });

    // free-text filter (cooperates with excel filters)
    if (opts.searchId){
      var input = document.getElementById(opts.searchId);
      if (input){
        input.addEventListener("keyup", function(){
          var q = this.value.toLowerCase();
          Array.from(table.tBodies[0].rows).forEach(function(row){
            var textMatch = row.textContent.toLowerCase().includes(q);
            var excelHidden = row.style.display === "none";
            row.style.display = (textMatch && !excelHidden) ? "" : (textMatch ? "" : "none");
          });
        });
      }
    }
  }

  // init both tables
  initFeatTable({ tableId: "general-feats-table", searchId: "general-feat-filter" });
  initFeatTable({ tableId: "class-feats-table",   searchId: "class-feat-filter"   });
})();
</script>


{% endblock %}
