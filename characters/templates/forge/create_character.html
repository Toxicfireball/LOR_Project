
{% extends "base.html" %}
{% block title %}Create Character – Stage 1{% endblock %}
{% block content %}



<script>window.__RACE_FEATURES_URL__ = "{% url 'characters:race_features_data' %}";</script>


<style>
  /* Global styles */
  body { background-color: #f4f4f4; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; color: #333; margin: 0; padding: 0; line-height: 1.6; }
  form#characterForm { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #fff; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
  /* Global styles */
  body {
    background-color: #f4f4f4;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    color: #333;
    margin: 0;
    padding: 0;
    line-height: 1.6;
  }
/* Modal */
.modal { position: fixed; inset: 0; display: none; z-index: 1000; }
.modal[aria-hidden="false"] { display: block; }
.modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.35); }
.modal__dialog {
  position: relative;
  max-width: 720px;
  margin: 5vh auto;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 15px 40px rgba(0,0,0,.2);
  overflow: hidden;
}
.modal__header {
  display:flex; align-items:center; justify-content:space-between;
  padding: 12px 16px; background:#f7f7fb; border-bottom:1px solid #eee;
}
.modal__close { background:transparent; border:0; font-size:1.25rem; line-height:1; cursor:pointer; padding:4px 8px; }
.modal__body { padding: 16px; }
.modal__footer { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding: 12px 16px; border-top:1px solid #eee; }

.grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.grid2 label { font-weight:600; }
.grid2 input, .grid2 select { margin-top:6px; }

.btn-primary { background:#007BFF; color:#fff; border:0; padding:.6rem 1rem; border-radius:8px; cursor:pointer; }
.btn-primary:hover { background:#005fd1; }

.form-error { color:#b00020; font-size:.95rem; min-height:1.2em; }

  /* Container and form layout */
  form#characterForm {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    background-color: #fff;
    border: 1px solid #ddd;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Headings */
  h2, h3 {
    text-align: center;
    margin-top: 0;
  }

  /* Section containers */
  div.section {
    background-color: #eef;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  div.section.light {
    background-color: #f9f9f9;
  }

  /* Labels and inputs */
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  input[type="text"],
  input[type="number"],
  select,
  textarea {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }
.feature-card {
  background:#fff; border:1px solid #ddd; border-radius:6px; padding:12px; margin:10px 0;
}
.feature-card h4 { margin:0 0 6px; }
.feature-meta { font-size:.9rem; color:#555; margin-bottom:6px; }
.feature-kv { margin:6px 0; }
.feature-kv dt { font-weight:bold; }
.feature-kv dd { margin:0 0 6px 0; }
.feature-subclass-select { margin-top:8px; }
.group-title { margin: 16px 0 8px; font-weight: bold; }
.group-divider { border-top:1px solid #ddd; margin:12px 0; }
.small-note { color:#666; font-size:.9rem; }

  /* Buttons */
  button {
    background-color: #007BFF;
    color: #fff;
    border: none;
    padding: 10px 20px;
    margin-top: 10px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 1rem;
  }
  button:hover {
    background-color: #0056b3;
  }
  button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  /* Inline form sections */
  #subrace-container,
  #racial-allocation-section,
  #half-elf-origin-container {
    margin-top: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #eef;
  }

  /* Stats table */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  table th, table td {
    padding: 8px;
    border: 1px solid #ccc;
    text-align: center;
  }
  table th {
    background-color: #eee;
  }

  /* Textarea for backstory */
  textarea {
    resize: vertical;
  }

  /* Centering final submit button */
  form#characterForm > div[style*="text-align:center"] {
    margin-top: 20px;
  }

</style>
{% if form.errors %}
  <div class="error-summary" style="background:#fdecea;border:1px solid #f5c2c7;padding:12px;margin:12px 0;">
    <strong>There are errors in your submission:</strong>
    {% if form.non_field_errors %}
      <div style="margin-top:6px;">{{ form.non_field_errors }}</div>
    {% endif %}
    <ul style="margin:6px 0 0 18px;">
      {% for field in form %}
        {% for error in field.errors %}
          <li><strong>{{ field.label }}:</strong> {{ error }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
{% endif %}

<h2 style="text-align:center;">Stage 1: Basic Character Creation</h2>
<p style="text-align:center;">Enter your character’s name, choose your race (and subrace if available) and background, provide a backstory, and adjust your ability scores using the point-buy system.</p>

<form method="post" id="characterForm" style="max-width:900px; margin: 0 auto; border:1px solid #ddd; padding:20px; background:#fff;">
  {% csrf_token %}

  <!-- Basic Info -->
  <div style="background:#f9f9f9; padding:15px; margin-bottom:20px; border:1px solid #ddd;">
    <label for="name">Character Name:</label>
    <input type="text" name="name" id="name" required>

    <!-- ability score table -->
    <div class="container" style="border:1px solid #ddd; padding:15px; background:#f9f9f9; margin-bottom:20px;">
      <h2>Add Ability Scores</h2>
      <div id="score-section">
        <h3>Add in Order: Point Buy &gt; Race &gt; Background &gt; Boost</h3>
        <p><strong>Point Buy Remaining:</strong> <span id="points-remaining">12</span></p>
        <p><strong>Background Modifier Total:</strong> <span id="background-total">0</span> / 3 <button type="button" onclick="resetBackground()">Reset Background</button></p>
        <p><strong>Boost Slots Remaining:</strong> <span id="boosts-remaining">5</span> <button type="button" onclick="resetBoosts()">Reset Boosts</button></p>
        <h3>Adjust Base Scores (Point Buy)</h3>
        <table><thead><tr><th>Ability</th><th>Base Score (8–13)</th><th>Race Mod</th><th>Background Mod</th><th>Boost Mod</th><th>Final Value</th></tr></thead>
          <tbody id="stat-table"></tbody>
        </table>
        <button type="button" onclick="resetCharacter()">Reset All</button>
      </div>
    </div>

    <!-- Race & Subrace -->
    <label for="race">Race:</label>
    <select name="race" id="race" required>
      <option value="">-- Select a Race --</option>
    </select>

    <div id="subrace-container" style="display:none; margin-top:10px;">
      <label for="subrace">Subrace:</label>
      <select name="subrace" id="subrace" style="width:100%; padding:8px;"></select>
    </div>

    <!-- Racial allocation -->
    <div id="racial-allocation-section" style="display:none; border:1px solid #ddd; padding:10px; background:#eef; margin-top:10px;">
      <h3>Allocate Your Racial Bonus Points</h3>
      <p>You have <span id="racial-points"></span> bonus point(s) to allocate among your abilities.</p>
      <div style="display:flex; flex-wrap:wrap; gap:10px;">
        <label>Strength: <input type="number" id="racial-strength" value="0" min="0" max="1" style="width:50px;"></label>
        <label>Dexterity: <input type="number" id="racial-dexterity" value="0" min="0" max="1" style="width:50px;"></label>
        <label>Constitution: <input type="number" id="racial-constitution" value="0" min="0" max="1" style="width:50px;"></label>
        <label>Intelligence: <input type="number" id="racial-intelligence" value="0" min="0" max="1" style="width:50px;"></label>
        <label>Wisdom: <input type="number" id="racial-wisdom" value="0" min="0" max="1" style="width:50px;"></label>
        <label>Charisma: <input type="number" id="racial-charisma" value="0" min="0" max="1" style="width:50px;"></label>
      </div>
      <button type="button" onclick="applyRacialAllocation()">Apply Racial Bonuses</button>
    </div>

    <!-- Half-elf origin -->

  </div>
  <div id="racial-features" class="section light" style="display:none;">
    <h3>Racial Features</h3>
    <div id="racial-features-body">Select a race to see its features.</div>
  </div>

  <!-- Will store subclass picks keyed by feature id -->
  <input type="hidden" name="racial_subclass_picks" id="racial_subclass_picks" value="{}">
  <input type="hidden" name="race_option_picks" id="race_option_picks" value="{}">
<div class="section light">
  <h3>How Background Choices Work</h3>
  <ul style="margin:0 0 0 18px;">
    <li><strong>Total Budget:</strong> No matter the combination, you end with <strong>+3 ability bonus</strong> (split over up to two abilities) and <strong>two skill/tool proficiencies</strong>.</li>
    <li><strong>Main Only:</strong> You gain the Main’s <em>Primary</em> (+2) and <em>Secondary</em> (+1) ability bonuses, plus both the Main’s <em>Primary</em> and <em>Secondary</em> skill/tool proficiencies.</li>
    <li><strong>Main + 1 Side:</strong> You keep the Main’s full Primary benefits. From the Side you choose <em>either</em> +1 to an ability (from its Primary or Secondary ability) <em>or</em> one of its skill/tool proficiencies (Primary or Secondary).</li>
    <li><strong>Main + 2 Sides:</strong> You keep the Main’s full Primary benefits. Then choose <em>one</em> +1 ability bonus from either Side (from that Side’s Primary or Secondary ability) <em>and</em> choose <em>one</em> skill/tool proficiency from either Side (Primary or Secondary).</li>
    <li><strong>Stacking Limits:</strong> The same ability or the same skill/tool can be applied at most <strong>twice</strong> total. If a choice would exceed that limit, it’s ignored and (if possible) replaced by your Main’s Secondary ability bonus.</li>
  </ul>
</div>

  <!-- Backgrounds -->
  <div class="section">
    
    <h3>Background Combination</h3>
    <label><input type="radio" name="bg_combo" value="0" checked> Main Background Only</label>
    <label><input type="radio" name="bg_combo" value="1"> Main + 1 Side Background</label>
    <label><input type="radio" name="bg_combo" value="2"> Main + 2 Side Backgrounds</label>
  </div>
  
<div class="section">
  <h3>Main Background</h3>
<p class="small-note" style="margin:4px 0 10px;">
  Don’t see your background?
  <button type="button" id="toggle-proposal" style="padding:.25rem .5rem;border:1px solid #ccc;background:#fafafa;">
    Propose a custom background to a campaign…
  </button>
</p>




  <label for="main_background">Select Main Background:</label>
  <select
    id="main_background"
    name="main_background"
    style="width:100%; padding:8px;"
  >
    <option value="">-- Select Main Background --</option>
  </select>
  <p>(In Main-only mode, you get both primary (+2) and secondary (+1) benefits.)</p>
</div>


  <div id="side_bg1_container" class="section" style="display:none;">
    <h3>Side Background</h3>
<label for="side_background_1">Select Side Background 1:</label>
<select
  id="side_background_1"
  name="side_background_1"
  style="width:100%; padding:8px;"
>
  <option value="">-- Select Side Background --</option>
</select>

<div id="side_bg1_fields" style="margin-top:10px;">
  <label for="side_bg1_ability_choice">Choose Side Background 1 Ability Bonus:</label>
<select id="side_bg1_ability_choice">
  <option value="primary">Primary Ability (+1)</option>
  <option value="secondary">Secondary Ability (+1)</option>
</select>

<label for="side_bg1_skill_choice">Choose Side Background 1 Skill Proficiency:</label>
<select id="side_bg1_skill_choice">
  <option value="primary">Primary Skill</option>
  <option value="secondary">Secondary Skill</option>
</select>

</div>
</div>


  <div id="side_bg2_container" class="section" style="display:none;">
    <h3>Side Background 2</h3>
    <label for="side_background_2">Select Side Background 2:</label>
    <select
  id="side_background_2"
  name="side_background_2"
  style="width:100%; padding:8px;">
  <option value="">-- Select Side Background --</option>
</select>

    <div id="side_bg2_fields" style="margin-top:10px;">
  <p>Select which side background supplies ability vs. skill:</p>
  <label><input type="radio" name="whichSideAbility" value="1" checked> Side 1 gives ability, Side 2 gives skill</label>
  <label><input type="radio" name="whichSideAbility" value="2"> Side 2 gives ability, Side 1 gives skill</label>
  <!-- now the two dropdowns for each side: -->
  <label for="side_bg2_ability_choice">Choose Side Background 2 Ability Bonus:</label>
<select id="side_bg2_ability_choice">
  <option value="primary">Primary Ability (+1)</option>
  <option value="secondary">Secondary Ability (+1)</option>
</select>


  <label for="side_bg2_skill_choice">Choose Side Background 2 Skill Proficiency:</label>
  <select id="side_bg2_skill_choice">
    <option value="primary">Primary Skill</option>
    <option value="secondary">Secondary Skill</option>
  </select>
</div>

  </div>
  

  <div style="margin-top:1rem;">
    <h4>Background Skill Proficiencies</h4>
    <div id="background-skill-display">
      No skill proficiencies allocated yet.
    </div>
  </div>
  <!-- Hidden fields for JS to write into -->
  <input type="hidden" name="final_race" id="finalRace" value="">
  <input type="hidden" name="strength" id="strengthInput" value="8">
  <input type="hidden" name="dexterity" id="dexterityInput" value="8">
  <input type="hidden" name="constitution" id="constitutionInput" value="8">
  <input type="hidden" name="intelligence" id="intelligenceInput" value="8">
  <input type="hidden" name="wisdom" id="wisdomInput" value="8">
  <input type="hidden" name="charisma" id="charismaInput" value="8">
  <input type="hidden" name="computed_skill_proficiencies" id="computed_skill_proficiencies" value="{}">

  <!-- Backstory -->
  <div style="margin-bottom:20px;"><label for="backstory">Backstory:</label><textarea name="backstory" id="backstory" rows="4"></textarea></div>

  <input type="hidden" name="action" id="formAction" value="create">
<div style="text-align:center; display:flex; gap:.5rem; justify-content:center;">
  <button type="submit" onclick="document.getElementById('formAction').value='draft'">Save Draft</button>
  <button type="submit" onclick="document.getElementById('formAction').value='create'">Finish Stage 1 &amp; Create Character</button>
</div>

</form>
<!-- Minimal + clean modal (NOT nested in characterForm) -->
<div id="proposal-modal" class="modal" aria-hidden="true">
  <div class="modal__backdrop" id="proposal-backdrop"></div>
  <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="proposal-title">
    <div class="modal__header">
      <h4 id="proposal-title">Propose Background</h4>
      <button type="button" class="modal__close" id="close-proposal" aria-label="Close">×</button>
    </div>

    <form method="post" action="{% url 'characters:propose_background_inline' %}" id="proposalForm" class="modal__body">
      {% csrf_token %}

      <div class="grid2">
        <label>
          Campaign
          <select name="campaign" id="proposal_campaign" required></select>
        </label>

        <label>
          Code
          <input type="text" name="code" required placeholder="e.g. street_urchin">
        </label>

        <label>
          Name
          <input type="text" name="name" required>
        </label>

        <label>
          Primary Ability
          <select name="primary_ability" id="primary_ability" required>
            <option value="strength">Strength</option>
            <option value="dexterity">Dexterity</option>
            <option value="constitution">Constitution</option>
            <option value="intelligence">Intelligence</option>
            <option value="wisdom">Wisdom</option>
            <option value="charisma">Charisma</option>
          </select>
        </label>

        <label>
          Secondary Ability
          <select name="secondary_ability" id="secondary_ability" required>
            <option value="strength">Strength</option>
            <option value="dexterity">Dexterity</option>
            <option value="constitution">Constitution</option>
            <option value="intelligence">Intelligence</option>
            <option value="wisdom">Wisdom</option>
            <option value="charisma">Charisma</option>
          </select>
        </label>

        <!-- Primary Skill -->
        <label>
          Primary Skill Type
          <select name="primary_skill_kind" id="p_kind" required>
            <option value="skill">Skill</option>
            <option value="subskill">SubSkill</option>
          </select>
        </label>
        <label>
          Primary Skill / SubSkill
          <select name="primary_skill_choice" id="p_choice" required>
            <option value="">-- select --</option>
          </select>
        </label>

        <!-- Secondary Skill -->
        <label>
          Secondary Skill Type
          <select name="secondary_skill_kind" id="s_kind" required>
            <option value="skill">Skill</option>
            <option value="subskill">SubSkill</option>
          </select>
        </label>
        <label>
          Secondary Skill / SubSkill
          <select name="secondary_skill_choice" id="s_choice" required>
            <option value="">-- select --</option>
          </select>
        </label>
      </div>

      <p class="small-note" id="proposal-rule">
        Only <strong>one</strong> of the two chosen skills may be <em>Advanced</em>. Each choice must be a <em>Skill</em> or a <em>SubSkill</em>.
      </p>

      <div class="modal__footer">
        <span class="form-error" id="proposal-error" aria-live="polite"></span>
        <button type="submit" class="btn-primary">Submit to GM</button>
      </div>
    </form>
  </div>
</div>




<script id="races-data" type="application/json">{{ races_json|safe }}</script>
<script id="backgrounds-data" type="application/json">{{ backgrounds_json|safe }}</script>
<script id="skills-data" type="application/json">{{ skills_json|safe }}</script>
<script id="subskills-data" type="application/json">{{ subskills_json|safe }}</script>
<script id="user-campaigns-data" type="application/json">{{ user_campaigns_json|safe }}</script>

<script>
(function () {
  const races = JSON.parse(document.getElementById('races-data').textContent || '[]');
  const bgs   = JSON.parse(document.getElementById('backgrounds-data').textContent || '[]');

  const raceLabelByCode = Object.fromEntries(races.map(r => [r.code, r.label]));
  const subraceLabelByParent = Object.fromEntries(
    races.map(r => [r.code, Object.fromEntries((r.subraces || []).map(s => [s.code, s.label]))])
  );
  const bgLabelByCode = Object.fromEntries(bgs.map(bg => [bg.code, bg.label]));

  function relabelSelectOptions(selectEl, labelMap) {
    if (!selectEl) return;
    Array.from(selectEl.options).forEach(opt => {
      if (labelMap[opt.value]) opt.textContent = labelMap[opt.value];
    });
  }

  // Expose small helpers for the next steps:
  window.__lor = { races, bgs, raceLabelByCode, subraceLabelByParent, bgLabelByCode, relabelSelectOptions };
})();
</script>


<script>
const racesData       = {{ races_json|safe }};
const backgroundsData = {{ backgrounds_json|safe }};

// ✅ you must declare this before you write into it
const racialModifiersDict = {};

const customizableRaces   = {};
const subracesDict        = {};

const toNumMods = (mods = {}) => {
  const get = (Nice, ugly) => Number((mods[Nice] ?? mods[ugly] ?? 0));
  return {
    Strength:     get("Strength", "strength"),
    Dexterity:    get("Dexterity","dexterity"),
    Constitution: get("Constitution","constitution"),
    Intelligence: get("Intelligence","intelligence"),
    Wisdom:       get("Wisdom","wisdom"),
    Charisma:     get("Charisma","charisma"),
  };
};



racesData.forEach(r => {
  racialModifiersDict[`R-${r.id}`] = toNumMods(r.modifiers);
  if (Array.isArray(r.subraces)) {
    r.subraces.forEach(sr => {
      racialModifiersDict[`S-${sr.id}`] = toNumMods(sr.modifiers);
    });
  }
});


  document.addEventListener("DOMContentLoaded", () => {
    //
    // Element references
    //
    const raceSelect          = document.getElementById("race");
    const subraceDiv          = document.getElementById("subrace-container");
    const subraceSelect       = document.getElementById("subrace");


    const mainBgSelect        = document.getElementById("main_background");
    const side1Div            = document.getElementById("side_bg1_container");
    const side1Select         = document.getElementById("side_background_1");
    const side1AbilitySelect  = document.getElementById("side_bg1_ability_choice");
    const side1SkillSelect    = document.getElementById("side_bg1_skill_choice");

    const side2Div            = document.getElementById("side_bg2_container");
    const side2Select         = document.getElementById("side_background_2");
    const whichSideRadios     = document.getElementsByName("whichSideAbility");
    const side2AbilitySelect  = document.getElementById("side_bg2_ability_choice");
    const side2SkillSelect    = document.getElementById("side_bg2_skill_choice");

    const bgComboRadios       = document.getElementsByName("bg_combo");

    const pointsRemainingEl   = document.getElementById("points-remaining");
    const bgTotalEl           = document.getElementById("background-total");
    const boostsRemainingEl   = document.getElementById("boosts-remaining");
    const statTableBody       = document.getElementById("stat-table");

    const strengthInput       = document.getElementById("strengthInput");
    const dexterityInput      = document.getElementById("dexterityInput");
    const constitutionInput   = document.getElementById("constitutionInput");
    const intelligenceInput   = document.getElementById("intelligenceInput");
    const wisdomInput         = document.getElementById("wisdomInput");
    const charismaInput       = document.getElementById("charismaInput");

    const computedSkillsInput = document.getElementById("computed_skill_proficiencies");
        // --- Racial features (AJAX) ------------------------------------------------
    const racialFeaturesWrap = document.getElementById("racial-features");
    const racialFeaturesBody = document.getElementById("racial-features-body");
    const raceFeaturesURL    = window.__RACE_FEATURES_URL__;
    const subclassPicksInput = document.getElementById("racial_subclass_picks");
    let racialSubclassPicks  = {};

    try { racialSubclassPicks = JSON.parse(subclassPicksInput.value || "{}") || {}; }
    catch(e) { racialSubclassPicks = {}; }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, c => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]
      ));
    }
// --- Add this helper near your other small helpers (inside DOMContentLoaded) ---
function resetBackgroundUI() {
  // clear internal bg state
  resetBGState();
  stats.forEach(s => backgroundModifiers[s] = 0);

  // clear selects & choices
  if (mainBgSelect)        mainBgSelect.value = "";
  if (side1Select)         side1Select.value = "";
  if (side2Select)         side2Select.value = "";
  if (side1AbilitySelect)  side1AbilitySelect.value = "primary";
  if (side1SkillSelect)    side1SkillSelect.value = "primary";
  if (side2AbilitySelect)  side2AbilitySelect.value = "primary";
  if (side2SkillSelect)    side2SkillSelect.value = "primary";
  if (whichSideRadios && whichSideRadios.length) {
    // default: Side 1 gives ability, Side 2 gives skill
    Array.from(whichSideRadios).forEach(r => (r.checked = r.value === "1"));
  }

  // show only "Main only" section UI
  if (side1Div) side1Div.style.display = "none";
  if (side2Div) side2Div.style.display = "none";
  if (bgComboRadios && bgComboRadios.length) {
    Array.from(bgComboRadios).forEach(r => (r.checked = r.value === "0"));
  }

  // clear computed skills display + hidden field
  document.getElementById("background-skill-display").innerHTML = "No skill proficiencies allocated yet.";
  if (computedSkillsInput) computedSkillsInput.value = "{}";

  // also reset any boosts (keeps “Add in Order” contract intact)
  window.resetBoosts();

  // re-render counters/table
  updateDisplay();
}

// --- Replace your current window.resetBackground = ... with this: ---
window.resetBackground = () => {
  resetBackgroundUI();
};

// (optional but recommended) make Reset All also clear race/subrace & backgrounds
window.resetCharacter = () => {
  // clear race & subrace
  raceSelect.value = "";
  subraceSelect.innerHTML = "<option value=''>-- Select a Subrace --</option>";
  subraceDiv.style.display = "none";

  // clear any racial ASI allocations
  racialASIBonus = {};
  stats.forEach(s => {
    const el = document.getElementById("racial-" + s.toLowerCase());
    if (el) el.value = 0;
    racialASIBonus[s] = 0;
  });
  document.getElementById("racial-allocation-section").style.display = "none";
  document.getElementById("racial-points").innerText = "0";

  // clear backgrounds & boosts and re-init base stats/counters
  resetBackgroundUI();
  stats.forEach(s => {
    baseStats[s] = 8;
    boostModifiers[s] = 0;
    boostedStats[s] = false;
  });
  pointsRemaining = 12;
  boostsRemaining = 5;
  highBoostUsed = false;

  // clear racial features pane
  const racialFeaturesWrap = document.getElementById("racial-features");
  const racialFeaturesBody = document.getElementById("racial-features-body");
  if (racialFeaturesWrap && racialFeaturesBody) {
    racialFeaturesWrap.style.display = "none";
    racialFeaturesBody.innerHTML = "Select a race to see its features.";
  }

  updateDisplay();
};

// --- Also hook background reset when race/subrace changes ---
raceSelect.addEventListener("change", () => {
  // (existing code that rebuilds subrace list etc… stays)
  resetBackgroundUI();   // <- NEW: nuke backgrounds when race changes
});

subraceSelect.addEventListener("change", () => {
  resetBackgroundUI();   // <- NEW: if they swap subrace, clear backgrounds too
});

function featureCardHTML(f) {
  const kv = (f.details || [])
    .map(d => `<dt>${escapeHtml(d.label)}</dt><dd>${d.value}</dd>`)
    .join("");

  const subclassSelectHTML = f.is_subclass_choice ? `
    <div class="feature-subclass-select">
      <label>Select ${escapeHtml(f.subclass_group || "Subclass")}:
        <select data-feature="${f.id}">
          <option value="">-- Choose an option --</option>
          ${(f.subclasses || []).map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("")}
        </select>
      </label>
      <div class="small-note">Required: pick a ${escapeHtml(f.subclass_group || "subclass")} for this feature.</div>
    </div>
  ` : "";

  const optionsBlock = raceOptionsHTML(f);   // ⬅ NEW

  const desc = (f.description_html || "").trim();
  const descHTML = desc ? `<div class="feature-desc small-note">${desc}</div>` : "";

  return `
    <div class="feature-card" data-feature-id="${f.id}">
      <h4>${escapeHtml(f.name || "Feature")}</h4>
      ${kv ? `<dl class="feature-kv">${kv}</dl>` : ""}
      ${optionsBlock}            <!-- ⬅ shows RaceFeatureOption select (and nested subclass picker if needed) -->
      ${subclassSelectHTML}      <!-- ⬅ top-level subclass_choice (if any) -->
      ${descHTML}
    </div>
  `;
}


    function sectionHTML(title, list) {
      if (!Array.isArray(list) || list.length === 0) return "";
      return `
        <div class="group-divider"></div>
        <div class="group-title">${escapeHtml(title)}</div>
        ${list.map(featureCardHTML).join("")}
      `;
    }

    function bindSubclassSelects(container) {
      container.querySelectorAll("select[data-feature]").forEach(sel => {
        const fid  = String(sel.getAttribute("data-feature"));
        const saved = racialSubclassPicks[fid] ? String(racialSubclassPicks[fid]) : "";
        if (saved) sel.value = saved;

        sel.addEventListener("change", () => {
          if (sel.value) {
            racialSubclassPicks[fid] = sel.value;
          } else {
            delete racialSubclassPicks[fid];
          }
          subclassPicksInput.value = JSON.stringify(racialSubclassPicks);
        });
      });
      // keep input in sync even if nothing changed (useful on first render)
      subclassPicksInput.value = JSON.stringify(racialSubclassPicks);
    }

    async function loadRaceFeatures() {
      const raceId    = (raceSelect.value || "").trim();
      const subraceId = (subraceDiv.style.display !== "none" && subraceSelect.value) ? subraceSelect.value.trim() : "";

      if (!raceId) {
        racialFeaturesWrap.style.display = "none";
        racialFeaturesBody.innerHTML = "Select a race to see its features.";
        return;
      }

      const qs = new URLSearchParams({ race: raceId });
      if (subraceId) qs.set("subrace", subraceId);

      racialFeaturesWrap.style.display = "";
      racialFeaturesBody.innerHTML = `<div class="small-note">Loading features…</div>`;

      try {
        const res = await fetch(`${raceFeaturesURL}?${qs.toString()}`, {
          headers: { "X-Requested-With": "XMLHttpRequest" },
          credentials: "same-origin"                 // ← ensure the session cookie is sent
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        const parts = [];
        // Race-wide (no subrace, no class)
        parts.push(sectionHTML("Race Features", data.universal_features || []));
        // Subrace-specific (only current subrace)
        parts.push(sectionHTML("Subrace Features", data.subrace_features || []));
        // Optional: class-specific buckets (if your Race has them)
        (data.class_features_by_class || []).forEach(bucket => {
          parts.push(sectionHTML(`${bucket.class_name} Features`, bucket.features || []));
        });

        const html = parts.join("").trim();
        racialFeaturesBody.innerHTML = html || `<div class="small-note">No racial features for this selection.</div>`;
        bindSubclassSelects(racialFeaturesBody);
        bindRaceOptionControls(racialFeaturesBody);
      } catch (e) {
  racialFeaturesBody.innerHTML = `<div class="small-note">Could not load racial features. Please try again.</div>`;      }
    }
    // --------------------------------------------------------------------------

    const finalRaceInput      = document.getElementById("finalRace");
    const characterForm       = document.getElementById("characterForm");

    //
    // State
    //
    const stats = ["Strength","Dexterity","Constitution","Intelligence","Wisdom","Charisma"];
    let baseStats           = {};
    let backgroundModifiers = {};
    let boostModifiers      = {};
    let boostedStats        = {};
    let racialASIBonus      = {};
    let racialASIPoints     = 0;
    let pointsRemaining     = 12;
    let boostsRemaining     = 5;
    let highBoostUsed       = false;

    //
    // Helpers: add ability bonus & skill
    //
    let bgAbilityBonuses = {};
    let bgSkillProficiencies = {};
    function resetBGState(){
      bgAbilityBonuses = stats.reduce((o,s)=>{o[s]=0;return o},{});
      bgSkillProficiencies = {};
    }
function addAbilityBonus(ability, bonus){
  bgAbilityBonuses[ability] = Math.min(Number(bgAbilityBonuses[ability]||0) + Number(bonus||0), 2);
}

function addSkill(name){
  if(!name) return;
  bgSkillProficiencies[name] = "Trained";
}


    //
    // Initialize everything
    //
    function initializeCharacter(){
      stats.forEach(s=>{
        baseStats[s]=8;
        backgroundModifiers[s]=0;
        boostModifiers[s]=0;
        boostedStats[s]=false;
        racialASIBonus[s]=0;
      });
      pointsRemaining=12;
      boostsRemaining=5;
      highBoostUsed=false;
      updateDisplay();
    }

    //
    // Populate race & background selects
    //
function populateRaceDropdown(){
  racesData.forEach(r=>{
    const text = r.label || r.name;       // show bonuses if present
    const val  = r.id;                    // ✅ submit PK
    raceSelect.add(new Option(text, val));
  });
}
function populateBackgroundDropdowns(){
  [mainBgSelect, side1Select, side2Select].forEach(el=>{
    backgroundsData.forEach(b=>{
      const text = b.label || b.name; // show the nice label if present
      el.add(new Option(text, b.code));
    });
  });
}


    //
    // Subrace & customizable ASIs
    //
function applyRacialSlots(){
  const raceId = Number(raceSelect.value);
  const r = racesData.find(x => x.id === raceId);

  const parentPts = r ? (r.free_points || 0) : 0;
  let subPts = 0;
  if (subraceDiv.style.display === "block" && r && Array.isArray(r.subraces)) {
    const sr = r.subraces.find(x => x.id === Number(subraceSelect.value));
    subPts = sr ? (sr.free_points || 0) : 0;
  }
  racialASIPoints = parentPts + subPts;
  document.getElementById("racial-points").innerText = racialASIPoints;
  document.getElementById("racial-allocation-section").style.display = racialASIPoints > 0 ? "" : "none";

  if (racialASIPoints > 0) {
    const maxPer = r.max_bonus_per_ability;
const fixedMods = (subraceSelect.value)
  ? (racialModifiersDict[`S-${Number(subraceSelect.value)}`] || {})
  : (racialModifiersDict[`R-${raceId}`] || {});
    stats.forEach(s => {
      const fixed = fixedMods[s] || 0;
      document.getElementById("racial-" + s.toLowerCase()).max = Math.max(maxPer - fixed, 0);
    });
  }
}

function getCurrentRacialModifiers() {
  const mainId = Number(raceSelect.value);
  const subId  = Number(subraceSelect.value);

  const mainMods = racialModifiersDict[`R-${mainId}`] || {};
  const subMods  = subId ? (racialModifiersDict[`S-${subId}`] || {}) : {};

  const combined = {};
  const n = (x) => Number(x ?? 0);

  ["Strength","Dexterity","Constitution","Intelligence","Wisdom","Charisma"].forEach(stat => {
    combined[stat] = n(mainMods[stat]) + n(subMods[stat]) + n(racialASIBonus[stat]);
  });
  return combined;
}

    //
    // Half-elf origin
    //


    //
    // Prevent duplicate backgrounds
    //
function preventDuplicate(a,b,msg){
  a.addEventListener("change",()=>{
    if (a.value && a.value === b.value){
      alert(msg);
      a.value = "";
    }
    window.resetBoosts(); // ← keep boosts consistent when a dup is corrected
  });
}


    //
    // Background logic
    //
    const raceOptionPicksInput = document.getElementById("race_option_picks");
let raceOptionPicks = {};
try { raceOptionPicks = JSON.parse(raceOptionPicksInput.value || "{}") || {}; } catch(e){ raceOptionPicks = {}; }

function raceOptionsHTML(f) {
  const opts = f.race_options || [];
  if (!opts.length) return "";

  const saved = (raceOptionPicks[String(f.id)] || {}).option_id || "";
  const savedSub = (raceOptionPicks[String(f.id)] || {}).subclass_id || "";

  const options = ['<option value="">-- Choose an option --</option>']
    .concat(opts.map(o => `<option value="${o.id}" ${String(saved)===String(o.id) ? "selected":""}>${escapeHtml(o.label)}</option>`))
    .join("");

  // Side panel for the currently selected option
  let inner = "";
  const selected = opts.find(o => String(o.id) === String(saved));
  if (selected && selected.grants_feature) {
    const gf = selected.grants_feature;
    const kv = (gf.details || [])
      .map(d => `<dt>${escapeHtml(d.label)}</dt><dd>${d.value}</dd>`)
      .join("");
    inner += `
      <div class="feature-card" style="background:#fafafa;border-color:#eee;">
        ${kv ? `<dl class="feature-kv">${kv}</dl>` : ""}
        ${gf.description_html ? `<div class="feature-desc small-note">${gf.description_html}</div>` : ""}
      </div>
    `;
    if (gf.is_subclass_choice) {
      const subOptions = ['<option value="">-- Choose ${escapeHtml(gf.subclass_group || "subclass")} --</option>']
        .concat((gf.subclasses || []).map(s => `<option value="${s.id}" ${String(savedSub)===String(s.id) ? "selected": ""}>${escapeHtml(s.name)}</option>`))
        .join("");
      inner += `
        <div class="feature-subclass-select">
          <label>${escapeHtml(gf.subclass_group || "Subclass")}:
            <select data-option-subclass-for="${f.id}">${subOptions}</select>
          </label>
        </div>
      `;
    }
  }

  return `
    <div class="feature-option-select">
      <label>Choose one:
        <select data-option-for="${f.id}">
          ${options}
        </select>
      </label>
    </div>
    ${inner}
  `;
}

function bindRaceOptionControls(container) {
  // option picker
  container.querySelectorAll("select[data-option-for]").forEach(sel => {
    const fid = String(sel.getAttribute("data-option-for"));
    sel.addEventListener("change", () => {
      const optId = sel.value || "";
      raceOptionPicks[fid] = { option_id: optId };
      raceOptionPicksInput.value = JSON.stringify(raceOptionPicks);
      // re-render to show details / nested subclass selector for the chosen option
      loadRaceFeatures();
    });
  });

  // nested subclass picker when an option grants a subclass_choice
  container.querySelectorAll("select[data-option-subclass-for]").forEach(sel => {
    const fid = String(sel.getAttribute("data-option-subclass-for"));
    sel.addEventListener("change", () => {
      const rec = raceOptionPicks[fid] || {};
      rec.subclass_id = sel.value || "";
      raceOptionPicks[fid] = rec;
      raceOptionPicksInput.value = JSON.stringify(raceOptionPicks);
    });
  });
}

    function updateBackgroundModifiers(){
      resetBGState();
const main = backgroundsData.find(b=>b.code===mainBgSelect.value);      const combo = document.querySelector('input[name="bg_combo"]:checked').value;
      if(main){
        // always primary
        addAbilityBonus(main.primary.ability,main.primary.bonus);
        addSkill(main.primary.skill);
        if(combo==="0"){
          // main-only gets secondary too
          addAbilityBonus(main.secondary.ability,main.secondary.bonus);
          addSkill(main.secondary.skill);
        } else if(combo==="1" && side1Select.value){
const side = backgroundsData.find(b=>b.code===side1Select.value);          addAbilityBonus(side[side1AbilitySelect.value].ability,1);
          addSkill(side[side1SkillSelect.value].skill);
        } else if(combo==="2"){
          const which = Array.from(whichSideRadios).find(r=>r.checked).value;
          // which=1: side1 ability, side2 skill; which=2: side2 ability, side1 skill
          const abilEl = which==="1" ? side1Select : side2Select;
          const abilChoice = (abilEl===side1Select?side1AbilitySelect:side2AbilitySelect).value;
          if(abilEl.value){
const s = backgroundsData.find(b=>b.code===abilEl.value);            addAbilityBonus(s[abilChoice].ability,1);
          }
          const skillEl = which==="1"? side2Select : side1Select;
          const skillChoice = (skillEl===side1Select?side1SkillSelect:side2SkillSelect).value;
          if(skillEl.value){
const s = backgroundsData.find(b=>b.code===skillEl.value);            addSkill(s[skillChoice].skill);
          }
        }
      }
      Object.assign(backgroundModifiers,bgAbilityBonuses);
      updateBackgroundSummary();
    }

    function updateBackgroundSummary(){
      let sum=0;
      stats.forEach(s=>sum+=backgroundModifiers[s]);
      bgTotalEl.textContent = sum;
      updateBackgroundSkillProficiencies();
    }

    function updateBackgroundSkillProficiencies(){
      let html="";
      for(let sk in bgSkillProficiencies){
        html+=`<strong>${sk}</strong>: Trained<br>`;
      }
      document.getElementById("background-skill-display").innerHTML =
        html||"No skill proficiencies allocated yet.";
    }

    //
    // Point buy adjust
    //
    function adjustStat(stat,amt){
      if(step()<1) return;
      if(amt===1 && pointsRemaining>0 && baseStats[stat]<13){
        baseStats[stat]++; pointsRemaining--;
      } else if(amt===-1 && baseStats[stat]>8){
        baseStats[stat]--; pointsRemaining++;
      }
      updateDisplay();
    }

    //
    // Boost logic
    //
    function applyBoost(stat,value){
      if(step()<4 || boostsRemaining<=0 || boostedStats[stat]) return;
      const baseVal = baseStats[stat]
                    + (getCurrentRacialModifiers()[stat]||0)
                    + (backgroundModifiers[stat]||0);
      let cost=1;
      if(value===2 && baseVal>=14 && baseVal<=17){
        if(highBoostUsed||boostsRemaining<2) return;
        cost=2; highBoostUsed=true;
      } else if(value===1){
        if(baseVal<14) return;
      } else if(value===2 && baseVal>13) return;
      else if(value===3){
        if(baseVal>10) return;
      }
      boostModifiers[stat]+=value;
      boostsRemaining-=cost;
      boostedStats[stat]=true;
      updateDisplay();
    }

    //
    // Race modifiers + ASIs
    //





    //
    // Calculate which step we’re on
    //


    function step(){
      if(pointsRemaining>0) return 1;
      if(!raceSelect.value) return 2;
      if(Number(bgTotalEl.textContent)<3) return 3;
      return 4;
    }

    //
    // Update display: table, counters, hidden inputs
    //
    function updateDisplay(){
      // counters
      pointsRemainingEl.textContent = pointsRemaining;
      boostsRemainingEl.textContent = boostsRemaining;
      updateBackgroundModifiers();

      // rebuild table
      const raceMods = getCurrentRacialModifiers();
      let rows="";
      stats.forEach(stat=>{
        const base = baseStats[stat];
        const rm   = raceMods[stat]||0;
        const bm   = backgroundModifiers[stat]||0;
        const ub   = boostModifiers[stat]||0;
        const final= base+rm+bm+ub;
        const stp  = step();
        rows += `
          <tr>
            <td>${stat}</td>
            <td>
              <button type="button" onclick="adjustStat('${stat}',1)" 
                ${stp>1||base>=13?"disabled":""}>+</button>
              ${base}
              <button type="button" onclick="adjustStat('${stat}',-1)"
                ${stp>1||base<=8?"disabled":""}>-</button>
            </td>
            <td>${rm}</td>
            <td>${bm}</td>
            <td>
              <button type="button" onclick="applyBoost('${stat}',3)"
                ${stp<4||boostedStats[stat]?"disabled":""}>+3</button>
              <button type="button" onclick="applyBoost('${stat}',2)"
                ${stp<4||boostedStats[stat]?"disabled":""}>+2</button>
              <button type="button" onclick="applyBoost('${stat}',1)"
                ${stp<4||boostedStats[stat]?"disabled":""}>+1</button>
              ${ub}
            </td>
            <td>${final}</td>
          </tr>
        `;
      });
      statTableBody.innerHTML = rows;

      // hidden inputs
  // hidden inputs (Final = Base + Race + Background + Boost)
  const eff = getCurrentRacialModifiers();
  strengthInput.value     = baseStats.Strength     + (eff.Strength||0)     + (backgroundModifiers.Strength||0)     + (boostModifiers.Strength||0);
  dexterityInput.value    = baseStats.Dexterity    + (eff.Dexterity||0)    + (backgroundModifiers.Dexterity||0)    + (boostModifiers.Dexterity||0);
  constitutionInput.value = baseStats.Constitution + (eff.Constitution||0) + (backgroundModifiers.Constitution||0) + (boostModifiers.Constitution||0);
  intelligenceInput.value = baseStats.Intelligence + (eff.Intelligence||0) + (backgroundModifiers.Intelligence||0) + (boostModifiers.Intelligence||0);
  wisdomInput.value       = baseStats.Wisdom       + (eff.Wisdom||0)       + (backgroundModifiers.Wisdom||0)       + (boostModifiers.Wisdom||0);
  charismaInput.value     = baseStats.Charisma     + (eff.Charisma||0)     + (backgroundModifiers.Charisma||0)     + (boostModifiers.Charisma||0);

    }

    //
    // Validate side-background choice on submit
    //
    function validateSideBackgroundBonusTypes(){
      const combo = document.querySelector('input[name="bg_combo"]:checked').value;
      if(combo==="1" && !side1Select.value){
        alert("Please select your Side Background 1.");
        return false;
      }
      if(combo==="2" && (!side1Select.value||!side2Select.value)){
        alert("Please select both Side Backgrounds.");
        return false;
      }
      return true;
    }

    //
    // Form submission
    //
    characterForm.addEventListener("submit",e=>{
      if(!validateSideBackgroundBonusTypes()){
        e.preventDefault();
        return;
      }
      // finalRace
      finalRaceInput.value = (subraceDiv.style.display==="block"&&subraceSelect.value)
                           ? subraceSelect.value
                           : raceSelect.value;
      // skill proficiencies JSON
      computedSkillsInput.value = JSON.stringify(bgSkillProficiencies);
    });

    //
    // Racial allocation apply
    //
    window.applyRacialAllocation = () => {
      // collect and sum
      let total=0;
      stats.forEach(s=>{
        const val = Number(document.getElementById("racial-"+s.toLowerCase()).value);
        if(val>1){ alert("Max +1 per ability"); return; }
        total+=val;
      });
      if(total!==racialASIPoints){
        alert(`Please allocate exactly ${racialASIPoints} point(s).`);
        return;
      }
      stats.forEach(s=>{
        racialASIBonus[s] = Number(document.getElementById("racial-"+s.toLowerCase()).value);
      });
      alert("Racial bonuses applied!");
      updateDisplay();
    };

    //
    // Hook global handlers
    //
    window.adjustStat    = adjustStat;
    window.applyBoost    = applyBoost;
    window.resetBoosts   = () => { stats.forEach(s=>{boostModifiers[s]=0;boostedStats[s]=false;}); boostsRemaining=5; highBoostUsed=false; updateDisplay(); };
    window.resetCharacter= initializeCharacter;

    //
    // Wire up events
    //
    populateRaceDropdown();
    populateBackgroundDropdowns();
    initializeCharacter();

    // race → subrace + ASI slots + half-elf
raceSelect.addEventListener("change", () => {
  subraceSelect.innerHTML = "<option value=''>-- Select a Subrace --</option>";
  const r = racesData.find(x => x.id === Number(raceSelect.value));
  if (r && Array.isArray(r.subraces) && r.subraces.length) {
    r.subraces.forEach(sr => subraceSelect.add(new Option(sr.label || sr.name, sr.id)));
    subraceDiv.style.display = "";
  } else {
    subraceDiv.style.display = "none";
  }
  applyRacialSlots();
  updateDisplay();
  loadRaceFeatures();       // ← keep this
});

subraceSelect.addEventListener("change", () => {
  applyRacialSlots();
  updateDisplay();
  loadRaceFeatures();       // ← keep this
});




    // background combo → show/hide side selects
// background combo → show/hide side selects (also reset boosts)
Array.from(bgComboRadios).forEach(r=>{
  r.addEventListener("change",()=>{
    const c = r.value;
    side1Div.style.display = (c==="1"||c==="2") ? "block" : "none";
    side2Div.style.display = (c==="2") ? "block" : "none";
    window.resetBoosts(); // ← reset all Boost Mod picks when background combo changes
  });
});


    // any background dropdown/choice change
// any background dropdown/choice change → reset boosts
[ mainBgSelect, side1Select, side1AbilitySelect, side1SkillSelect,
  side2Select, side2AbilitySelect, side2SkillSelect,
  ...whichSideRadios
].forEach(el=>{
  if (el && el.addEventListener) {
    el.addEventListener("change", () => {
      window.resetBoosts();  // ← nukes boostModifiers/boostedStats and re-renders
    });
  }
});



    // duplicate prevention
    preventDuplicate(mainBgSelect,side1Select,"Main and Side 1 cannot match.");
    preventDuplicate(mainBgSelect,side2Select,"Main and Side 2 cannot match.");
    preventDuplicate(side1Select, side2Select,"Side 1 and Side 2 cannot match.");
    // also prevent selecting side2 = side1
    preventDuplicate(side2Select, side1Select, "Side Background cannot match Side Background.");
// After options are populated, swap visible labels to show bonuses/proficiencies
// build label maps by ID, not code
// After options are populated, swap visible labels to show bonuses/proficiencies
// After options are populated, swap visible labels to show bonuses/proficiencies
const raceLabelById = Object.fromEntries(racesData.map(r => [String(r.id), r.label]));
const subraceLabelByParentId = Object.fromEntries(
  racesData.map(r => [
    String(r.id),
    Object.fromEntries((r.subraces || []).map(s => [String(s.id), s.label]))
  ])
);

if (window.__lor) {
  window.__lor.relabelSelectOptions(raceSelect, raceLabelById);
  const firstSubMap = subraceLabelByParentId[raceSelect.value] || {};
  window.__lor.relabelSelectOptions(subraceSelect, firstSubMap);

  raceSelect.addEventListener('change', () => {
    const subMap = subraceLabelByParentId[raceSelect.value] || {};
    window.__lor.relabelSelectOptions(subraceSelect, subMap);
  });
}

loadRaceFeatures(); // NEW

    // finally initial render
    updateDisplay();
  });
</script>
<script id="skills-data" type="application/json">{{ skills_json|safe }}</script>
<script id="subskills-data" type="application/json">{{ subskills_json|safe }}</script>
<script id="user-campaigns-data" type="application/json">{{ user_campaigns_json|safe }}</script>


<script>
(function(){
  // Data from server
  const campaigns = JSON.parse(document.getElementById('user-campaigns-data').textContent || '[]');
  const skills    = JSON.parse(document.getElementById('skills-data').textContent || '[]');       // [{id, name, is_advanced}]
  const subskills = JSON.parse(document.getElementById('subskills-data').textContent || '[]');   // [{id, name, skill__name, skill__is_advanced}]

  // Elements
  const openBtn   = document.getElementById('toggle-proposal');
  const modal     = document.getElementById('proposal-modal');
  const backdrop  = document.getElementById('proposal-backdrop');
  const closeBtn  = document.getElementById('close-proposal');
  const form      = document.getElementById('proposalForm');

  const campSel   = document.getElementById('proposal_campaign');

  const pKind     = document.getElementById('p_kind');
  const pChoice   = document.getElementById('p_choice');
  const sKind     = document.getElementById('s_kind');
  const sChoice   = document.getElementById('s_choice');

  const errorBox  = document.getElementById('proposal-error');

  // Helpers
  function openModal(){ modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.setAttribute('aria-hidden','true'); errorBox.textContent = ''; }

  function fillCampaigns() {
    if (!campSel) return;
    campSel.innerHTML = '<option value="">-- Select Campaign --</option>';
    campaigns.forEach(c => campSel.add(new Option(c.name, c.id)));
  }

  function fillChoices(kindSel, targetSel) {
    if (!kindSel || !targetSel) return;
    targetSel.innerHTML = '<option value="">-- select --</option>';
    const kind = kindSel.value;

    if (kind === 'skill') {
      skills.forEach(s => targetSel.add(new Option(
        (s.is_advanced ? '★ ' : '') + s.name,
        'skill:' + s.id
      )));
    } else {
      subskills.forEach(su => targetSel.add(new Option(
        (su["skill__is_advanced"] ? '★ ' : '') + su["skill__name"] + ' – ' + su.name,
        'subskill:' + su.id
      )));
    }
  }

  function isAdvancedChoice(value) {
    if (!value) return false;
    const [kind, idStr] = value.split(':');
    const id = Number(idStr);
    if (kind === 'skill') {
      const sk = skills.find(s => s.id === id);
      return !!(sk && sk.is_advanced);
    }
    if (kind === 'subskill') {
      const su = subskills.find(su => su.id === id);
      return !!(su && su["skill__is_advanced"]);
    }
    return false;
  }

  function kindsMatchValue(kindSel, value) {
    if (!value) return false;
    const [kind] = value.split(':');
    return (kindSel.value === kind); // "skill" vs "subskill"
  }

  // Events: open/close
  if (openBtn) openBtn.addEventListener('click', openModal);
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (backdrop) backdrop.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

  // Select population
  fillCampaigns();
  fillChoices(pKind, pChoice);
  fillChoices(sKind, sChoice);

  pKind.addEventListener('change', () => fillChoices(pKind, pChoice));
  sKind.addEventListener('change', () => fillChoices(sKind, sChoice));

  // Validation (enforce your rules)
  form.addEventListener('submit', (e) => {
    errorBox.textContent = '';

    // Ensure chosen values align with their types (Skill/SubSkill)
    if (!kindsMatchValue(pKind, pChoice.value)) {
      e.preventDefault();
      errorBox.textContent = 'Primary selection does not match its type.';
      return;
    }
    if (!kindsMatchValue(sKind, sChoice.value)) {
      e.preventDefault();
      errorBox.textContent = 'Secondary selection does not match its type.';
      return;
    }

    // Only one Advanced allowed across the two
    const advancedCount = (isAdvancedChoice(pChoice.value) ? 1 : 0) + (isAdvancedChoice(sChoice.value) ? 1 : 0);
    if (advancedCount > 1) {
      e.preventDefault();
      errorBox.textContent = 'Only one of the two skills may be Advanced.';
      return;
    }
  });
})();
</script>


{% endblock %}