{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto p-6 space-y-10">

  {# =========================== RACE HEADER (flat, consistent) =========================== #}
  <section class="grid grid-cols-1 lg:grid-cols-[160px_1fr_160px] gap-6 items-start">
    <div>
      {% if race.primary_image %}
        <img src="{{ race.primary_image.url }}" alt="{{ race.name }} primary image"
             class="w-full h-40 object-cover rounded-lg border border-gray-200 bg-white" />
      {% else %}
        <div class="w-full h-40 rounded-lg bg-gray-100 text-gray-400 flex items-center justify-center border border-gray-200">
          No Image
        </div>
      {% endif %}
    </div>

    <div class="space-y-4">
      <header class="space-y-1">
        <div class="text-3xl font-bold tracking-tight">{{ race.name }}</div>
<ul class="flex flex-wrap gap-2 text-sm text-gray-700">
  <!-- Size -->
  <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
    <span class="uppercase text-[10px] tracking-wide text-gray-500">Size</span>
    <span class="font-medium">{{ race.size|capfirst }}</span>
  </li>

  <!-- Starting HP (only if present) -->
  {% if race_starting_hp %}
  <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
    <span class="uppercase text-[10px] tracking-wide text-gray-500">Starting HP</span>
    <span class="font-medium">{{ race_starting_hp }}</span>
  </li>
  {% endif %}

  <!-- Speeds: land/swim/climb/fly/burrow if present -->
  {% if race_speeds %}
    {% for label, val in race_speeds %}
      <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
        <span class="uppercase text-[10px] tracking-wide text-gray-500">{{ label }}</span>
        <span class="font-medium">{{ val }} ft</span>
      </li>
    {% endfor %}
  {% else %}
    <!-- Fallback if you only have race.speed -->
    <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
      <span class="uppercase text-[10px] tracking-wide text-gray-500">Speed</span>
      <span class="font-medium">{{ race.speed }} ft</span>
    </li>
  {% endif %}
</ul>
      </header>

      {% if race.description %}
        <div class="prose max-w-none">{{ race.description|safe }}</div>
      {% endif %}

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        {% if languages %}
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-xs uppercase tracking-wide text-gray-500">Languages</span>
            {% for lang in languages %}
              <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-xs border border-gray-200">{{ lang.name }}</span>
            {% endfor %}
          </div>
        {% endif %}
        {% if tags %}
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-xs uppercase tracking-wide text-gray-500">Tags</span>
            {% for tag in tags %}
              <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-800 text-xs border border-gray-200">{{ tag.name }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      {# Race ability bonuses (only non-zero) #}
      {% if race.strength_bonus or race.dexterity_bonus or race.constitution_bonus or race.intelligence_bonus or race.wisdom_bonus or race.charisma_bonus %}
        <div class="rounded-lg bg-white border border-gray-200 p-3">
          <div class="text-xs uppercase tracking-wide text-gray-500 mb-2">Ability Bonuses</div>
          <div class="flex flex-wrap gap-2 text-sm">
            {% if race.strength_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">STR +{{ race.strength_bonus }}</span>{% endif %}
            {% if race.dexterity_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">DEX +{{ race.dexterity_bonus }}</span>{% endif %}
            {% if race.constitution_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">CON +{{ race.constitution_bonus }}</span>{% endif %}
            {% if race.intelligence_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">INT +{{ race.intelligence_bonus }}</span>{% endif %}
            {% if race.wisdom_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">WIS +{{ race.wisdom_bonus }}</span>{% endif %}
            {% if race.charisma_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">CHA +{{ race.charisma_bonus }}</span>{% endif %}
          </div>
        </div>
      {% endif %}
      {# Budget/Free/Max intentionally not shown #}
    </div>

    <div>
      {% if race.secondary_image %}
        <img src="{{ race.secondary_image.url }}" alt="{{ race.name }} secondary image"
             class="w-full h-40 object-cover rounded-lg border border-gray-200 bg-white" />
      {% else %}
        <div class="w-full h-40 rounded-lg bg-gray-100 text-gray-400 flex items-center justify-center border border-gray-200">
          No Image
        </div>
      {% endif %}
    </div>
  </section>

  {# =========================== SUBRACE LINKS (flat chips) =========================== #}
  {% if subraces %}
    <section class="space-y-3">
      <div class="text-2xl font-semibold">Subraces</div>
      <div class="flex flex-wrap gap-2">
        {% for sr in subraces %}
          <a href="{{ sr.get_absolute_url|default:'#' }}"
             class="px-3 py-1 rounded-full bg-white border border-gray-200 hover:bg-gray-50 text-gray-800 text-sm">
            {{ sr.name }}
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  {# =========================== UNIVERSAL FEATURES =========================== #}
  <section class="space-y-4">
    <div class="text-2xl font-semibold">Universal Racial Features</div>
    {% if universal_features %}
      <div class="grid grid-cols-1 gap-4">
        {% for f in universal_features %}
          {% include "codex/partials/_racial_feature_card.html" with feat=f %}
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-500 text-sm">No universal racial features.</p>
    {% endif %}
  </section>

  {# =========================== CLASS-TIED FEATURES =========================== #}
  <section class="space-y-4">
    <div class="text-2xl font-semibold">Features by Class</div>
    {% if class_features_by_class %}
      <div class="space-y-6">
        {% for cls, feats in class_features_by_class %}
          <div class="rounded-lg border border-gray-200 bg-white overflow-hidden">
            <div class="px-4 py-2 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
              <div class="font-semibold">{{ cls.name }}</div>
              <span class="text-xs text-gray-500">{{ feats|length }} feature{{ feats|length|pluralize }}</span>
            </div>
            <div class="p-4 grid grid-cols-1 gap-4">
              {% for f in feats %}
                {% include "codex/partials/_racial_feature_card.html" with feat=f %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-500 text-sm">No class-specific racial features.</p>
    {% endif %}
  </section>

  {# =========================== SUBRACE FEATURES (also shows subrace bonuses) =========================== #}
  <section class="space-y-4">
    <div class="text-2xl font-semibold">Features by Subrace</div>
    {% if subrace_features_by_subrace %}
      <div class="space-y-8">
        {% for sr, feats in subrace_features_by_subrace %}
          <div class="rounded-lg border border-gray-200 bg-white overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
              <div class="font-semibold">{{ sr.race.name }} â€” {{ sr.name }}</div>
              <span class="text-xs text-gray-600">{{ feats|length }} feature{{ feats|length|pluralize }}</span>
            </div>

            {# Subrace overview (non-zero ability bonuses) #}
            <div class="px-4 pt-4 pb-1">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="rounded-lg bg-white border border-gray-200 p-3">
                  <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Basics</div>
<ul class="flex flex-wrap gap-2 text-sm text-gray-700">
  <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
    <span class="uppercase text-[10px] tracking-wide text-gray-500">Size</span>
    <span class="font-medium">{{ sr.size|capfirst }}</span>
  </li>

  <!-- Speeds that might exist on the subrace -->
  {% if sr.speed %}
  <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
    <span class="uppercase text-[10px] tracking-wide text-gray-500">Speed</span>
    <span class="font-medium">{{ sr.speed }} ft</span>
  </li>
  {% endif %}
  {% if sr.speed_climb %}
  <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
    <span class="uppercase text-[10px] tracking-wide text-gray-500">Climb</span>
    <span class="font-medium">{{ sr.speed_climb }} ft</span>
  </li>
  {% endif %}
  {% if sr.speed_swim %}
  <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
    <span class="uppercase text-[10px] tracking-wide text-gray-500">Swim</span>
    <span class="font-medium">{{ sr.speed_swim }} ft</span>
  </li>
  {% endif %}
  {% if sr.speed_fly %}
  <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
    <span class="uppercase text-[10px] tracking-wide text-gray-500">Fly</span>
    <span class="font-medium">{{ sr.speed_fly }} ft</span>
  </li>
  {% endif %}
  {% if sr.speed_burrow %}
  <li class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 border border-gray-200">
    <span class="uppercase text-[10px] tracking-wide text-gray-500">Burrow</span>
    <span class="font-medium">{{ sr.speed_burrow }} ft</span>
  </li>
  {% endif %}
</ul>
                </div>

                {% if sr.strength_bonus or sr.dexterity_bonus or sr.constitution_bonus or sr.intelligence_bonus or sr.wisdom_bonus or sr.charisma_bonus %}
                  <div class="md:col-span-2 rounded-lg bg-white border border-gray-200 p-3">
                    <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Ability Bonuses</div>
                    <div class="flex flex-wrap gap-2 text-sm">
                      {% if sr.strength_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">STR +{{ sr.strength_bonus }}</span>{% endif %}
                      {% if sr.dexterity_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">DEX +{{ sr.dexterity_bonus }}</span>{% endif %}
                      {% if sr.constitution_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">CON +{{ sr.constitution_bonus }}</span>{% endif %}
                      {% if sr.intelligence_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">INT +{{ sr.intelligence_bonus }}</span>{% endif %}
                      {% if sr.wisdom_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">WIS +{{ sr.wisdom_bonus }}</span>{% endif %}
                      {% if sr.charisma_bonus %}<span class="px-2 py-1 rounded bg-gray-50 border border-gray-200">CHA +{{ sr.charisma_bonus }}</span>{% endif %}
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>

            <div class="p-4 grid grid-cols-1 gap-4">
              {% for f in feats %}
                {% include "codex/partials/_racial_feature_card.html" with feat=f %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-500 text-sm">No subrace-specific racial features.</p>
    {% endif %}
  </section>

  {# =========================== OPTIONAL: SUBCLASS UMBRELLA =========================== #}
  {% if subclass_features_by_group %}
    <section class="space-y-4">
      <div class="text-2xl font-semibold">Subclass Features (umbrella / group)</div>
      <div class="space-y-6">
        {% for grp, feats in subclass_features_by_group %}
          <div class="rounded-lg border border-gray-200 bg-white overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
              <div class="font-semibold">{{ grp.character_class.name }} â€” {{ grp.name }}</div>
              <span class="text-xs text-gray-600">{{ feats|length }} feature{{ feats|length|pluralize }}</span>
            </div>
            <div class="p-4 grid grid-cols-1 gap-4">
              {% for f in feats %}
                {% include "codex/partials/_racial_feature_card.html" with feat=f %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endif %}

</div>
{% endblock %}